<!doctype html><html itemscope itemtype=http://schema.org/WebPage lang=zh-CN><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1,maximum-scale=2"><meta name=robots content="noodp"><title>红包雨 - </title><meta name=author content="都将会"><meta name=author-link content><meta name=description content="
TL 厂竞赛项目记录  20230905-20230916
借此机会记录红包雨项目后端开发的全流程
"><meta name=keywords content='都将会,Java,红包雨'><meta itemprop=name content="红包雨"><meta itemprop=description content="
TL 厂竞赛项目记录  20230905-20230916
借此机会记录红包雨项目后端开发的全流程
"><meta itemprop=datePublished content="2023-09-17T10:13:57+08:00"><meta itemprop=dateModified content="2023-09-17T10:13:57+08:00"><meta itemprop=wordCount content="12853"><meta itemprop=image content="https://leni.fun/images/avatar.jpg"><meta itemprop=keywords content="项目记录,"><meta property="og:title" content="红包雨"><meta property="og:description" content="
TL 厂竞赛项目记录  20230905-20230916
借此机会记录红包雨项目后端开发的全流程
"><meta property="og:type" content="article"><meta property="og:url" content="https://leni.fun/%E7%BA%A2%E5%8C%85%E9%9B%A8/"><meta property="og:image" content="https://leni.fun/images/avatar.jpg"><meta property="article:section" content="posts"><meta property="article:published_time" content="2023-09-17T10:13:57+08:00"><meta property="article:modified_time" content="2023-09-17T10:13:57+08:00"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://leni.fun/images/avatar.jpg"><meta name=twitter:title content="红包雨"><meta name=twitter:description content="
TL 厂竞赛项目记录  20230905-20230916
借此机会记录红包雨项目后端开发的全流程
"><meta name=application-name content="都将会的 APP"><meta name=apple-mobile-web-app-title content="都将会的 APP"><meta name=theme-color data-light=#f8f8f8 data-dark=#252627 content="#f8f8f8"><meta name=msapplication-TileColor content="#da532c"><link rel="shortcut icon" type=image/x-icon href=/favicon.ico><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=mask-icon href=/safari-pinned-tab.svg color=#5bbad5><link rel=manifest href=/site.webmanifest><link rel=canonical href=https://leni.fun/%E7%BA%A2%E5%8C%85%E9%9B%A8/><link rel=prev href=https://leni.fun/spring/><link rel=next href=https://leni.fun/%E7%BA%A2%E5%8C%85%E9%9B%A8ppt/><link rel=stylesheet href=/css/style.min.css><link rel=stylesheet href=/lib/fontawesome-free/all.min.css><link rel=stylesheet href=/lib/animate/animate.min.css><script type=application/ld+json>{"@context":"http://schema.org","@type":"BlogPosting","headline":"红包雨","inLanguage":"zh-CN","mainEntityOfPage":{"@type":"WebPage","@id":"https:\/\/leni.fun\/%E7%BA%A2%E5%8C%85%E9%9B%A8\/"},"genre":"posts","keywords":"项目记录","wordcount":12853,"url":"https:\/\/leni.fun\/%E7%BA%A2%E5%8C%85%E9%9B%A8\/","datePublished":"2023-09-17T10:13:57+08:00","dateModified":"2023-09-17T10:13:57+08:00","publisher":{"@type":"Organization","name":""},"author":{"@type":"Person","name":"都将会"},"description":""}</script></head><body data-header-desktop=sticky data-header-mobile=auto><script>(window.localStorage?.getItem("theme")?localStorage.getItem("theme")==="dark":"dark"==="auto"?window.matchMedia("(prefers-color-scheme: dark)").matches:"dark"==="dark")&&document.body.setAttribute("data-theme","dark")</script><div class=wrapper data-page-style=normal><header class="desktop animate__faster" id=header-desktop><div class=header-wrapper data-github-corner=left><div class=header-title><a href=/ title><img loading=lazy src=/images/icon.png srcset="/images/icon.png, /images/icon.png 1.5x, /images/icon.png 2x" sizes=auto data-title=/images/icon.png data-alt=/images/icon.png class=logo style="background:url(/svg/loading.min.svg)no-repeat 50%" onload='this.title=this.dataset.title,this.alt=this.dataset.alt;for(const e of["style","data-title","data-alt","onerror","onload"])this.removeAttribute(e);this.dataset.lazyloaded=""' onerror='this.title=this.dataset.title,this.alt=this.dataset.alt;for(const e of["style","data-title","data-alt","onerror","onload"])this.removeAttribute(e)'><span class=header-title-text>都将会</span></a><span id=typeit-header-subtitle-desktop class="typeit header-subtitle"></span></div><nav><ul class=menu><li class="menu-item has-children"><a class=menu-link href=/posts/><i class="fa-solid fa-archive fa-fw fa-sm" aria-hidden=true></i> 技术</a><i class="dropdown-icon fa-solid fa-chevron-down" aria-hidden=true></i><ul class=sub-menu><li class=menu-item><a class=menu-link href=/categories/><i class="fa-solid fa-th fa-fw fa-sm" aria-hidden=true></i> 分类</a></li><li class=menu-item><a class=menu-link href=/tags/><i class="fa-solid fa-tags fa-fw fa-sm" aria-hidden=true></i> 标签</a></li></ul></li><li class=menu-item><a class=menu-link href=/life/><i class="fa-solid fa-camera-alt fa-fw fa-sm" aria-hidden=true></i> 生活</a></li><li class=menu-item><a class=menu-link href=/friends/><i class="fa-solid fa-users fa-fw fa-sm" aria-hidden=true></i> 友链</a></li><li class=menu-item><a class=menu-link href=/about/><i class="fa-solid fa-info-circle fa-fw fa-sm" aria-hidden=true></i> 关于</a></li><li class="menu-item delimiter"></li><li class="menu-item search" id=search-desktop><input type=text placeholder=关键词搜索 id=search-input-desktop>
<a href=javascript:void(0); class="search-button search-toggle" id=search-toggle-desktop title=搜索><i class="fa-solid fa-search fa-fw" aria-hidden=true></i>
</a><a href=javascript:void(0); class="search-button search-clear" id=search-clear-desktop title=清空><i class="fa-solid fa-times-circle fa-fw" aria-hidden=true></i>
</a><span class="search-button search-loading" id=search-loading-desktop><i class="fa-solid fa-spinner fa-fw fa-spin" aria-hidden=true></i></span></li><li class="menu-item theme-switch" title=切换主题><i class="fa-solid fa-adjust fa-fw" aria-hidden=true></i></li></ul></nav></div></header><header class="mobile animate__faster" id=header-mobile><div class=header-container><div class=header-wrapper><div class=header-title><a href=/ title><img loading=lazy src=/images/icon.png srcset="/images/icon.png, /images/icon.png 1.5x, /images/icon.png 2x" sizes=auto data-title=/images/icon.png data-alt=/images/icon.png class=logo style="background:url(/svg/loading.min.svg)no-repeat 50%" onload='this.title=this.dataset.title,this.alt=this.dataset.alt;for(const e of["style","data-title","data-alt","onerror","onload"])this.removeAttribute(e);this.dataset.lazyloaded=""' onerror='this.title=this.dataset.title,this.alt=this.dataset.alt;for(const e of["style","data-title","data-alt","onerror","onload"])this.removeAttribute(e)'><span class=header-title-text>都将会</span></a><span id=typeit-header-subtitle-mobile class="typeit header-subtitle"></span></div><div class=menu-toggle id=menu-toggle-mobile><span></span><span></span><span></span></div></div><nav><ul class=menu id=menu-mobile><li class=search-wrapper><div class="search mobile" id=search-mobile><input type=text placeholder=关键词搜索 id=search-input-mobile>
<a href=javascript:void(0); class="search-button search-toggle" id=search-toggle-mobile title=搜索><i class="fa-solid fa-search fa-fw" aria-hidden=true></i>
</a><a href=javascript:void(0); class="search-button search-clear" id=search-clear-mobile title=清空><i class="fa-solid fa-times-circle fa-fw" aria-hidden=true></i>
</a><span class="search-button search-loading" id=search-loading-mobile><i class="fa-solid fa-spinner fa-fw fa-spin" aria-hidden=true></i></span></div><a href=javascript:void(0); class=search-cancel id=search-cancel-mobile>取消</a></li><li class=menu-item><span class=nested-item><a class=menu-link href=/posts/><i class="fa-solid fa-archive fa-fw fa-sm" aria-hidden=true></i> 技术</a>
<i class="dropdown-icon fa-solid fa-chevron-right" aria-hidden=true></i></span><ul class=sub-menu><li class=menu-item><a class=menu-link href=/categories/><i class="fa-solid fa-th fa-fw fa-sm" aria-hidden=true></i> 分类</a></li><li class=menu-item><a class=menu-link href=/tags/><i class="fa-solid fa-tags fa-fw fa-sm" aria-hidden=true></i> 标签</a></li></ul></li><li class=menu-item><a class=menu-link href=/life/><i class="fa-solid fa-camera-alt fa-fw fa-sm" aria-hidden=true></i> 生活</a></li><li class=menu-item><a class=menu-link href=/friends/><i class="fa-solid fa-users fa-fw fa-sm" aria-hidden=true></i> 友链</a></li><li class=menu-item><a class=menu-link href=/about/><i class="fa-solid fa-info-circle fa-fw fa-sm" aria-hidden=true></i> 关于</a></li><li class="menu-item menu-system"><span class="menu-system-item theme-switch" title=切换主题><i class="fa-solid fa-adjust fa-fw" aria-hidden=true></i></span></li></ul></nav></div></header><div class="search-dropdown desktop"><div id=search-dropdown-desktop></div></div><div class="search-dropdown mobile"><div id=search-dropdown-mobile></div></div><nav aria-label=breadcrumb class="breadcrumb-container sticky"><ol class=breadcrumb><li class=breadcrumb-item><a href=/ title>主页</a></li><li class=breadcrumb-item><a href=/posts/ title=Posts>Posts</a></li><li class="breadcrumb-item active" aria-current=page>红包雨</li></ol></nav><main class=container><aside class=toc id=toc-auto><h2 class=toc-title>目录&nbsp;<i class="toc-icon fa-solid fa-angle-down fa-fw" aria-hidden=true></i></h2><div class=toc-content id=toc-content-auto></div></aside><aside class=aside-custom></aside><article class="page single"><div class=header><h1 class="single-title animate__animated animate__flipInX"><span>红包雨</span></h1></div><div class=post-meta><div class=post-meta-line><span class=post-author><span class=author><img loading=lazy src=/images/avatar.jpg srcset="/images/avatar.jpg, /images/avatar.jpg 1.5x, /images/avatar.jpg 2x" sizes=auto data-title=都将会 data-alt=都将会 class=avatar style="background:url(/svg/loading.min.svg)no-repeat 50%" onload='this.title=this.dataset.title,this.alt=this.dataset.alt;for(const e of["style","data-title","data-alt","onerror","onload"])this.removeAttribute(e);this.dataset.lazyloaded=""' onerror='this.title=this.dataset.title,this.alt=this.dataset.alt;for(const e of["style","data-title","data-alt","onerror","onload"])this.removeAttribute(e)'>&nbsp;都将会</span></span>
<span class=post-category>收录于 <a href=/categories/202309/><i class="fa-regular fa-folder fa-fw" aria-hidden=true></i> 202309</a></span></div><div class=post-meta-line><span title="发布于 2023-09-17 10:13:57"><i class="fa-regular fa-calendar-alt fa-fw me-1" aria-hidden=true></i><time datetime=2023-09-17>2023-09-17</time></span>&nbsp;<span title="更新于 2023-09-17 10:13:57"><i class="fa-regular fa-edit fa-fw me-1" aria-hidden=true></i><time datetime=2023-09-17>2023-09-17</time></span>&nbsp;<span><i class="fa-solid fa-pencil-alt fa-fw me-1" aria-hidden=true></i>约 12853 字</span>&nbsp;<span><i class="fa-regular fa-clock fa-fw me-1" aria-hidden=true></i>预计阅读 26 分钟</span>&nbsp;<span id=busuanzi_container_page_pv class="busuanzi_visitors comment-visitors" data-flag-title=红包雨>
<i class="fa-regular fa-eye fa-fw me-1" aria-hidden=true></i><span id=busuanzi_value_page_pv>-</span>&nbsp;次阅读
</span>&nbsp;</div></div><div class=featured-image><img loading=lazy src=/images/pic14.jpg srcset="/images/pic14.jpg, /images/pic14.jpg 1.5x, /images/pic14.jpg 2x" sizes=auto data-title=/images/pic14.jpg data-alt=/images/pic14.jpg width=991 height=575 style="background:url(/svg/loading.min.svg)no-repeat 50%" onload='this.title=this.dataset.title,this.alt=this.dataset.alt;for(const e of["style","data-title","data-alt","onerror","onload"])this.removeAttribute(e);this.dataset.lazyloaded=""' onerror='this.title=this.dataset.title,this.alt=this.dataset.alt;for(const e of["style","data-title","data-alt","onerror","onload"])this.removeAttribute(e)'></div><div class="details toc" id=toc-static data-kept=false><div class="details-summary toc-title"><span>目录</span>
<span><i class="details-icon fa-solid fa-angle-right" aria-hidden=true></i></span></div><div class="details-content toc-content" id=toc-content-static><nav id=TableOfContents><ul><li><a href=#项目需求>项目需求</a><ul><li><a href=#功能要求>功能要求</a></li><li><a href=#设计要求>设计要求</a></li></ul></li><li><a href=#整体设计>整体设计</a><ul><li><a href=#技术可行性分析>技术可行性分析</a></li></ul></li><li><a href=#数据库设计>数据库设计</a><ul><li><a href=#mysql-设计>MySQL 设计</a><ul><li><a href=#红包活动表-tbl_red_envelope>红包活动表 tbl_red_envelope</a></li><li><a href=#报名表-tbl_sign>报名表 tbl_sign</a></li><li><a href=#抢红包记录表-tbl_record>抢红包记录表 tbl_record</a></li><li><a href=#消息通知表-tbl_message>消息通知表 tbl_message</a></li><li><a href=#人群表-tbl_group>人群表 tbl_group</a></li><li><a href=#用户表-ums_user>用户表 ums_user</a></li><li><a href=#角色表-ums_role>角色表 ums_role</a></li><li><a href=#用户登录日志表-ums_user_login_log>用户登录日志表 ums_user_login_log</a></li><li><a href=#资源表-ums_resource>资源表 ums_resource</a></li><li><a href=#角色资源关系表-ums_role_resource_relation>角色资源关系表 ums_role_resource_relation</a></li></ul></li><li><a href=#redis-设计>Redis 设计</a><ul><li><a href=#工具类>工具类</a></li></ul></li></ul></li><li><a href=#系统管理模块>系统管理模块</a><ul><li><a href=#核心代码>核心代码</a></li></ul></li><li><a href=#红包活动模块>红包活动模块</a><ul><li><a href=#抢红包核心思路>抢红包核心思路</a><ul><li><a href=#1-创建红包活动>（1） 创建红包活动</a></li><li><a href=#2-查询红包活动>（2） 查询红包活动</a></li><li><a href=#3-报名抢红包>（3） 报名抢红包</a></li><li><a href=#4-提交抢红包分数>（4） 提交抢红包分数</a></li><li><a href=#5-查看抢得红包金额>（5） 查看抢得红包金额</a></li><li><a href=#6-查看抢红包排行榜>（6） 查看抢红包排行榜</a></li><li><a href=#拆红包算法>拆红包算法</a></li></ul></li></ul></li><li><a href=#即时互动模块聊天室>即时互动模块（聊天室）</a><ul><li><a href=#维护用户通道>维护用户通道</a></li><li><a href=#消息处理>消息处理</a></li><li><a href=#小坑>小坑</a></li><li><a href=#最终实现>最终实现</a></li></ul></li><li><a href=#定时任务模块>定时任务模块</a><ul><li><a href=#sql>SQL</a></li><li><a href=#常用的表>常用的表</a></li><li><a href=#yml-配置>yml 配置</a></li><li><a href=#核心代码-1>核心代码</a></li></ul></li><li><a href=#亮点>亮点</a></li></ul></nav></div></div><div class=content id=content><blockquote><p>TL 厂竞赛项目记录 20230905-20230916</p><p>借此机会记录红包雨项目后端开发的全流程</p></blockquote><h2 id=项目需求>项目需求</h2><p>通过参与活动获取随机红包金额，获得的红包金额将直接存入用户的账户余额，用户可以用于消费或提现。</p><h3 id=功能要求>功能要求</h3><ol><li>用户、企业注册、登录、查看账号余额等；</li><li>支持活动的创建，要求包含活动名称、时间、描述等基本内容；</li><li>发放红包、领取红包，支持互动聊天弹幕（聊天室的信息发送及滚动展示）、排行榜等即时互动功能；</li><li>支持从后端查看活动及活动的红包的领取记录和情况；</li><li>注意用户数据的保护，用户登录需要加密；</li></ol><h3 id=设计要求>设计要求</h3><ol><li>提供简洁直观的用户界面，过程中应考虑用户参与活动的便利性和趣味性；</li><li>可以探讨一些吸引用户参与的营销策略，如推送消息提醒、分享红包活动获取额外奖励等；</li><li>界面端呈现形式（限定在 H5、PC Web，小程序、Android、iOS、Flutter等）。</li></ol><h2 id=整体设计>整体设计</h2><p><a class=lightgallery href=https://publicpictures.oss-cn-hangzhou.aliyuncs.com/img/image-20230915212230270.png data-thumbnail=https://publicpictures.oss-cn-hangzhou.aliyuncs.com/img/image-20230915212230270.png data-sub-html="<h2>image-20230915212230270</h2>"><img loading=lazy src=https://publicpictures.oss-cn-hangzhou.aliyuncs.com/img/image-20230915212230270.png srcset="https://publicpictures.oss-cn-hangzhou.aliyuncs.com/img/image-20230915212230270.png, https://publicpictures.oss-cn-hangzhou.aliyuncs.com/img/image-20230915212230270.png 1.5x, https://publicpictures.oss-cn-hangzhou.aliyuncs.com/img/image-20230915212230270.png 2x" sizes=auto data-title=image-20230915212230270 data-alt=image-20230915212230270 style="background:url(/svg/loading.min.svg)no-repeat 50%" onload='this.title=this.dataset.title,this.alt=this.dataset.alt;for(const e of["style","data-title","data-alt","onerror","onload"])this.removeAttribute(e);this.dataset.lazyloaded=""' onerror='this.title=this.dataset.title,this.alt=this.dataset.alt;for(const e of["style","data-title","data-alt","onerror","onload"])this.removeAttribute(e)'></a></p><p><a class=lightgallery href=https://publicpictures.oss-cn-hangzhou.aliyuncs.com/img/image-20230916005444017.png data-thumbnail=https://publicpictures.oss-cn-hangzhou.aliyuncs.com/img/image-20230916005444017.png data-sub-html="<h2>image-20230916005444017</h2>"><img loading=lazy src=https://publicpictures.oss-cn-hangzhou.aliyuncs.com/img/image-20230916005444017.png srcset="https://publicpictures.oss-cn-hangzhou.aliyuncs.com/img/image-20230916005444017.png, https://publicpictures.oss-cn-hangzhou.aliyuncs.com/img/image-20230916005444017.png 1.5x, https://publicpictures.oss-cn-hangzhou.aliyuncs.com/img/image-20230916005444017.png 2x" sizes=auto data-title=image-20230916005444017 data-alt=image-20230916005444017 style="background:url(/svg/loading.min.svg)no-repeat 50%" onload='this.title=this.dataset.title,this.alt=this.dataset.alt;for(const e of["style","data-title","data-alt","onerror","onload"])this.removeAttribute(e);this.dataset.lazyloaded=""' onerror='this.title=this.dataset.title,this.alt=this.dataset.alt;for(const e of["style","data-title","data-alt","onerror","onload"])this.removeAttribute(e)'></a></p><p>预期采用前后端分离架构，技术栈如下：</p><table><thead><tr><th>框架名称</th><th>功能</th></tr></thead><tbody><tr><td><strong>Spring Boot</strong></td><td>后端框架</td></tr><tr><td><strong>Spring Security</strong></td><td>安全及权限校验</td></tr><tr><td><strong>MyBatis-Plus</strong></td><td>持久层框架</td></tr><tr><td><strong>MySQL</strong></td><td>数据库</td></tr><tr><td><strong>Redis 集群</strong></td><td>缓存</td></tr><tr><td><strong>Slf4j</strong></td><td>日志</td></tr><tr><td><strong>Quartz</strong></td><td>定时任务</td></tr><tr><td><strong>Netty</strong></td><td>网络应用程序框架</td></tr></tbody></table><p>以上就是本项目使用的技术栈，这些技术都是各个领域内主流的框架，安全性、稳定性以及可扩展性都有足够的保障。通过这些框架，本项目团队设计了功能全面的后端接口。按功能分可以分为四大模块：定时任务模块、即时互动模块、红包活动模块、系统管理模块。各个模块下有若干接口实现相应功能。本项目功能架构如下图所示。</p><p><a class=lightgallery href=https://publicpictures.oss-cn-hangzhou.aliyuncs.com/img/wps1.jpg data-thumbnail=https://publicpictures.oss-cn-hangzhou.aliyuncs.com/img/wps1.jpg data-sub-html="<h2>img</h2>"><img loading=lazy src=https://publicpictures.oss-cn-hangzhou.aliyuncs.com/img/wps1.jpg srcset="https://publicpictures.oss-cn-hangzhou.aliyuncs.com/img/wps1.jpg, https://publicpictures.oss-cn-hangzhou.aliyuncs.com/img/wps1.jpg 1.5x, https://publicpictures.oss-cn-hangzhou.aliyuncs.com/img/wps1.jpg 2x" sizes=auto data-title=img data-alt=img style="background:url(/svg/loading.min.svg)no-repeat 50%" onload='this.title=this.dataset.title,this.alt=this.dataset.alt;for(const e of["style","data-title","data-alt","onerror","onload"])this.removeAttribute(e);this.dataset.lazyloaded=""' onerror='this.title=this.dataset.title,this.alt=this.dataset.alt;for(const e of["style","data-title","data-alt","onerror","onload"])this.removeAttribute(e)'></a></p><h3 id=技术可行性分析>技术可行性分析</h3><p>本节对红包雨系统的技术可行性进行了详细分析。该系统面临着并发处理、强一致性要求和防恶意行为的挑战。以下是针对这些挑战的可行性分析。</p><ol><li>针对系统的并发处理挑战，我们在技术上采用了Redis集群，Redis集群是一种高性能的内存数据库，特别适合处理高并发请求。在业务上选择了发布活动时直接拆分红包这一策略，来减轻服务器在高峰期的瞬时负载压力，提高系统的可伸缩性。经验证，以上手段能够有效提升系统的并发能力。</li><li>系统中的强一致性主要涉及金额的增减操作。我们采用了Redis的list和 hash结构来分发红包，同时通过数据库事务来确保金额的准确增加或减少。首先，红包金额会在Redis的List中进行分发，确保每个红包只能被领取一次。然后，一旦用户领取了红包，系统会触发数据库事务，将对应金额从企业账户扣除，并将金额存入用户账户，从而保证了红包的金额分发和企业账户的准确增减。通过这一流程，我们确保了每个红包要么被领取，要么被归还到企业账户，从而实现了强一致性，防止了金额的错误分发或丢失问题。这一策略在确保红包雨系统的财务一致性方面表现出可行性。</li><li>系统面临来自恶意用户的潜在攻击，为了应对这一挑战，我们采取了多层次的安全措施。在技术层面，我们引入了Spring Security的过滤器机制，这个强大的安全框架可以检测和拦截潜在的恶意请求。Spring Security的配置允许我们定义访问规则、身份验证流程以及对敏感操作的保护，从而增强了系统的安全性。在业务层面，我们引入了用户黑名单和登录失败次数限制的功能。具体来说，当用户多次登录失败达到五次时，系统会自动锁定该用户的账户半小时，以防止暴力破解。此外，我们维护一个黑名单，用于标识已知的恶意用户。黑名单中的用户将被系统屏蔽，并不允许其进行进一步的操作。</li></ol><p>通过结合技术和业务层面的措施，我们有效地减少了潜在的攻击风险，提高了系统的整体安全性。这一综合策略有助于确保红包雨系统不受到恶意行为的威胁，保护了用户的资金和数据安全。</p><p>综上所述，红包雨系统在处理高并发、维护财务一致性和防范恶意行为方面采用了一系列有效的技术和策略。通过使用Redis集群和智能红包拆分策略，系统成功提高了并发处理能力。此外，通过Redis和数据库的协同工作，确保了金额的强一致性，防止了错误分发。在安全性方面，引入了Spring Security的过滤器机制、用户黑名单和登录失败次数限制，有力地防御了恶意攻击。这些措施的综合应用为红包雨系统带来了可行性，保障了系统的性能、一致性和安全性。</p><p>然而，系统仍需持续监测和改进，以确保系统适应不断变化的需求和威胁，为用户和企业提供可靠的服务。然而，我们仍需持续监测系统的性能、安全性，并进行容量规划，以确保系统在高并发场景下能有效地运行。这些措施将有助于保持系统的可行性，并确保用户的满意度。</p><h2 id=数据库设计>数据库设计</h2><h3 id=mysql-设计>MySQL 设计</h3><h4 id=红包活动表-tbl_red_envelope>红包活动表 tbl_red_envelope</h4><table><thead><tr><th>字段名</th><th>数据类型</th><th>默认值</th><th>允许空值</th><th>备注</th></tr></thead><tbody><tr><td>id</td><td>bigint(16)</td><td></td><td></td><td>红包id</td></tr><tr><td>total_amount</td><td>decimal(10,2)</td><td></td><td>是</td><td>红包总金额</td></tr><tr><td>red_count</td><td>int</td><td></td><td></td><td>红包总个数</td></tr><tr><td>content</td><td>varchar(255)</td><td></td><td>是</td><td>活动详情</td></tr><tr><td>sign_start_time</td><td>datetime</td><td></td><td></td><td>报名开始时间</td></tr><tr><td>sign_end_time</td><td>datetime</td><td></td><td></td><td>报名截止时间</td></tr><tr><td>start_time</td><td>datetime</td><td></td><td></td><td>抢红包开始时间</td></tr><tr><td>end_time</td><td>datetime</td><td></td><td></td><td>抢红包截止时间</td></tr><tr><td>head_count_limit</td><td>int</td><td></td><td></td><td>活动人数限制</td></tr><tr><td>activity_name</td><td>varchar</td><td></td><td></td><td>活动名称</td></tr><tr><td>split_envelopes</td><td>varchar</td><td></td><td></td><td>红包拆分情况，金额用英文逗号分隔</td></tr><tr><td>same_group</td><td>int</td><td>0</td><td>是</td><td>是否是组内红包，1是，0否</td></tr><tr><td>picture</td><td>varchar</td><td></td><td>是</td><td>图片链接</td></tr><tr><td>status</td><td>int</td><td></td><td>是</td><td>进行中0、已满1、已结束2</td></tr><tr><td>create_time</td><td>datetime</td><td></td><td></td><td>创建时间</td></tr><tr><td>update_time</td><td>datetime</td><td></td><td>是</td><td>创建用户</td></tr><tr><td>create_by</td><td>varchar</td><td></td><td>是</td><td>修改时间</td></tr><tr><td>update_by</td><td>varchar</td><td></td><td>是</td><td>修改用户</td></tr><tr><td>deleted</td><td>int</td><td>0</td><td>是</td><td>逻辑删除标识：0->否；1->是</td></tr></tbody></table><h4 id=报名表-tbl_sign>报名表 tbl_sign</h4><table><thead><tr><th>字段名</th><th>数据类型</th><th>默认值</th><th>允许空值</th><th>备注</th></tr></thead><tbody><tr><td>id</td><td>bigint(16)</td><td></td><td></td><td>报名 id</td></tr><tr><td>red_id</td><td>bigint(16)</td><td></td><td></td><td>所属红包 id</td></tr><tr><td>user_id</td><td>bigint(16)</td><td></td><td></td><td>报名用户 id</td></tr><tr><td>create_time</td><td>datetime</td><td></td><td></td><td>创建时间</td></tr><tr><td>update_time</td><td>datetime</td><td></td><td>是</td><td>创建用户</td></tr><tr><td>create_by</td><td>varchar</td><td></td><td>是</td><td>修改时间</td></tr><tr><td>update_by</td><td>varchar</td><td></td><td>是</td><td>修改用户</td></tr><tr><td>deleted</td><td>int</td><td>0</td><td>是</td><td>逻辑删除标识：0->否；1->是</td></tr></tbody></table><h4 id=抢红包记录表-tbl_record>抢红包记录表 tbl_record</h4><table><thead><tr><th>字段名</th><th>数据类型</th><th>默认值</th><th>允许空值</th><th>备注</th></tr></thead><tbody><tr><td>id</td><td>bigint(16)</td><td></td><td></td><td>红包记录id</td></tr><tr><td>received_user_id</td><td>bigint(16)</td><td></td><td></td><td>收到红包的用户id</td></tr><tr><td>red_id</td><td>bigint(16)</td><td></td><td></td><td>红包id</td></tr><tr><td>score</td><td>int</td><td></td><td></td><td>点击得分</td></tr><tr><td>receive_amount</td><td>decimal</td><td></td><td></td><td>用户抢到的金额</td></tr><tr><td>create_time</td><td>datetime</td><td></td><td></td><td>创建时间</td></tr><tr><td>update_time</td><td>datetime</td><td></td><td>是</td><td>创建用户</td></tr><tr><td>create_by</td><td>varchar</td><td></td><td>是</td><td>修改时间</td></tr><tr><td>update_by</td><td>varchar</td><td></td><td>是</td><td>修改用户</td></tr><tr><td>deleted</td><td>int</td><td>0</td><td>是</td><td>逻辑删除标识：0->否；1->是</td></tr></tbody></table><h4 id=消息通知表-tbl_message>消息通知表 tbl_message</h4><table><thead><tr><th>字段名</th><th>数据类型</th><th>默认值</th><th>允许空值</th><th>备注</th></tr></thead><tbody><tr><td>id</td><td>bigint(16)</td><td></td><td></td><td>消息id</td></tr><tr><td>receive_crowd_id</td><td>bigint(16)</td><td></td><td></td><td>收取人群id</td></tr><tr><td>send_user_id</td><td>bigint(16)</td><td></td><td></td><td>发送账号id</td></tr><tr><td>is_auto</td><td>int</td><td></td><td></td><td>是否自动发送</td></tr><tr><td>send_time</td><td>datetime</td><td></td><td></td><td>发送时间</td></tr><tr><td>reply</td><td>varchar</td><td></td><td>是</td><td>收到回复</td></tr><tr><td>method</td><td>int</td><td></td><td></td><td>消息形式 1-短信发送 2-邮件发送</td></tr><tr><td>content</td><td>varchar</td><td></td><td></td><td>消息内容</td></tr><tr><td>create_time</td><td>datetime</td><td></td><td></td><td>创建时间</td></tr><tr><td>update_time</td><td>datetime</td><td></td><td></td><td>创建用户</td></tr><tr><td>create_by</td><td>varchar</td><td></td><td>是</td><td>修改时间</td></tr><tr><td>update_by</td><td>varchar</td><td></td><td>是</td><td>修改用户</td></tr><tr><td>deleted</td><td>int</td><td>0</td><td>是</td><td>逻辑删除标识：0->否；1->是</td></tr></tbody></table><h4 id=人群表-tbl_group>人群表 tbl_group</h4><table><thead><tr><th>字段名</th><th>数据类型</th><th>默认值</th><th>允许空值</th><th>备注</th></tr></thead><tbody><tr><td>id</td><td>bigint(16)</td><td></td><td></td><td>人群id</td></tr><tr><td>user_id</td><td>bigint(16)</td><td></td><td></td><td>接收用户id</td></tr><tr><td>user_name</td><td>varchar</td><td></td><td>是</td><td>用户姓名</td></tr><tr><td>phone</td><td>varchar</td><td></td><td>是</td><td>手机号</td></tr><tr><td>email</td><td>varchar</td><td></td><td>是</td><td>邮箱地址</td></tr><tr><td>create_time</td><td>datetime</td><td></td><td></td><td>创建时间</td></tr><tr><td>update_time</td><td>datetime</td><td></td><td>是</td><td>创建用户</td></tr><tr><td>create_by</td><td>varchar</td><td></td><td>是</td><td>修改时间</td></tr><tr><td>update_by</td><td>varchar</td><td></td><td>是</td><td>修改用户</td></tr><tr><td>deleted</td><td>int</td><td>0</td><td>是</td><td>逻辑删除标识：0->否；1->是</td></tr></tbody></table><h4 id=用户表-ums_user>用户表 ums_user</h4><table><thead><tr><th>字段名</th><th>数据类型</th><th>默认值</th><th>允许空值</th><th>备注</th></tr></thead><tbody><tr><td>id</td><td>bigint(16)</td><td></td><td></td><td></td></tr><tr><td>username</td><td>varchar</td><td></td><td></td><td>用户名</td></tr><tr><td>password</td><td>varchar</td><td></td><td></td><td>密码</td></tr><tr><td>icon</td><td>varchar</td><td></td><td></td><td>头像</td></tr><tr><td>phone</td><td>varchar</td><td></td><td></td><td>手机号</td></tr><tr><td>email</td><td>varchar</td><td></td><td></td><td>邮箱</td></tr><tr><td>nick_name</td><td>varchar</td><td></td><td></td><td>昵称</td></tr><tr><td>account_balance</td><td>decimal</td><td>0.00</td><td></td><td>用户余额</td></tr><tr><td>withdraw_amount</td><td>decimal</td><td>0.00</td><td></td><td>已提现金额</td></tr><tr><td>note</td><td>varchar</td><td></td><td>是</td><td>备注信息</td></tr><tr><td>login_time</td><td>datetime</td><td></td><td></td><td>最后登录时间</td></tr><tr><td>status</td><td>int</td><td>1</td><td></td><td>帐号启用状态：0->禁用；1->启用</td></tr><tr><td>black</td><td>int</td><td>0</td><td></td><td>是否是黑名单 1 是黑名单 0不是</td></tr><tr><td>belong_to</td><td>varchar</td><td>-1</td><td></td><td>组织 id ，没有组织默认-1</td></tr><tr><td>role_id</td><td>bigint(16)</td><td></td><td></td><td>角色 1-管理员 2-用户 3-企业</td></tr><tr><td>black_type</td><td>varchar</td><td></td><td>是</td><td>拉入黑名单的类型</td></tr><tr><td>black_reason</td><td>varchar</td><td></td><td>是</td><td>拉入黑名单的原因</td></tr><tr><td>create_time</td><td>datetime</td><td></td><td></td><td>创建时间</td></tr><tr><td>update_time</td><td>datetime</td><td></td><td>是</td><td>创建用户</td></tr><tr><td>create_by</td><td>varchar</td><td></td><td>是</td><td>修改时间</td></tr><tr><td>update_by</td><td>varchar</td><td></td><td>是</td><td>修改用户</td></tr><tr><td>deleted</td><td>int</td><td>0</td><td>是</td><td>逻辑删除标识：0->否；1->是</td></tr></tbody></table><h4 id=角色表-ums_role>角色表 ums_role</h4><table><thead><tr><th>字段名</th><th>数据类型</th><th>默认值</th><th>允许空值</th><th>备注</th></tr></thead><tbody><tr><td>id</td><td>bigint(16)</td><td></td><td></td><td>角色ID</td></tr><tr><td>name</td><td>varchar</td><td></td><td></td><td>名称</td></tr><tr><td>description</td><td>varchar</td><td></td><td></td><td>描述</td></tr><tr><td>status</td><td>int</td><td>1</td><td></td><td>启用状态：0->禁用；1->启用</td></tr><tr><td>create_time</td><td>datetime</td><td></td><td></td><td>创建时间</td></tr><tr><td>update_time</td><td>datetime</td><td></td><td>是</td><td>创建用户</td></tr><tr><td>create_by</td><td>varchar</td><td></td><td>是</td><td>修改时间</td></tr><tr><td>update_by</td><td>varchar</td><td></td><td>是</td><td>修改用户</td></tr><tr><td>deleted</td><td>int</td><td>0</td><td>是</td><td>逻辑删除标识：0->否；1->是</td></tr></tbody></table><h4 id=用户登录日志表-ums_user_login_log>用户登录日志表 ums_user_login_log</h4><table><thead><tr><th>字段名</th><th>数据类型</th><th>默认值</th><th>允许空值</th><th>备注</th></tr></thead><tbody><tr><td>id</td><td>bigint(16)</td><td></td><td></td><td>日志 ID</td></tr><tr><td>user_id</td><td>bigint(16)</td><td></td><td></td><td>用户ID</td></tr><tr><td>ip</td><td>varchar</td><td></td><td></td><td>登陆地IP</td></tr><tr><td>address</td><td>varchar</td><td></td><td></td><td>登录地址</td></tr><tr><td>user_agent</td><td>varchar</td><td></td><td></td><td>浏览器登录类型</td></tr><tr><td>create_time</td><td>datetime</td><td></td><td></td><td>创建时间</td></tr><tr><td>update_time</td><td>datetime</td><td></td><td>是</td><td>创建用户</td></tr><tr><td>create_by</td><td>varchar</td><td></td><td>是</td><td>修改时间</td></tr><tr><td>update_by</td><td>varchar</td><td></td><td>是</td><td>修改用户</td></tr><tr><td>deleted</td><td>int</td><td>0</td><td>是</td><td>逻辑删除标识：0->否；1->是</td></tr></tbody></table><h4 id=资源表-ums_resource>资源表 ums_resource</h4><table><thead><tr><th>字段名</th><th>数据类型</th><th>默认值</th><th>允许空值</th><th>备注</th></tr></thead><tbody><tr><td>id</td><td>bigint(16)</td><td></td><td></td><td>资源ID</td></tr><tr><td>name</td><td>varchar</td><td></td><td></td><td>分类名称</td></tr><tr><td>description</td><td>varchar</td><td></td><td></td><td>描述</td></tr><tr><td>status</td><td>int</td><td>1</td><td></td><td>启用状态：0->禁用；1->启用</td></tr><tr><td>create_time</td><td>datetime</td><td></td><td></td><td>创建时间</td></tr><tr><td>update_time</td><td>datetime</td><td></td><td>是</td><td>创建用户</td></tr><tr><td>create_by</td><td>varchar</td><td></td><td>是</td><td>修改时间</td></tr><tr><td>update_by</td><td>varchar</td><td></td><td>是</td><td>修改用户</td></tr><tr><td>deleted</td><td>int</td><td>0</td><td>是</td><td>逻辑删除标识：0->否；1->是</td></tr></tbody></table><h4 id=角色资源关系表-ums_role_resource_relation>角色资源关系表 ums_role_resource_relation</h4><table><thead><tr><th>字段名</th><th>数据类型</th><th>默认值</th><th>允许空值</th><th>备注</th></tr></thead><tbody><tr><td>id</td><td>bigint(16)</td><td></td><td></td><td></td></tr><tr><td>role_id</td><td>bigint(16)</td><td></td><td></td><td>角色ID</td></tr><tr><td>resource_id</td><td>bigint(16)</td><td></td><td></td><td>资源ID</td></tr><tr><td>status</td><td>int</td><td>1</td><td></td><td>启用状态：0->禁用；1->启用</td></tr><tr><td>create_time</td><td>datetime</td><td></td><td></td><td>创建时间</td></tr><tr><td>update_time</td><td>datetime</td><td></td><td>是</td><td>创建用户</td></tr><tr><td>create_by</td><td>varchar</td><td></td><td>是</td><td>修改时间</td></tr><tr><td>update_by</td><td>varchar</td><td></td><td>是</td><td>修改用户</td></tr><tr><td>deleted</td><td>int</td><td>0</td><td>是</td><td>逻辑删除标识：0->否；1->是</td></tr></tbody></table><h3 id=redis-设计>Redis 设计</h3><p>核心的Redis键：</p><ul><li>RED_ENVELOPE_CREATE_KEY：用于存储红包拆分情况的列表。</li><li>RED_ENVELOPE_CREATE_COUNT：用于缓存报名人数。</li><li>RED_ENVELOPE_SCORE：用于存储用户得分的哈希表。</li><li>RED_ENVELOPE_LOCK：用于分布式锁，以确保操作的原子性。</li><li>RED_ENVELOPE_CONSUME_KEY：用于存储用户抢到的红包金额。</li></ul><h4 id=工具类>工具类</h4><p>RedisService</p><div class=highlight id=id-1><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>  1
</span><span class=lnt>  2
</span><span class=lnt>  3
</span><span class=lnt>  4
</span><span class=lnt>  5
</span><span class=lnt>  6
</span><span class=lnt>  7
</span><span class=lnt>  8
</span><span class=lnt>  9
</span><span class=lnt> 10
</span><span class=lnt> 11
</span><span class=lnt> 12
</span><span class=lnt> 13
</span><span class=lnt> 14
</span><span class=lnt> 15
</span><span class=lnt> 16
</span><span class=lnt> 17
</span><span class=lnt> 18
</span><span class=lnt> 19
</span><span class=lnt> 20
</span><span class=lnt> 21
</span><span class=lnt> 22
</span><span class=lnt> 23
</span><span class=lnt> 24
</span><span class=lnt> 25
</span><span class=lnt> 26
</span><span class=lnt> 27
</span><span class=lnt> 28
</span><span class=lnt> 29
</span><span class=lnt> 30
</span><span class=lnt> 31
</span><span class=lnt> 32
</span><span class=lnt> 33
</span><span class=lnt> 34
</span><span class=lnt> 35
</span><span class=lnt> 36
</span><span class=lnt> 37
</span><span class=lnt> 38
</span><span class=lnt> 39
</span><span class=lnt> 40
</span><span class=lnt> 41
</span><span class=lnt> 42
</span><span class=lnt> 43
</span><span class=lnt> 44
</span><span class=lnt> 45
</span><span class=lnt> 46
</span><span class=lnt> 47
</span><span class=lnt> 48
</span><span class=lnt> 49
</span><span class=lnt> 50
</span><span class=lnt> 51
</span><span class=lnt> 52
</span><span class=lnt> 53
</span><span class=lnt> 54
</span><span class=lnt> 55
</span><span class=lnt> 56
</span><span class=lnt> 57
</span><span class=lnt> 58
</span><span class=lnt> 59
</span><span class=lnt> 60
</span><span class=lnt> 61
</span><span class=lnt> 62
</span><span class=lnt> 63
</span><span class=lnt> 64
</span><span class=lnt> 65
</span><span class=lnt> 66
</span><span class=lnt> 67
</span><span class=lnt> 68
</span><span class=lnt> 69
</span><span class=lnt> 70
</span><span class=lnt> 71
</span><span class=lnt> 72
</span><span class=lnt> 73
</span><span class=lnt> 74
</span><span class=lnt> 75
</span><span class=lnt> 76
</span><span class=lnt> 77
</span><span class=lnt> 78
</span><span class=lnt> 79
</span><span class=lnt> 80
</span><span class=lnt> 81
</span><span class=lnt> 82
</span><span class=lnt> 83
</span><span class=lnt> 84
</span><span class=lnt> 85
</span><span class=lnt> 86
</span><span class=lnt> 87
</span><span class=lnt> 88
</span><span class=lnt> 89
</span><span class=lnt> 90
</span><span class=lnt> 91
</span><span class=lnt> 92
</span><span class=lnt> 93
</span><span class=lnt> 94
</span><span class=lnt> 95
</span><span class=lnt> 96
</span><span class=lnt> 97
</span><span class=lnt> 98
</span><span class=lnt> 99
</span><span class=lnt>100
</span><span class=lnt>101
</span><span class=lnt>102
</span><span class=lnt>103
</span><span class=lnt>104
</span><span class=lnt>105
</span><span class=lnt>106
</span><span class=lnt>107
</span><span class=lnt>108
</span><span class=lnt>109
</span><span class=lnt>110
</span><span class=lnt>111
</span><span class=lnt>112
</span><span class=lnt>113
</span><span class=lnt>114
</span><span class=lnt>115
</span><span class=lnt>116
</span><span class=lnt>117
</span><span class=lnt>118
</span><span class=lnt>119
</span><span class=lnt>120
</span><span class=lnt>121
</span><span class=lnt>122
</span><span class=lnt>123
</span><span class=lnt>124
</span><span class=lnt>125
</span><span class=lnt>126
</span><span class=lnt>127
</span><span class=lnt>128
</span><span class=lnt>129
</span><span class=lnt>130
</span><span class=lnt>131
</span><span class=lnt>132
</span><span class=lnt>133
</span><span class=lnt>134
</span><span class=lnt>135
</span><span class=lnt>136
</span><span class=lnt>137
</span><span class=lnt>138
</span><span class=lnt>139
</span><span class=lnt>140
</span><span class=lnt>141
</span><span class=lnt>142
</span><span class=lnt>143
</span><span class=lnt>144
</span><span class=lnt>145
</span><span class=lnt>146
</span><span class=lnt>147
</span><span class=lnt>148
</span><span class=lnt>149
</span><span class=lnt>150
</span><span class=lnt>151
</span><span class=lnt>152
</span><span class=lnt>153
</span><span class=lnt>154
</span><span class=lnt>155
</span><span class=lnt>156
</span><span class=lnt>157
</span><span class=lnt>158
</span><span class=lnt>159
</span><span class=lnt>160
</span><span class=lnt>161
</span><span class=lnt>162
</span><span class=lnt>163
</span><span class=lnt>164
</span><span class=lnt>165
</span><span class=lnt>166
</span><span class=lnt>167
</span><span class=lnt>168
</span><span class=lnt>169
</span><span class=lnt>170
</span><span class=lnt>171
</span><span class=lnt>172
</span><span class=lnt>173
</span><span class=lnt>174
</span><span class=lnt>175
</span><span class=lnt>176
</span><span class=lnt>177
</span><span class=lnt>178
</span><span class=lnt>179
</span><span class=lnt>180
</span><span class=lnt>181
</span><span class=lnt>182
</span><span class=lnt>183
</span><span class=lnt>184
</span><span class=lnt>185
</span><span class=lnt>186
</span><span class=lnt>187
</span><span class=lnt>188
</span><span class=lnt>189
</span><span class=lnt>190
</span><span class=lnt>191
</span><span class=lnt>192
</span><span class=lnt>193
</span><span class=lnt>194
</span><span class=lnt>195
</span><span class=lnt>196
</span><span class=lnt>197
</span><span class=lnt>198
</span><span class=lnt>199
</span><span class=lnt>200
</span><span class=lnt>201
</span><span class=lnt>202
</span><span class=lnt>203
</span><span class=lnt>204
</span><span class=lnt>205
</span><span class=lnt>206
</span><span class=lnt>207
</span><span class=lnt>208
</span><span class=lnt>209
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kn>import</span><span class=w> </span><span class=nn>java.util.List</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kn>import</span><span class=w> </span><span class=nn>java.util.Map</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kn>import</span><span class=w> </span><span class=nn>java.util.Set</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * redis操作Service
</span></span></span><span class=line><span class=cl><span class=cm> */</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kd>interface</span> <span class=nc>RedisService</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>     * 加锁操作
</span></span></span><span class=line><span class=cl><span class=cm>     */</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kt>boolean</span><span class=w> </span><span class=nf>acquireLock</span><span class=p>(</span><span class=n>String</span><span class=w> </span><span class=n>lockKey</span><span class=p>,</span><span class=w> </span><span class=n>String</span><span class=w> </span><span class=n>requestId</span><span class=p>,</span><span class=w> </span><span class=kt>long</span><span class=w> </span><span class=n>expireTimeInSeconds</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kt>boolean</span><span class=w> </span><span class=nf>acquireLock</span><span class=p>(</span><span class=n>String</span><span class=w> </span><span class=n>lockKey</span><span class=p>,</span><span class=w> </span><span class=kt>long</span><span class=w> </span><span class=n>expireTimeInSeconds</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>     * 是否拥有锁
</span></span></span><span class=line><span class=cl><span class=cm>     */</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kt>boolean</span><span class=w> </span><span class=nf>isLocked</span><span class=p>(</span><span class=n>String</span><span class=w> </span><span class=n>key</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>     * 释放锁操作
</span></span></span><span class=line><span class=cl><span class=cm>     */</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kt>boolean</span><span class=w> </span><span class=nf>releaseLock</span><span class=p>(</span><span class=n>String</span><span class=w> </span><span class=n>lockKey</span><span class=p>,</span><span class=w> </span><span class=n>String</span><span class=w> </span><span class=n>requestId</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kt>boolean</span><span class=w> </span><span class=nf>releaseLock</span><span class=p>(</span><span class=n>String</span><span class=w> </span><span class=n>lockKey</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>     * 异步等待锁的释放
</span></span></span><span class=line><span class=cl><span class=cm>     */</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>waitForLockRelease</span><span class=p>(</span><span class=n>String</span><span class=w> </span><span class=n>lockKey</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>     * 保存属性
</span></span></span><span class=line><span class=cl><span class=cm>     */</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kt>void</span><span class=w> </span><span class=nf>set</span><span class=p>(</span><span class=n>String</span><span class=w> </span><span class=n>key</span><span class=p>,</span><span class=w> </span><span class=n>Object</span><span class=w> </span><span class=n>value</span><span class=p>,</span><span class=w> </span><span class=kt>long</span><span class=w> </span><span class=n>time</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>     * 保存属性
</span></span></span><span class=line><span class=cl><span class=cm>     */</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kt>void</span><span class=w> </span><span class=nf>set</span><span class=p>(</span><span class=n>String</span><span class=w> </span><span class=n>key</span><span class=p>,</span><span class=w> </span><span class=n>Object</span><span class=w> </span><span class=n>value</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>     * 获取属性
</span></span></span><span class=line><span class=cl><span class=cm>     */</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>Object</span><span class=w> </span><span class=nf>get</span><span class=p>(</span><span class=n>String</span><span class=w> </span><span class=n>key</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>     * 删除属性
</span></span></span><span class=line><span class=cl><span class=cm>     */</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>Boolean</span><span class=w> </span><span class=nf>del</span><span class=p>(</span><span class=n>String</span><span class=w> </span><span class=n>key</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>     * 批量删除属性
</span></span></span><span class=line><span class=cl><span class=cm>     */</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>Long</span><span class=w> </span><span class=nf>del</span><span class=p>(</span><span class=n>List</span><span class=o>&lt;</span><span class=n>String</span><span class=o>&gt;</span><span class=w> </span><span class=n>keys</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>     * 设置过期时间
</span></span></span><span class=line><span class=cl><span class=cm>     */</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>Boolean</span><span class=w> </span><span class=nf>expire</span><span class=p>(</span><span class=n>String</span><span class=w> </span><span class=n>key</span><span class=p>,</span><span class=w> </span><span class=kt>long</span><span class=w> </span><span class=n>time</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>     * 获取过期时间
</span></span></span><span class=line><span class=cl><span class=cm>     */</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>Long</span><span class=w> </span><span class=nf>getExpire</span><span class=p>(</span><span class=n>String</span><span class=w> </span><span class=n>key</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>     * 判断是否有该属性
</span></span></span><span class=line><span class=cl><span class=cm>     */</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>Boolean</span><span class=w> </span><span class=nf>hasKey</span><span class=p>(</span><span class=n>String</span><span class=w> </span><span class=n>key</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>     * 按delta递增
</span></span></span><span class=line><span class=cl><span class=cm>     */</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>Long</span><span class=w> </span><span class=nf>incr</span><span class=p>(</span><span class=n>String</span><span class=w> </span><span class=n>key</span><span class=p>,</span><span class=w> </span><span class=kt>long</span><span class=w> </span><span class=n>delta</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>     * 按delta递减
</span></span></span><span class=line><span class=cl><span class=cm>     */</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>Long</span><span class=w> </span><span class=nf>decr</span><span class=p>(</span><span class=n>String</span><span class=w> </span><span class=n>key</span><span class=p>,</span><span class=w> </span><span class=kt>long</span><span class=w> </span><span class=n>delta</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>     * 获取Hash结构中的属性
</span></span></span><span class=line><span class=cl><span class=cm>     */</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>Object</span><span class=w> </span><span class=nf>hGet</span><span class=p>(</span><span class=n>String</span><span class=w> </span><span class=n>key</span><span class=p>,</span><span class=w> </span><span class=n>String</span><span class=w> </span><span class=n>hashKey</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>     * 向Hash结构中放入一个属性
</span></span></span><span class=line><span class=cl><span class=cm>     */</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>Boolean</span><span class=w> </span><span class=nf>hSet</span><span class=p>(</span><span class=n>String</span><span class=w> </span><span class=n>key</span><span class=p>,</span><span class=w> </span><span class=n>String</span><span class=w> </span><span class=n>hashKey</span><span class=p>,</span><span class=w> </span><span class=n>Object</span><span class=w> </span><span class=n>value</span><span class=p>,</span><span class=w> </span><span class=kt>long</span><span class=w> </span><span class=n>time</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>     * 向Hash结构中放入一个属性
</span></span></span><span class=line><span class=cl><span class=cm>     */</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kt>void</span><span class=w> </span><span class=nf>hSet</span><span class=p>(</span><span class=n>String</span><span class=w> </span><span class=n>key</span><span class=p>,</span><span class=w> </span><span class=n>String</span><span class=w> </span><span class=n>hashKey</span><span class=p>,</span><span class=w> </span><span class=n>Object</span><span class=w> </span><span class=n>value</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>     * 直接获取整个Hash结构
</span></span></span><span class=line><span class=cl><span class=cm>     */</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>Map</span><span class=o>&lt;</span><span class=n>Object</span><span class=p>,</span><span class=w> </span><span class=n>Object</span><span class=o>&gt;</span><span class=w> </span><span class=nf>hGetAll</span><span class=p>(</span><span class=n>String</span><span class=w> </span><span class=n>key</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>     * 直接设置整个Hash结构
</span></span></span><span class=line><span class=cl><span class=cm>     */</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>Boolean</span><span class=w> </span><span class=nf>hSetAll</span><span class=p>(</span><span class=n>String</span><span class=w> </span><span class=n>key</span><span class=p>,</span><span class=w> </span><span class=n>Map</span><span class=o>&lt;</span><span class=n>String</span><span class=p>,</span><span class=w> </span><span class=n>Object</span><span class=o>&gt;</span><span class=w> </span><span class=n>map</span><span class=p>,</span><span class=w> </span><span class=kt>long</span><span class=w> </span><span class=n>time</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>     * 直接设置整个Hash结构
</span></span></span><span class=line><span class=cl><span class=cm>     */</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kt>void</span><span class=w> </span><span class=nf>hSetAll</span><span class=p>(</span><span class=n>String</span><span class=w> </span><span class=n>key</span><span class=p>,</span><span class=w> </span><span class=n>Map</span><span class=o>&lt;</span><span class=n>String</span><span class=p>,</span><span class=w> </span><span class=o>?&gt;</span><span class=w> </span><span class=n>map</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>     * 删除Hash结构中的属性
</span></span></span><span class=line><span class=cl><span class=cm>     */</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kt>void</span><span class=w> </span><span class=nf>hDel</span><span class=p>(</span><span class=n>String</span><span class=w> </span><span class=n>key</span><span class=p>,</span><span class=w> </span><span class=n>Object</span><span class=p>...</span><span class=w> </span><span class=n>hashKey</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>     * 判断Hash结构中是否有该属性
</span></span></span><span class=line><span class=cl><span class=cm>     */</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>Boolean</span><span class=w> </span><span class=nf>hHasKey</span><span class=p>(</span><span class=n>String</span><span class=w> </span><span class=n>key</span><span class=p>,</span><span class=w> </span><span class=n>String</span><span class=w> </span><span class=n>hashKey</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>     * Hash结构中属性递增
</span></span></span><span class=line><span class=cl><span class=cm>     */</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>Long</span><span class=w> </span><span class=nf>hIncr</span><span class=p>(</span><span class=n>String</span><span class=w> </span><span class=n>key</span><span class=p>,</span><span class=w> </span><span class=n>String</span><span class=w> </span><span class=n>hashKey</span><span class=p>,</span><span class=w> </span><span class=n>Long</span><span class=w> </span><span class=n>delta</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>     * Hash结构中属性递减
</span></span></span><span class=line><span class=cl><span class=cm>     */</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>Long</span><span class=w> </span><span class=nf>hDecr</span><span class=p>(</span><span class=n>String</span><span class=w> </span><span class=n>key</span><span class=p>,</span><span class=w> </span><span class=n>String</span><span class=w> </span><span class=n>hashKey</span><span class=p>,</span><span class=w> </span><span class=n>Long</span><span class=w> </span><span class=n>delta</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>     * 获取Set结构
</span></span></span><span class=line><span class=cl><span class=cm>     */</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>Set</span><span class=o>&lt;</span><span class=n>Object</span><span class=o>&gt;</span><span class=w> </span><span class=nf>sMembers</span><span class=p>(</span><span class=n>String</span><span class=w> </span><span class=n>key</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>     * 向Set结构中添加属性
</span></span></span><span class=line><span class=cl><span class=cm>     */</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>Long</span><span class=w> </span><span class=nf>sAdd</span><span class=p>(</span><span class=n>String</span><span class=w> </span><span class=n>key</span><span class=p>,</span><span class=w> </span><span class=n>Object</span><span class=p>...</span><span class=w> </span><span class=n>values</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>     * 向Set结构中添加属性
</span></span></span><span class=line><span class=cl><span class=cm>     */</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>Long</span><span class=w> </span><span class=nf>sAdd</span><span class=p>(</span><span class=n>String</span><span class=w> </span><span class=n>key</span><span class=p>,</span><span class=w> </span><span class=kt>long</span><span class=w> </span><span class=n>time</span><span class=p>,</span><span class=w> </span><span class=n>Object</span><span class=p>...</span><span class=w> </span><span class=n>values</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>     * 是否为Set中的属性
</span></span></span><span class=line><span class=cl><span class=cm>     */</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>Boolean</span><span class=w> </span><span class=nf>sIsMember</span><span class=p>(</span><span class=n>String</span><span class=w> </span><span class=n>key</span><span class=p>,</span><span class=w> </span><span class=n>Object</span><span class=w> </span><span class=n>value</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>     * 获取Set结构的长度
</span></span></span><span class=line><span class=cl><span class=cm>     */</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>Long</span><span class=w> </span><span class=nf>sSize</span><span class=p>(</span><span class=n>String</span><span class=w> </span><span class=n>key</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>     * 删除Set结构中的属性
</span></span></span><span class=line><span class=cl><span class=cm>     */</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>Long</span><span class=w> </span><span class=nf>sRemove</span><span class=p>(</span><span class=n>String</span><span class=w> </span><span class=n>key</span><span class=p>,</span><span class=w> </span><span class=n>Object</span><span class=p>...</span><span class=w> </span><span class=n>values</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>     * 获取List结构中的属性
</span></span></span><span class=line><span class=cl><span class=cm>     */</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>List</span><span class=o>&lt;</span><span class=n>Object</span><span class=o>&gt;</span><span class=w> </span><span class=nf>lRange</span><span class=p>(</span><span class=n>String</span><span class=w> </span><span class=n>key</span><span class=p>,</span><span class=w> </span><span class=kt>long</span><span class=w> </span><span class=n>start</span><span class=p>,</span><span class=w> </span><span class=kt>long</span><span class=w> </span><span class=n>end</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>     * 获取List结构的长度
</span></span></span><span class=line><span class=cl><span class=cm>     */</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>Long</span><span class=w> </span><span class=nf>lSize</span><span class=p>(</span><span class=n>String</span><span class=w> </span><span class=n>key</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>     * 根据索引获取List中的属性
</span></span></span><span class=line><span class=cl><span class=cm>     */</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>Object</span><span class=w> </span><span class=nf>lIndex</span><span class=p>(</span><span class=n>String</span><span class=w> </span><span class=n>key</span><span class=p>,</span><span class=w> </span><span class=kt>long</span><span class=w> </span><span class=n>index</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>     * 向List结构中添加属性
</span></span></span><span class=line><span class=cl><span class=cm>     */</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>Long</span><span class=w> </span><span class=nf>lPush</span><span class=p>(</span><span class=n>String</span><span class=w> </span><span class=n>key</span><span class=p>,</span><span class=w> </span><span class=n>Object</span><span class=w> </span><span class=n>value</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>     * 向List结构中添加属性
</span></span></span><span class=line><span class=cl><span class=cm>     */</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>Long</span><span class=w> </span><span class=nf>lPush</span><span class=p>(</span><span class=n>String</span><span class=w> </span><span class=n>key</span><span class=p>,</span><span class=w> </span><span class=n>Object</span><span class=w> </span><span class=n>value</span><span class=p>,</span><span class=w> </span><span class=kt>long</span><span class=w> </span><span class=n>time</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>     * 向List结构中批量添加属性
</span></span></span><span class=line><span class=cl><span class=cm>     */</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>Long</span><span class=w> </span><span class=nf>lPushAll</span><span class=p>(</span><span class=n>String</span><span class=w> </span><span class=n>key</span><span class=p>,</span><span class=w> </span><span class=n>Object</span><span class=p>...</span><span class=w> </span><span class=n>values</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>     * 向List结构中批量添加属性
</span></span></span><span class=line><span class=cl><span class=cm>     */</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>Long</span><span class=w> </span><span class=nf>lPushAll</span><span class=p>(</span><span class=n>String</span><span class=w> </span><span class=n>key</span><span class=p>,</span><span class=w> </span><span class=n>Long</span><span class=w> </span><span class=n>time</span><span class=p>,</span><span class=w> </span><span class=n>Object</span><span class=p>...</span><span class=w> </span><span class=n>values</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>     * 从List结构中移除属性
</span></span></span><span class=line><span class=cl><span class=cm>     */</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>Long</span><span class=w> </span><span class=nf>lRemove</span><span class=p>(</span><span class=n>String</span><span class=w> </span><span class=n>key</span><span class=p>,</span><span class=w> </span><span class=kt>long</span><span class=w> </span><span class=n>count</span><span class=p>,</span><span class=w> </span><span class=n>Object</span><span class=w> </span><span class=n>value</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>     * List 出栈
</span></span></span><span class=line><span class=cl><span class=cm>     */</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>Object</span><span class=w> </span><span class=nf>lPop</span><span class=p>(</span><span class=n>String</span><span class=w> </span><span class=n>key</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span></span></span></code></pre></td></tr></table></div></div><p>RedisServiceImpl</p><div class=highlight id=id-2><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>  1
</span><span class=lnt>  2
</span><span class=lnt>  3
</span><span class=lnt>  4
</span><span class=lnt>  5
</span><span class=lnt>  6
</span><span class=lnt>  7
</span><span class=lnt>  8
</span><span class=lnt>  9
</span><span class=lnt> 10
</span><span class=lnt> 11
</span><span class=lnt> 12
</span><span class=lnt> 13
</span><span class=lnt> 14
</span><span class=lnt> 15
</span><span class=lnt> 16
</span><span class=lnt> 17
</span><span class=lnt> 18
</span><span class=lnt> 19
</span><span class=lnt> 20
</span><span class=lnt> 21
</span><span class=lnt> 22
</span><span class=lnt> 23
</span><span class=lnt> 24
</span><span class=lnt> 25
</span><span class=lnt> 26
</span><span class=lnt> 27
</span><span class=lnt> 28
</span><span class=lnt> 29
</span><span class=lnt> 30
</span><span class=lnt> 31
</span><span class=lnt> 32
</span><span class=lnt> 33
</span><span class=lnt> 34
</span><span class=lnt> 35
</span><span class=lnt> 36
</span><span class=lnt> 37
</span><span class=lnt> 38
</span><span class=lnt> 39
</span><span class=lnt> 40
</span><span class=lnt> 41
</span><span class=lnt> 42
</span><span class=lnt> 43
</span><span class=lnt> 44
</span><span class=lnt> 45
</span><span class=lnt> 46
</span><span class=lnt> 47
</span><span class=lnt> 48
</span><span class=lnt> 49
</span><span class=lnt> 50
</span><span class=lnt> 51
</span><span class=lnt> 52
</span><span class=lnt> 53
</span><span class=lnt> 54
</span><span class=lnt> 55
</span><span class=lnt> 56
</span><span class=lnt> 57
</span><span class=lnt> 58
</span><span class=lnt> 59
</span><span class=lnt> 60
</span><span class=lnt> 61
</span><span class=lnt> 62
</span><span class=lnt> 63
</span><span class=lnt> 64
</span><span class=lnt> 65
</span><span class=lnt> 66
</span><span class=lnt> 67
</span><span class=lnt> 68
</span><span class=lnt> 69
</span><span class=lnt> 70
</span><span class=lnt> 71
</span><span class=lnt> 72
</span><span class=lnt> 73
</span><span class=lnt> 74
</span><span class=lnt> 75
</span><span class=lnt> 76
</span><span class=lnt> 77
</span><span class=lnt> 78
</span><span class=lnt> 79
</span><span class=lnt> 80
</span><span class=lnt> 81
</span><span class=lnt> 82
</span><span class=lnt> 83
</span><span class=lnt> 84
</span><span class=lnt> 85
</span><span class=lnt> 86
</span><span class=lnt> 87
</span><span class=lnt> 88
</span><span class=lnt> 89
</span><span class=lnt> 90
</span><span class=lnt> 91
</span><span class=lnt> 92
</span><span class=lnt> 93
</span><span class=lnt> 94
</span><span class=lnt> 95
</span><span class=lnt> 96
</span><span class=lnt> 97
</span><span class=lnt> 98
</span><span class=lnt> 99
</span><span class=lnt>100
</span><span class=lnt>101
</span><span class=lnt>102
</span><span class=lnt>103
</span><span class=lnt>104
</span><span class=lnt>105
</span><span class=lnt>106
</span><span class=lnt>107
</span><span class=lnt>108
</span><span class=lnt>109
</span><span class=lnt>110
</span><span class=lnt>111
</span><span class=lnt>112
</span><span class=lnt>113
</span><span class=lnt>114
</span><span class=lnt>115
</span><span class=lnt>116
</span><span class=lnt>117
</span><span class=lnt>118
</span><span class=lnt>119
</span><span class=lnt>120
</span><span class=lnt>121
</span><span class=lnt>122
</span><span class=lnt>123
</span><span class=lnt>124
</span><span class=lnt>125
</span><span class=lnt>126
</span><span class=lnt>127
</span><span class=lnt>128
</span><span class=lnt>129
</span><span class=lnt>130
</span><span class=lnt>131
</span><span class=lnt>132
</span><span class=lnt>133
</span><span class=lnt>134
</span><span class=lnt>135
</span><span class=lnt>136
</span><span class=lnt>137
</span><span class=lnt>138
</span><span class=lnt>139
</span><span class=lnt>140
</span><span class=lnt>141
</span><span class=lnt>142
</span><span class=lnt>143
</span><span class=lnt>144
</span><span class=lnt>145
</span><span class=lnt>146
</span><span class=lnt>147
</span><span class=lnt>148
</span><span class=lnt>149
</span><span class=lnt>150
</span><span class=lnt>151
</span><span class=lnt>152
</span><span class=lnt>153
</span><span class=lnt>154
</span><span class=lnt>155
</span><span class=lnt>156
</span><span class=lnt>157
</span><span class=lnt>158
</span><span class=lnt>159
</span><span class=lnt>160
</span><span class=lnt>161
</span><span class=lnt>162
</span><span class=lnt>163
</span><span class=lnt>164
</span><span class=lnt>165
</span><span class=lnt>166
</span><span class=lnt>167
</span><span class=lnt>168
</span><span class=lnt>169
</span><span class=lnt>170
</span><span class=lnt>171
</span><span class=lnt>172
</span><span class=lnt>173
</span><span class=lnt>174
</span><span class=lnt>175
</span><span class=lnt>176
</span><span class=lnt>177
</span><span class=lnt>178
</span><span class=lnt>179
</span><span class=lnt>180
</span><span class=lnt>181
</span><span class=lnt>182
</span><span class=lnt>183
</span><span class=lnt>184
</span><span class=lnt>185
</span><span class=lnt>186
</span><span class=lnt>187
</span><span class=lnt>188
</span><span class=lnt>189
</span><span class=lnt>190
</span><span class=lnt>191
</span><span class=lnt>192
</span><span class=lnt>193
</span><span class=lnt>194
</span><span class=lnt>195
</span><span class=lnt>196
</span><span class=lnt>197
</span><span class=lnt>198
</span><span class=lnt>199
</span><span class=lnt>200
</span><span class=lnt>201
</span><span class=lnt>202
</span><span class=lnt>203
</span><span class=lnt>204
</span><span class=lnt>205
</span><span class=lnt>206
</span><span class=lnt>207
</span><span class=lnt>208
</span><span class=lnt>209
</span><span class=lnt>210
</span><span class=lnt>211
</span><span class=lnt>212
</span><span class=lnt>213
</span><span class=lnt>214
</span><span class=lnt>215
</span><span class=lnt>216
</span><span class=lnt>217
</span><span class=lnt>218
</span><span class=lnt>219
</span><span class=lnt>220
</span><span class=lnt>221
</span><span class=lnt>222
</span><span class=lnt>223
</span><span class=lnt>224
</span><span class=lnt>225
</span><span class=lnt>226
</span><span class=lnt>227
</span><span class=lnt>228
</span><span class=lnt>229
</span><span class=lnt>230
</span><span class=lnt>231
</span><span class=lnt>232
</span><span class=lnt>233
</span><span class=lnt>234
</span><span class=lnt>235
</span><span class=lnt>236
</span><span class=lnt>237
</span><span class=lnt>238
</span><span class=lnt>239
</span><span class=lnt>240
</span><span class=lnt>241
</span><span class=lnt>242
</span><span class=lnt>243
</span><span class=lnt>244
</span><span class=lnt>245
</span><span class=lnt>246
</span><span class=lnt>247
</span><span class=lnt>248
</span><span class=lnt>249
</span><span class=lnt>250
</span><span class=lnt>251
</span><span class=lnt>252
</span><span class=lnt>253
</span><span class=lnt>254
</span><span class=lnt>255
</span><span class=lnt>256
</span><span class=lnt>257
</span><span class=lnt>258
</span><span class=lnt>259
</span><span class=lnt>260
</span><span class=lnt>261
</span><span class=lnt>262
</span><span class=lnt>263
</span><span class=lnt>264
</span><span class=lnt>265
</span><span class=lnt>266
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kn>import</span><span class=w> </span><span class=nn>com.project.common.service.RedisService</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kn>import</span><span class=w> </span><span class=nn>org.springframework.beans.factory.annotation.Autowired</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kn>import</span><span class=w> </span><span class=nn>org.springframework.data.redis.core.RedisTemplate</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kn>import</span><span class=w> </span><span class=nn>org.springframework.data.redis.core.StringRedisTemplate</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kn>import</span><span class=w> </span><span class=nn>java.util.List</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kn>import</span><span class=w> </span><span class=nn>java.util.Map</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kn>import</span><span class=w> </span><span class=nn>java.util.Set</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kn>import</span><span class=w> </span><span class=nn>java.util.concurrent.TimeUnit</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kn>import static</span><span class=w> </span><span class=nn>com.project.modules.redEnvelope.constant.Constant.RED_ENVELOPE_LOCK</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * redis操作实现类
</span></span></span><span class=line><span class=cl><span class=cm> */</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kd>class</span> <span class=nc>RedisServiceImpl</span><span class=w> </span><span class=kd>implements</span><span class=w> </span><span class=n>RedisService</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Autowired</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=n>RedisTemplate</span><span class=o>&lt;</span><span class=n>String</span><span class=p>,</span><span class=w> </span><span class=n>Object</span><span class=o>&gt;</span><span class=w> </span><span class=n>redisTemplate</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Autowired</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=n>StringRedisTemplate</span><span class=w> </span><span class=n>stringRedisTemplate</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// 加锁操作</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Override</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kt>boolean</span><span class=w> </span><span class=nf>acquireLock</span><span class=p>(</span><span class=n>String</span><span class=w> </span><span class=n>lockKey</span><span class=p>,</span><span class=w> </span><span class=n>String</span><span class=w> </span><span class=n>requestId</span><span class=p>,</span><span class=w> </span><span class=kt>long</span><span class=w> </span><span class=n>expireTimeInSeconds</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>Boolean</span><span class=w> </span><span class=n>lockAcquired</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>stringRedisTemplate</span><span class=p>.</span><span class=na>opsForValue</span><span class=p>().</span><span class=na>setIfAbsent</span><span class=p>(</span><span class=n>lockKey</span><span class=p>,</span><span class=w> </span><span class=n>requestId</span><span class=p>,</span><span class=w> </span><span class=n>expireTimeInSeconds</span><span class=p>,</span><span class=w> </span><span class=n>TimeUnit</span><span class=p>.</span><span class=na>SECONDS</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>return</span><span class=w> </span><span class=n>lockAcquired</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=w> </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=n>lockAcquired</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w> </span><span class=k>catch</span><span class=w> </span><span class=p>(</span><span class=n>Exception</span><span class=w> </span><span class=n>e</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// 处理异常</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>return</span><span class=w> </span><span class=kc>false</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Override</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kt>boolean</span><span class=w> </span><span class=nf>acquireLock</span><span class=p>(</span><span class=n>String</span><span class=w> </span><span class=n>lockKey</span><span class=p>,</span><span class=w> </span><span class=kt>long</span><span class=w> </span><span class=n>expireTimeInSeconds</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>acquireLock</span><span class=p>(</span><span class=n>lockKey</span><span class=p>,</span><span class=w> </span><span class=n>RED_ENVELOPE_LOCK</span><span class=p>,</span><span class=w> </span><span class=n>expireTimeInSeconds</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// 释放锁操作</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Override</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kt>boolean</span><span class=w> </span><span class=nf>releaseLock</span><span class=p>(</span><span class=n>String</span><span class=w> </span><span class=n>lockKey</span><span class=p>,</span><span class=w> </span><span class=n>String</span><span class=w> </span><span class=n>requestId</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>String</span><span class=w> </span><span class=n>currentValue</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>stringRedisTemplate</span><span class=p>.</span><span class=na>opsForValue</span><span class=p>().</span><span class=na>get</span><span class=p>(</span><span class=n>lockKey</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>currentValue</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=w> </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=n>currentValue</span><span class=p>.</span><span class=na>equals</span><span class=p>(</span><span class=n>requestId</span><span class=p>))</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>return</span><span class=w> </span><span class=n>stringRedisTemplate</span><span class=p>.</span><span class=na>delete</span><span class=p>(</span><span class=n>lockKey</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>return</span><span class=w> </span><span class=kc>false</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w> </span><span class=k>catch</span><span class=w> </span><span class=p>(</span><span class=n>Exception</span><span class=w> </span><span class=n>e</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// 处理异常</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>return</span><span class=w> </span><span class=kc>false</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kt>boolean</span><span class=w> </span><span class=nf>isLockOwned</span><span class=p>(</span><span class=n>String</span><span class=w> </span><span class=n>lockKey</span><span class=p>,</span><span class=w> </span><span class=n>String</span><span class=w> </span><span class=n>requestId</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>String</span><span class=w> </span><span class=n>currentValue</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>stringRedisTemplate</span><span class=p>.</span><span class=na>opsForValue</span><span class=p>().</span><span class=na>get</span><span class=p>(</span><span class=n>lockKey</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>return</span><span class=w> </span><span class=n>currentValue</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=w> </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=n>currentValue</span><span class=p>.</span><span class=na>equals</span><span class=p>(</span><span class=n>requestId</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w> </span><span class=k>catch</span><span class=w> </span><span class=p>(</span><span class=n>Exception</span><span class=w> </span><span class=n>e</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// 处理异常</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>return</span><span class=w> </span><span class=kc>false</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Override</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kt>boolean</span><span class=w> </span><span class=nf>isLocked</span><span class=p>(</span><span class=n>String</span><span class=w> </span><span class=n>key</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>isLockOwned</span><span class=p>(</span><span class=n>key</span><span class=p>,</span><span class=w> </span><span class=n>RED_ENVELOPE_LOCK</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Override</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kt>boolean</span><span class=w> </span><span class=nf>releaseLock</span><span class=p>(</span><span class=n>String</span><span class=w> </span><span class=n>lockKey</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>releaseLock</span><span class=p>(</span><span class=n>lockKey</span><span class=p>,</span><span class=w> </span><span class=n>RED_ENVELOPE_LOCK</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// 异步等待锁的释放</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Override</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>waitForLockRelease</span><span class=p>(</span><span class=n>String</span><span class=w> </span><span class=n>lockKey</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// 使用BLPOP来异步等待锁的释放</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// BLPOP会一直等待直到有数据被push到lockKey，此时表示锁已释放</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>stringRedisTemplate</span><span class=p>.</span><span class=na>opsForList</span><span class=p>().</span><span class=na>leftPop</span><span class=p>(</span><span class=n>lockKey</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Override</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>set</span><span class=p>(</span><span class=n>String</span><span class=w> </span><span class=n>key</span><span class=p>,</span><span class=w> </span><span class=n>Object</span><span class=w> </span><span class=n>value</span><span class=p>,</span><span class=w> </span><span class=kt>long</span><span class=w> </span><span class=n>time</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>redisTemplate</span><span class=p>.</span><span class=na>opsForValue</span><span class=p>().</span><span class=na>set</span><span class=p>(</span><span class=n>key</span><span class=p>,</span><span class=w> </span><span class=n>value</span><span class=p>,</span><span class=w> </span><span class=n>time</span><span class=p>,</span><span class=w> </span><span class=n>TimeUnit</span><span class=p>.</span><span class=na>SECONDS</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Override</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>set</span><span class=p>(</span><span class=n>String</span><span class=w> </span><span class=n>key</span><span class=p>,</span><span class=w> </span><span class=n>Object</span><span class=w> </span><span class=n>value</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>redisTemplate</span><span class=p>.</span><span class=na>opsForValue</span><span class=p>().</span><span class=na>set</span><span class=p>(</span><span class=n>key</span><span class=p>,</span><span class=w> </span><span class=n>value</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Override</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=n>Object</span><span class=w> </span><span class=nf>get</span><span class=p>(</span><span class=n>String</span><span class=w> </span><span class=n>key</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>redisTemplate</span><span class=p>.</span><span class=na>opsForValue</span><span class=p>().</span><span class=na>get</span><span class=p>(</span><span class=n>key</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Override</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=n>Boolean</span><span class=w> </span><span class=nf>del</span><span class=p>(</span><span class=n>String</span><span class=w> </span><span class=n>key</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>redisTemplate</span><span class=p>.</span><span class=na>delete</span><span class=p>(</span><span class=n>key</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Override</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=n>Long</span><span class=w> </span><span class=nf>del</span><span class=p>(</span><span class=n>List</span><span class=o>&lt;</span><span class=n>String</span><span class=o>&gt;</span><span class=w> </span><span class=n>keys</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>redisTemplate</span><span class=p>.</span><span class=na>delete</span><span class=p>(</span><span class=n>keys</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Override</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=n>Boolean</span><span class=w> </span><span class=nf>expire</span><span class=p>(</span><span class=n>String</span><span class=w> </span><span class=n>key</span><span class=p>,</span><span class=w> </span><span class=kt>long</span><span class=w> </span><span class=n>time</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>redisTemplate</span><span class=p>.</span><span class=na>expire</span><span class=p>(</span><span class=n>key</span><span class=p>,</span><span class=w> </span><span class=n>time</span><span class=p>,</span><span class=w> </span><span class=n>TimeUnit</span><span class=p>.</span><span class=na>SECONDS</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Override</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=n>Long</span><span class=w> </span><span class=nf>getExpire</span><span class=p>(</span><span class=n>String</span><span class=w> </span><span class=n>key</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>redisTemplate</span><span class=p>.</span><span class=na>getExpire</span><span class=p>(</span><span class=n>key</span><span class=p>,</span><span class=w> </span><span class=n>TimeUnit</span><span class=p>.</span><span class=na>SECONDS</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Override</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=n>Boolean</span><span class=w> </span><span class=nf>hasKey</span><span class=p>(</span><span class=n>String</span><span class=w> </span><span class=n>key</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>redisTemplate</span><span class=p>.</span><span class=na>hasKey</span><span class=p>(</span><span class=n>key</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Override</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=n>Long</span><span class=w> </span><span class=nf>incr</span><span class=p>(</span><span class=n>String</span><span class=w> </span><span class=n>key</span><span class=p>,</span><span class=w> </span><span class=kt>long</span><span class=w> </span><span class=n>delta</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>redisTemplate</span><span class=p>.</span><span class=na>opsForValue</span><span class=p>().</span><span class=na>increment</span><span class=p>(</span><span class=n>key</span><span class=p>,</span><span class=w> </span><span class=n>delta</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Override</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=n>Long</span><span class=w> </span><span class=nf>decr</span><span class=p>(</span><span class=n>String</span><span class=w> </span><span class=n>key</span><span class=p>,</span><span class=w> </span><span class=kt>long</span><span class=w> </span><span class=n>delta</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>redisTemplate</span><span class=p>.</span><span class=na>opsForValue</span><span class=p>().</span><span class=na>increment</span><span class=p>(</span><span class=n>key</span><span class=p>,</span><span class=w> </span><span class=o>-</span><span class=n>delta</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Override</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=n>Object</span><span class=w> </span><span class=nf>hGet</span><span class=p>(</span><span class=n>String</span><span class=w> </span><span class=n>key</span><span class=p>,</span><span class=w> </span><span class=n>String</span><span class=w> </span><span class=n>hashKey</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>redisTemplate</span><span class=p>.</span><span class=na>opsForHash</span><span class=p>().</span><span class=na>get</span><span class=p>(</span><span class=n>key</span><span class=p>,</span><span class=w> </span><span class=n>hashKey</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Override</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=n>Boolean</span><span class=w> </span><span class=nf>hSet</span><span class=p>(</span><span class=n>String</span><span class=w> </span><span class=n>key</span><span class=p>,</span><span class=w> </span><span class=n>String</span><span class=w> </span><span class=n>hashKey</span><span class=p>,</span><span class=w> </span><span class=n>Object</span><span class=w> </span><span class=n>value</span><span class=p>,</span><span class=w> </span><span class=kt>long</span><span class=w> </span><span class=n>time</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>redisTemplate</span><span class=p>.</span><span class=na>opsForHash</span><span class=p>().</span><span class=na>put</span><span class=p>(</span><span class=n>key</span><span class=p>,</span><span class=w> </span><span class=n>hashKey</span><span class=p>,</span><span class=w> </span><span class=n>value</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>expire</span><span class=p>(</span><span class=n>key</span><span class=p>,</span><span class=w> </span><span class=n>time</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Override</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>hSet</span><span class=p>(</span><span class=n>String</span><span class=w> </span><span class=n>key</span><span class=p>,</span><span class=w> </span><span class=n>String</span><span class=w> </span><span class=n>hashKey</span><span class=p>,</span><span class=w> </span><span class=n>Object</span><span class=w> </span><span class=n>value</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>redisTemplate</span><span class=p>.</span><span class=na>opsForHash</span><span class=p>().</span><span class=na>put</span><span class=p>(</span><span class=n>key</span><span class=p>,</span><span class=w> </span><span class=n>hashKey</span><span class=p>,</span><span class=w> </span><span class=n>value</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Override</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=n>Map</span><span class=o>&lt;</span><span class=n>Object</span><span class=p>,</span><span class=w> </span><span class=n>Object</span><span class=o>&gt;</span><span class=w> </span><span class=nf>hGetAll</span><span class=p>(</span><span class=n>String</span><span class=w> </span><span class=n>key</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>redisTemplate</span><span class=p>.</span><span class=na>opsForHash</span><span class=p>().</span><span class=na>entries</span><span class=p>(</span><span class=n>key</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Override</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=n>Boolean</span><span class=w> </span><span class=nf>hSetAll</span><span class=p>(</span><span class=n>String</span><span class=w> </span><span class=n>key</span><span class=p>,</span><span class=w> </span><span class=n>Map</span><span class=o>&lt;</span><span class=n>String</span><span class=p>,</span><span class=w> </span><span class=n>Object</span><span class=o>&gt;</span><span class=w> </span><span class=n>map</span><span class=p>,</span><span class=w> </span><span class=kt>long</span><span class=w> </span><span class=n>time</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>redisTemplate</span><span class=p>.</span><span class=na>opsForHash</span><span class=p>().</span><span class=na>putAll</span><span class=p>(</span><span class=n>key</span><span class=p>,</span><span class=w> </span><span class=n>map</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>expire</span><span class=p>(</span><span class=n>key</span><span class=p>,</span><span class=w> </span><span class=n>time</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Override</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>hSetAll</span><span class=p>(</span><span class=n>String</span><span class=w> </span><span class=n>key</span><span class=p>,</span><span class=w> </span><span class=n>Map</span><span class=o>&lt;</span><span class=n>String</span><span class=p>,</span><span class=w> </span><span class=o>?&gt;</span><span class=w> </span><span class=n>map</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>redisTemplate</span><span class=p>.</span><span class=na>opsForHash</span><span class=p>().</span><span class=na>putAll</span><span class=p>(</span><span class=n>key</span><span class=p>,</span><span class=w> </span><span class=n>map</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Override</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>hDel</span><span class=p>(</span><span class=n>String</span><span class=w> </span><span class=n>key</span><span class=p>,</span><span class=w> </span><span class=n>Object</span><span class=p>...</span><span class=w> </span><span class=n>hashKey</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>redisTemplate</span><span class=p>.</span><span class=na>opsForHash</span><span class=p>().</span><span class=na>delete</span><span class=p>(</span><span class=n>key</span><span class=p>,</span><span class=w> </span><span class=n>hashKey</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Override</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=n>Boolean</span><span class=w> </span><span class=nf>hHasKey</span><span class=p>(</span><span class=n>String</span><span class=w> </span><span class=n>key</span><span class=p>,</span><span class=w> </span><span class=n>String</span><span class=w> </span><span class=n>hashKey</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>redisTemplate</span><span class=p>.</span><span class=na>opsForHash</span><span class=p>().</span><span class=na>hasKey</span><span class=p>(</span><span class=n>key</span><span class=p>,</span><span class=w> </span><span class=n>hashKey</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Override</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=n>Long</span><span class=w> </span><span class=nf>hIncr</span><span class=p>(</span><span class=n>String</span><span class=w> </span><span class=n>key</span><span class=p>,</span><span class=w> </span><span class=n>String</span><span class=w> </span><span class=n>hashKey</span><span class=p>,</span><span class=w> </span><span class=n>Long</span><span class=w> </span><span class=n>delta</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>redisTemplate</span><span class=p>.</span><span class=na>opsForHash</span><span class=p>().</span><span class=na>increment</span><span class=p>(</span><span class=n>key</span><span class=p>,</span><span class=w> </span><span class=n>hashKey</span><span class=p>,</span><span class=w> </span><span class=n>delta</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Override</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=n>Long</span><span class=w> </span><span class=nf>hDecr</span><span class=p>(</span><span class=n>String</span><span class=w> </span><span class=n>key</span><span class=p>,</span><span class=w> </span><span class=n>String</span><span class=w> </span><span class=n>hashKey</span><span class=p>,</span><span class=w> </span><span class=n>Long</span><span class=w> </span><span class=n>delta</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>redisTemplate</span><span class=p>.</span><span class=na>opsForHash</span><span class=p>().</span><span class=na>increment</span><span class=p>(</span><span class=n>key</span><span class=p>,</span><span class=w> </span><span class=n>hashKey</span><span class=p>,</span><span class=w> </span><span class=o>-</span><span class=n>delta</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Override</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=n>Set</span><span class=o>&lt;</span><span class=n>Object</span><span class=o>&gt;</span><span class=w> </span><span class=nf>sMembers</span><span class=p>(</span><span class=n>String</span><span class=w> </span><span class=n>key</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>redisTemplate</span><span class=p>.</span><span class=na>opsForSet</span><span class=p>().</span><span class=na>members</span><span class=p>(</span><span class=n>key</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Override</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=n>Long</span><span class=w> </span><span class=nf>sAdd</span><span class=p>(</span><span class=n>String</span><span class=w> </span><span class=n>key</span><span class=p>,</span><span class=w> </span><span class=n>Object</span><span class=p>...</span><span class=w> </span><span class=n>values</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>redisTemplate</span><span class=p>.</span><span class=na>opsForSet</span><span class=p>().</span><span class=na>add</span><span class=p>(</span><span class=n>key</span><span class=p>,</span><span class=w> </span><span class=n>values</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Override</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=n>Long</span><span class=w> </span><span class=nf>sAdd</span><span class=p>(</span><span class=n>String</span><span class=w> </span><span class=n>key</span><span class=p>,</span><span class=w> </span><span class=kt>long</span><span class=w> </span><span class=n>time</span><span class=p>,</span><span class=w> </span><span class=n>Object</span><span class=p>...</span><span class=w> </span><span class=n>values</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>Long</span><span class=w> </span><span class=n>count</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>redisTemplate</span><span class=p>.</span><span class=na>opsForSet</span><span class=p>().</span><span class=na>add</span><span class=p>(</span><span class=n>key</span><span class=p>,</span><span class=w> </span><span class=n>values</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>expire</span><span class=p>(</span><span class=n>key</span><span class=p>,</span><span class=w> </span><span class=n>time</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>count</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Override</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=n>Boolean</span><span class=w> </span><span class=nf>sIsMember</span><span class=p>(</span><span class=n>String</span><span class=w> </span><span class=n>key</span><span class=p>,</span><span class=w> </span><span class=n>Object</span><span class=w> </span><span class=n>value</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>redisTemplate</span><span class=p>.</span><span class=na>opsForSet</span><span class=p>().</span><span class=na>isMember</span><span class=p>(</span><span class=n>key</span><span class=p>,</span><span class=w> </span><span class=n>value</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Override</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=n>Long</span><span class=w> </span><span class=nf>sSize</span><span class=p>(</span><span class=n>String</span><span class=w> </span><span class=n>key</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>redisTemplate</span><span class=p>.</span><span class=na>opsForSet</span><span class=p>().</span><span class=na>size</span><span class=p>(</span><span class=n>key</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Override</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=n>Long</span><span class=w> </span><span class=nf>sRemove</span><span class=p>(</span><span class=n>String</span><span class=w> </span><span class=n>key</span><span class=p>,</span><span class=w> </span><span class=n>Object</span><span class=p>...</span><span class=w> </span><span class=n>values</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>redisTemplate</span><span class=p>.</span><span class=na>opsForSet</span><span class=p>().</span><span class=na>remove</span><span class=p>(</span><span class=n>key</span><span class=p>,</span><span class=w> </span><span class=n>values</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Override</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=n>List</span><span class=o>&lt;</span><span class=n>Object</span><span class=o>&gt;</span><span class=w> </span><span class=nf>lRange</span><span class=p>(</span><span class=n>String</span><span class=w> </span><span class=n>key</span><span class=p>,</span><span class=w> </span><span class=kt>long</span><span class=w> </span><span class=n>start</span><span class=p>,</span><span class=w> </span><span class=kt>long</span><span class=w> </span><span class=n>end</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>redisTemplate</span><span class=p>.</span><span class=na>opsForList</span><span class=p>().</span><span class=na>range</span><span class=p>(</span><span class=n>key</span><span class=p>,</span><span class=w> </span><span class=n>start</span><span class=p>,</span><span class=w> </span><span class=n>end</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Override</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=n>Long</span><span class=w> </span><span class=nf>lSize</span><span class=p>(</span><span class=n>String</span><span class=w> </span><span class=n>key</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>redisTemplate</span><span class=p>.</span><span class=na>opsForList</span><span class=p>().</span><span class=na>size</span><span class=p>(</span><span class=n>key</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Override</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=n>Object</span><span class=w> </span><span class=nf>lIndex</span><span class=p>(</span><span class=n>String</span><span class=w> </span><span class=n>key</span><span class=p>,</span><span class=w> </span><span class=kt>long</span><span class=w> </span><span class=n>index</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>redisTemplate</span><span class=p>.</span><span class=na>opsForList</span><span class=p>().</span><span class=na>index</span><span class=p>(</span><span class=n>key</span><span class=p>,</span><span class=w> </span><span class=n>index</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Override</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=n>Long</span><span class=w> </span><span class=nf>lPush</span><span class=p>(</span><span class=n>String</span><span class=w> </span><span class=n>key</span><span class=p>,</span><span class=w> </span><span class=n>Object</span><span class=w> </span><span class=n>value</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>redisTemplate</span><span class=p>.</span><span class=na>opsForList</span><span class=p>().</span><span class=na>rightPush</span><span class=p>(</span><span class=n>key</span><span class=p>,</span><span class=w> </span><span class=n>value</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Override</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=n>Long</span><span class=w> </span><span class=nf>lPush</span><span class=p>(</span><span class=n>String</span><span class=w> </span><span class=n>key</span><span class=p>,</span><span class=w> </span><span class=n>Object</span><span class=w> </span><span class=n>value</span><span class=p>,</span><span class=w> </span><span class=kt>long</span><span class=w> </span><span class=n>time</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>Long</span><span class=w> </span><span class=n>index</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>redisTemplate</span><span class=p>.</span><span class=na>opsForList</span><span class=p>().</span><span class=na>rightPush</span><span class=p>(</span><span class=n>key</span><span class=p>,</span><span class=w> </span><span class=n>value</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>expire</span><span class=p>(</span><span class=n>key</span><span class=p>,</span><span class=w> </span><span class=n>time</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>index</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Override</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=n>Long</span><span class=w> </span><span class=nf>lPushAll</span><span class=p>(</span><span class=n>String</span><span class=w> </span><span class=n>key</span><span class=p>,</span><span class=w> </span><span class=n>Object</span><span class=p>...</span><span class=w> </span><span class=n>values</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>redisTemplate</span><span class=p>.</span><span class=na>opsForList</span><span class=p>().</span><span class=na>rightPushAll</span><span class=p>(</span><span class=n>key</span><span class=p>,</span><span class=w> </span><span class=n>values</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Override</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=n>Long</span><span class=w> </span><span class=nf>lPushAll</span><span class=p>(</span><span class=n>String</span><span class=w> </span><span class=n>key</span><span class=p>,</span><span class=w> </span><span class=n>Long</span><span class=w> </span><span class=n>time</span><span class=p>,</span><span class=w> </span><span class=n>Object</span><span class=p>...</span><span class=w> </span><span class=n>values</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>Long</span><span class=w> </span><span class=n>count</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>redisTemplate</span><span class=p>.</span><span class=na>opsForList</span><span class=p>().</span><span class=na>rightPushAll</span><span class=p>(</span><span class=n>key</span><span class=p>,</span><span class=w> </span><span class=n>values</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>expire</span><span class=p>(</span><span class=n>key</span><span class=p>,</span><span class=w> </span><span class=n>time</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>count</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Override</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=n>Long</span><span class=w> </span><span class=nf>lRemove</span><span class=p>(</span><span class=n>String</span><span class=w> </span><span class=n>key</span><span class=p>,</span><span class=w> </span><span class=kt>long</span><span class=w> </span><span class=n>count</span><span class=p>,</span><span class=w> </span><span class=n>Object</span><span class=w> </span><span class=n>value</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>redisTemplate</span><span class=p>.</span><span class=na>opsForList</span><span class=p>().</span><span class=na>remove</span><span class=p>(</span><span class=n>key</span><span class=p>,</span><span class=w> </span><span class=n>count</span><span class=p>,</span><span class=w> </span><span class=n>value</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Override</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=n>Object</span><span class=w> </span><span class=nf>lPop</span><span class=p>(</span><span class=n>String</span><span class=w> </span><span class=n>key</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>redisTemplate</span><span class=p>.</span><span class=na>opsForList</span><span class=p>().</span><span class=na>leftPop</span><span class=p>(</span><span class=n>key</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span></span></span></code></pre></td></tr></table></div></div><h2 id=系统管理模块>系统管理模块</h2><p>系统管理模块在系统中扮演着关键的角色，其任务是实现用户注册、登录以及敏感资源的权限控制。这一模块的核心目标是确保只有经过授权的用户才能访问敏感资源，以维护系统的安全性和数据保密性。</p><p>在认证方面，系统采用JWT（JSON Web Token）作为用户令牌的生成和验证机制，并提供相关功能，如令牌刷新和令牌撤销。为了增强令牌的安全性，系统前后端约定了一个常量值，作为令牌的前缀，以降低令牌被盗用的潜在风险。此外，为保护传输中的密码数据的机密性和完整性，前端首先对密码进行一次SM2加密，然后在后端再进行二次加密后才存储到数据库中。</p><p><a class=lightgallery href=https://publicpictures.oss-cn-hangzhou.aliyuncs.com/img/image-20230915104006621.png data-thumbnail=https://publicpictures.oss-cn-hangzhou.aliyuncs.com/img/image-20230915104006621.png data-sub-html="<h2>image-20230915104006621</h2>"><img loading=lazy src=https://publicpictures.oss-cn-hangzhou.aliyuncs.com/img/image-20230915104006621.png srcset="https://publicpictures.oss-cn-hangzhou.aliyuncs.com/img/image-20230915104006621.png, https://publicpictures.oss-cn-hangzhou.aliyuncs.com/img/image-20230915104006621.png 1.5x, https://publicpictures.oss-cn-hangzhou.aliyuncs.com/img/image-20230915104006621.png 2x" sizes=auto data-title=image-20230915104006621 data-alt=image-20230915104006621 style="background:url(/svg/loading.min.svg)no-repeat 50%" onload='this.title=this.dataset.title,this.alt=this.dataset.alt;for(const e of["style","data-title","data-alt","onerror","onload"])this.removeAttribute(e);this.dataset.lazyloaded=""' onerror='this.title=this.dataset.title,this.alt=this.dataset.alt;for(const e of["style","data-title","data-alt","onerror","onload"])this.removeAttribute(e)'></a></p><p>在授权方面，系统设计了数据库模型来管理用户、角色、权限和资源之间的多对多关系。系统定义了三种角色：系统管理员、普通用户和企业用户。为了动态地管理用户对资源的访问权限，系统实现了AccessDecisionManager接口，该接口用于决定属于某个角色的用户是否被允许访问特定的资源。</p><p>在网络攻击处理方面，系统引入了Spring Security框架，以应对常见的作弊和Web攻击。系统采取了一系列措施，包括输入验证、输出编码、防止SQL注入和CSRF攻击等，以提高系统的安全性，并有效应对潜在的攻击威胁。</p><h3 id=核心代码>核心代码</h3><div class=highlight id=id-3><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=c1>// 权限控制</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * 动态权限决策管理器，用于判断用户是否有访问权限、
</span></span></span><span class=line><span class=cl><span class=cm> */</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kd>class</span> <span class=nc>DynamicAccessDecisionManager</span><span class=w> </span><span class=kd>implements</span><span class=w> </span><span class=n>AccessDecisionManager</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Override</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>decide</span><span class=p>(</span><span class=n>Authentication</span><span class=w> </span><span class=n>authentication</span><span class=p>,</span><span class=w> </span><span class=n>Object</span><span class=w> </span><span class=n>object</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                       </span><span class=n>Collection</span><span class=o>&lt;</span><span class=n>ConfigAttribute</span><span class=o>&gt;</span><span class=w> </span><span class=n>configAttributes</span><span class=p>)</span><span class=w> </span><span class=kd>throws</span><span class=w> </span><span class=n>AccessDeniedException</span><span class=p>,</span><span class=w> </span><span class=n>InsufficientAuthenticationException</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// 当接口未被配置资源时直接放行</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>CollUtil</span><span class=p>.</span><span class=na>isEmpty</span><span class=p>(</span><span class=n>configAttributes</span><span class=p>))</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>return</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>for</span><span class=w> </span><span class=p>(</span><span class=n>ConfigAttribute</span><span class=w> </span><span class=n>configAttribute</span><span class=w> </span><span class=p>:</span><span class=w> </span><span class=n>configAttributes</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>//将访问所需资源或用户拥有资源进行比对</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>String</span><span class=w> </span><span class=n>needAuthority</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>configAttribute</span><span class=p>.</span><span class=na>getAttribute</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>for</span><span class=w> </span><span class=p>(</span><span class=n>GrantedAuthority</span><span class=w> </span><span class=n>grantedAuthority</span><span class=w> </span><span class=p>:</span><span class=w> </span><span class=n>authentication</span><span class=p>.</span><span class=na>getAuthorities</span><span class=p>())</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>needAuthority</span><span class=p>.</span><span class=na>trim</span><span class=p>().</span><span class=na>equals</span><span class=p>(</span><span class=n>grantedAuthority</span><span class=p>.</span><span class=na>getAuthority</span><span class=p>()))</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=k>return</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>throw</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>AccessDeniedException</span><span class=p>(</span><span class=s>&#34;抱歉，您没有访问权限&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Override</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kt>boolean</span><span class=w> </span><span class=nf>supports</span><span class=p>(</span><span class=n>ConfigAttribute</span><span class=w> </span><span class=n>configAttribute</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=kc>true</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Override</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kt>boolean</span><span class=w> </span><span class=nf>supports</span><span class=p>(</span><span class=n>Class</span><span class=o>&lt;?&gt;</span><span class=w> </span><span class=n>aClass</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=kc>true</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span></span></span></code></pre></td></tr></table></div></div><h2 id=红包活动模块>红包活动模块</h2><h3 id=抢红包核心思路>抢红包核心思路</h3><p>该模块包括了创建红包活动、查询红包活动、用户报名抢红包、提交抢红包分数、查看红包领取情况、查看红包排行榜等功能，是红包雨系统的核心，用于管理和控制红包活动的整个生命周期。核心接口如下：</p><h4 id=1-创建红包活动>（1） 创建红包活动</h4><p>企业设定活动名称、描述、红包金额、数量、抢红包时间等参数，发布红包活动。</p><p>在发布红包之后，会立刻出发一个拆红包算法。项目采用了改进的二倍均值算法来实现红包的分发，这个算法在初始化阶段确保了每个红包的金额在剩余红包平均值的50% - 150%之间浮动，这样既保持了一定的随机性，又控制了红包金额的合理范围，避免了出现过大或过小的情况。这是一种有效的策略，使得红包的分发更具趣味性和公平性。</p><p>项目计划探索一种高级红包分发策略，即利用抢红包活动的历史数据来训练聚类模型，以提升分发过程的智能化。该模型的主要目标是基于用户过去抢红包的元宝数、红包数、炸弹数等历史数据模式，来生成下一次红包的拆分比重数组，而不仅仅依赖随机性。这一方法将随机性与数据驱动的理念相结合，旨在使用户抢得的红包金额比重更加接近他们在实际抢红包活动中的表现情况。这个策略在提高用户体验和红包分发公平性方面具有潜在的价值。</p><h4 id=2-查询红包活动>（2） 查询红包活动</h4><p>本接口支持前端页面根据活动状态、用户所属组织、活动名称和描述条件分页查询红包活动。在企业页面中，企业可以查询自己发起的红包活动；在用户页面中，用户可以查询自己参与的红包活动。当活动报名人数已满时，或活动报名时间截止时，会对活动的状态属性进行更改。点击某一红包活动时，可以进入详细查询该红包，并在相应页面进行报名和进入聊天等候室。</p><h4 id=3-报名抢红包>（3） 报名抢红包</h4><p>用户在报名抢红包时，后台会启动定时任务，在活动开始时向前端发送开抢指令，在活动开始前发送短信和邮件通知，提醒用户即将开始抢红包。</p><h4 id=4-提交抢红包分数>（4） 提交抢红包分数</h4><p>对于用户提交抢红包分数这一接口，我们采用了一种高效且用户友好的设计。前端设定了每1-3秒提交一次当前抢红包的总得分，并在抢红包结束时再次提交当前的总得分。这一流程的核心是在后端Redis缓存中维护一个hash结构，用于实时更新用户的总得分。这种设计带来了多重好处。首先，它允许我们保存用户在抢红包过程中的得分情况，确保即使在最终提交分数之前，用户的得分已经得到记录。这有助于防止用户因为最终提交分数失败而导致没有获得任何金额的情况。其次，这一设计有助于分散后端接口请求的压力。通过将得分提交分散在一段时间内，而不是等到抢红包结束时才提交，我们可以有效地降低了并发请求的高峰，从而提高了系统的稳定性和性能。综合而言，这一方案不仅提高了用户体验，还优化了系统的性能和稳定性。它充分利用了Redis的实时性和高性能特点，为红包雨项目的顺畅运行提供了有力支持。</p><h4 id=5-查看抢得红包金额>（5） 查看抢得红包金额</h4><p>由于分配红包需要根据用户在红包雨游戏中的得分来进行对应分配，所以本接口通过异步任务的方式，等待后台结算红包完成，分布式锁释放后，从Redis中获取当前用户在指定红包中抢到的金额。</p><h4 id=6-查看抢红包排行榜>（6） 查看抢红包排行榜</h4><p>用户在抢完红包后会跳转排行榜，在此界面可以查看当前红包雨的抢红包情况，并且可以在下方进行留言互动。</p><h4 id=拆红包算法>拆红包算法</h4><p>假设 M 为剩余红包金额，N 为剩余人数，求出剩余平均金额为 avg = M/N，每位用户抢到的金额在 avg 的上下 50% 随机浮动。为保证高并发、无锁化、原子性，使用 Redis 实现。</p><div class=highlight id=id-4><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=w>    </span><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>     * 拆红包的算法：在剩余红包平均值的 50% - 150% 浮动
</span></span></span><span class=line><span class=cl><span class=cm>     *
</span></span></span><span class=line><span class=cl><span class=cm>     * @param totalMoney        总金额
</span></span></span><span class=line><span class=cl><span class=cm>     * @param redEnvelopeNumber 红包数
</span></span></span><span class=line><span class=cl><span class=cm>     * @return 红包分配情况，从大到小排列
</span></span></span><span class=line><span class=cl><span class=cm>     */</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>protected</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=n>BigDecimal</span><span class=o>[]</span><span class=w> </span><span class=nf>splitRedEnvelopeAlgorithm</span><span class=p>(</span><span class=n>BigDecimal</span><span class=w> </span><span class=n>totalMoney</span><span class=p>,</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>redEnvelopeNumber</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>BigDecimal</span><span class=o>[]</span><span class=w> </span><span class=n>res</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>BigDecimal</span><span class=o>[</span><span class=n>redEnvelopeNumber</span><span class=o>]</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>BigDecimal</span><span class=w> </span><span class=n>useMoney</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>BigDecimal</span><span class=p>.</span><span class=na>ZERO</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>for</span><span class=w> </span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>0</span><span class=p>;</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=n>redEnvelopeNumber</span><span class=p>;</span><span class=w> </span><span class=n>i</span><span class=o>++</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>i</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=n>redEnvelopeNumber</span><span class=w> </span><span class=o>-</span><span class=w> </span><span class=n>1</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>res</span><span class=o>[</span><span class=n>i</span><span class=o>]</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>totalMoney</span><span class=p>.</span><span class=na>subtract</span><span class=p>(</span><span class=n>useMoney</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w> </span><span class=k>else</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>BigDecimal</span><span class=w> </span><span class=n>avgMoney</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>totalMoney</span><span class=p>.</span><span class=na>subtract</span><span class=p>(</span><span class=n>useMoney</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=p>.</span><span class=na>divide</span><span class=p>(</span><span class=n>BigDecimal</span><span class=p>.</span><span class=na>valueOf</span><span class=p>(</span><span class=n>redEnvelopeNumber</span><span class=w> </span><span class=o>-</span><span class=w> </span><span class=n>i</span><span class=p>),</span><span class=w> </span><span class=n>2</span><span class=p>,</span><span class=w> </span><span class=n>RoundingMode</span><span class=p>.</span><span class=na>HALF_UP</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=p>.</span><span class=na>divide</span><span class=p>(</span><span class=n>BigDecimal</span><span class=p>.</span><span class=na>valueOf</span><span class=p>(</span><span class=n>2</span><span class=p>),</span><span class=w> </span><span class=n>2</span><span class=p>,</span><span class=w> </span><span class=n>RoundingMode</span><span class=p>.</span><span class=na>HALF_UP</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=c1>// 在剩余红包平均值的 50% - 150% 浮动</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>res</span><span class=o>[</span><span class=n>i</span><span class=o>]</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>RandomUtil</span><span class=p>.</span><span class=na>randomBigDecimal</span><span class=p>(</span><span class=n>avgMoney</span><span class=p>,</span><span class=w> </span><span class=n>avgMoney</span><span class=p>.</span><span class=na>multiply</span><span class=p>(</span><span class=n>BigDecimal</span><span class=p>.</span><span class=na>valueOf</span><span class=p>(</span><span class=n>3</span><span class=p>)))</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=p>.</span><span class=na>setScale</span><span class=p>(</span><span class=n>2</span><span class=p>,</span><span class=w> </span><span class=n>RoundingMode</span><span class=p>.</span><span class=na>HALF_UP</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>useMoney</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>useMoney</span><span class=p>.</span><span class=na>add</span><span class=p>(</span><span class=n>res</span><span class=o>[</span><span class=n>i</span><span class=o>]</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>res</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span></span></span></code></pre></td></tr></table></div></div><h2 id=即时互动模块聊天室>即时互动模块（聊天室）</h2><p>即时互动模块是项目中的一个关键组成部分。HTTP协议是半双工的协议，同一时刻，只能有一个方向的数据传输，并且消息体冗长，不适用于即时通信系统。WebSocket提供了一种浏览器与服务器间进行全双工通信的网络技术，浏览器与服务器之间只需要做一个握手动作，之后就形成了一条快速通道，两者可以互相传输数据。WebSocket是基于TCP全双工进行消息传递，相比于HTTP半双工，性能得到很大的提升。系统基于Netty实现了WebSocket连接，用于用户之间的实时互动，包括聊天、点赞和送礼功能。该模块使得用户能够在红包活动页面下进行多种互动操作，从而提升用户参与度和用户体验。</p><p>在技术选型时，我们选择Netty，因为Netty 中有一个EventLoop 的概念，用于处理 Channel 上的事件和任务，负责监听网络事件并调用事件处理器进行相关I/O操作。每个 Channel 都会绑定一个 EventLoop，一个 EventLoop 可以处理多个 Channel 上的事件和任务。</p><p><a class=lightgallery href=https://publicpictures.oss-cn-hangzhou.aliyuncs.com/img/wps2.jpg data-thumbnail=https://publicpictures.oss-cn-hangzhou.aliyuncs.com/img/wps2.jpg data-sub-html="<h2>img</h2>"><img loading=lazy src=https://publicpictures.oss-cn-hangzhou.aliyuncs.com/img/wps2.jpg srcset="https://publicpictures.oss-cn-hangzhou.aliyuncs.com/img/wps2.jpg, https://publicpictures.oss-cn-hangzhou.aliyuncs.com/img/wps2.jpg 1.5x, https://publicpictures.oss-cn-hangzhou.aliyuncs.com/img/wps2.jpg 2x" sizes=auto data-title=img data-alt=img style="background:url(/svg/loading.min.svg)no-repeat 50%" onload='this.title=this.dataset.title,this.alt=this.dataset.alt;for(const e of["style","data-title","data-alt","onerror","onload"])this.removeAttribute(e);this.dataset.lazyloaded=""' onerror='this.title=this.dataset.title,this.alt=this.dataset.alt;for(const e of["style","data-title","data-alt","onerror","onload"])this.removeAttribute(e)'></a></p><p>在技术实现上，首先通过WebSocketServerProtocolHandler将HTTP协议升级为WebSocket协议，以支持WebSocket通信。</p><p>pipeline结构是一个带有head与tail指针的双向链表，其中的节点为handler，要通过ctx.fireChannelRead(msg)等方法，将当前handler的处理结果传递给下一个handler，当有入站（Inbound）操作时，会从head开始向后调用handler，直到handler不是处理Inbound操作为止，当有出站（Outbound）操作时，会从tail开始向前调用handler，直到handler不是处理Outbound操作为止。它的数据结构和调用顺序如下图所示：</p><p><a class=lightgallery href=https://publicpictures.oss-cn-hangzhou.aliyuncs.com/img/wps3.jpg data-thumbnail=https://publicpictures.oss-cn-hangzhou.aliyuncs.com/img/wps3.jpg data-sub-html="<h2>pipeline 数据结构</h2>"><img loading=lazy src=https://publicpictures.oss-cn-hangzhou.aliyuncs.com/img/wps3.jpg srcset="https://publicpictures.oss-cn-hangzhou.aliyuncs.com/img/wps3.jpg, https://publicpictures.oss-cn-hangzhou.aliyuncs.com/img/wps3.jpg 1.5x, https://publicpictures.oss-cn-hangzhou.aliyuncs.com/img/wps3.jpg 2x" sizes=auto data-title="pipeline 数据结构" data-alt="pipeline 数据结构" style="background:url(/svg/loading.min.svg)no-repeat 50%" onload='this.title=this.dataset.title,this.alt=this.dataset.alt;for(const e of["style","data-title","data-alt","onerror","onload"])this.removeAttribute(e);this.dataset.lazyloaded=""' onerror='this.title=this.dataset.title,this.alt=this.dataset.alt;for(const e of["style","data-title","data-alt","onerror","onload"])this.removeAttribute(e)'></a></p><p><a class=lightgallery href=https://publicpictures.oss-cn-hangzhou.aliyuncs.com/img/wps4.jpg data-thumbnail=https://publicpictures.oss-cn-hangzhou.aliyuncs.com/img/wps4.jpg data-sub-html="<h2>img</h2>"><img loading=lazy src=https://publicpictures.oss-cn-hangzhou.aliyuncs.com/img/wps4.jpg srcset="https://publicpictures.oss-cn-hangzhou.aliyuncs.com/img/wps4.jpg, https://publicpictures.oss-cn-hangzhou.aliyuncs.com/img/wps4.jpg 1.5x, https://publicpictures.oss-cn-hangzhou.aliyuncs.com/img/wps4.jpg 2x" sizes=auto data-title=img data-alt=img style="background:url(/svg/loading.min.svg)no-repeat 50%" onload='this.title=this.dataset.title,this.alt=this.dataset.alt;for(const e of["style","data-title","data-alt","onerror","onload"])this.removeAttribute(e);this.dataset.lazyloaded=""' onerror='this.title=this.dataset.title,this.alt=this.dataset.alt;for(const e of["style","data-title","data-alt","onerror","onload"])this.removeAttribute(e)'></a></p><p>我们在 pipeline 中自定义了一个WebSocketHandler处理类，用于处理WebSocket连接和消息的收发。此外，还通过二次编解码器，处理粘包与拆包。主要功能包括：</p><h3 id=维护用户通道>维护用户通道</h3><p>WebSocketHandler维护一个用户通道管理集合，每个连接的用户都有一个唯一的通道ID，这些通道ID，与红包ID相关联，与用户通道对象进行映射。当用户连接或断开连接时，会触发相应的事件。这有助于维护通道的活跃性和清除无效的通道。通过这种方式，服务器可以轻松地将消息发送给参与特定红包活动的所有用户，实现了基于红包ID的用户通道管理。此外，异常处理的回调方法确保在通信过程中出现异常时，通道能够被正确地关闭和管理，同时记录异常信息以便进行适当的故障诊断和处理。这对于保持系统的稳定性和可靠性至关重要。核心代码如下：</p><div class=highlight id=id-5><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=w>		</span><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>     * 用户通道管理
</span></span></span><span class=line><span class=cl><span class=cm>     * key：通道 id
</span></span></span><span class=line><span class=cl><span class=cm>     * value：通道对象
</span></span></span><span class=line><span class=cl><span class=cm>     */</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=n>ConcurrentHashMap</span><span class=o>&lt;</span><span class=n>String</span><span class=p>,</span><span class=w> </span><span class=n>Channel</span><span class=o>&gt;</span><span class=w> </span><span class=n>channelMap</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>ConcurrentHashMap</span><span class=o>&lt;&gt;</span><span class=p>(</span><span class=n>16</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>     * 红包频道管理
</span></span></span><span class=line><span class=cl><span class=cm>     * key: 红包 id
</span></span></span><span class=line><span class=cl><span class=cm>     * value： 通道 id 的 set
</span></span></span><span class=line><span class=cl><span class=cm>     */</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=n>ConcurrentHashMap</span><span class=o>&lt;</span><span class=n>Long</span><span class=p>,</span><span class=w> </span><span class=n>ConcurrentHashSet</span><span class=o>&lt;</span><span class=n>String</span><span class=o>&gt;&gt;</span><span class=w> </span><span class=n>redChannels</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>ConcurrentHashMap</span><span class=o>&lt;&gt;</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>     * 通道就绪事件
</span></span></span><span class=line><span class=cl><span class=cm>     */</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Override</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>channelActive</span><span class=p>(</span><span class=n>ChannelHandlerContext</span><span class=w> </span><span class=n>ctx</span><span class=p>)</span><span class=w> </span><span class=kd>throws</span><span class=w> </span><span class=n>Exception</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>Channel</span><span class=w> </span><span class=n>channel</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>ctx</span><span class=p>.</span><span class=na>channel</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// 放入通道组</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>channelMap</span><span class=p>.</span><span class=na>put</span><span class=p>(</span><span class=n>channel</span><span class=p>.</span><span class=na>id</span><span class=p>().</span><span class=na>asLongText</span><span class=p>(),</span><span class=w> </span><span class=n>channel</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>channel</span><span class=p>.</span><span class=na>writeAndFlush</span><span class=p>(</span><span class=k>new</span><span class=w> </span><span class=n>TextWebSocketFrame</span><span class=p>(</span><span class=n>channel</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=s>&#34;上线了&#34;</span><span class=p>));</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>log</span><span class=p>.</span><span class=na>info</span><span class=p>(</span><span class=s>&#34;[&#34;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>channelMap</span><span class=p>.</span><span class=na>size</span><span class=p>()</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=s>&#34;]有新的连接:&#34;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>channel</span><span class=p>.</span><span class=na>remoteAddress</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>     * 通道未就绪事件
</span></span></span><span class=line><span class=cl><span class=cm>     */</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Override</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>channelInactive</span><span class=p>(</span><span class=n>ChannelHandlerContext</span><span class=w> </span><span class=n>ctx</span><span class=p>)</span><span class=w> </span><span class=kd>throws</span><span class=w> </span><span class=n>Exception</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>Channel</span><span class=w> </span><span class=n>channel</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>ctx</span><span class=p>.</span><span class=na>channel</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>log</span><span class=p>.</span><span class=na>info</span><span class=p>(</span><span class=s>&#34;通道：&#34;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>channel</span><span class=p>.</span><span class=na>remoteAddress</span><span class=p>()</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=s>&#34;已下线&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// 当有客户端断开连接的时候,就移除对应的通道</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>channelMap</span><span class=p>.</span><span class=na>remove</span><span class=p>(</span><span class=n>channel</span><span class=p>.</span><span class=na>id</span><span class=p>().</span><span class=na>asLongText</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>ctx</span><span class=p>.</span><span class=na>close</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>     * 异常处理事件
</span></span></span><span class=line><span class=cl><span class=cm>     *
</span></span></span><span class=line><span class=cl><span class=cm>     * @param ctx   ctx
</span></span></span><span class=line><span class=cl><span class=cm>     * @param cause 导致
</span></span></span><span class=line><span class=cl><span class=cm>     * @throws Exception 异常
</span></span></span><span class=line><span class=cl><span class=cm>     */</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Override</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>exceptionCaught</span><span class=p>(</span><span class=n>ChannelHandlerContext</span><span class=w> </span><span class=n>ctx</span><span class=p>,</span><span class=w> </span><span class=n>Throwable</span><span class=w> </span><span class=n>cause</span><span class=p>)</span><span class=w> </span><span class=kd>throws</span><span class=w> </span><span class=n>Exception</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>Channel</span><span class=w> </span><span class=n>channel</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>ctx</span><span class=p>.</span><span class=na>channel</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>//移除集合</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>channelMap</span><span class=p>.</span><span class=na>remove</span><span class=p>(</span><span class=n>channel</span><span class=p>.</span><span class=na>id</span><span class=p>().</span><span class=na>asLongText</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>ctx</span><span class=p>.</span><span class=na>close</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>log</span><span class=p>.</span><span class=na>error</span><span class=p>(</span><span class=s>&#34;异常信息：{}&#34;</span><span class=p>,</span><span class=w> </span><span class=n>cause</span><span class=p>.</span><span class=na>getMessage</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span></span></span></code></pre></td></tr></table></div></div><h3 id=消息处理>消息处理</h3><p>WebSocketHandler支持不同类型的消息发送，包括欢迎消息、指令消息（点赞和送礼）和聊天消息。根据不同的消息类型，服务器可以向用户发送个性化的消息内容。</p><div class=highlight id=id-6><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=c1>// 消息处理</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>     * 发送消息
</span></span></span><span class=line><span class=cl><span class=cm>     *
</span></span></span><span class=line><span class=cl><span class=cm>     * @param redId           红包 id
</span></span></span><span class=line><span class=cl><span class=cm>     * @param responseMessage 消息内容
</span></span></span><span class=line><span class=cl><span class=cm>     */</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>sendMessage</span><span class=p>(</span><span class=n>Long</span><span class=w> </span><span class=n>redId</span><span class=p>,</span><span class=w> </span><span class=n>String</span><span class=w> </span><span class=n>responseMessage</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>for</span><span class=w> </span><span class=p>(</span><span class=n>String</span><span class=w> </span><span class=n>channel</span><span class=w> </span><span class=p>:</span><span class=w> </span><span class=n>redChannels</span><span class=p>.</span><span class=na>getOrDefault</span><span class=p>(</span><span class=n>redId</span><span class=p>,</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>ConcurrentHashSet</span><span class=o>&lt;&gt;</span><span class=p>()))</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>Channel</span><span class=w> </span><span class=n>c</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>channelMap</span><span class=p>.</span><span class=na>get</span><span class=p>(</span><span class=n>channel</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>c</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=w> </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=n>c</span><span class=p>.</span><span class=na>isActive</span><span class=p>()</span><span class=w> </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=n>c</span><span class=p>.</span><span class=na>isWritable</span><span class=p>())</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>c</span><span class=p>.</span><span class=na>writeAndFlush</span><span class=p>(</span><span class=k>new</span><span class=w> </span><span class=n>TextWebSocketFrame</span><span class=p>(</span><span class=n>responseMessage</span><span class=p>));</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>log</span><span class=p>.</span><span class=na>info</span><span class=p>(</span><span class=s>&#34;发送消息：&#34;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>responseMessage</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span></span></span></code></pre></td></tr></table></div></div><h3 id=小坑>小坑</h3><div class=highlight id=id-7><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=w>    </span><span class=nd>@Value</span><span class=p>(</span><span class=s>&#34;${netty.port}&#34;</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>port</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@PostConstruct</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>init</span><span class=p>(){</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>new</span><span class=w> </span><span class=n>NettyServer</span><span class=p>(</span><span class=n>port</span><span class=p>).</span><span class=na>start</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>log</span><span class=p>.</span><span class=na>info</span><span class=p>(</span><span class=s>&#34;netty start...&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=k>catch</span><span class=w> </span><span class=p>(</span><span class=n>Exception</span><span class=w> </span><span class=n>e</span><span class=p>){</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>           </span><span class=n>log</span><span class=p>.</span><span class=na>error</span><span class=p>(</span><span class=n>e</span><span class=p>.</span><span class=na>getMessage</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span></span></span></code></pre></td></tr></table></div></div><p>报错：<code>Parameter 0 of constructor in com.project.modules.netty.NettyServer required a bean of type 'int' that could not be found.</code></p><p>原因：变量加了 static，在实例化之后才被执行；同理，加 final 不能再更改，也会出问题。</p><p>解决方案：删除 static。</p><h3 id=最终实现>最终实现</h3><p>server 类，启动 websocket 服务</p><div class=highlight id=id-8><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span><span class=lnt>57
</span><span class=lnt>58
</span><span class=lnt>59
</span><span class=lnt>60
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kn>package</span><span class=w> </span><span class=nn>com.project.modules.netty</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kn>import</span><span class=w> </span><span class=nn>io.netty.bootstrap.ServerBootstrap</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kn>import</span><span class=w> </span><span class=nn>io.netty.channel.ChannelFuture</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kn>import</span><span class=w> </span><span class=nn>io.netty.channel.EventLoopGroup</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kn>import</span><span class=w> </span><span class=nn>io.netty.channel.nio.NioEventLoopGroup</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kn>import</span><span class=w> </span><span class=nn>io.netty.channel.socket.nio.NioServerSocketChannel</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kn>import</span><span class=w> </span><span class=nn>io.netty.handler.logging.LogLevel</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kn>import</span><span class=w> </span><span class=nn>io.netty.handler.logging.LoggingHandler</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kn>import</span><span class=w> </span><span class=nn>lombok.extern.slf4j.Slf4j</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kn>import</span><span class=w> </span><span class=nn>org.springframework.beans.factory.annotation.Autowired</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kn>import</span><span class=w> </span><span class=nn>org.springframework.context.ApplicationListener</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kn>import</span><span class=w> </span><span class=nn>org.springframework.context.event.ContextRefreshedEvent</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kn>import</span><span class=w> </span><span class=nn>org.springframework.stereotype.Component</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * Netty 实现 websocket
</span></span></span><span class=line><span class=cl><span class=cm> */</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nd>@Component</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nd>@Slf4j</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kd>class</span> <span class=nc>NettyWebSocketServer</span><span class=w> </span><span class=kd>implements</span><span class=w> </span><span class=n>ApplicationListener</span><span class=o>&lt;</span><span class=n>ContextRefreshedEvent</span><span class=o>&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>port</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>9702</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Autowired</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=n>WebSocketChannelInit</span><span class=w> </span><span class=n>webSocketChannelInit</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=n>EventLoopGroup</span><span class=w> </span><span class=n>bossGroup</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>NioEventLoopGroup</span><span class=p>(</span><span class=n>1</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=n>EventLoopGroup</span><span class=w> </span><span class=n>workerGroup</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>NioEventLoopGroup</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>     * 容器初始化完成后调用
</span></span></span><span class=line><span class=cl><span class=cm>     *
</span></span></span><span class=line><span class=cl><span class=cm>     * @param contextRefreshedEvent
</span></span></span><span class=line><span class=cl><span class=cm>     */</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Override</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>onApplicationEvent</span><span class=p>(</span><span class=n>ContextRefreshedEvent</span><span class=w> </span><span class=n>contextRefreshedEvent</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// 启动netty服务器</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>this</span><span class=p>.</span><span class=na>init</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>init</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>//1.创建服务端启动助手</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>ServerBootstrap</span><span class=w> </span><span class=n>serverBootstrap</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>ServerBootstrap</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>//2.设置线程组</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>serverBootstrap</span><span class=p>.</span><span class=na>group</span><span class=p>(</span><span class=n>bossGroup</span><span class=p>,</span><span class=w> </span><span class=n>workerGroup</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>//3.设置参数</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>serverBootstrap</span><span class=p>.</span><span class=na>channel</span><span class=p>(</span><span class=n>NioServerSocketChannel</span><span class=p>.</span><span class=na>class</span><span class=p>).</span><span class=na>handler</span><span class=p>(</span><span class=k>new</span><span class=w> </span><span class=n>LoggingHandler</span><span class=p>(</span><span class=n>LogLevel</span><span class=p>.</span><span class=na>DEBUG</span><span class=p>)).</span><span class=na>childHandler</span><span class=p>(</span><span class=n>webSocketChannelInit</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>//4.启动  绑定端口不能和服务端口一致</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>ChannelFuture</span><span class=w> </span><span class=n>channelFuture</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>serverBootstrap</span><span class=p>.</span><span class=na>bind</span><span class=p>(</span><span class=n>port</span><span class=p>).</span><span class=na>sync</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>channelFuture</span><span class=p>.</span><span class=na>channel</span><span class=p>().</span><span class=na>closeFuture</span><span class=p>().</span><span class=na>sync</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>log</span><span class=p>.</span><span class=na>info</span><span class=p>(</span><span class=n>NettyWebSocketServer</span><span class=p>.</span><span class=na>class</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=s>&#34; 启动正在监听： &#34;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>channelFuture</span><span class=p>.</span><span class=na>channel</span><span class=p>().</span><span class=na>localAddress</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w> </span><span class=k>catch</span><span class=w> </span><span class=p>(</span><span class=n>Exception</span><span class=w> </span><span class=n>e</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>e</span><span class=p>.</span><span class=na>printStackTrace</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w> </span><span class=k>finally</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>bossGroup</span><span class=p>.</span><span class=na>shutdownGracefully</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>workerGroup</span><span class=p>.</span><span class=na>shutdownGracefully</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span></span></span></code></pre></td></tr></table></div></div><p>pipelines 设置各种 handler</p><div class=highlight id=id-9><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kn>package</span><span class=w> </span><span class=nn>com.project.modules.netty</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kn>import</span><span class=w> </span><span class=nn>io.netty.channel.Channel</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kn>import</span><span class=w> </span><span class=nn>io.netty.channel.ChannelInitializer</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kn>import</span><span class=w> </span><span class=nn>io.netty.channel.ChannelPipeline</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kn>import</span><span class=w> </span><span class=nn>io.netty.handler.codec.http.HttpObjectAggregator</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kn>import</span><span class=w> </span><span class=nn>io.netty.handler.codec.http.HttpServerCodec</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kn>import</span><span class=w> </span><span class=nn>io.netty.handler.codec.http.websocketx.WebSocketServerProtocolHandler</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kn>import</span><span class=w> </span><span class=nn>io.netty.handler.stream.ChunkedWriteHandler</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kn>import</span><span class=w> </span><span class=nn>lombok.extern.slf4j.Slf4j</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kn>import</span><span class=w> </span><span class=nn>org.springframework.beans.factory.annotation.Autowired</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kn>import</span><span class=w> </span><span class=nn>org.springframework.stereotype.Component</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * 通道初始化对象
</span></span></span><span class=line><span class=cl><span class=cm> */</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nd>@Component</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nd>@Slf4j</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kd>class</span> <span class=nc>WebSocketChannelInit</span><span class=w> </span><span class=kd>extends</span><span class=w> </span><span class=n>ChannelInitializer</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Autowired</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=n>WebSocketHandler</span><span class=w> </span><span class=n>webSocketHandler</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Override</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>protected</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>initChannel</span><span class=p>(</span><span class=n>Channel</span><span class=w> </span><span class=n>channel</span><span class=p>)</span><span class=w> </span><span class=kd>throws</span><span class=w> </span><span class=n>Exception</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>log</span><span class=p>.</span><span class=na>info</span><span class=p>(</span><span class=s>&#34;收到新连接&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>ChannelPipeline</span><span class=w> </span><span class=n>pipeline</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>channel</span><span class=p>.</span><span class=na>pipeline</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// websocket本身是基于http协议的，对http协议的支持.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>pipeline</span><span class=p>.</span><span class=na>addLast</span><span class=p>(</span><span class=k>new</span><span class=w> </span><span class=n>HttpServerCodec</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// 对大数据流的支持</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>pipeline</span><span class=p>.</span><span class=na>addLast</span><span class=p>(</span><span class=k>new</span><span class=w> </span><span class=n>ChunkedWriteHandler</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>//post请求分三部分. request line / request header / message body</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// HttpObjectAggregator将多个信息转化成单一的request或者response对象</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>pipeline</span><span class=p>.</span><span class=na>addLast</span><span class=p>(</span><span class=k>new</span><span class=w> </span><span class=n>HttpObjectAggregator</span><span class=p>(</span><span class=n>8192</span><span class=p>));</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// 将http协议升级为ws协议. websocket的支持</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>pipeline</span><span class=p>.</span><span class=na>addLast</span><span class=p>(</span><span class=k>new</span><span class=w> </span><span class=n>WebSocketServerProtocolHandler</span><span class=p>(</span><span class=s>&#34;/ws&#34;</span><span class=p>,</span><span class=w> </span><span class=kc>null</span><span class=p>,</span><span class=w> </span><span class=kc>true</span><span class=p>,</span><span class=w> </span><span class=n>65536</span><span class=w> </span><span class=o>*</span><span class=w> </span><span class=n>10</span><span class=p>));</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// 自定义处理handler</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>pipeline</span><span class=p>.</span><span class=na>addLast</span><span class=p>(</span><span class=n>webSocketHandler</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span></span></span></code></pre></td></tr></table></div></div><p>handler，处理通道和消息</p><div class=highlight id=id-10><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>  1
</span><span class=lnt>  2
</span><span class=lnt>  3
</span><span class=lnt>  4
</span><span class=lnt>  5
</span><span class=lnt>  6
</span><span class=lnt>  7
</span><span class=lnt>  8
</span><span class=lnt>  9
</span><span class=lnt> 10
</span><span class=lnt> 11
</span><span class=lnt> 12
</span><span class=lnt> 13
</span><span class=lnt> 14
</span><span class=lnt> 15
</span><span class=lnt> 16
</span><span class=lnt> 17
</span><span class=lnt> 18
</span><span class=lnt> 19
</span><span class=lnt> 20
</span><span class=lnt> 21
</span><span class=lnt> 22
</span><span class=lnt> 23
</span><span class=lnt> 24
</span><span class=lnt> 25
</span><span class=lnt> 26
</span><span class=lnt> 27
</span><span class=lnt> 28
</span><span class=lnt> 29
</span><span class=lnt> 30
</span><span class=lnt> 31
</span><span class=lnt> 32
</span><span class=lnt> 33
</span><span class=lnt> 34
</span><span class=lnt> 35
</span><span class=lnt> 36
</span><span class=lnt> 37
</span><span class=lnt> 38
</span><span class=lnt> 39
</span><span class=lnt> 40
</span><span class=lnt> 41
</span><span class=lnt> 42
</span><span class=lnt> 43
</span><span class=lnt> 44
</span><span class=lnt> 45
</span><span class=lnt> 46
</span><span class=lnt> 47
</span><span class=lnt> 48
</span><span class=lnt> 49
</span><span class=lnt> 50
</span><span class=lnt> 51
</span><span class=lnt> 52
</span><span class=lnt> 53
</span><span class=lnt> 54
</span><span class=lnt> 55
</span><span class=lnt> 56
</span><span class=lnt> 57
</span><span class=lnt> 58
</span><span class=lnt> 59
</span><span class=lnt> 60
</span><span class=lnt> 61
</span><span class=lnt> 62
</span><span class=lnt> 63
</span><span class=lnt> 64
</span><span class=lnt> 65
</span><span class=lnt> 66
</span><span class=lnt> 67
</span><span class=lnt> 68
</span><span class=lnt> 69
</span><span class=lnt> 70
</span><span class=lnt> 71
</span><span class=lnt> 72
</span><span class=lnt> 73
</span><span class=lnt> 74
</span><span class=lnt> 75
</span><span class=lnt> 76
</span><span class=lnt> 77
</span><span class=lnt> 78
</span><span class=lnt> 79
</span><span class=lnt> 80
</span><span class=lnt> 81
</span><span class=lnt> 82
</span><span class=lnt> 83
</span><span class=lnt> 84
</span><span class=lnt> 85
</span><span class=lnt> 86
</span><span class=lnt> 87
</span><span class=lnt> 88
</span><span class=lnt> 89
</span><span class=lnt> 90
</span><span class=lnt> 91
</span><span class=lnt> 92
</span><span class=lnt> 93
</span><span class=lnt> 94
</span><span class=lnt> 95
</span><span class=lnt> 96
</span><span class=lnt> 97
</span><span class=lnt> 98
</span><span class=lnt> 99
</span><span class=lnt>100
</span><span class=lnt>101
</span><span class=lnt>102
</span><span class=lnt>103
</span><span class=lnt>104
</span><span class=lnt>105
</span><span class=lnt>106
</span><span class=lnt>107
</span><span class=lnt>108
</span><span class=lnt>109
</span><span class=lnt>110
</span><span class=lnt>111
</span><span class=lnt>112
</span><span class=lnt>113
</span><span class=lnt>114
</span><span class=lnt>115
</span><span class=lnt>116
</span><span class=lnt>117
</span><span class=lnt>118
</span><span class=lnt>119
</span><span class=lnt>120
</span><span class=lnt>121
</span><span class=lnt>122
</span><span class=lnt>123
</span><span class=lnt>124
</span><span class=lnt>125
</span><span class=lnt>126
</span><span class=lnt>127
</span><span class=lnt>128
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kn>package</span><span class=w> </span><span class=nn>com.project.modules.netty</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kn>import</span><span class=w> </span><span class=nn>cn.hutool.core.collection.ConcurrentHashSet</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kn>import</span><span class=w> </span><span class=nn>io.netty.channel.Channel</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kn>import</span><span class=w> </span><span class=nn>io.netty.channel.ChannelHandler</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kn>import</span><span class=w> </span><span class=nn>io.netty.channel.ChannelHandlerContext</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kn>import</span><span class=w> </span><span class=nn>io.netty.channel.SimpleChannelInboundHandler</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kn>import</span><span class=w> </span><span class=nn>io.netty.handler.codec.http.websocketx.TextWebSocketFrame</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kn>import</span><span class=w> </span><span class=nn>lombok.extern.slf4j.Slf4j</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kn>import</span><span class=w> </span><span class=nn>org.springframework.stereotype.Component</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kn>import</span><span class=w> </span><span class=nn>java.util.concurrent.ConcurrentHashMap</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * 自定义处理类
</span></span></span><span class=line><span class=cl><span class=cm> */</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nd>@Component</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nd>@ChannelHandler.Sharable</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nd>@Slf4j</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kd>class</span> <span class=nc>WebSocketHandler</span><span class=w> </span><span class=kd>extends</span><span class=w> </span><span class=n>SimpleChannelInboundHandler</span><span class=o>&lt;</span><span class=n>TextWebSocketFrame</span><span class=o>&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>     * 用户通道管理
</span></span></span><span class=line><span class=cl><span class=cm>     * key：通道 id
</span></span></span><span class=line><span class=cl><span class=cm>     * value：通道对象
</span></span></span><span class=line><span class=cl><span class=cm>     */</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=n>ConcurrentHashMap</span><span class=o>&lt;</span><span class=n>String</span><span class=p>,</span><span class=w> </span><span class=n>Channel</span><span class=o>&gt;</span><span class=w> </span><span class=n>channelMap</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>ConcurrentHashMap</span><span class=o>&lt;&gt;</span><span class=p>(</span><span class=n>16</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>     * 红包频道管理
</span></span></span><span class=line><span class=cl><span class=cm>     * key: 红包 id
</span></span></span><span class=line><span class=cl><span class=cm>     * value： 通道 id 的 set
</span></span></span><span class=line><span class=cl><span class=cm>     */</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=n>ConcurrentHashMap</span><span class=o>&lt;</span><span class=n>Long</span><span class=p>,</span><span class=w> </span><span class=n>ConcurrentHashSet</span><span class=o>&lt;</span><span class=n>String</span><span class=o>&gt;&gt;</span><span class=w> </span><span class=n>redChannels</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>ConcurrentHashMap</span><span class=o>&lt;&gt;</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>     * 发送消息
</span></span></span><span class=line><span class=cl><span class=cm>     *
</span></span></span><span class=line><span class=cl><span class=cm>     * @param redId           红包 id
</span></span></span><span class=line><span class=cl><span class=cm>     * @param responseMessage 消息内容
</span></span></span><span class=line><span class=cl><span class=cm>     */</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>sendMessage</span><span class=p>(</span><span class=n>Long</span><span class=w> </span><span class=n>redId</span><span class=p>,</span><span class=w> </span><span class=n>String</span><span class=w> </span><span class=n>responseMessage</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>for</span><span class=w> </span><span class=p>(</span><span class=n>String</span><span class=w> </span><span class=n>channel</span><span class=w> </span><span class=p>:</span><span class=w> </span><span class=n>redChannels</span><span class=p>.</span><span class=na>getOrDefault</span><span class=p>(</span><span class=n>redId</span><span class=p>,</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>ConcurrentHashSet</span><span class=o>&lt;&gt;</span><span class=p>()))</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>Channel</span><span class=w> </span><span class=n>c</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>channelMap</span><span class=p>.</span><span class=na>get</span><span class=p>(</span><span class=n>channel</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>c</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=w> </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=n>c</span><span class=p>.</span><span class=na>isActive</span><span class=p>()</span><span class=w> </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=n>c</span><span class=p>.</span><span class=na>isWritable</span><span class=p>())</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>c</span><span class=p>.</span><span class=na>writeAndFlush</span><span class=p>(</span><span class=k>new</span><span class=w> </span><span class=n>TextWebSocketFrame</span><span class=p>(</span><span class=n>responseMessage</span><span class=p>));</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>log</span><span class=p>.</span><span class=na>info</span><span class=p>(</span><span class=s>&#34;发送消息：&#34;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>responseMessage</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>     * 收到消息事件
</span></span></span><span class=line><span class=cl><span class=cm>     *
</span></span></span><span class=line><span class=cl><span class=cm>     * @param ctx 通道处理程序上下文
</span></span></span><span class=line><span class=cl><span class=cm>     * @param msg 文本框架网络套接字
</span></span></span><span class=line><span class=cl><span class=cm>     */</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Override</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>protected</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>channelRead0</span><span class=p>(</span><span class=n>ChannelHandlerContext</span><span class=w> </span><span class=n>ctx</span><span class=p>,</span><span class=w> </span><span class=n>TextWebSocketFrame</span><span class=w> </span><span class=n>msg</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>log</span><span class=p>.</span><span class=na>info</span><span class=p>(</span><span class=s>&#34;msg:&#34;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>msg</span><span class=p>.</span><span class=na>text</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>String</span><span class=o>[]</span><span class=w> </span><span class=n>params</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>msg</span><span class=p>.</span><span class=na>text</span><span class=p>().</span><span class=na>split</span><span class=p>(</span><span class=s>&#34;###&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>params</span><span class=p>.</span><span class=na>length</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=n>2</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>log</span><span class=p>.</span><span class=na>error</span><span class=p>(</span><span class=s>&#34;消息格式错误&#34;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>msg</span><span class=p>.</span><span class=na>text</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>return</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>String</span><span class=w> </span><span class=n>channelId</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>ctx</span><span class=p>.</span><span class=na>channel</span><span class=p>().</span><span class=na>id</span><span class=p>().</span><span class=na>asLongText</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>Long</span><span class=w> </span><span class=n>redId</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>Long</span><span class=p>.</span><span class=na>valueOf</span><span class=p>(</span><span class=n>params</span><span class=o>[</span><span class=n>0</span><span class=o>]</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// 更新红包频道中的通道</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>ConcurrentHashSet</span><span class=o>&lt;</span><span class=n>String</span><span class=o>&gt;</span><span class=w> </span><span class=n>channelIds</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>redChannels</span><span class=p>.</span><span class=na>getOrDefault</span><span class=p>(</span><span class=n>redId</span><span class=p>,</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>ConcurrentHashSet</span><span class=o>&lt;&gt;</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>channelIds</span><span class=p>.</span><span class=na>add</span><span class=p>(</span><span class=n>channelId</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>redChannels</span><span class=p>.</span><span class=na>put</span><span class=p>(</span><span class=n>redId</span><span class=p>,</span><span class=w> </span><span class=n>channelIds</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>String</span><span class=w> </span><span class=n>userName</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>params</span><span class=o>[</span><span class=n>1</span><span class=o>]</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>params</span><span class=p>.</span><span class=na>length</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=n>2</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// xxx来了</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>sendMessage</span><span class=p>(</span><span class=n>redId</span><span class=p>,</span><span class=w> </span><span class=s>&#34;@welcome###&#34;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>userName</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>return</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>String</span><span class=w> </span><span class=n>message</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>params</span><span class=o>[</span><span class=n>2</span><span class=o>]</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>message</span><span class=p>.</span><span class=na>startsWith</span><span class=p>(</span><span class=s>&#34;@&#34;</span><span class=p>))</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// 指令消息</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>sendMessage</span><span class=p>(</span><span class=n>redId</span><span class=p>,</span><span class=w> </span><span class=n>message</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=s>&#34;###&#34;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>userName</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>return</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// 群发聊天消息</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>sendMessage</span><span class=p>(</span><span class=n>redId</span><span class=p>,</span><span class=w> </span><span class=n>userName</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=s>&#34;###&#34;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>message</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>     * 通道就绪事件
</span></span></span><span class=line><span class=cl><span class=cm>     */</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Override</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>channelActive</span><span class=p>(</span><span class=n>ChannelHandlerContext</span><span class=w> </span><span class=n>ctx</span><span class=p>)</span><span class=w> </span><span class=kd>throws</span><span class=w> </span><span class=n>Exception</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>Channel</span><span class=w> </span><span class=n>channel</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>ctx</span><span class=p>.</span><span class=na>channel</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// 放入通道组</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>channelMap</span><span class=p>.</span><span class=na>put</span><span class=p>(</span><span class=n>channel</span><span class=p>.</span><span class=na>id</span><span class=p>().</span><span class=na>asLongText</span><span class=p>(),</span><span class=w> </span><span class=n>channel</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>channel</span><span class=p>.</span><span class=na>writeAndFlush</span><span class=p>(</span><span class=k>new</span><span class=w> </span><span class=n>TextWebSocketFrame</span><span class=p>(</span><span class=n>channel</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=s>&#34;上线了&#34;</span><span class=p>));</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>log</span><span class=p>.</span><span class=na>info</span><span class=p>(</span><span class=s>&#34;[&#34;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>channelMap</span><span class=p>.</span><span class=na>size</span><span class=p>()</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=s>&#34;]有新的连接:&#34;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>channel</span><span class=p>.</span><span class=na>remoteAddress</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>     * 通道未就绪事件
</span></span></span><span class=line><span class=cl><span class=cm>     */</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Override</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>channelInactive</span><span class=p>(</span><span class=n>ChannelHandlerContext</span><span class=w> </span><span class=n>ctx</span><span class=p>)</span><span class=w> </span><span class=kd>throws</span><span class=w> </span><span class=n>Exception</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>Channel</span><span class=w> </span><span class=n>channel</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>ctx</span><span class=p>.</span><span class=na>channel</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>log</span><span class=p>.</span><span class=na>info</span><span class=p>(</span><span class=s>&#34;通道：&#34;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>channel</span><span class=p>.</span><span class=na>remoteAddress</span><span class=p>()</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=s>&#34;已下线&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// 当有客户端断开连接的时候,就移除对应的通道</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>channelMap</span><span class=p>.</span><span class=na>remove</span><span class=p>(</span><span class=n>channel</span><span class=p>.</span><span class=na>id</span><span class=p>().</span><span class=na>asLongText</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>ctx</span><span class=p>.</span><span class=na>close</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>     * 异常处理事件
</span></span></span><span class=line><span class=cl><span class=cm>     *
</span></span></span><span class=line><span class=cl><span class=cm>     * @param ctx   ctx
</span></span></span><span class=line><span class=cl><span class=cm>     * @param cause 导致
</span></span></span><span class=line><span class=cl><span class=cm>     * @throws Exception 异常
</span></span></span><span class=line><span class=cl><span class=cm>     */</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Override</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>exceptionCaught</span><span class=p>(</span><span class=n>ChannelHandlerContext</span><span class=w> </span><span class=n>ctx</span><span class=p>,</span><span class=w> </span><span class=n>Throwable</span><span class=w> </span><span class=n>cause</span><span class=p>)</span><span class=w> </span><span class=kd>throws</span><span class=w> </span><span class=n>Exception</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>Channel</span><span class=w> </span><span class=n>channel</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>ctx</span><span class=p>.</span><span class=na>channel</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>//移除集合</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>channelMap</span><span class=p>.</span><span class=na>remove</span><span class=p>(</span><span class=n>channel</span><span class=p>.</span><span class=na>id</span><span class=p>().</span><span class=na>asLongText</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>ctx</span><span class=p>.</span><span class=na>close</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>log</span><span class=p>.</span><span class=na>error</span><span class=p>(</span><span class=s>&#34;异常信息：{}&#34;</span><span class=p>,</span><span class=w> </span><span class=n>cause</span><span class=p>.</span><span class=na>getMessage</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span></span></span></code></pre></td></tr></table></div></div><h2 id=定时任务模块>定时任务模块</h2><p>根据模块划分，详细实现 定时任务与通知模块是项目中的一个关键组件，主要用于管理红包活动的不同阶段，并向用户和企业发送相应的通知。在项目中，定时任务分为以下几个阶段：</p><ol><li>通知用户抢红包活动即将开始：在抢红包活动开始前的10分钟，通过邮件和短信通知用户，提醒他们即将有机会参与红包活动。</li><li>抢红包活动开始后的通知：在抢红包活动正式开始时，通过定时任务通知用户可以开始抢红包了。</li><li>抢红包结束后的结算：当抢红包活动结束后，触发定时任务执行后台结算方法。</li><li>通知企业红包退款：在结算完毕后，通过邮件通知企业红包已经退回了部分金额。</li></ol><p>在技术实现上，采用了Quartz框架来实现定时任务的管理和调度。Quartz提供了灵活的任务调度功能，允许定义任务的执行时间、频率和触发器等属性。</p><p><a class=lightgallery href=https://publicpictures.oss-cn-hangzhou.aliyuncs.com/img/image-20230915104221247.png data-thumbnail=https://publicpictures.oss-cn-hangzhou.aliyuncs.com/img/image-20230915104221247.png data-sub-html="<h2>image-20230915104221247</h2>"><img loading=lazy src=https://publicpictures.oss-cn-hangzhou.aliyuncs.com/img/image-20230915104221247.png srcset="https://publicpictures.oss-cn-hangzhou.aliyuncs.com/img/image-20230915104221247.png, https://publicpictures.oss-cn-hangzhou.aliyuncs.com/img/image-20230915104221247.png 1.5x, https://publicpictures.oss-cn-hangzhou.aliyuncs.com/img/image-20230915104221247.png 2x" sizes=auto data-title=image-20230915104221247 data-alt=image-20230915104221247 style="background:url(/svg/loading.min.svg)no-repeat 50%" onload='this.title=this.dataset.title,this.alt=this.dataset.alt;for(const e of["style","data-title","data-alt","onerror","onload"])this.removeAttribute(e);this.dataset.lazyloaded=""' onerror='this.title=this.dataset.title,this.alt=this.dataset.alt;for(const e of["style","data-title","data-alt","onerror","onload"])this.removeAttribute(e)'></a></p><p>首先，使用 JobBuilder.newJob(StartJob.class) 创建一个 JobDetail 对象，用于定义任务。redId 作为任务数据的参数传递。然后，使用 TriggerBuilder.newTrigger() 创建一个 Trigger 对象，并自定义任务的执行时间。最后，将 Trigger 关联到 JobDetail，并进行调度执行。</p><h3 id=sql>SQL</h3><div class=highlight id=id-11><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>  1
</span><span class=lnt>  2
</span><span class=lnt>  3
</span><span class=lnt>  4
</span><span class=lnt>  5
</span><span class=lnt>  6
</span><span class=lnt>  7
</span><span class=lnt>  8
</span><span class=lnt>  9
</span><span class=lnt> 10
</span><span class=lnt> 11
</span><span class=lnt> 12
</span><span class=lnt> 13
</span><span class=lnt> 14
</span><span class=lnt> 15
</span><span class=lnt> 16
</span><span class=lnt> 17
</span><span class=lnt> 18
</span><span class=lnt> 19
</span><span class=lnt> 20
</span><span class=lnt> 21
</span><span class=lnt> 22
</span><span class=lnt> 23
</span><span class=lnt> 24
</span><span class=lnt> 25
</span><span class=lnt> 26
</span><span class=lnt> 27
</span><span class=lnt> 28
</span><span class=lnt> 29
</span><span class=lnt> 30
</span><span class=lnt> 31
</span><span class=lnt> 32
</span><span class=lnt> 33
</span><span class=lnt> 34
</span><span class=lnt> 35
</span><span class=lnt> 36
</span><span class=lnt> 37
</span><span class=lnt> 38
</span><span class=lnt> 39
</span><span class=lnt> 40
</span><span class=lnt> 41
</span><span class=lnt> 42
</span><span class=lnt> 43
</span><span class=lnt> 44
</span><span class=lnt> 45
</span><span class=lnt> 46
</span><span class=lnt> 47
</span><span class=lnt> 48
</span><span class=lnt> 49
</span><span class=lnt> 50
</span><span class=lnt> 51
</span><span class=lnt> 52
</span><span class=lnt> 53
</span><span class=lnt> 54
</span><span class=lnt> 55
</span><span class=lnt> 56
</span><span class=lnt> 57
</span><span class=lnt> 58
</span><span class=lnt> 59
</span><span class=lnt> 60
</span><span class=lnt> 61
</span><span class=lnt> 62
</span><span class=lnt> 63
</span><span class=lnt> 64
</span><span class=lnt> 65
</span><span class=lnt> 66
</span><span class=lnt> 67
</span><span class=lnt> 68
</span><span class=lnt> 69
</span><span class=lnt> 70
</span><span class=lnt> 71
</span><span class=lnt> 72
</span><span class=lnt> 73
</span><span class=lnt> 74
</span><span class=lnt> 75
</span><span class=lnt> 76
</span><span class=lnt> 77
</span><span class=lnt> 78
</span><span class=lnt> 79
</span><span class=lnt> 80
</span><span class=lnt> 81
</span><span class=lnt> 82
</span><span class=lnt> 83
</span><span class=lnt> 84
</span><span class=lnt> 85
</span><span class=lnt> 86
</span><span class=lnt> 87
</span><span class=lnt> 88
</span><span class=lnt> 89
</span><span class=lnt> 90
</span><span class=lnt> 91
</span><span class=lnt> 92
</span><span class=lnt> 93
</span><span class=lnt> 94
</span><span class=lnt> 95
</span><span class=lnt> 96
</span><span class=lnt> 97
</span><span class=lnt> 98
</span><span class=lnt> 99
</span><span class=lnt>100
</span><span class=lnt>101
</span><span class=lnt>102
</span><span class=lnt>103
</span><span class=lnt>104
</span><span class=lnt>105
</span><span class=lnt>106
</span><span class=lnt>107
</span><span class=lnt>108
</span><span class=lnt>109
</span><span class=lnt>110
</span><span class=lnt>111
</span><span class=lnt>112
</span><span class=lnt>113
</span><span class=lnt>114
</span><span class=lnt>115
</span><span class=lnt>116
</span><span class=lnt>117
</span><span class=lnt>118
</span><span class=lnt>119
</span><span class=lnt>120
</span><span class=lnt>121
</span><span class=lnt>122
</span><span class=lnt>123
</span><span class=lnt>124
</span><span class=lnt>125
</span><span class=lnt>126
</span><span class=lnt>127
</span><span class=lnt>128
</span><span class=lnt>129
</span><span class=lnt>130
</span><span class=lnt>131
</span><span class=lnt>132
</span><span class=lnt>133
</span><span class=lnt>134
</span><span class=lnt>135
</span><span class=lnt>136
</span><span class=lnt>137
</span><span class=lnt>138
</span><span class=lnt>139
</span><span class=lnt>140
</span><span class=lnt>141
</span><span class=lnt>142
</span><span class=lnt>143
</span><span class=lnt>144
</span><span class=lnt>145
</span><span class=lnt>146
</span><span class=lnt>147
</span><span class=lnt>148
</span><span class=lnt>149
</span><span class=lnt>150
</span><span class=lnt>151
</span><span class=lnt>152
</span><span class=lnt>153
</span><span class=lnt>154
</span><span class=lnt>155
</span><span class=lnt>156
</span><span class=lnt>157
</span><span class=lnt>158
</span><span class=lnt>159
</span><span class=lnt>160
</span><span class=lnt>161
</span><span class=lnt>162
</span><span class=lnt>163
</span><span class=lnt>164
</span><span class=lnt>165
</span><span class=lnt>166
</span><span class=lnt>167
</span><span class=lnt>168
</span><span class=lnt>169
</span><span class=lnt>170
</span><span class=lnt>171
</span><span class=lnt>172
</span><span class=lnt>173
</span><span class=lnt>174
</span><span class=lnt>175
</span><span class=lnt>176
</span><span class=lnt>177
</span><span class=lnt>178
</span><span class=lnt>179
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=o>#</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=o>#</span><span class=w> </span><span class=k>In</span><span class=w> </span><span class=n>your</span><span class=w> </span><span class=n>Quartz</span><span class=w> </span><span class=n>properties</span><span class=w> </span><span class=n>file</span><span class=p>,</span><span class=w> </span><span class=n>you</span><span class=s1>&#39;ll need to set
</span></span></span><span class=line><span class=cl><span class=s1># org.quartz.jobStore.driverDelegateClass = org.quartz.impl.jdbcjobstore.StdJDBCDelegate
</span></span></span><span class=line><span class=cl><span class=s1>#
</span></span></span><span class=line><span class=cl><span class=s1>#
</span></span></span><span class=line><span class=cl><span class=s1># By: Ron Cordell - roncordell
</span></span></span><span class=line><span class=cl><span class=s1>#  I didn&#39;</span><span class=n>t</span><span class=w> </span><span class=n>see</span><span class=w> </span><span class=n>this</span><span class=w> </span><span class=n>anywhere</span><span class=p>,</span><span class=w> </span><span class=n>so</span><span class=w> </span><span class=n>I</span><span class=w> </span><span class=n>thought</span><span class=w> </span><span class=n>I</span><span class=s1>&#39;d post it here. This is the script from Quartz to create the tables in a MySQL database, modified to use INNODB instead of MYISAM.
</span></span></span><span class=line><span class=cl><span class=s1>
</span></span></span><span class=line><span class=cl><span class=s1>DROP TABLE IF EXISTS QRTZ_FIRED_TRIGGERS;
</span></span></span><span class=line><span class=cl><span class=s1>DROP TABLE IF EXISTS QRTZ_PAUSED_TRIGGER_GRPS;
</span></span></span><span class=line><span class=cl><span class=s1>DROP TABLE IF EXISTS QRTZ_SCHEDULER_STATE;
</span></span></span><span class=line><span class=cl><span class=s1>DROP TABLE IF EXISTS QRTZ_LOCKS;
</span></span></span><span class=line><span class=cl><span class=s1>DROP TABLE IF EXISTS QRTZ_SIMPLE_TRIGGERS;
</span></span></span><span class=line><span class=cl><span class=s1>DROP TABLE IF EXISTS QRTZ_SIMPROP_TRIGGERS;
</span></span></span><span class=line><span class=cl><span class=s1>DROP TABLE IF EXISTS QRTZ_CRON_TRIGGERS;
</span></span></span><span class=line><span class=cl><span class=s1>DROP TABLE IF EXISTS QRTZ_BLOB_TRIGGERS;
</span></span></span><span class=line><span class=cl><span class=s1>DROP TABLE IF EXISTS QRTZ_TRIGGERS;
</span></span></span><span class=line><span class=cl><span class=s1>DROP TABLE IF EXISTS QRTZ_JOB_DETAILS;
</span></span></span><span class=line><span class=cl><span class=s1>DROP TABLE IF EXISTS QRTZ_CALENDARS;
</span></span></span><span class=line><span class=cl><span class=s1>
</span></span></span><span class=line><span class=cl><span class=s1>CREATE TABLE QRTZ_JOB_DETAILS(
</span></span></span><span class=line><span class=cl><span class=s1>SCHED_NAME VARCHAR(120) NOT NULL,
</span></span></span><span class=line><span class=cl><span class=s1>JOB_NAME VARCHAR(190) NOT NULL,
</span></span></span><span class=line><span class=cl><span class=s1>JOB_GROUP VARCHAR(190) NOT NULL,
</span></span></span><span class=line><span class=cl><span class=s1>DESCRIPTION VARCHAR(250) NULL,
</span></span></span><span class=line><span class=cl><span class=s1>JOB_CLASS_NAME VARCHAR(250) NOT NULL,
</span></span></span><span class=line><span class=cl><span class=s1>IS_DURABLE VARCHAR(1) NOT NULL,
</span></span></span><span class=line><span class=cl><span class=s1>IS_NONCONCURRENT VARCHAR(1) NOT NULL,
</span></span></span><span class=line><span class=cl><span class=s1>IS_UPDATE_DATA VARCHAR(1) NOT NULL,
</span></span></span><span class=line><span class=cl><span class=s1>REQUESTS_RECOVERY VARCHAR(1) NOT NULL,
</span></span></span><span class=line><span class=cl><span class=s1>JOB_DATA BLOB NULL,
</span></span></span><span class=line><span class=cl><span class=s1>PRIMARY KEY (SCHED_NAME,JOB_NAME,JOB_GROUP))
</span></span></span><span class=line><span class=cl><span class=s1>ENGINE=InnoDB;
</span></span></span><span class=line><span class=cl><span class=s1>
</span></span></span><span class=line><span class=cl><span class=s1>CREATE TABLE QRTZ_TRIGGERS (
</span></span></span><span class=line><span class=cl><span class=s1>SCHED_NAME VARCHAR(120) NOT NULL,
</span></span></span><span class=line><span class=cl><span class=s1>TRIGGER_NAME VARCHAR(190) NOT NULL,
</span></span></span><span class=line><span class=cl><span class=s1>TRIGGER_GROUP VARCHAR(190) NOT NULL,
</span></span></span><span class=line><span class=cl><span class=s1>JOB_NAME VARCHAR(190) NOT NULL,
</span></span></span><span class=line><span class=cl><span class=s1>JOB_GROUP VARCHAR(190) NOT NULL,
</span></span></span><span class=line><span class=cl><span class=s1>DESCRIPTION VARCHAR(250) NULL,
</span></span></span><span class=line><span class=cl><span class=s1>NEXT_FIRE_TIME BIGINT(13) NULL,
</span></span></span><span class=line><span class=cl><span class=s1>PREV_FIRE_TIME BIGINT(13) NULL,
</span></span></span><span class=line><span class=cl><span class=s1>PRIORITY INTEGER NULL,
</span></span></span><span class=line><span class=cl><span class=s1>TRIGGER_STATE VARCHAR(16) NOT NULL,
</span></span></span><span class=line><span class=cl><span class=s1>TRIGGER_TYPE VARCHAR(8) NOT NULL,
</span></span></span><span class=line><span class=cl><span class=s1>START_TIME BIGINT(13) NOT NULL,
</span></span></span><span class=line><span class=cl><span class=s1>END_TIME BIGINT(13) NULL,
</span></span></span><span class=line><span class=cl><span class=s1>CALENDAR_NAME VARCHAR(190) NULL,
</span></span></span><span class=line><span class=cl><span class=s1>MISFIRE_INSTR SMALLINT(2) NULL,
</span></span></span><span class=line><span class=cl><span class=s1>JOB_DATA BLOB NULL,
</span></span></span><span class=line><span class=cl><span class=s1>PRIMARY KEY (SCHED_NAME,TRIGGER_NAME,TRIGGER_GROUP),
</span></span></span><span class=line><span class=cl><span class=s1>FOREIGN KEY (SCHED_NAME,JOB_NAME,JOB_GROUP)
</span></span></span><span class=line><span class=cl><span class=s1>REFERENCES QRTZ_JOB_DETAILS(SCHED_NAME,JOB_NAME,JOB_GROUP))
</span></span></span><span class=line><span class=cl><span class=s1>ENGINE=InnoDB;
</span></span></span><span class=line><span class=cl><span class=s1>
</span></span></span><span class=line><span class=cl><span class=s1>CREATE TABLE QRTZ_SIMPLE_TRIGGERS (
</span></span></span><span class=line><span class=cl><span class=s1>SCHED_NAME VARCHAR(120) NOT NULL,
</span></span></span><span class=line><span class=cl><span class=s1>TRIGGER_NAME VARCHAR(190) NOT NULL,
</span></span></span><span class=line><span class=cl><span class=s1>TRIGGER_GROUP VARCHAR(190) NOT NULL,
</span></span></span><span class=line><span class=cl><span class=s1>REPEAT_COUNT BIGINT(7) NOT NULL,
</span></span></span><span class=line><span class=cl><span class=s1>REPEAT_INTERVAL BIGINT(12) NOT NULL,
</span></span></span><span class=line><span class=cl><span class=s1>TIMES_TRIGGERED BIGINT(10) NOT NULL,
</span></span></span><span class=line><span class=cl><span class=s1>PRIMARY KEY (SCHED_NAME,TRIGGER_NAME,TRIGGER_GROUP),
</span></span></span><span class=line><span class=cl><span class=s1>FOREIGN KEY (SCHED_NAME,TRIGGER_NAME,TRIGGER_GROUP)
</span></span></span><span class=line><span class=cl><span class=s1>REFERENCES QRTZ_TRIGGERS(SCHED_NAME,TRIGGER_NAME,TRIGGER_GROUP))
</span></span></span><span class=line><span class=cl><span class=s1>ENGINE=InnoDB;
</span></span></span><span class=line><span class=cl><span class=s1>
</span></span></span><span class=line><span class=cl><span class=s1>CREATE TABLE QRTZ_CRON_TRIGGERS (
</span></span></span><span class=line><span class=cl><span class=s1>SCHED_NAME VARCHAR(120) NOT NULL,
</span></span></span><span class=line><span class=cl><span class=s1>TRIGGER_NAME VARCHAR(190) NOT NULL,
</span></span></span><span class=line><span class=cl><span class=s1>TRIGGER_GROUP VARCHAR(190) NOT NULL,
</span></span></span><span class=line><span class=cl><span class=s1>CRON_EXPRESSION VARCHAR(120) NOT NULL,
</span></span></span><span class=line><span class=cl><span class=s1>TIME_ZONE_ID VARCHAR(80),
</span></span></span><span class=line><span class=cl><span class=s1>PRIMARY KEY (SCHED_NAME,TRIGGER_NAME,TRIGGER_GROUP),
</span></span></span><span class=line><span class=cl><span class=s1>FOREIGN KEY (SCHED_NAME,TRIGGER_NAME,TRIGGER_GROUP)
</span></span></span><span class=line><span class=cl><span class=s1>REFERENCES QRTZ_TRIGGERS(SCHED_NAME,TRIGGER_NAME,TRIGGER_GROUP))
</span></span></span><span class=line><span class=cl><span class=s1>ENGINE=InnoDB;
</span></span></span><span class=line><span class=cl><span class=s1>
</span></span></span><span class=line><span class=cl><span class=s1>CREATE TABLE QRTZ_SIMPROP_TRIGGERS
</span></span></span><span class=line><span class=cl><span class=s1>  (
</span></span></span><span class=line><span class=cl><span class=s1>    SCHED_NAME VARCHAR(120) NOT NULL,
</span></span></span><span class=line><span class=cl><span class=s1>    TRIGGER_NAME VARCHAR(190) NOT NULL,
</span></span></span><span class=line><span class=cl><span class=s1>    TRIGGER_GROUP VARCHAR(190) NOT NULL,
</span></span></span><span class=line><span class=cl><span class=s1>    STR_PROP_1 VARCHAR(512) NULL,
</span></span></span><span class=line><span class=cl><span class=s1>    STR_PROP_2 VARCHAR(512) NULL,
</span></span></span><span class=line><span class=cl><span class=s1>    STR_PROP_3 VARCHAR(512) NULL,
</span></span></span><span class=line><span class=cl><span class=s1>    INT_PROP_1 INT NULL,
</span></span></span><span class=line><span class=cl><span class=s1>    INT_PROP_2 INT NULL,
</span></span></span><span class=line><span class=cl><span class=s1>    LONG_PROP_1 BIGINT NULL,
</span></span></span><span class=line><span class=cl><span class=s1>    LONG_PROP_2 BIGINT NULL,
</span></span></span><span class=line><span class=cl><span class=s1>    DEC_PROP_1 NUMERIC(13,4) NULL,
</span></span></span><span class=line><span class=cl><span class=s1>    DEC_PROP_2 NUMERIC(13,4) NULL,
</span></span></span><span class=line><span class=cl><span class=s1>    BOOL_PROP_1 VARCHAR(1) NULL,
</span></span></span><span class=line><span class=cl><span class=s1>    BOOL_PROP_2 VARCHAR(1) NULL,
</span></span></span><span class=line><span class=cl><span class=s1>    PRIMARY KEY (SCHED_NAME,TRIGGER_NAME,TRIGGER_GROUP),
</span></span></span><span class=line><span class=cl><span class=s1>    FOREIGN KEY (SCHED_NAME,TRIGGER_NAME,TRIGGER_GROUP)
</span></span></span><span class=line><span class=cl><span class=s1>    REFERENCES QRTZ_TRIGGERS(SCHED_NAME,TRIGGER_NAME,TRIGGER_GROUP))
</span></span></span><span class=line><span class=cl><span class=s1>ENGINE=InnoDB;
</span></span></span><span class=line><span class=cl><span class=s1>
</span></span></span><span class=line><span class=cl><span class=s1>CREATE TABLE QRTZ_BLOB_TRIGGERS (
</span></span></span><span class=line><span class=cl><span class=s1>SCHED_NAME VARCHAR(120) NOT NULL,
</span></span></span><span class=line><span class=cl><span class=s1>TRIGGER_NAME VARCHAR(190) NOT NULL,
</span></span></span><span class=line><span class=cl><span class=s1>TRIGGER_GROUP VARCHAR(190) NOT NULL,
</span></span></span><span class=line><span class=cl><span class=s1>BLOB_DATA BLOB NULL,
</span></span></span><span class=line><span class=cl><span class=s1>PRIMARY KEY (SCHED_NAME,TRIGGER_NAME,TRIGGER_GROUP),
</span></span></span><span class=line><span class=cl><span class=s1>INDEX (SCHED_NAME,TRIGGER_NAME, TRIGGER_GROUP),
</span></span></span><span class=line><span class=cl><span class=s1>FOREIGN KEY (SCHED_NAME,TRIGGER_NAME,TRIGGER_GROUP)
</span></span></span><span class=line><span class=cl><span class=s1>REFERENCES QRTZ_TRIGGERS(SCHED_NAME,TRIGGER_NAME,TRIGGER_GROUP))
</span></span></span><span class=line><span class=cl><span class=s1>ENGINE=InnoDB;
</span></span></span><span class=line><span class=cl><span class=s1>
</span></span></span><span class=line><span class=cl><span class=s1>CREATE TABLE QRTZ_CALENDARS (
</span></span></span><span class=line><span class=cl><span class=s1>SCHED_NAME VARCHAR(120) NOT NULL,
</span></span></span><span class=line><span class=cl><span class=s1>CALENDAR_NAME VARCHAR(190) NOT NULL,
</span></span></span><span class=line><span class=cl><span class=s1>CALENDAR BLOB NOT NULL,
</span></span></span><span class=line><span class=cl><span class=s1>PRIMARY KEY (SCHED_NAME,CALENDAR_NAME))
</span></span></span><span class=line><span class=cl><span class=s1>ENGINE=InnoDB;
</span></span></span><span class=line><span class=cl><span class=s1>
</span></span></span><span class=line><span class=cl><span class=s1>CREATE TABLE QRTZ_PAUSED_TRIGGER_GRPS (
</span></span></span><span class=line><span class=cl><span class=s1>SCHED_NAME VARCHAR(120) NOT NULL,
</span></span></span><span class=line><span class=cl><span class=s1>TRIGGER_GROUP VARCHAR(190) NOT NULL,
</span></span></span><span class=line><span class=cl><span class=s1>PRIMARY KEY (SCHED_NAME,TRIGGER_GROUP))
</span></span></span><span class=line><span class=cl><span class=s1>ENGINE=InnoDB;
</span></span></span><span class=line><span class=cl><span class=s1>
</span></span></span><span class=line><span class=cl><span class=s1>CREATE TABLE QRTZ_FIRED_TRIGGERS (
</span></span></span><span class=line><span class=cl><span class=s1>SCHED_NAME VARCHAR(120) NOT NULL,
</span></span></span><span class=line><span class=cl><span class=s1>ENTRY_ID VARCHAR(95) NOT NULL,
</span></span></span><span class=line><span class=cl><span class=s1>TRIGGER_NAME VARCHAR(190) NOT NULL,
</span></span></span><span class=line><span class=cl><span class=s1>TRIGGER_GROUP VARCHAR(190) NOT NULL,
</span></span></span><span class=line><span class=cl><span class=s1>INSTANCE_NAME VARCHAR(190) NOT NULL,
</span></span></span><span class=line><span class=cl><span class=s1>FIRED_TIME BIGINT(13) NOT NULL,
</span></span></span><span class=line><span class=cl><span class=s1>SCHED_TIME BIGINT(13) NOT NULL,
</span></span></span><span class=line><span class=cl><span class=s1>PRIORITY INTEGER NOT NULL,
</span></span></span><span class=line><span class=cl><span class=s1>STATE VARCHAR(16) NOT NULL,
</span></span></span><span class=line><span class=cl><span class=s1>JOB_NAME VARCHAR(190) NULL,
</span></span></span><span class=line><span class=cl><span class=s1>JOB_GROUP VARCHAR(190) NULL,
</span></span></span><span class=line><span class=cl><span class=s1>IS_NONCONCURRENT VARCHAR(1) NULL,
</span></span></span><span class=line><span class=cl><span class=s1>REQUESTS_RECOVERY VARCHAR(1) NULL,
</span></span></span><span class=line><span class=cl><span class=s1>PRIMARY KEY (SCHED_NAME,ENTRY_ID))
</span></span></span><span class=line><span class=cl><span class=s1>ENGINE=InnoDB;
</span></span></span><span class=line><span class=cl><span class=s1>
</span></span></span><span class=line><span class=cl><span class=s1>CREATE TABLE QRTZ_SCHEDULER_STATE (
</span></span></span><span class=line><span class=cl><span class=s1>SCHED_NAME VARCHAR(120) NOT NULL,
</span></span></span><span class=line><span class=cl><span class=s1>INSTANCE_NAME VARCHAR(190) NOT NULL,
</span></span></span><span class=line><span class=cl><span class=s1>LAST_CHECKIN_TIME BIGINT(13) NOT NULL,
</span></span></span><span class=line><span class=cl><span class=s1>CHECKIN_INTERVAL BIGINT(13) NOT NULL,
</span></span></span><span class=line><span class=cl><span class=s1>PRIMARY KEY (SCHED_NAME,INSTANCE_NAME))
</span></span></span><span class=line><span class=cl><span class=s1>ENGINE=InnoDB;
</span></span></span><span class=line><span class=cl><span class=s1>
</span></span></span><span class=line><span class=cl><span class=s1>CREATE TABLE QRTZ_LOCKS (
</span></span></span><span class=line><span class=cl><span class=s1>SCHED_NAME VARCHAR(120) NOT NULL,
</span></span></span><span class=line><span class=cl><span class=s1>LOCK_NAME VARCHAR(40) NOT NULL,
</span></span></span><span class=line><span class=cl><span class=s1>PRIMARY KEY (SCHED_NAME,LOCK_NAME))
</span></span></span><span class=line><span class=cl><span class=s1>ENGINE=InnoDB;
</span></span></span><span class=line><span class=cl><span class=s1>
</span></span></span><span class=line><span class=cl><span class=s1>CREATE INDEX IDX_QRTZ_J_REQ_RECOVERY ON QRTZ_JOB_DETAILS(SCHED_NAME,REQUESTS_RECOVERY);
</span></span></span><span class=line><span class=cl><span class=s1>CREATE INDEX IDX_QRTZ_J_GRP ON QRTZ_JOB_DETAILS(SCHED_NAME,JOB_GROUP);
</span></span></span><span class=line><span class=cl><span class=s1>
</span></span></span><span class=line><span class=cl><span class=s1>CREATE INDEX IDX_QRTZ_T_J ON QRTZ_TRIGGERS(SCHED_NAME,JOB_NAME,JOB_GROUP);
</span></span></span><span class=line><span class=cl><span class=s1>CREATE INDEX IDX_QRTZ_T_JG ON QRTZ_TRIGGERS(SCHED_NAME,JOB_GROUP);
</span></span></span><span class=line><span class=cl><span class=s1>CREATE INDEX IDX_QRTZ_T_C ON QRTZ_TRIGGERS(SCHED_NAME,CALENDAR_NAME);
</span></span></span><span class=line><span class=cl><span class=s1>CREATE INDEX IDX_QRTZ_T_G ON QRTZ_TRIGGERS(SCHED_NAME,TRIGGER_GROUP);
</span></span></span><span class=line><span class=cl><span class=s1>CREATE INDEX IDX_QRTZ_T_STATE ON QRTZ_TRIGGERS(SCHED_NAME,TRIGGER_STATE);
</span></span></span><span class=line><span class=cl><span class=s1>CREATE INDEX IDX_QRTZ_T_N_STATE ON QRTZ_TRIGGERS(SCHED_NAME,TRIGGER_NAME,TRIGGER_GROUP,TRIGGER_STATE);
</span></span></span><span class=line><span class=cl><span class=s1>CREATE INDEX IDX_QRTZ_T_N_G_STATE ON QRTZ_TRIGGERS(SCHED_NAME,TRIGGER_GROUP,TRIGGER_STATE);
</span></span></span><span class=line><span class=cl><span class=s1>CREATE INDEX IDX_QRTZ_T_NEXT_FIRE_TIME ON QRTZ_TRIGGERS(SCHED_NAME,NEXT_FIRE_TIME);
</span></span></span><span class=line><span class=cl><span class=s1>CREATE INDEX IDX_QRTZ_T_NFT_ST ON QRTZ_TRIGGERS(SCHED_NAME,TRIGGER_STATE,NEXT_FIRE_TIME);
</span></span></span><span class=line><span class=cl><span class=s1>CREATE INDEX IDX_QRTZ_T_NFT_MISFIRE ON QRTZ_TRIGGERS(SCHED_NAME,MISFIRE_INSTR,NEXT_FIRE_TIME);
</span></span></span><span class=line><span class=cl><span class=s1>CREATE INDEX IDX_QRTZ_T_NFT_ST_MISFIRE ON QRTZ_TRIGGERS(SCHED_NAME,MISFIRE_INSTR,NEXT_FIRE_TIME,TRIGGER_STATE);
</span></span></span><span class=line><span class=cl><span class=s1>CREATE INDEX IDX_QRTZ_T_NFT_ST_MISFIRE_GRP ON QRTZ_TRIGGERS(SCHED_NAME,MISFIRE_INSTR,NEXT_FIRE_TIME,TRIGGER_GROUP,TRIGGER_STATE);
</span></span></span><span class=line><span class=cl><span class=s1>
</span></span></span><span class=line><span class=cl><span class=s1>CREATE INDEX IDX_QRTZ_FT_TRIG_INST_NAME ON QRTZ_FIRED_TRIGGERS(SCHED_NAME,INSTANCE_NAME);
</span></span></span><span class=line><span class=cl><span class=s1>CREATE INDEX IDX_QRTZ_FT_INST_JOB_REQ_RCVRY ON QRTZ_FIRED_TRIGGERS(SCHED_NAME,INSTANCE_NAME,REQUESTS_RECOVERY);
</span></span></span><span class=line><span class=cl><span class=s1>CREATE INDEX IDX_QRTZ_FT_J_G ON QRTZ_FIRED_TRIGGERS(SCHED_NAME,JOB_NAME,JOB_GROUP);
</span></span></span><span class=line><span class=cl><span class=s1>CREATE INDEX IDX_QRTZ_FT_JG ON QRTZ_FIRED_TRIGGERS(SCHED_NAME,JOB_GROUP);
</span></span></span><span class=line><span class=cl><span class=s1>CREATE INDEX IDX_QRTZ_FT_T_G ON QRTZ_FIRED_TRIGGERS(SCHED_NAME,TRIGGER_NAME,TRIGGER_GROUP);
</span></span></span><span class=line><span class=cl><span class=s1>CREATE INDEX IDX_QRTZ_FT_TG ON QRTZ_FIRED_TRIGGERS(SCHED_NAME,TRIGGER_GROUP);
</span></span></span><span class=line><span class=cl><span class=s1>
</span></span></span><span class=line><span class=cl><span class=s1>commit;</span></span></span></code></pre></td></tr></table></div></div><h3 id=常用的表>常用的表</h3><ul><li>qrtz_cron_triggers 存放cron类型的触发器</li><li>qrtz_job_details 存放jobDetail信息</li><li>qrtz_simple_triggers 存放简单类型的触发器</li><li>qrtz_simprop_triggers 存放CalendarIntervalTrigger和DailyTimeIntervalTrigger类型的触发器</li><li>qrtz_triggers 存放触发器基本信息</li><li>qrtz_locks 存放锁信息</li><li>qrtz_scheduler_state 存放调度器状态</li></ul><h3 id=yml-配置>yml 配置</h3><div class=highlight id=id-12><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=w> </span><span class=nt>spring</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>quartz</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c>#相关属性配置</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>properties</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>org</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>quartz</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>scheduler</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>instanceName</span><span class=p>:</span><span class=w> </span><span class=l>clusteredScheduler</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>instanceId</span><span class=p>:</span><span class=w> </span><span class=l>AUTO</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>jobStore</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>class</span><span class=p>:</span><span class=w> </span><span class=l>org.quartz.impl.jdbcjobstore.JobStoreTX</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>driverDelegateClass</span><span class=p>:</span><span class=w> </span><span class=l>org.quartz.impl.jdbcjobstore.StdJDBCDelegate</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>tablePrefix</span><span class=p>:</span><span class=w> </span><span class=l>QRTZ_</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>isClustered</span><span class=p>:</span><span class=w> </span><span class=kc>true</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>clusterCheckinInterval</span><span class=p>:</span><span class=w> </span><span class=m>10000</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>useProperties</span><span class=p>:</span><span class=w> </span><span class=kc>false</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>threadPool</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>class</span><span class=p>:</span><span class=w> </span><span class=l>org.quartz.simpl.SimpleThreadPool</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>threadCount</span><span class=p>:</span><span class=w> </span><span class=m>15</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>threadPriority</span><span class=p>:</span><span class=w> </span><span class=m>5</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>threadsInheritContextClassLoaderOfInitializingThread</span><span class=p>:</span><span class=w> </span><span class=kc>true</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c>#数据库方式</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>job-store-type</span><span class=p>:</span><span class=w> </span><span class=l>jdbc</span></span></span></code></pre></td></tr></table></div></div><h3 id=核心代码-1>核心代码</h3><div class=highlight id=id-13><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=c1>// 定时任务和消息通知模块</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>scheduleStartAndEnd</span><span class=p>(</span><span class=n>Long</span><span class=w> </span><span class=n>redId</span><span class=p>,</span><span class=w> </span><span class=n>Date</span><span class=w> </span><span class=n>startTime</span><span class=p>,</span><span class=w> </span><span class=n>Date</span><span class=w> </span><span class=n>endTime</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>scheduleStart</span><span class=p>(</span><span class=n>redId</span><span class=p>,</span><span class=w> </span><span class=n>startTime</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// 留一定时间给用户传输时延</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>scheduleEnd</span><span class=p>(</span><span class=n>redId</span><span class=p>,</span><span class=w> </span><span class=n>DateUtil</span><span class=p>.</span><span class=na>offsetSecond</span><span class=p>(</span><span class=n>endTime</span><span class=p>,</span><span class=w> </span><span class=n>waitUserOffset</span><span class=p>));</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w> </span><span class=k>catch</span><span class=w> </span><span class=p>(</span><span class=n>Exception</span><span class=w> </span><span class=n>e</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>log</span><span class=p>.</span><span class=na>error</span><span class=p>(</span><span class=n>e</span><span class=p>.</span><span class=na>getMessage</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>scheduleStart</span><span class=p>(</span><span class=n>Long</span><span class=w> </span><span class=n>redId</span><span class=p>,</span><span class=w> </span><span class=n>Date</span><span class=w> </span><span class=n>time</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>log</span><span class=p>.</span><span class=na>info</span><span class=p>(</span><span class=s>&#34;创建定时任务-通知开始抢红包&#34;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>redId</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>time</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// 创建一个JobDetail，用于定义任务</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>JobDetail</span><span class=w> </span><span class=n>jobDetail</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>JobBuilder</span><span class=p>.</span><span class=na>newJob</span><span class=p>(</span><span class=n>StartJob</span><span class=p>.</span><span class=na>class</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>.</span><span class=na>usingJobData</span><span class=p>(</span><span class=s>&#34;redId&#34;</span><span class=p>,</span><span class=w> </span><span class=n>redId</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>.</span><span class=na>build</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// 创建一个Trigger，定义任务的执行时间</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>Trigger</span><span class=w> </span><span class=n>trigger</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>TriggerBuilder</span><span class=p>.</span><span class=na>newTrigger</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>.</span><span class=na>withIdentity</span><span class=p>(</span><span class=n>redId</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>START</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>.</span><span class=na>startAt</span><span class=p>(</span><span class=n>time</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>.</span><span class=na>build</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// 调度任务</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>scheduler</span><span class=p>.</span><span class=na>scheduleJob</span><span class=p>(</span><span class=n>jobDetail</span><span class=p>,</span><span class=w> </span><span class=n>trigger</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>TriggerKey</span><span class=w> </span><span class=n>triggerKey</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>TriggerKey</span><span class=p>(</span><span class=n>redId</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>START</span><span class=p>,</span><span class=w> </span><span class=n>redId</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>START</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>log</span><span class=p>.</span><span class=na>info</span><span class=p>(</span><span class=n>scheduler</span><span class=p>.</span><span class=na>getTriggerState</span><span class=p>(</span><span class=n>triggerKey</span><span class=p>).</span><span class=na>name</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w> </span><span class=k>catch</span><span class=w> </span><span class=p>(</span><span class=n>SchedulerException</span><span class=w> </span><span class=n>e</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>log</span><span class=p>.</span><span class=na>error</span><span class=p>(</span><span class=s>&#34;【任务执行异常】&#34;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>e</span><span class=p>.</span><span class=na>getMessage</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>scheduleEnd</span><span class=p>(</span><span class=n>Long</span><span class=w> </span><span class=n>redId</span><span class=p>,</span><span class=w> </span><span class=n>Date</span><span class=w> </span><span class=n>time</span><span class=p>)</span><span class=w> </span><span class=kd>throws</span><span class=w> </span><span class=n>SchedulerException</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>log</span><span class=p>.</span><span class=na>info</span><span class=p>(</span><span class=s>&#34;创建定时任务-结算红包&#34;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>time</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// 创建一个JobDetail，用于定义任务</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>JobDetail</span><span class=w> </span><span class=n>jobDetail</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>JobBuilder</span><span class=p>.</span><span class=na>newJob</span><span class=p>(</span><span class=n>EndJob</span><span class=p>.</span><span class=na>class</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>.</span><span class=na>usingJobData</span><span class=p>(</span><span class=s>&#34;redId&#34;</span><span class=p>,</span><span class=w> </span><span class=n>redId</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>.</span><span class=na>build</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// 创建一个Trigger，定义任务的执行时间</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>Trigger</span><span class=w> </span><span class=n>trigger</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>TriggerBuilder</span><span class=p>.</span><span class=na>newTrigger</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>.</span><span class=na>withIdentity</span><span class=p>(</span><span class=n>redId</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=s>&#34;end&#34;</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>.</span><span class=na>startAt</span><span class=p>(</span><span class=n>time</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>.</span><span class=na>build</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// 调度任务</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>scheduler</span><span class=p>.</span><span class=na>scheduleJob</span><span class=p>(</span><span class=n>jobDetail</span><span class=p>,</span><span class=w> </span><span class=n>trigger</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span></span></span></code></pre></td></tr></table></div></div><h2 id=亮点>亮点</h2><ol><li><p>在即时互动模块，使用WebSocket协议和Netty框架可以显著提高性能、可扩展性和用户体验。采用 websocket 协议进行全双工通信，比 http 协议具有更低的延迟，并且节约了带宽。Netty 使用异步和事件驱动的编程模型，这意味着它可以处理大量的并发连接而不会阻塞主线程。此外，Netty 还提供了一些安全性特性，可以帮助WebSocket连接免受各种网络攻击，例如DDoS攻击和WebSocket协议的安全漏洞。</p></li><li><p>对于抢红包这一核心业务，我们既需要缓存来实现低延迟，又需要保证缓存服务的可靠性，于是选择采用Redis 集群这一技术方案。哨兵机制是实现 Redis 不间断服务的重要保证。具体来说，主从集群的数据同步，是数据可靠的基础保证；而在主库发生故障时，自动的主从切换是服务不间断的关键支撑。Redis 的哨兵机制自动完成了监控、选主、通知这三大功能，从而实现了主从库的自动切换，可以降低 Redis 集群的运维开销：</p><ol><li>监控主库运行状态，并判断主库是否客观下线；</li><li>在主库客观下线后，选取新主库；</li><li>选出新主库后，通知从库和客户端。</li></ol><p>为了降低误判率，在实际应用时，哨兵机制通常采用多实例的方式进行部署，多个哨兵实例通过“少数服从多数”的原则，来判断主库是否客观下线。一般来说，我们可以部署三个哨兵，如果有两个哨兵认定主库“主观下线”，就可以开始切换过程。</p></li></ol><p><a class=lightgallery href=https://publicpictures.oss-cn-hangzhou.aliyuncs.com/img/efcfa517d0f09d057be7da32a84cf2a1.jpg data-thumbnail=https://publicpictures.oss-cn-hangzhou.aliyuncs.com/img/efcfa517d0f09d057be7da32a84cf2a1.jpg data-sub-html="<h2>img</h2>"><img loading=lazy src=https://publicpictures.oss-cn-hangzhou.aliyuncs.com/img/efcfa517d0f09d057be7da32a84cf2a1.jpg srcset="https://publicpictures.oss-cn-hangzhou.aliyuncs.com/img/efcfa517d0f09d057be7da32a84cf2a1.jpg, https://publicpictures.oss-cn-hangzhou.aliyuncs.com/img/efcfa517d0f09d057be7da32a84cf2a1.jpg 1.5x, https://publicpictures.oss-cn-hangzhou.aliyuncs.com/img/efcfa517d0f09d057be7da32a84cf2a1.jpg 2x" sizes=auto data-title=img data-alt=img style="background:url(/svg/loading.min.svg)no-repeat 50%" onload='this.title=this.dataset.title,this.alt=this.dataset.alt;for(const e of["style","data-title","data-alt","onerror","onload"])this.removeAttribute(e);this.dataset.lazyloaded=""' onerror='this.title=this.dataset.title,this.alt=this.dataset.alt;for(const e of["style","data-title","data-alt","onerror","onload"])this.removeAttribute(e)'></a></p><p><a class=lightgallery href=https://publicpictures.oss-cn-hangzhou.aliyuncs.com/img/1945703abf16ee14e2f7559873e4e60d.jpg data-thumbnail=https://publicpictures.oss-cn-hangzhou.aliyuncs.com/img/1945703abf16ee14e2f7559873e4e60d.jpg data-sub-html="<h2>img</h2>"><img loading=lazy src=https://publicpictures.oss-cn-hangzhou.aliyuncs.com/img/1945703abf16ee14e2f7559873e4e60d.jpg srcset="https://publicpictures.oss-cn-hangzhou.aliyuncs.com/img/1945703abf16ee14e2f7559873e4e60d.jpg, https://publicpictures.oss-cn-hangzhou.aliyuncs.com/img/1945703abf16ee14e2f7559873e4e60d.jpg 1.5x, https://publicpictures.oss-cn-hangzhou.aliyuncs.com/img/1945703abf16ee14e2f7559873e4e60d.jpg 2x" sizes=auto data-title=img data-alt=img style="background:url(/svg/loading.min.svg)no-repeat 50%" onload='this.title=this.dataset.title,this.alt=this.dataset.alt;for(const e of["style","data-title","data-alt","onerror","onload"])this.removeAttribute(e);this.dataset.lazyloaded=""' onerror='this.title=this.dataset.title,this.alt=this.dataset.alt;for(const e of["style","data-title","data-alt","onerror","onload"])this.removeAttribute(e)'></a></p><p><a class=lightgallery href=https://publicpictures.oss-cn-hangzhou.aliyuncs.com/img/f2e9b8830db46d959daa6a39fbf4a14c.jpg data-thumbnail=https://publicpictures.oss-cn-hangzhou.aliyuncs.com/img/f2e9b8830db46d959daa6a39fbf4a14c.jpg data-sub-html="<h2>img</h2>"><img loading=lazy src=https://publicpictures.oss-cn-hangzhou.aliyuncs.com/img/f2e9b8830db46d959daa6a39fbf4a14c.jpg srcset="https://publicpictures.oss-cn-hangzhou.aliyuncs.com/img/f2e9b8830db46d959daa6a39fbf4a14c.jpg, https://publicpictures.oss-cn-hangzhou.aliyuncs.com/img/f2e9b8830db46d959daa6a39fbf4a14c.jpg 1.5x, https://publicpictures.oss-cn-hangzhou.aliyuncs.com/img/f2e9b8830db46d959daa6a39fbf4a14c.jpg 2x" sizes=auto data-title=img data-alt=img style="background:url(/svg/loading.min.svg)no-repeat 50%" onload='this.title=this.dataset.title,this.alt=this.dataset.alt;for(const e of["style","data-title","data-alt","onerror","onload"])this.removeAttribute(e);this.dataset.lazyloaded=""' onerror='this.title=this.dataset.title,this.alt=this.dataset.alt;for(const e of["style","data-title","data-alt","onerror","onload"])this.removeAttribute(e)'></a></p></div><div class=post-footer id=post-footer><div class=post-info><div class=post-info-line><div class=post-info-mod><span title="更新于 2023-09-17 10:13:57">更新于 2023-09-17&nbsp;</span></div><div class=post-info-license><span><a rel="license external nofollow noopener noreferrer" href=https://creativecommons.org/licenses/by-nc/4.0/ target=_blank>CC BY-NC 4.0</a></span></div></div><div class=post-info-line><div class=post-info-md></div><div class=post-info-share><span><a href=javascript:void(0); title="分享到 微博" data-sharer=weibo data-url=https://leni.fun/%E7%BA%A2%E5%8C%85%E9%9B%A8/ data-title=红包雨 data-image=/images/pic14.jpg><i class="fa-brands fa-weibo fa-fw" aria-hidden=true></i></a></span></div></div></div><div class=post-info-more><section class=post-tags><i class="fa-solid fa-tags fa-fw me-1" aria-hidden=true></i><a href=/tags/%E9%A1%B9%E7%9B%AE%E8%AE%B0%E5%BD%95/ class=post-tag>项目记录</a></section><section><span><a href=javascript:void(0); onclick=window.history.back()>返回</a></span>&nbsp;|&nbsp;<span><a href=/>主页</a></span></section></div><div class=post-nav><a href=/spring/ class=post-nav-item rel=prev title=🚩Spring><i class="fa-solid fa-angle-left fa-fw" aria-hidden=true></i>🚩Spring</a>
<a href=/%E7%BA%A2%E5%8C%85%E9%9B%A8ppt/ class=post-nav-item rel=next title="红包雨 PPT 分享">红包雨 PPT 分享<i class="fa-solid fa-angle-right fa-fw" aria-hidden=true></i></a></div></div></article></main><footer class=footer><div class=footer-container><div class="footer-line copyright order-5" itemscope itemtype=http://schema.org/CreativeWork><i class="fa-regular fa-copyright fa-fw" aria-hidden=true></i>
<span itemprop=copyrightYear>2021 - 2024</span><span class=author itemprop=copyrightHolder>
<a href=/>都将会</a></span><span class="license footer-divider"><a rel="license external nofollow noopener noreferrer" href=https://beian.miit.gov.cn target=_blank>浙ICP备2023023782号</a></span></div><div class="footer-line statistics"><span class=site-time title=网站运行中……><i class="fa-solid fa-heartbeat fa-fw animate-icon" aria-hidden=true></i><span class="run-times ms-1">网站运行中……</span></span></div><div class="footer-line visitor order-4"><span id=busuanzi_container_site_uv title=总访客数><i class="fa-regular fa-user fa-fw" aria-hidden=true></i>&nbsp;<span id=busuanzi_value_site_uv><i class="fa-solid fa-spinner fa-spin fa-fw" aria-hidden=true></i></span></span><span id=busuanzi_container_site_pv class=footer-divider title=总访问量><i class="fa-regular fa-eye fa-fw" aria-hidden=true></i>&nbsp;<span id=busuanzi_value_site_pv><i class="fa-solid fa-spinner fa-spin fa-fw" aria-hidden=true></i></span></span></div></div></footer></div><div class=widgets><div class="fixed-buttons animate__faster d-none"><div class="fixed-button back-to-top" role=button aria-label=回到顶部><i class="fa-solid fa-arrow-up fa-fw" aria-hidden=true></i><span class=variant-numeric>0%</span></div></div><a href=https://github.com/hihihiman/hihihiman.github.io title=博客源码 target=_blank rel="external nofollow" class="github-corner left d-none-mobile"><svg viewBox="0 0 250 250" aria-hidden="true"><path d="M0 0 115 115h15l12 27L250 250V0z"/><path d="M128.3 109C113.8 99.7 119 89.6 119 89.6 122 82.7 120.5 78.6 120.5 78.6 119.2 72 123.4 76.3 123.4 76.3 127.3 80.9 125.5 87.3 125.5 87.3 122.9 97.6 130.6 101.9 134.4 103.2" fill="currentcolor" style="transform-origin:130px 106px" class="octo-arm"/><path d="M115 115C114.9 115.1 118.7 116.5 119.8 115.4l13.9-13.8C136.9 99.2 139.9 98.4 142.2 98.6 133.8 88 127.5 74.4 143.8 58 148.5 53.4 154 51.2 159.7 51 160.3 49.4 163.2 43.6 171.4 40.1 171.4 40.1 176.1 42.5 178.8 56.2 183.1 58.6 187.2 61.8 190.9 65.4 194.5 69 197.7 73.2 200.1 77.6 213.8 80.2 216.3 84.9 216.3 84.9 212.7 93.1 206.9 96 205.4 96.6 205.1 102.4 203 107.8 198.3 112.5 181.9 128.9 168.3 122.5 157.7 114.1 157.9 116.9 156.7 120.9 152.7 124.9L141 136.5C139.8 137.7 141.6 141.9 141.8 141.8z" fill="currentcolor" class="octo-body"/></svg></a><div id=mask></div><div class=reading-progress-bar style=left:0;bottom:0></div><noscript><div class=noscript-warning>FixIt 主题在启用 JavaScript 的情况下效果最佳。</div></noscript></div><link rel=stylesheet href=/lib/lightgallery/css/lightgallery-bundle.min.css><link rel=stylesheet href=/lib/katex/katex.min.css><link rel=stylesheet href=/lib/cookieconsent/cookieconsent.min.css><link rel=stylesheet href=/lib/pace/themes/pink/pace-theme-center-atom.css><script src=/lib/autocomplete/autocomplete.min.js defer></script><script src=/lib/fuse/fuse.min.js defer></script><script src=/lib/lightgallery/lightgallery.min.js defer></script><script src=/lib/lightgallery/plugins/thumbnail/lg-thumbnail.min.js defer></script><script src=/lib/lightgallery/plugins/zoom/lg-zoom.min.js defer></script><script src=/lib/sharer/sharer.min.js async defer></script><script src=/lib/typeit/index.umd.js defer></script><script src=/lib/katex/katex.min.js defer></script><script src=/lib/katex/auto-render.min.js defer></script><script src=/lib/katex/copy-tex.min.js defer></script><script src=/lib/katex/mhchem.min.js defer></script><script src=/lib/cookieconsent/cookieconsent.min.js defer></script><script src=/lib/pangu/pangu.min.js defer></script><script src=//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js async defer></script><script src=/lib/pace/pace.min.js async defer></script><script>window.config={autoBookmark:!0,code:{copyTitle:"复制到剪贴板",editLockTitle:"锁定可编辑代码块",editUnLockTitle:"解锁可编辑代码块",editable:!0,maxShownLines:1024},comment:{enable:!1},cookieconsent:{content:{dismiss:"同意",link:"了解更多",message:"本网站使用 Cookies 来改善您的浏览体验。"},enable:!0,palette:{button:{background:"#f0f0f0"},popup:{background:"#1aa3ff"}},theme:"edgeless"},data:{"typeit-header-subtitle-desktop":"的博客           ","typeit-header-subtitle-mobile":"的博客           "},enablePWA:!0,lightgallery:!0,math:{delimiters:[{display:!0,left:"$$",right:"$$"},{display:!0,left:"\\[",right:"\\]"},{display:!0,left:"\\begin{equation}",right:"\\end{equation}"},{display:!0,left:"\\begin{equation*}",right:"\\end{equation*}"},{display:!0,left:"\\begin{align}",right:"\\end{align}"},{display:!0,left:"\\begin{align*}",right:"\\end{align*}"},{display:!0,left:"\\begin{alignat}",right:"\\end{alignat}"},{display:!0,left:"\\begin{alignat*}",right:"\\end{alignat*}"},{display:!0,left:"\\begin{gather}",right:"\\end{gather}"},{display:!0,left:"\\begin{CD}",right:"\\end{CD}"},{display:!1,left:"$",right:"$"},{display:!1,left:"\\(",right:"\\)"}],strict:!1},pangu:{enable:!0,selector:"article"},search:{distance:100,findAllMatches:!1,highlightTag:"em",ignoreFieldNorm:!0,ignoreLocation:!0,isCaseSensitive:!1,location:0,maxResultLength:10,minMatchCharLength:2,noResultsFound:"没有找到结果",snippetLength:50,threshold:.3,useExtendedSearch:!0},siteTime:"2021-08-26T23:31:00+08:00",typeit:{cursorChar:"_",cursorSpeed:1e3,data:{"typeit-header-subtitle-desktop":["typeit-header-subtitle-desktop"],"typeit-header-subtitle-mobile":["typeit-header-subtitle-mobile"]},duration:-1,loop:!0,speed:150}}</script><script src=/js/theme.min.js defer></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/jquery@2.1.3/dist/jquery.min.js></script><script type=text/javascript src=/js/custom.js></script></body></html>
<!doctype html><html itemscope itemtype=http://schema.org/WebPage lang=zh-CN><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1,maximum-scale=2"><meta name=robots content="noodp"><title>🚩JUC - </title><meta name=author content="都将会"><meta name=author-link content><meta name=description content="“”"><meta name=keywords content="JUC,Java,interview,面试"><meta itemprop=name content="🚩JUC"><meta itemprop=description content="“”"><meta itemprop=datePublished content="2023-03-08T08:08:08+08:00"><meta itemprop=dateModified content="2023-03-08T08:08:08+08:00"><meta itemprop=wordCount content="3877"><meta itemprop=image content="https://leni.fun/images/avatar.jpg"><meta itemprop=keywords content="Java,"><meta property="og:title" content="🚩JUC"><meta property="og:description" content="“”"><meta property="og:type" content="article"><meta property="og:url" content="https://leni.fun/juc/"><meta property="og:image" content="https://leni.fun/images/avatar.jpg"><meta property="article:section" content="posts"><meta property="article:published_time" content="2023-03-08T08:08:08+08:00"><meta property="article:modified_time" content="2023-03-08T08:08:08+08:00"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://leni.fun/images/avatar.jpg"><meta name=twitter:title content="🚩JUC"><meta name=twitter:description content="“”"><meta name=application-name content="都将会的 APP"><meta name=apple-mobile-web-app-title content="都将会的 APP"><meta name=theme-color data-light=#f8f8f8 data-dark=#252627 content="#f8f8f8"><meta name=msapplication-TileColor content="#da532c"><link rel="shortcut icon" type=image/x-icon href=/favicon.ico><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=mask-icon href=/safari-pinned-tab.svg color=#5bbad5><link rel=manifest href=/site.webmanifest><link rel=canonical href=https://leni.fun/juc/><link rel=prev href=https://leni.fun/linux/><link rel=next href=https://leni.fun/juc-%E7%BB%8F%E5%85%B8%E4%BB%A3%E7%A0%81/><link rel=stylesheet href=/css/style.min.css><link rel=stylesheet href=/lib/fontawesome-free/all.min.css><link rel=stylesheet href=/lib/animate/animate.min.css><script type=application/ld+json>{"@context":"http://schema.org","@type":"BlogPosting","headline":"🚩JUC","inLanguage":"zh-CN","mainEntityOfPage":{"@type":"WebPage","@id":"https:\/\/leni.fun\/juc\/"},"genre":"posts","keywords":"Java","wordcount":3877,"url":"https:\/\/leni.fun\/juc\/","datePublished":"2023-03-08T08:08:08+08:00","dateModified":"2023-03-08T08:08:08+08:00","publisher":{"@type":"Organization","name":""},"author":{"@type":"Person","name":"都将会"},"description":"“”"}</script></head><body data-header-desktop=sticky data-header-mobile=auto><script>(window.localStorage?.getItem("theme")?localStorage.getItem("theme")==="dark":"dark"==="auto"?window.matchMedia("(prefers-color-scheme: dark)").matches:"dark"==="dark")&&document.body.setAttribute("data-theme","dark")</script><div class=wrapper data-page-style=normal><header class="desktop animate__faster" id=header-desktop><div class=header-wrapper data-github-corner=left><div class=header-title><a href=/ title><img loading=lazy src=/images/icon.png srcset="/images/icon.png, /images/icon.png 1.5x, /images/icon.png 2x" sizes=auto data-title=/images/icon.png data-alt=/images/icon.png class=logo style="background:url(/svg/loading.min.svg)no-repeat 50%" onload='this.title=this.dataset.title,this.alt=this.dataset.alt;for(const e of["style","data-title","data-alt","onerror","onload"])this.removeAttribute(e);this.dataset.lazyloaded=""' onerror='this.title=this.dataset.title,this.alt=this.dataset.alt;for(const e of["style","data-title","data-alt","onerror","onload"])this.removeAttribute(e)'><span class=header-title-text>都将会</span></a><span id=typeit-header-subtitle-desktop class="typeit header-subtitle"></span></div><nav><ul class=menu><li class="menu-item has-children"><a class=menu-link href=/posts/><i class="fa-solid fa-archive fa-fw fa-sm" aria-hidden=true></i> 技术</a><i class="dropdown-icon fa-solid fa-chevron-down" aria-hidden=true></i><ul class=sub-menu><li class=menu-item><a class=menu-link href=/categories/><i class="fa-solid fa-th fa-fw fa-sm" aria-hidden=true></i> 分类</a></li><li class=menu-item><a class=menu-link href=/tags/><i class="fa-solid fa-tags fa-fw fa-sm" aria-hidden=true></i> 标签</a></li></ul></li><li class=menu-item><a class=menu-link href=/life/><i class="fa-solid fa-camera-alt fa-fw fa-sm" aria-hidden=true></i> 生活</a></li><li class=menu-item><a class=menu-link href=/friends/><i class="fa-solid fa-users fa-fw fa-sm" aria-hidden=true></i> 友链</a></li><li class=menu-item><a class=menu-link href=/about/><i class="fa-solid fa-info-circle fa-fw fa-sm" aria-hidden=true></i> 关于</a></li><li class="menu-item delimiter"></li><li class="menu-item search" id=search-desktop><input type=text placeholder=关键词搜索 id=search-input-desktop>
<a href=javascript:void(0); class="search-button search-toggle" id=search-toggle-desktop title=搜索><i class="fa-solid fa-search fa-fw" aria-hidden=true></i>
</a><a href=javascript:void(0); class="search-button search-clear" id=search-clear-desktop title=清空><i class="fa-solid fa-times-circle fa-fw" aria-hidden=true></i>
</a><span class="search-button search-loading" id=search-loading-desktop><i class="fa-solid fa-spinner fa-fw fa-spin" aria-hidden=true></i></span></li><li class="menu-item theme-switch" title=切换主题><i class="fa-solid fa-adjust fa-fw" aria-hidden=true></i></li></ul></nav></div></header><header class="mobile animate__faster" id=header-mobile><div class=header-container><div class=header-wrapper><div class=header-title><a href=/ title><img loading=lazy src=/images/icon.png srcset="/images/icon.png, /images/icon.png 1.5x, /images/icon.png 2x" sizes=auto data-title=/images/icon.png data-alt=/images/icon.png class=logo style="background:url(/svg/loading.min.svg)no-repeat 50%" onload='this.title=this.dataset.title,this.alt=this.dataset.alt;for(const e of["style","data-title","data-alt","onerror","onload"])this.removeAttribute(e);this.dataset.lazyloaded=""' onerror='this.title=this.dataset.title,this.alt=this.dataset.alt;for(const e of["style","data-title","data-alt","onerror","onload"])this.removeAttribute(e)'><span class=header-title-text>都将会</span></a><span id=typeit-header-subtitle-mobile class="typeit header-subtitle"></span></div><div class=menu-toggle id=menu-toggle-mobile><span></span><span></span><span></span></div></div><nav><ul class=menu id=menu-mobile><li class=search-wrapper><div class="search mobile" id=search-mobile><input type=text placeholder=关键词搜索 id=search-input-mobile>
<a href=javascript:void(0); class="search-button search-toggle" id=search-toggle-mobile title=搜索><i class="fa-solid fa-search fa-fw" aria-hidden=true></i>
</a><a href=javascript:void(0); class="search-button search-clear" id=search-clear-mobile title=清空><i class="fa-solid fa-times-circle fa-fw" aria-hidden=true></i>
</a><span class="search-button search-loading" id=search-loading-mobile><i class="fa-solid fa-spinner fa-fw fa-spin" aria-hidden=true></i></span></div><a href=javascript:void(0); class=search-cancel id=search-cancel-mobile>取消</a></li><li class=menu-item><span class=nested-item><a class=menu-link href=/posts/><i class="fa-solid fa-archive fa-fw fa-sm" aria-hidden=true></i> 技术</a>
<i class="dropdown-icon fa-solid fa-chevron-right" aria-hidden=true></i></span><ul class=sub-menu><li class=menu-item><a class=menu-link href=/categories/><i class="fa-solid fa-th fa-fw fa-sm" aria-hidden=true></i> 分类</a></li><li class=menu-item><a class=menu-link href=/tags/><i class="fa-solid fa-tags fa-fw fa-sm" aria-hidden=true></i> 标签</a></li></ul></li><li class=menu-item><a class=menu-link href=/life/><i class="fa-solid fa-camera-alt fa-fw fa-sm" aria-hidden=true></i> 生活</a></li><li class=menu-item><a class=menu-link href=/friends/><i class="fa-solid fa-users fa-fw fa-sm" aria-hidden=true></i> 友链</a></li><li class=menu-item><a class=menu-link href=/about/><i class="fa-solid fa-info-circle fa-fw fa-sm" aria-hidden=true></i> 关于</a></li><li class="menu-item menu-system"><span class="menu-system-item theme-switch" title=切换主题><i class="fa-solid fa-adjust fa-fw" aria-hidden=true></i></span></li></ul></nav></div></header><div class="search-dropdown desktop"><div id=search-dropdown-desktop></div></div><div class="search-dropdown mobile"><div id=search-dropdown-mobile></div></div><nav aria-label=breadcrumb class="breadcrumb-container sticky"><ol class=breadcrumb><li class=breadcrumb-item><a href=/ title>主页</a></li><li class=breadcrumb-item><a href=/posts/ title=Posts>Posts</a></li><li class="breadcrumb-item active" aria-current=page>🚩JUC</li></ol></nav><main class=container><aside class=toc id=toc-auto><h2 class=toc-title>目录&nbsp;<i class="toc-icon fa-solid fa-angle-down fa-fw" aria-hidden=true></i></h2><div class=toc-content id=toc-content-auto></div></aside><aside class=aside-custom></aside><article class="page single"><div class=header><h1 class="single-title animate__animated animate__flipInX"><span>🚩JUC</span></h1></div><div class=post-meta><div class=post-meta-line><span class=post-author><span class=author><img loading=lazy src=/images/avatar.jpg srcset="/images/avatar.jpg, /images/avatar.jpg 1.5x, /images/avatar.jpg 2x" sizes=auto data-title=都将会 data-alt=都将会 class=avatar style="background:url(/svg/loading.min.svg)no-repeat 50%" onload='this.title=this.dataset.title,this.alt=this.dataset.alt;for(const e of["style","data-title","data-alt","onerror","onload"])this.removeAttribute(e);this.dataset.lazyloaded=""' onerror='this.title=this.dataset.title,this.alt=this.dataset.alt;for(const e of["style","data-title","data-alt","onerror","onload"])this.removeAttribute(e)'>&nbsp;都将会</span></span>
<span class=post-category>收录于 <a href=/categories/interview/><i class="fa-regular fa-folder fa-fw" aria-hidden=true></i> interview</a></span></div><div class=post-meta-line><span title="发布于 2023-03-08 08:08:08"><i class="fa-regular fa-calendar-alt fa-fw me-1" aria-hidden=true></i><time datetime=2023-03-08>2023-03-08</time></span>&nbsp;<span title="更新于 2023-03-08 08:08:08"><i class="fa-regular fa-edit fa-fw me-1" aria-hidden=true></i><time datetime=2023-03-08>2023-03-08</time></span>&nbsp;<span><i class="fa-solid fa-pencil-alt fa-fw me-1" aria-hidden=true></i>约 3877 字</span>&nbsp;<span><i class="fa-regular fa-clock fa-fw me-1" aria-hidden=true></i>预计阅读 8 分钟</span>&nbsp;<span id=busuanzi_container_page_pv class="busuanzi_visitors comment-visitors" data-flag-title=🚩JUC>
<i class="fa-regular fa-eye fa-fw me-1" aria-hidden=true></i><span id=busuanzi_value_page_pv>-</span>&nbsp;次阅读
</span>&nbsp;</div></div><div class="details toc" id=toc-static data-kept=false><div class="details-summary toc-title"><span>目录</span>
<span><i class="details-icon fa-solid fa-angle-right" aria-hidden=true></i></span></div><div class="details-content toc-content" id=toc-content-static><nav id=TableOfContents><ul><li><ul><li><a href=#进程-vs-线程>进程 vs 线程？</a></li><li><a href=#并行-vs-并发>并行 vs 并发？</a></li><li><a href=#创建线程的方式>🌟创建线程的方式？</a><ul><li><a href=#executors-和-threadpoolexecutors-的区别和联系>Executors 和 ThreadPoolExecutors 的区别和联系？</a></li><li><a href=#线程池使用场景>线程池使用场景</a></li></ul></li><li><a href=#java-线程的状态>Java 线程的状态</a><ul><li><a href=#objectwait-vs-threadsleeplong->🌟Object.wait() vs Thread.sleep(long) ？</a></li><li><a href=#如何停止线程>如何停止线程？</a></li></ul></li><li><a href=#synchronized>🌟synchronized</a><ul><li><a href=#synchronized-中的锁>synchronized 中的锁</a></li><li><a href=#hotspot-jvm-中对象存储锁的方式>Hotspot JVM 中对象存储锁的方式</a></li><li><a href=#lock-和-synchronized-的区别>Lock 和 synchronized 的区别？</a></li></ul></li><li><a href=#死锁诊断>死锁诊断</a></li><li><a href=#volatile>🌟volatile</a></li><li><a href=#aqs--abstractqueuedsynchronizer-抽象队列同步器>🌟AQS = AbstractQueuedSynchronizer 抽象队列同步器</a><ul><li><a href=#aqs和-synchronized-的区别>AQS和 synchronized 的区别？</a></li><li><a href=#线程并发时同步队列的放入情况>线程并发时同步队列的放入情况</a></li><li><a href=#使用场景>使用场景</a></li></ul></li><li><a href=#threadlocal>ThreadLocal</a><ul><li><a href=#使用场景-1>使用场景</a></li><li><a href=#强软弱虚引用>强、软、弱、虚引用</a></li><li><a href=#内存泄漏问题>内存泄漏问题</a></li></ul></li><li><a href=#forkjoin-框架>Fork/Join 框架</a><ul><li><a href=#构造函数>构造函数</a></li><li><a href=#任务提交方式>任务提交方式</a></li><li><a href=#使用场景-2>使用场景</a></li></ul></li><li><a href=#参考资料>参考资料</a></li></ul></li></ul></nav></div></div><div class=content id=content><blockquote><p>JUC = java.util.concurrent</p></blockquote><h3 id=进程-vs-线程>进程 vs 线程？</h3><ol><li>进程是正在运行程序的实例（多开软件 = 多实例进程），包含了线程</li><li>进程是分配资源的基本单位，同一进程下所有线程共享内存空间</li><li>切换线程成本 &lt; 切换进程</li><li>容器的本质是进程。</li></ol><h3 id=并行-vs-并发>并行 vs 并发？</h3><ul><li>并发：同一时间，<strong>多个线程轮流使用 CPU</strong>，Java 并发有三大特性<ul><li><strong>原子性</strong>：锁</li><li><strong>可见性</strong>：一个线程修改共享变量对其他线程可见（volatile）</li><li><strong>有序性</strong>：防止先读和后写（volatile）</li></ul></li><li>并行：4 核 CPU 同时执行 4 个线程</li></ul><h3 id=创建线程的方式>🌟创建线程的方式？</h3><ol><li>extends Thread @override run()</li><li>implements Runnable @override run() 无返回值，不可抛异常</li><li>implements Callable @ovverride call() 有返回值，可抛异常<ol><li>FutureTask&lt;> ft; ft.get() 异步获得结果</li></ol></li><li>线程池</li></ol><h4 id=executors-和-threadpoolexecutors-的区别和联系>Executors 和 ThreadPoolExecutors 的区别和联系？</h4><p>ThreadPoolExecutor 是线程池的核心实现，有 7 大参数：
public ThreadPoolExecutor(</p><ol><li><p>int corePoolSize 核心线程数，对于 N 核（逻辑处理器） CPU</p><ol><li><strong>IO 密集型：2N+1</strong>，读写请求任务时间长</li><li><strong>CPU 密集型：N+1</strong>，计算、Bitmap 转换，高并发，减少切换上下文</li></ol><blockquote><p>+1的目的是为了确保在不同类型的工作负载下都有一个额外的线程可供使用，以提高系统的性能和资源利用率。</p></blockquote></li><li><p>int maximumPoolSize 最大（核心+救急）线程数</p></li><li><p>long keepAliveTime 救急线程生存时间值</p></li><li><p>TimeUnit unit 救急线程生存时间单位</p></li><li><p>BlockingQueue<runnable> queue 阻塞队列，满了创建救急线程</p><ol><li>ArrayBlockingQueue 数组 FIFO（饿加载），入队出队锁住整个队列</li><li>LinkedBlockingQueue 链表 FIFO（懒加载），首尾有两把锁，入队出队互不影响，效率高</li><li>DelayedWorkQueue 出队执行时间靠前的</li><li>SynchronousQueue：每次插入都等待移出，不存储元素</li></ol></li><li><p>ThreadFactory threadFactory 定义线程名、是否是守护线程</p></li><li><p>RejectedExecutionHandler handler 当线程和阻塞队列都忙时，触发的拒绝策略</p><ol><li>AbortPolicy 抛异常（默认）</li><li>CallerRunsPolicy 调用者所在线程执行</li><li>DiscardOldestPolicy 丢弃阻塞队列最久任务</li><li>DiscardPolicy 丢弃当前任务</li></ol></li></ol><p>Executors 是一个工具类，提供了一些快速创建线程池的静态方法，但<strong>不推荐使用</strong>，原因：
线程池或请求队列长度 = Integer.MAX_VALUE 没做限制，会导致 OOM。</p><ul><li>newCachedThreadPool()：它会试图<strong>缓存线程</strong>并重用，当无缓存线程可用时，就会创建新的工作线程；用来处理大量短时间工作任务。其内部使用 <strong>SynchronousQueue</strong> 作为工作队列。</li><li>newFixedThreadPool(int nThreads)：固定线程数，用于任务量已知且相对耗时的场景。</li><li>newSingleThreadExecutor()：单线程，顺序执行任务</li><li>newSingleThreadScheduledExecutor() 和 newScheduledThreadPool(int corePoolSize)，创建的是个 ScheduledExecutorService，可以进行<strong>定时或周期性</strong>的工作调度，区别在于单一工作线程还是多个工作线程。</li><li>newWorkStealingPool(int parallelism)，这是一个经常被人忽略的线程池，<strong>Java 8</strong> 才加入这个创建方法，其<strong>内部会构建ForkJoinPool</strong>，利用Work-Stealing算法，<strong>并行地处理任务，不保证处理顺序</strong>。</li></ul><h4 id=线程池使用场景>线程池使用场景</h4><ol><li><strong>数据迁移</strong>：MySQL -> es 用到了 CountDownLatch + 线程池，初始值设为查询总页数，每页 ctl.countDown()，最终 countDownLatch.await() 等待计数归零</li><li>数据汇总：并行执行没有依赖关系的接口，Callable + Future</li><li>异步调用：上级方法不需依赖下级方法的返回值 e.g. <strong>保存搜索历史</strong><ol><li>@EnableAsync class SpringBootApplication</li><li>@Async(&ldquo;taskExecutor&rdquo;)</li></ol></li></ol><h3 id=java-线程的状态>Java 线程的状态</h3><ul><li><code>yield()</code>：使线程进入就绪状态，但不释放锁资源，不会导致阻塞</li><li><code>t.join()</code>：当前线程调用线程t，当前线程不释放锁，t会释放同步锁</li><li><code>notify()</code>：<strong>随机</strong>唤醒在此监视器上等待的线程</li></ul><p><a class=lightgallery href=https://publicpictures.oss-cn-hangzhou.aliyuncs.com/img/2023/08/08/1dba36cf63eb3676a04f33a5373f190d.png data-thumbnail=https://publicpictures.oss-cn-hangzhou.aliyuncs.com/img/2023/08/08/1dba36cf63eb3676a04f33a5373f190d.png data-sub-html="<h2>image.png</h2>"><img loading=lazy src=https://publicpictures.oss-cn-hangzhou.aliyuncs.com/img/2023/08/08/1dba36cf63eb3676a04f33a5373f190d.png srcset="https://publicpictures.oss-cn-hangzhou.aliyuncs.com/img/2023/08/08/1dba36cf63eb3676a04f33a5373f190d.png, https://publicpictures.oss-cn-hangzhou.aliyuncs.com/img/2023/08/08/1dba36cf63eb3676a04f33a5373f190d.png 1.5x, https://publicpictures.oss-cn-hangzhou.aliyuncs.com/img/2023/08/08/1dba36cf63eb3676a04f33a5373f190d.png 2x" sizes=auto data-title=image.png data-alt=image.png style="background:url(/svg/loading.min.svg)no-repeat 50%" onload='this.title=this.dataset.title,this.alt=this.dataset.alt;for(const e of["style","data-title","data-alt","onerror","onload"])this.removeAttribute(e);this.dataset.lazyloaded=""' onerror='this.title=this.dataset.title,this.alt=this.dataset.alt;for(const e of["style","data-title","data-alt","onerror","onload"])this.removeAttribute(e)'></a></p><h4 id=objectwait-vs-threadsleeplong->🌟Object.wait() vs Thread.sleep(long) ？</h4><ol><li><strong>wait() 方法是 Object 类的成员方法，而 sleep() 方法是 Thread 类的静态方法</strong>。在使用 wait() 方法时需要获取对象的监视器锁，而 sleep() 方法不需要。</li><li>wait() 方法会释放对象的<strong>监视器锁</strong>，使得其他线程可以获取该对象的监视器锁并执行同步代码块或同步方法。而 sleep() 方法不会释放任何锁，线程仍然持有之前获取的所有锁。</li><li>wait() 方法必须在 <strong>synchronized 块或方法内部调用</strong>，即在 synchronized 块或方法内部调用 wait() 方法时，当前线程会释放锁并进入等待状态。而 sleep() 方法可以在任何地方调用，不需要持有任何锁。</li><li>wait() 方法会一直等待，直到被 notify() 或 notifyAll() 唤醒，或者等待超时。而 sleep() 方法会暂停线程的执行，等待指定的时间后自动唤醒线程。</li></ol><h4 id=如何停止线程>如何停止线程？</h4><ol><li>正常执行完 run()</li><li>stop() 不推荐</li><li><strong>interrupt 打断</strong>（阻塞会抛异常 InterruptedException），成功后可用 isInterrupt() 判断</li></ol><h3 id=synchronized>🌟synchronized</h3><h4 id=synchronized-中的锁>synchronized 中的锁</h4><ol><li>偏向锁【无竞争】：只被一个线程持有，第一次 CAS（乐观锁），之后判断线程 id
​ 🌟CAS = Compare and Swap（比较并替换）：当且仅当<strong>内存地址V的值</strong>与<strong>预期值A</strong>相等时，将内存地址V的值修改为<strong>目标值B</strong>，否则就什么都不做。<strong>在无锁情况下，保证线程操作共享数据的原子性</strong>，通过自旋锁，调用操作系统底层 CAS 来实现（Unsafe 类），用于 AQS、AtomicXxx。缺点：循环时间长开销很大、只能保证一个共享变量的原子操作、ABA问题。在Java 1.5及之后的版本中，JDK的<code>java.util.concurrent.atomic</code>包提供了<code>AtomicStampedReference</code>类，引入了一个标记 <strong>Stamp</strong>，以解决ABA问题。</li><li>轻量级锁【有竞争】：多线程交替，每次修改都是 CAS 操作，保证原子性</li><li>重量级锁 Monitor【多线程竞争】：悲观锁，由 JVM 提供，C++实现。一旦发生锁竞争，都会变成重量级锁<ol><li>waitSet：waiting 状态的线程集合</li><li>entrySet：BLOCKED 状态的线程集合</li><li>owner：当前获得锁的线程，只有一个</li></ol></li></ol><h4 id=hotspot-jvm-中对象存储锁的方式>Hotspot JVM 中对象存储锁的方式</h4><ul><li>对象头<ul><li>MarkWord（001 无锁，101 偏向锁，00 轻量级锁，10 重量级锁，11 GC）</li><li>KlassWord</li></ul></li><li>实例数据 Object body</li><li>对齐填充</li></ul><h4 id=lock-和-synchronized-的区别>Lock 和 synchronized 的区别？</h4><p>synchronized 是Java 的一个内置关键字，只能实现非公平锁。
Lock 是一个类，有 ReentrantLock、ReentrantReadWriteLock 的实现，可以实现：</p><ol><li>公平锁</li><li>中断试图获取锁的一个线程</li><li>设置超时</li><li>必须手动 <code>unlock()</code>释放，防止死锁</li></ol><p>有竞争时，Lock 性能更好。</p><h3 id=死锁诊断>死锁诊断</h3><blockquote><p>四个必要条件：互斥、请求和保持、不可剥夺、循环等待</p></blockquote><ul><li>jps：JVM 中<strong>进程</strong>状态</li><li>jstack：Java 进程内<strong>线程</strong>的堆栈 <code>jstack -l &lt;进程 id></code></li><li>jconsole：对 JVM 的<strong>内存、线程、类</strong>的监控</li></ul><h3 id=volatile>🌟volatile</h3><p>功能：</p><ol><li>保证线程间的<strong>可见性</strong></li><li><strong>禁止指令重排序</strong>（JIT 即时编译器自动优化，可通过 -Xint 关闭，但不推荐）<ul><li>指令重排是为了减少<strong>流水线中断</strong></li></ul></li></ol><p>用法和原理：</p><ol><li>volatile 修饰的<strong>写变量放在最后</strong>，阻止上方写操作越过屏障</li><li>volatile 修饰的<strong>读变量放在最先</strong>，阻止下方读操作约过屏障</li></ol><p>使用场景：</p><ol><li>DCL 单例</li><li>AQS.state</li></ol><h3 id=aqs--abstractqueuedsynchronizer-抽象队列同步器>🌟AQS = AbstractQueuedSynchronizer 抽象队列同步器</h3><h4 id=aqs和-synchronized-的区别>AQS和 synchronized 的区别？</h4><p>它们都是悲观锁。<strong>AQS 由 Java 实现，手动开启和关闭</strong>，处理竞争有多种方案，synchronized 由 C++ 实现，自动释放锁，遇到竞争就变成重量级锁，性能差。</p><h4 id=线程并发时同步队列的放入情况>线程并发时同步队列的放入情况</h4><p>AQS 有一个 FIFO 队列，head 指向最久元素，tail 指向最新元素，可以实现公平锁和非公平锁：</p><ul><li>公平锁：FIFO</li><li>非公平锁：新元素与队列中元素竞争</li></ul><h4 id=使用场景>使用场景</h4><ol><li>ReentrantLock 可重入锁 = CAS + AQS（extends）<ol><li>exclusiveOwnerThread 当前持有锁的线程，当其为 null 时，唤醒双向队列中的线程</li></ol></li><li>Semaphore：控制某方法并发访问线程数<ol><li><strong>acquire() 请求 -1</strong></li><li><strong>release() 释放 +1</strong></li></ol></li></ol><p>内部状态： volatile state = 0 无锁/1 有锁 ，修改通过 CAS，保证原子性。</p><h3 id=threadlocal>ThreadLocal</h3><p>为每个线程都分配一个独立的线程副本，解决多线程并发访问冲突问题，包含 set、get、remove 方法，key 是 ThreadLocal 自己，放入 ThreadLocalMap 中。</p><h4 id=使用场景-1>使用场景</h4><ol><li>在复杂的链式调用中传递参数：工作中可能会遇到很长的调用链，例如：在A->B->C->D的调用链中，D需要使用A的参数，而为了避免一层层传递参数，可以使用ThreadLocal将参数存储在A中，然后在D中取出使用。</li><li>为每个线程生成独立的随机数或者其他类似的资源：在多线程编程中，可能需要为每个线程生成独享的对象，避免多线程下的竞争条件。例如，给每个线程携带dateFormat。</li></ol><div class=highlight id=id-1><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=w>    </span><span class=kd>static</span><span class=w> </span><span class=n>ThreadLocal</span><span class=o>&lt;</span><span class=n>SimpleDateFormat</span><span class=o>&gt;</span><span class=w> </span><span class=n>dateFormatThreadLocal</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>ThreadLocal</span><span class=p>.</span><span class=na>withInitial</span><span class=p>(()</span><span class=w> </span><span class=o>-&gt;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>new</span><span class=w> </span><span class=n>SimpleDateFormat</span><span class=p>(</span><span class=s>&#34;yyyy-MM-dd HH:mm:ss&#34;</span><span class=p>));</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// ...略</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=n>String</span><span class=w> </span><span class=nf>date</span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>seconds</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>//参数的单位是毫秒，从1970.1.1 00:00:00 GMT计时</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>Date</span><span class=w> </span><span class=n>date</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>Date</span><span class=p>(</span><span class=n>1000</span><span class=w> </span><span class=o>*</span><span class=w> </span><span class=n>seconds</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>SimpleDateFormat</span><span class=w> </span><span class=n>dateFormat</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>dateFormatThreadLocal</span><span class=p>.</span><span class=na>get</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>dateFormat</span><span class=p>.</span><span class=na>format</span><span class=p>(</span><span class=n>date</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span></span></span></code></pre></td></tr></table></div></div><p>ThreadLocal是一种避免共享的设计模式，它是一种<code>无同步方案</code>。其实把dateFormat写在date()里面也是无同步方案，只不过，它叫另一种名字——<code>栈封闭</code></p><h4 id=强软弱虚引用>强、软、弱、虚引用</h4><ul><li>强引用：new，GC Root （<strong>可达性分析</strong>）找不到时回收</li><li>软引用：SoftReference，内存不足时回收</li><li>弱引用：WeakReference，始终回收</li><li>虚引用：ReferenceQueue，由 ReferenceHandler 线程释放</li></ul><h4 id=内存泄漏问题>内存泄漏问题</h4><div class=highlight id=id-2><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>static</span><span class=w> </span><span class=kd>class</span> <span class=nc>Entry</span><span class=w> </span><span class=kd>extends</span><span class=w> </span><span class=n>WeakReference</span><span class=o>&lt;</span><span class=n>ThreadLocal</span><span class=o>&lt;?&gt;&gt;</span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>Object</span><span class=w> </span><span class=n>value</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>Entry</span><span class=p>(</span><span class=n>ThreadLocal</span><span class=o>&lt;?&gt;</span><span class=w> </span><span class=n>k</span><span class=p>,</span><span class=n>Object</span><span class=w> </span><span class=n>v</span><span class=p>){</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kd>super</span><span class=p>(</span><span class=n>k</span><span class=p>);</span><span class=w> </span><span class=c1>// 弱引用，GC 会释放</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>value</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>v</span><span class=p>;</span><span class=w> </span><span class=c1>// 强引用，内存泄漏</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span></span></span></code></pre></td></tr></table></div></div><p>解决方案：手动调用 remove() 方法</p><h3 id=forkjoin-框架>Fork/Join 框架</h3><p><a class=lightgallery href=https://publicpictures.oss-cn-hangzhou.aliyuncs.com/img/java-thread-x-forkjoin-4.png data-thumbnail=https://publicpictures.oss-cn-hangzhou.aliyuncs.com/img/java-thread-x-forkjoin-4.png data-sub-html="<h2>img</h2>"><img loading=lazy src=https://publicpictures.oss-cn-hangzhou.aliyuncs.com/img/java-thread-x-forkjoin-4.png srcset="https://publicpictures.oss-cn-hangzhou.aliyuncs.com/img/java-thread-x-forkjoin-4.png, https://publicpictures.oss-cn-hangzhou.aliyuncs.com/img/java-thread-x-forkjoin-4.png 1.5x, https://publicpictures.oss-cn-hangzhou.aliyuncs.com/img/java-thread-x-forkjoin-4.png 2x" sizes=auto data-title=img data-alt=img style="background:url(/svg/loading.min.svg)no-repeat 50%" onload='this.title=this.dataset.title,this.alt=this.dataset.alt;for(const e of["style","data-title","data-alt","onerror","onload"])this.removeAttribute(e);this.dataset.lazyloaded=""' onerror='this.title=this.dataset.title,this.alt=this.dataset.alt;for(const e of["style","data-title","data-alt","onerror","onload"])this.removeAttribute(e)'></a></p><p>ForkJoinTask 实现了 Future 接口，说明它也是一个可取消的异步运算任务，实际上ForkJoinTask 是 Future 的轻量级实现，主要用在纯粹是计算的函数式任务或者操作完全独立的对象计算任务。fork 是主运行方法，用于异步执行；而 join 方法在任务结果计算完毕之后才会运行，用来合并或返回计算结果。</p><h4 id=构造函数>构造函数</h4><p>在 ForkJoinPool 中我们可以自定义四个参数:</p><ul><li>parallelism: 并行度，默认为CPU数，最小为1</li><li>factory: 工作线程工厂；</li><li>handler: 处理工作线程运行任务时的异常情况类，默认为null；</li><li>asyncMode: 是否为异步模式，默认为 false。如果为true，表示子任务的执行遵循 FIFO 顺序并且任务不能被合并(join)，这种模式适用于工作线程只运行事件类型的异步任务。</li></ul><p>在多数场景使用时，如果没有太强的业务需求，我们一般直接使用 ForkJoinPool 中的common池，在JDK1.8之后提供了ForkJoinPool.commonPool()方法可以直接使用common池。</p><h4 id=任务提交方式>任务提交方式</h4><ul><li>invoke()会等待任务计算完毕并返回计算结果；</li><li>execute()是直接向池提交一个任务来异步执行，无返回结果；</li><li>submit()也是异步执行，但是会返回提交的任务，在适当的时候可通过task.get()获取执行结果。</li></ul><h4 id=使用场景-2>使用场景</h4><ul><li>Arrays 在JDK 8之后新增的并行排序方法(parallelSort)就运用了 ForkJoinPool 的特性</li><li>ConcurrentHashMap 在JDK 8之后添加的函数式方法(如forEach等)也有运用。</li></ul><h3 id=参考资料>参考资料</h3><ul><li><a href=https://pdai.tech/md/java/thread/java-thread-x-juc-executor-ForkJoinPool.html target=_blank rel="external nofollow noopener noreferrer">https://pdai.tech/md/java/thread/java-thread-x-juc-executor-ForkJoinPool.html</a></li></ul></div><div class=post-footer id=post-footer><div class=post-info><div class=post-info-line><div class=post-info-mod><span title="更新于 2023-03-08 08:08:08">更新于 2023-03-08&nbsp;</span></div><div class=post-info-license><span><a rel="license external nofollow noopener noreferrer" href=https://creativecommons.org/licenses/by-nc/4.0/ target=_blank>CC BY-NC 4.0</a></span></div></div><div class=post-info-line><div class=post-info-md></div><div class=post-info-share><span><a href=javascript:void(0); title="分享到 微博" data-sharer=weibo data-url=https://leni.fun/juc/ data-title=🚩JUC><i class="fa-brands fa-weibo fa-fw" aria-hidden=true></i></a></span></div></div></div><div class=post-info-more><section class=post-tags><i class="fa-solid fa-tags fa-fw me-1" aria-hidden=true></i><a href=/tags/java/ class=post-tag>Java</a></section><section><span><a href=javascript:void(0); onclick=window.history.back()>返回</a></span>&nbsp;|&nbsp;<span><a href=/>主页</a></span></section></div><div class=post-nav><a href=/linux/ class=post-nav-item rel=prev title="🚩Linux 面试题"><i class="fa-solid fa-angle-left fa-fw" aria-hidden=true></i>🚩Linux 面试题</a>
<a href=/juc-%E7%BB%8F%E5%85%B8%E4%BB%A3%E7%A0%81/ class=post-nav-item rel=next title="🚩JUC 经典代码">🚩JUC 经典代码<i class="fa-solid fa-angle-right fa-fw" aria-hidden=true></i></a></div></div></article></main><footer class=footer><div class=footer-container><div class="footer-line copyright order-5" itemscope itemtype=http://schema.org/CreativeWork><i class="fa-regular fa-copyright fa-fw" aria-hidden=true></i>
<span itemprop=copyrightYear>2021 - 2024</span><span class=author itemprop=copyrightHolder>
<a href=/>都将会</a></span><span class="license footer-divider"><a rel="license external nofollow noopener noreferrer" href=https://beian.miit.gov.cn target=_blank>浙ICP备2023023782号</a></span></div><div class="footer-line statistics"><span class=site-time title=网站运行中……><i class="fa-solid fa-heartbeat fa-fw animate-icon" aria-hidden=true></i><span class="run-times ms-1">网站运行中……</span></span></div><div class="footer-line visitor order-4"><span id=busuanzi_container_site_uv title=总访客数><i class="fa-regular fa-user fa-fw" aria-hidden=true></i>&nbsp;<span id=busuanzi_value_site_uv><i class="fa-solid fa-spinner fa-spin fa-fw" aria-hidden=true></i></span></span><span id=busuanzi_container_site_pv class=footer-divider title=总访问量><i class="fa-regular fa-eye fa-fw" aria-hidden=true></i>&nbsp;<span id=busuanzi_value_site_pv><i class="fa-solid fa-spinner fa-spin fa-fw" aria-hidden=true></i></span></span></div></div></footer></div><div class=widgets><div class="fixed-buttons animate__faster d-none"><div class="fixed-button back-to-top" role=button aria-label=回到顶部><i class="fa-solid fa-arrow-up fa-fw" aria-hidden=true></i><span class=variant-numeric>0%</span></div></div><a href=https://github.com/hihihiman/hihihiman.github.io title=博客源码 target=_blank rel="external nofollow" class="github-corner left d-none-mobile"><svg viewBox="0 0 250 250" aria-hidden="true"><path d="M0 0 115 115h15l12 27L250 250V0z"/><path d="M128.3 109C113.8 99.7 119 89.6 119 89.6 122 82.7 120.5 78.6 120.5 78.6 119.2 72 123.4 76.3 123.4 76.3 127.3 80.9 125.5 87.3 125.5 87.3 122.9 97.6 130.6 101.9 134.4 103.2" fill="currentcolor" style="transform-origin:130px 106px" class="octo-arm"/><path d="M115 115C114.9 115.1 118.7 116.5 119.8 115.4l13.9-13.8C136.9 99.2 139.9 98.4 142.2 98.6 133.8 88 127.5 74.4 143.8 58 148.5 53.4 154 51.2 159.7 51 160.3 49.4 163.2 43.6 171.4 40.1 171.4 40.1 176.1 42.5 178.8 56.2 183.1 58.6 187.2 61.8 190.9 65.4 194.5 69 197.7 73.2 200.1 77.6 213.8 80.2 216.3 84.9 216.3 84.9 212.7 93.1 206.9 96 205.4 96.6 205.1 102.4 203 107.8 198.3 112.5 181.9 128.9 168.3 122.5 157.7 114.1 157.9 116.9 156.7 120.9 152.7 124.9L141 136.5C139.8 137.7 141.6 141.9 141.8 141.8z" fill="currentcolor" class="octo-body"/></svg></a><div id=mask></div><div class=reading-progress-bar style=left:0;bottom:0></div><noscript><div class=noscript-warning>FixIt 主题在启用 JavaScript 的情况下效果最佳。</div></noscript></div><link rel=stylesheet href=/lib/lightgallery/css/lightgallery-bundle.min.css><link rel=stylesheet href=/lib/katex/katex.min.css><link rel=stylesheet href=/lib/cookieconsent/cookieconsent.min.css><link rel=stylesheet href=/lib/pace/themes/pink/pace-theme-center-atom.css><script src=/lib/autocomplete/autocomplete.min.js defer></script><script src=/lib/fuse/fuse.min.js defer></script><script src=/lib/lightgallery/lightgallery.min.js defer></script><script src=/lib/lightgallery/plugins/thumbnail/lg-thumbnail.min.js defer></script><script src=/lib/lightgallery/plugins/zoom/lg-zoom.min.js defer></script><script src=/lib/sharer/sharer.min.js async defer></script><script src=/lib/typeit/index.umd.js defer></script><script src=/lib/katex/katex.min.js defer></script><script src=/lib/katex/auto-render.min.js defer></script><script src=/lib/katex/copy-tex.min.js defer></script><script src=/lib/katex/mhchem.min.js defer></script><script src=/lib/cookieconsent/cookieconsent.min.js defer></script><script src=/lib/pangu/pangu.min.js defer></script><script src=//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js async defer></script><script src=/lib/pace/pace.min.js async defer></script><script>window.config={autoBookmark:!0,code:{copyTitle:"复制到剪贴板",editLockTitle:"锁定可编辑代码块",editUnLockTitle:"解锁可编辑代码块",editable:!0,maxShownLines:1024},comment:{enable:!1},cookieconsent:{content:{dismiss:"同意",link:"了解更多",message:"本网站使用 Cookies 来改善您的浏览体验。"},enable:!0,palette:{button:{background:"#f0f0f0"},popup:{background:"#1aa3ff"}},theme:"edgeless"},data:{"typeit-header-subtitle-desktop":"的博客           ","typeit-header-subtitle-mobile":"的博客           "},enablePWA:!0,lightgallery:!0,math:{delimiters:[{display:!0,left:"$$",right:"$$"},{display:!0,left:"\\[",right:"\\]"},{display:!0,left:"\\begin{equation}",right:"\\end{equation}"},{display:!0,left:"\\begin{equation*}",right:"\\end{equation*}"},{display:!0,left:"\\begin{align}",right:"\\end{align}"},{display:!0,left:"\\begin{align*}",right:"\\end{align*}"},{display:!0,left:"\\begin{alignat}",right:"\\end{alignat}"},{display:!0,left:"\\begin{alignat*}",right:"\\end{alignat*}"},{display:!0,left:"\\begin{gather}",right:"\\end{gather}"},{display:!0,left:"\\begin{CD}",right:"\\end{CD}"},{display:!1,left:"$",right:"$"},{display:!1,left:"\\(",right:"\\)"}],strict:!1},pangu:{enable:!0,selector:"article"},search:{distance:100,findAllMatches:!1,highlightTag:"em",ignoreFieldNorm:!0,ignoreLocation:!0,isCaseSensitive:!1,location:0,maxResultLength:10,minMatchCharLength:2,noResultsFound:"没有找到结果",snippetLength:50,threshold:.3,useExtendedSearch:!0},siteTime:"2021-08-26T23:31:00+08:00",typeit:{cursorChar:"_",cursorSpeed:1e3,data:{"typeit-header-subtitle-desktop":["typeit-header-subtitle-desktop"],"typeit-header-subtitle-mobile":["typeit-header-subtitle-mobile"]},duration:-1,loop:!0,speed:150}}</script><script src=/js/theme.min.js defer></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/jquery@2.1.3/dist/jquery.min.js></script><script type=text/javascript src=/js/custom.js></script></body></html>
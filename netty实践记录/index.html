<!doctype html><html itemscope itemtype=http://schema.org/WebPage lang=zh-CN><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1,maximum-scale=2"><meta name=robots content="noodp"><title>Netty 实践记录 - </title><meta name=author content="都将会"><meta name=author-link content><meta name=description content="记录一些报错的解决方案"><meta name=keywords content='都将会,Java,Netty'><meta itemprop=name content="Netty 实践记录"><meta itemprop=description content="记录一些报错的解决方案"><meta itemprop=datePublished content="2023-08-27T21:01:43+08:00"><meta itemprop=dateModified content="2023-08-27T21:01:43+08:00"><meta itemprop=wordCount content="3215"><meta itemprop=image content="https://leni.fun/images/avatar.jpg"><meta itemprop=keywords content="Network,Netty,"><meta property="og:title" content="Netty 实践记录"><meta property="og:description" content="记录一些报错的解决方案"><meta property="og:type" content="article"><meta property="og:url" content="https://leni.fun/netty%E5%AE%9E%E8%B7%B5%E8%AE%B0%E5%BD%95/"><meta property="og:image" content="https://leni.fun/images/avatar.jpg"><meta property="article:section" content="posts"><meta property="article:published_time" content="2023-08-27T21:01:43+08:00"><meta property="article:modified_time" content="2023-08-27T21:01:43+08:00"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://leni.fun/images/avatar.jpg"><meta name=twitter:title content="Netty 实践记录"><meta name=twitter:description content="记录一些报错的解决方案"><meta name=application-name content="都将会的 APP"><meta name=apple-mobile-web-app-title content="都将会的 APP"><meta name=theme-color data-light=#f8f8f8 data-dark=#252627 content="#f8f8f8"><meta name=msapplication-TileColor content="#da532c"><link rel="shortcut icon" type=image/x-icon href=/favicon.ico><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=mask-icon href=/safari-pinned-tab.svg color=#5bbad5><link rel=manifest href=/site.webmanifest><link rel=canonical href=https://leni.fun/netty%E5%AE%9E%E8%B7%B5%E8%AE%B0%E5%BD%95/><link rel=prev href=https://leni.fun/netty/><link rel=next href=https://leni.fun/springsecurity/><link rel=stylesheet href=/css/style.min.css><link rel=stylesheet href=/lib/fontawesome-free/all.min.css><link rel=stylesheet href=/lib/animate/animate.min.css><script type=application/ld+json>{"@context":"http://schema.org","@type":"BlogPosting","headline":"Netty 实践记录","inLanguage":"zh-CN","mainEntityOfPage":{"@type":"WebPage","@id":"https:\/\/leni.fun\/netty%E5%AE%9E%E8%B7%B5%E8%AE%B0%E5%BD%95\/"},"genre":"posts","keywords":"Network, Netty","wordcount":3215,"url":"https:\/\/leni.fun\/netty%E5%AE%9E%E8%B7%B5%E8%AE%B0%E5%BD%95\/","datePublished":"2023-08-27T21:01:43+08:00","dateModified":"2023-08-27T21:01:43+08:00","publisher":{"@type":"Organization","name":""},"author":{"@type":"Person","name":"都将会"},"description":"记录一些报错的解决方案"}</script></head><body data-header-desktop=sticky data-header-mobile=auto><script>(window.localStorage?.getItem("theme")?localStorage.getItem("theme")==="dark":"dark"==="auto"?window.matchMedia("(prefers-color-scheme: dark)").matches:"dark"==="dark")&&document.body.setAttribute("data-theme","dark")</script><div class=wrapper data-page-style=normal><header class="desktop animate__faster" id=header-desktop><div class=header-wrapper data-github-corner=left><div class=header-title><a href=/ title><img loading=lazy src=/images/icon.png srcset="/images/icon.png, /images/icon.png 1.5x, /images/icon.png 2x" sizes=auto data-title=/images/icon.png data-alt=/images/icon.png class=logo style="background:url(/svg/loading.min.svg)no-repeat 50%" onload='this.title=this.dataset.title,this.alt=this.dataset.alt;for(const e of["style","data-title","data-alt","onerror","onload"])this.removeAttribute(e);this.dataset.lazyloaded=""' onerror='this.title=this.dataset.title,this.alt=this.dataset.alt;for(const e of["style","data-title","data-alt","onerror","onload"])this.removeAttribute(e)'><span class=header-title-text>都将会</span></a><span id=typeit-header-subtitle-desktop class="typeit header-subtitle"></span></div><nav><ul class=menu><li class="menu-item has-children"><a class=menu-link href=/posts/><i class="fa-solid fa-archive fa-fw fa-sm" aria-hidden=true></i> 技术</a><i class="dropdown-icon fa-solid fa-chevron-down" aria-hidden=true></i><ul class=sub-menu><li class=menu-item><a class=menu-link href=/categories/><i class="fa-solid fa-th fa-fw fa-sm" aria-hidden=true></i> 分类</a></li><li class=menu-item><a class=menu-link href=/tags/><i class="fa-solid fa-tags fa-fw fa-sm" aria-hidden=true></i> 标签</a></li></ul></li><li class=menu-item><a class=menu-link href=/life/><i class="fa-solid fa-camera-alt fa-fw fa-sm" aria-hidden=true></i> 生活</a></li><li class=menu-item><a class=menu-link href=/friends/><i class="fa-solid fa-users fa-fw fa-sm" aria-hidden=true></i> 友链</a></li><li class=menu-item><a class=menu-link href=/about/><i class="fa-solid fa-info-circle fa-fw fa-sm" aria-hidden=true></i> 关于</a></li><li class="menu-item delimiter"></li><li class="menu-item search" id=search-desktop><input type=text placeholder=关键词搜索 id=search-input-desktop>
<a href=javascript:void(0); class="search-button search-toggle" id=search-toggle-desktop title=搜索><i class="fa-solid fa-search fa-fw" aria-hidden=true></i>
</a><a href=javascript:void(0); class="search-button search-clear" id=search-clear-desktop title=清空><i class="fa-solid fa-times-circle fa-fw" aria-hidden=true></i>
</a><span class="search-button search-loading" id=search-loading-desktop><i class="fa-solid fa-spinner fa-fw fa-spin" aria-hidden=true></i></span></li><li class="menu-item theme-switch" title=切换主题><i class="fa-solid fa-adjust fa-fw" aria-hidden=true></i></li></ul></nav></div></header><header class="mobile animate__faster" id=header-mobile><div class=header-container><div class=header-wrapper><div class=header-title><a href=/ title><img loading=lazy src=/images/icon.png srcset="/images/icon.png, /images/icon.png 1.5x, /images/icon.png 2x" sizes=auto data-title=/images/icon.png data-alt=/images/icon.png class=logo style="background:url(/svg/loading.min.svg)no-repeat 50%" onload='this.title=this.dataset.title,this.alt=this.dataset.alt;for(const e of["style","data-title","data-alt","onerror","onload"])this.removeAttribute(e);this.dataset.lazyloaded=""' onerror='this.title=this.dataset.title,this.alt=this.dataset.alt;for(const e of["style","data-title","data-alt","onerror","onload"])this.removeAttribute(e)'><span class=header-title-text>都将会</span></a><span id=typeit-header-subtitle-mobile class="typeit header-subtitle"></span></div><div class=menu-toggle id=menu-toggle-mobile><span></span><span></span><span></span></div></div><nav><ul class=menu id=menu-mobile><li class=search-wrapper><div class="search mobile" id=search-mobile><input type=text placeholder=关键词搜索 id=search-input-mobile>
<a href=javascript:void(0); class="search-button search-toggle" id=search-toggle-mobile title=搜索><i class="fa-solid fa-search fa-fw" aria-hidden=true></i>
</a><a href=javascript:void(0); class="search-button search-clear" id=search-clear-mobile title=清空><i class="fa-solid fa-times-circle fa-fw" aria-hidden=true></i>
</a><span class="search-button search-loading" id=search-loading-mobile><i class="fa-solid fa-spinner fa-fw fa-spin" aria-hidden=true></i></span></div><a href=javascript:void(0); class=search-cancel id=search-cancel-mobile>取消</a></li><li class=menu-item><span class=nested-item><a class=menu-link href=/posts/><i class="fa-solid fa-archive fa-fw fa-sm" aria-hidden=true></i> 技术</a>
<i class="dropdown-icon fa-solid fa-chevron-right" aria-hidden=true></i></span><ul class=sub-menu><li class=menu-item><a class=menu-link href=/categories/><i class="fa-solid fa-th fa-fw fa-sm" aria-hidden=true></i> 分类</a></li><li class=menu-item><a class=menu-link href=/tags/><i class="fa-solid fa-tags fa-fw fa-sm" aria-hidden=true></i> 标签</a></li></ul></li><li class=menu-item><a class=menu-link href=/life/><i class="fa-solid fa-camera-alt fa-fw fa-sm" aria-hidden=true></i> 生活</a></li><li class=menu-item><a class=menu-link href=/friends/><i class="fa-solid fa-users fa-fw fa-sm" aria-hidden=true></i> 友链</a></li><li class=menu-item><a class=menu-link href=/about/><i class="fa-solid fa-info-circle fa-fw fa-sm" aria-hidden=true></i> 关于</a></li><li class="menu-item menu-system"><span class="menu-system-item theme-switch" title=切换主题><i class="fa-solid fa-adjust fa-fw" aria-hidden=true></i></span></li></ul></nav></div></header><div class="search-dropdown desktop"><div id=search-dropdown-desktop></div></div><div class="search-dropdown mobile"><div id=search-dropdown-mobile></div></div><nav aria-label=breadcrumb class="breadcrumb-container sticky"><ol class=breadcrumb><li class=breadcrumb-item><a href=/ title>主页</a></li><li class=breadcrumb-item><a href=/posts/ title=Posts>Posts</a></li><li class="breadcrumb-item active" aria-current=page>Netty 实践记录</li></ol></nav><main class=container><aside class=toc id=toc-auto><h2 class=toc-title>目录&nbsp;<i class="toc-icon fa-solid fa-angle-down fa-fw" aria-hidden=true></i></h2><div class=toc-content id=toc-content-auto></div></aside><aside class=aside-custom></aside><article class="page single"><div class=header><h1 class="single-title animate__animated animate__flipInX"><span>Netty 实践记录</span></h1></div><div class=post-meta><div class=post-meta-line><span class=post-author><span class=author><img loading=lazy src=/images/avatar.jpg srcset="/images/avatar.jpg, /images/avatar.jpg 1.5x, /images/avatar.jpg 2x" sizes=auto data-title=都将会 data-alt=都将会 class=avatar style="background:url(/svg/loading.min.svg)no-repeat 50%" onload='this.title=this.dataset.title,this.alt=this.dataset.alt;for(const e of["style","data-title","data-alt","onerror","onload"])this.removeAttribute(e);this.dataset.lazyloaded=""' onerror='this.title=this.dataset.title,this.alt=this.dataset.alt;for(const e of["style","data-title","data-alt","onerror","onload"])this.removeAttribute(e)'>&nbsp;都将会</span></span>
<span class=post-category>收录于 <a href=/categories/202308/><i class="fa-regular fa-folder fa-fw" aria-hidden=true></i> 202308</a></span></div><div class=post-meta-line><span title="发布于 2023-08-27 21:01:43"><i class="fa-regular fa-calendar-alt fa-fw me-1" aria-hidden=true></i><time datetime=2023-08-27>2023-08-27</time></span>&nbsp;<span title="更新于 2023-08-27 21:01:43"><i class="fa-regular fa-edit fa-fw me-1" aria-hidden=true></i><time datetime=2023-08-27>2023-08-27</time></span>&nbsp;<span><i class="fa-solid fa-pencil-alt fa-fw me-1" aria-hidden=true></i>约 3215 字</span>&nbsp;<span><i class="fa-regular fa-clock fa-fw me-1" aria-hidden=true></i>预计阅读 7 分钟</span>&nbsp;<span id=busuanzi_container_page_pv class="busuanzi_visitors comment-visitors" data-flag-title="Netty 实践记录">
<i class="fa-regular fa-eye fa-fw me-1" aria-hidden=true></i><span id=busuanzi_value_page_pv>-</span>&nbsp;次阅读
</span>&nbsp;</div></div><div class=featured-image><img loading=lazy src=/images/pic11.jpg srcset="/images/pic11.jpg, /images/pic11.jpg 1.5x, /images/pic11.jpg 2x" sizes=auto data-title=记录一些报错的解决方案 data-alt=/images/pic11.jpg width=2276 height=1280 style="background:url(/svg/loading.min.svg)no-repeat 50%" onload='this.title=this.dataset.title,this.alt=this.dataset.alt;for(const e of["style","data-title","data-alt","onerror","onload"])this.removeAttribute(e);this.dataset.lazyloaded=""' onerror='this.title=this.dataset.title,this.alt=this.dataset.alt;for(const e of["style","data-title","data-alt","onerror","onload"])this.removeAttribute(e)'></div><div class="details toc" id=toc-static data-kept=false><div class="details-summary toc-title"><span>目录</span>
<span><i class="details-icon fa-solid fa-angle-right" aria-hidden=true></i></span></div><div class="details-content toc-content" id=toc-content-static><nav id=TableOfContents><ul><li><ul><li><a href=#启动-exampleechoserver-项目报错解决>启动 example/EchoServer 项目报错解决</a><ul><li><a href=#java-程序包sunmisc不存在>java: 程序包sun.misc不存在</a></li><li><a href=#java-程序包ionettyutilcollection不存在>java: 程序包io.netty.util.collection不存在</a></li></ul></li><li><a href=#应用-netty-实现服务端和客户端>应用 Netty 实现服务端和客户端</a><ul><li><a href=#serverjava>Server.java</a></li><li><a href=#clientjava>Client.java</a></li></ul></li><li><a href=#调优参数>调优参数</a><ul><li><a href=#linux-系统参数>Linux 系统参数</a></li><li><a href=#socketchannel>SocketChannel</a></li><li><a href=#serversocketchannel>ServerSocketChannel</a></li><li><a href=#chenneloption>ChennelOption</a></li></ul></li><li><a href=#易诊断性>易诊断性</a><ul><li><a href=#完善对象名称>完善对象名称</a><ul><li><a href=#线程名称>线程名称</a></li><li><a href=#handler-名称>handler 名称</a></li></ul></li><li><a href=#集成日志>集成日志</a><ul><li><a href=#原理>原理</a></li><li><a href=#使用>使用</a></li></ul></li><li><a href=#统计并展示当前系统连接数>统计并展示当前系统连接数</a></li></ul></li><li><a href=#内存泄漏检测>内存泄漏检测</a><ul><li><a href=#resourceleakdetector>ResourceLeakDetector</a><ul><li><a href=#级别>级别</a></li><li><a href=#弱引用>弱引用</a></li><li><a href=#记录访问信息>记录访问信息</a></li><li><a href=#触发汇报时机>触发汇报时机</a></li></ul></li></ul></li><li><a href=#netty-注解>Netty 注解</a></li><li><a href=#pipeline-优化>pipeline 优化</a><ul><li><a href=#线程模型优化>线程模型优化</a></li><li><a href=#增强写>增强写</a></li><li><a href=#流量整形>流量整形</a></li><li><a href=#linux-下开启-native>Linux 下开启 native</a></li><li><a href=#防止-oom>防止 OOM</a></li><li><a href=#空闲监测keepalive-和-idle>空闲监测：keepalive 和 idle</a><ul><li><a href=#服务端>服务端</a></li><li><a href=#客户端>客户端</a></li></ul></li><li><a href=#黑白名单>黑白名单</a></li><li><a href=#认证>认证</a></li><li><a href=#ssltls-协议>SSL/TLS 协议</a></li></ul></li><li><a href=#netty-的应用>Netty 的应用</a><ul><li><a href=#dubbo>Dubbo</a></li><li><a href=#hadoop>Hadoop</a></li></ul></li><li><a href=#开源贡献注意事项>开源贡献注意事项</a></li><li><a href=#参考资料>参考资料</a></li></ul></li></ul></nav></div></div><div class=content id=content><h3 id=启动-exampleechoserver-项目报错解决>启动 example/EchoServer 项目报错解决</h3><h4 id=java-程序包sunmisc不存在>java: 程序包sun.misc不存在</h4><p>修改 Project Structure 从 jdk11降低到 jdk1.8</p><h4 id=java-程序包ionettyutilcollection不存在>java: 程序包io.netty.util.collection不存在</h4><p>造成报错的原因是用于生成模板的 groovy 脚本没有成功执行</p><p><a class=lightgallery href=https://publicpictures.oss-cn-hangzhou.aliyuncs.com/img/image-20230822210907778.png data-thumbnail=https://publicpictures.oss-cn-hangzhou.aliyuncs.com/img/image-20230822210907778.png data-sub-html="<h2>image-20230822210907778</h2>"><img loading=lazy src=https://publicpictures.oss-cn-hangzhou.aliyuncs.com/img/image-20230822210907778.png srcset="https://publicpictures.oss-cn-hangzhou.aliyuncs.com/img/image-20230822210907778.png, https://publicpictures.oss-cn-hangzhou.aliyuncs.com/img/image-20230822210907778.png 1.5x, https://publicpictures.oss-cn-hangzhou.aliyuncs.com/img/image-20230822210907778.png 2x" sizes=auto data-title=image-20230822210907778 data-alt=image-20230822210907778 style="background:url(/svg/loading.min.svg)no-repeat 50%" onload='this.title=this.dataset.title,this.alt=this.dataset.alt;for(const e of["style","data-title","data-alt","onerror","onload"])this.removeAttribute(e);this.dataset.lazyloaded=""' onerror='this.title=this.dataset.title,this.alt=this.dataset.alt;for(const e of["style","data-title","data-alt","onerror","onload"])this.removeAttribute(e)'></a></p><p>于是，手动执行 <code>-DskipTests compile</code></p><p><a class=lightgallery href=https://publicpictures.oss-cn-hangzhou.aliyuncs.com/img/image-20230822211205914.png data-thumbnail=https://publicpictures.oss-cn-hangzhou.aliyuncs.com/img/image-20230822211205914.png data-sub-html="<h2>image-20230822211205914</h2>"><img loading=lazy src=https://publicpictures.oss-cn-hangzhou.aliyuncs.com/img/image-20230822211205914.png srcset="https://publicpictures.oss-cn-hangzhou.aliyuncs.com/img/image-20230822211205914.png, https://publicpictures.oss-cn-hangzhou.aliyuncs.com/img/image-20230822211205914.png 1.5x, https://publicpictures.oss-cn-hangzhou.aliyuncs.com/img/image-20230822211205914.png 2x" sizes=auto data-title=image-20230822211205914 data-alt=image-20230822211205914 style="background:url(/svg/loading.min.svg)no-repeat 50%" onload='this.title=this.dataset.title,this.alt=this.dataset.alt;for(const e of["style","data-title","data-alt","onerror","onload"])this.removeAttribute(e);this.dataset.lazyloaded=""' onerror='this.title=this.dataset.title,this.alt=this.dataset.alt;for(const e of["style","data-title","data-alt","onerror","onload"])this.removeAttribute(e)'></a></p><h3 id=应用-netty-实现服务端和客户端>应用 Netty 实现服务端和客户端</h3><p><a class=lightgallery href=https://publicpictures.oss-cn-hangzhou.aliyuncs.com/img/image-20230825085837779.png data-thumbnail=https://publicpictures.oss-cn-hangzhou.aliyuncs.com/img/image-20230825085837779.png data-sub-html="<h2>image-20230825085837779</h2>"><img loading=lazy src=https://publicpictures.oss-cn-hangzhou.aliyuncs.com/img/image-20230825085837779.png srcset="https://publicpictures.oss-cn-hangzhou.aliyuncs.com/img/image-20230825085837779.png, https://publicpictures.oss-cn-hangzhou.aliyuncs.com/img/image-20230825085837779.png 1.5x, https://publicpictures.oss-cn-hangzhou.aliyuncs.com/img/image-20230825085837779.png 2x" sizes=auto data-title=image-20230825085837779 data-alt=image-20230825085837779 style="background:url(/svg/loading.min.svg)no-repeat 50%" onload='this.title=this.dataset.title,this.alt=this.dataset.alt;for(const e of["style","data-title","data-alt","onerror","onload"])this.removeAttribute(e);this.dataset.lazyloaded=""' onerror='this.title=this.dataset.title,this.alt=this.dataset.alt;for(const e of["style","data-title","data-alt","onerror","onload"])this.removeAttribute(e)'></a></p><p>消息结构</p><p><a class=lightgallery href=https://publicpictures.oss-cn-hangzhou.aliyuncs.com/img/image-20230825085937908.png data-thumbnail=https://publicpictures.oss-cn-hangzhou.aliyuncs.com/img/image-20230825085937908.png data-sub-html="<h2>image-20230825085937908</h2>"><img loading=lazy src=https://publicpictures.oss-cn-hangzhou.aliyuncs.com/img/image-20230825085937908.png srcset="https://publicpictures.oss-cn-hangzhou.aliyuncs.com/img/image-20230825085937908.png, https://publicpictures.oss-cn-hangzhou.aliyuncs.com/img/image-20230825085937908.png 1.5x, https://publicpictures.oss-cn-hangzhou.aliyuncs.com/img/image-20230825085937908.png 2x" sizes=auto data-title=image-20230825085937908 data-alt=image-20230825085937908 style="background:url(/svg/loading.min.svg)no-repeat 50%" onload='this.title=this.dataset.title,this.alt=this.dataset.alt;for(const e of["style","data-title","data-alt","onerror","onload"])this.removeAttribute(e);this.dataset.lazyloaded=""' onerror='this.title=this.dataset.title,this.alt=this.dataset.alt;for(const e of["style","data-title","data-alt","onerror","onload"])this.removeAttribute(e)'></a></p><h4 id=serverjava>Server.java</h4><div class=highlight id=id-1><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * 服务器端
</span></span></span><span class=line><span class=cl><span class=cm> * 4个编解码器 + 1个业务处理器 + 日志处理器
</span></span></span><span class=line><span class=cl><span class=cm> */</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kd>class</span> <span class=nc>Server</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>main</span><span class=p>(</span><span class=n>String</span><span class=o>[]</span><span class=w> </span><span class=n>args</span><span class=p>)</span><span class=w> </span><span class=kd>throws</span><span class=w> </span><span class=n>InterruptedException</span><span class=p>,</span><span class=w> </span><span class=n>ExecutionException</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>ServerBootstrap</span><span class=w> </span><span class=n>serverBootstrap</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>ServerBootstrap</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>serverBootstrap</span><span class=p>.</span><span class=na>channel</span><span class=p>(</span><span class=n>NioServerSocketChannel</span><span class=p>.</span><span class=na>class</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// 日志</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>serverBootstrap</span><span class=p>.</span><span class=na>handler</span><span class=p>(</span><span class=k>new</span><span class=w> </span><span class=n>LoggingHandler</span><span class=p>(</span><span class=n>LogLevel</span><span class=p>.</span><span class=na>INFO</span><span class=p>));</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>NioEventLoopGroup</span><span class=w> </span><span class=n>boss</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>NioEventLoopGroup</span><span class=p>(</span><span class=n>0</span><span class=p>,</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>DefaultThreadFactory</span><span class=p>(</span><span class=s>&#34;boss&#34;</span><span class=p>));</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>NioEventLoopGroup</span><span class=w> </span><span class=n>worker</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>NioEventLoopGroup</span><span class=p>(</span><span class=n>0</span><span class=p>,</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>DefaultThreadFactory</span><span class=p>(</span><span class=s>&#34;worker&#34;</span><span class=p>));</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>serverBootstrap</span><span class=p>.</span><span class=na>group</span><span class=p>(</span><span class=n>boss</span><span class=p>,</span><span class=n>worker</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// 参数设置</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>serverBootstrap</span><span class=p>.</span><span class=na>childOption</span><span class=p>(</span><span class=n>NioChannelOption</span><span class=p>.</span><span class=na>TCP_NODELAY</span><span class=p>,</span><span class=kc>true</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>serverBootstrap</span><span class=p>.</span><span class=na>childOption</span><span class=p>(</span><span class=n>NioChannelOption</span><span class=p>.</span><span class=na>SO_BACKLOG</span><span class=p>,</span><span class=n>1024</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>MetricHandler</span><span class=w> </span><span class=n>metricHandler</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>MetricHandler</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>serverBootstrap</span><span class=p>.</span><span class=na>childHandler</span><span class=p>(</span><span class=k>new</span><span class=w> </span><span class=n>ChannelInitializer</span><span class=o>&lt;</span><span class=n>NioSocketChannel</span><span class=o>&gt;</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nd>@Override</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=kd>protected</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>initChannel</span><span class=p>(</span><span class=n>NioSocketChannel</span><span class=w> </span><span class=n>nioSocketChannel</span><span class=p>)</span><span class=w> </span><span class=kd>throws</span><span class=w> </span><span class=n>Exception</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>ChannelPipeline</span><span class=w> </span><span class=n>pipeline</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>nioSocketChannel</span><span class=p>.</span><span class=na>pipeline</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=c1>// 日志</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>pipeline</span><span class=p>.</span><span class=na>addLast</span><span class=p>(</span><span class=s>&#34;logHandler&#34;</span><span class=p>,</span><span class=k>new</span><span class=w> </span><span class=n>LoggingHandler</span><span class=p>(</span><span class=n>LogLevel</span><span class=p>.</span><span class=na>DEBUG</span><span class=p>));</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=c1>// 统计连接数</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>pipeline</span><span class=p>.</span><span class=na>addLast</span><span class=p>(</span><span class=s>&#34;metricHandler&#34;</span><span class=p>,</span><span class=w> </span><span class=n>metricHandler</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=c1>// 请求</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>pipeline</span><span class=p>.</span><span class=na>addLast</span><span class=p>(</span><span class=s>&#34;frameDecoder&#34;</span><span class=p>,</span><span class=k>new</span><span class=w> </span><span class=n>OrderFrameDecoder</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>pipeline</span><span class=p>.</span><span class=na>addLast</span><span class=p>(</span><span class=s>&#34;protocolDecoder&#34;</span><span class=p>,</span><span class=k>new</span><span class=w> </span><span class=n>OrderProtocolDecoder</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=c1>// 处理</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>pipeline</span><span class=p>.</span><span class=na>addLast</span><span class=p>(</span><span class=s>&#34;processHandler&#34;</span><span class=p>,</span><span class=k>new</span><span class=w> </span><span class=n>OrderServerProcessHandler</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=c1>// 响应</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>pipeline</span><span class=p>.</span><span class=na>addLast</span><span class=p>(</span><span class=s>&#34;protocolEncoder&#34;</span><span class=p>,</span><span class=k>new</span><span class=w> </span><span class=n>OrderProtocolEncoder</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>pipeline</span><span class=p>.</span><span class=na>addLast</span><span class=p>(</span><span class=s>&#34;frameEncoder&#34;</span><span class=p>,</span><span class=k>new</span><span class=w> </span><span class=n>OrderFrameEncoder</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>});</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// 启动时阻塞</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>ChannelFuture</span><span class=w> </span><span class=n>channelFuture</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>serverBootstrap</span><span class=p>.</span><span class=na>bind</span><span class=p>(</span><span class=n>8090</span><span class=p>).</span><span class=na>sync</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>channelFuture</span><span class=p>.</span><span class=na>channel</span><span class=p>().</span><span class=na>closeFuture</span><span class=p>().</span><span class=na>get</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span></span></span></code></pre></td></tr></table></div></div><h4 id=clientjava>Client.java</h4><div class=highlight id=id-2><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * 客户端
</span></span></span><span class=line><span class=cl><span class=cm> * 通过响应分发来改进
</span></span></span><span class=line><span class=cl><span class=cm> */</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kd>class</span> <span class=nc>ClientV2</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>main</span><span class=p>(</span><span class=n>String</span><span class=o>[]</span><span class=w> </span><span class=n>args</span><span class=p>)</span><span class=w> </span><span class=kd>throws</span><span class=w> </span><span class=n>InterruptedException</span><span class=p>,</span><span class=w> </span><span class=n>ExecutionException</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>Bootstrap</span><span class=w> </span><span class=n>bootstrap</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>Bootstrap</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>bootstrap</span><span class=p>.</span><span class=na>channel</span><span class=p>(</span><span class=n>NioSocketChannel</span><span class=p>.</span><span class=na>class</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// 调参</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>bootstrap</span><span class=p>.</span><span class=na>option</span><span class=p>(</span><span class=n>NioChannelOption</span><span class=p>.</span><span class=na>CONNECT_TIMEOUT_MILLIS</span><span class=p>,</span><span class=n>10</span><span class=o>*</span><span class=n>1000</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>bootstrap</span><span class=p>.</span><span class=na>group</span><span class=p>(</span><span class=k>new</span><span class=w> </span><span class=n>NioEventLoopGroup</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>         </span><span class=n>RequestPendingCenter</span><span class=w> </span><span class=n>requestPendingCenter</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>RequestPendingCenter</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>bootstrap</span><span class=p>.</span><span class=na>handler</span><span class=p>(</span><span class=k>new</span><span class=w> </span><span class=n>ChannelInitializer</span><span class=o>&lt;</span><span class=n>NioSocketChannel</span><span class=o>&gt;</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nd>@Override</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=kd>protected</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>initChannel</span><span class=p>(</span><span class=n>NioSocketChannel</span><span class=w> </span><span class=n>nioSocketChannel</span><span class=p>)</span><span class=w> </span><span class=kd>throws</span><span class=w> </span><span class=n>Exception</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>ChannelPipeline</span><span class=w> </span><span class=n>pipeline</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>nioSocketChannel</span><span class=p>.</span><span class=na>pipeline</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>pipeline</span><span class=p>.</span><span class=na>addLast</span><span class=p>(</span><span class=s>&#34;frameDecoder&#34;</span><span class=p>,</span><span class=k>new</span><span class=w> </span><span class=n>OrderFrameDecoder</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>pipeline</span><span class=p>.</span><span class=na>addLast</span><span class=p>(</span><span class=s>&#34;frameEncoder&#34;</span><span class=p>,</span><span class=k>new</span><span class=w> </span><span class=n>OrderFrameEncoder</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>pipeline</span><span class=p>.</span><span class=na>addLast</span><span class=p>(</span><span class=s>&#34;protocolEncoder&#34;</span><span class=p>,</span><span class=k>new</span><span class=w> </span><span class=n>OrderProtocolEncoder</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>pipeline</span><span class=p>.</span><span class=na>addLast</span><span class=p>(</span><span class=s>&#34;protocolDecoder&#34;</span><span class=p>,</span><span class=k>new</span><span class=w> </span><span class=n>OrderProtocolDecoder</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=c1>// 响应式</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>pipeline</span><span class=p>.</span><span class=na>addLast</span><span class=p>(</span><span class=s>&#34;dispatcherHandler&#34;</span><span class=p>,</span><span class=k>new</span><span class=w> </span><span class=n>ResponseDispatcherHandler</span><span class=p>(</span><span class=n>requestPendingCenter</span><span class=p>));</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>pipeline</span><span class=p>.</span><span class=na>addLast</span><span class=p>(</span><span class=s>&#34;operationToRequestMessageEncoder&#34;</span><span class=p>,</span><span class=k>new</span><span class=w> </span><span class=n>OperationToRequestMessageEncoder</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>pipeline</span><span class=p>.</span><span class=na>addLast</span><span class=p>(</span><span class=s>&#34;logHandler&#34;</span><span class=p>,</span><span class=k>new</span><span class=w> </span><span class=n>LoggingHandler</span><span class=p>(</span><span class=n>LogLevel</span><span class=p>.</span><span class=na>INFO</span><span class=p>));</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>});</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// 启动时阻塞</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>ChannelFuture</span><span class=w> </span><span class=n>channelFuture</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>bootstrap</span><span class=p>.</span><span class=na>connect</span><span class=p>(</span><span class=s>&#34;127.0.0.1&#34;</span><span class=p>,</span><span class=w> </span><span class=n>8090</span><span class=p>).</span><span class=na>sync</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kt>long</span><span class=w> </span><span class=n>streamId</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>IdUtil</span><span class=p>.</span><span class=na>nextId</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>OrderOperation</span><span class=w> </span><span class=n>orderOperation</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>OrderOperation</span><span class=p>(</span><span class=n>1001</span><span class=p>,</span><span class=w> </span><span class=s>&#34;土豆&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>RequestMessage</span><span class=w> </span><span class=n>requestMessage</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>RequestMessage</span><span class=p>(</span><span class=n>streamId</span><span class=p>,</span><span class=n>orderOperation</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>         </span><span class=n>OperationResultFuture</span><span class=w> </span><span class=n>operationResultFuture</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>OperationResultFuture</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>         </span><span class=c1>// 加到 map 中去</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>         </span><span class=n>requestPendingCenter</span><span class=p>.</span><span class=na>add</span><span class=p>(</span><span class=n>streamId</span><span class=p>,</span><span class=n>operationResultFuture</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>         </span><span class=c1>// 写入队列并发送</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>channelFuture</span><span class=p>.</span><span class=na>channel</span><span class=p>().</span><span class=na>writeAndFlush</span><span class=p>(</span><span class=n>requestMessage</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// 阻塞等待结果</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>OperationResult</span><span class=w> </span><span class=n>operationResult</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>operationResultFuture</span><span class=p>.</span><span class=na>get</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>System</span><span class=p>.</span><span class=na>out</span><span class=p>.</span><span class=na>println</span><span class=p>(</span><span class=s>&#34;operationResult = &#34;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>operationResult</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>channelFuture</span><span class=p>.</span><span class=na>channel</span><span class=p>().</span><span class=na>closeFuture</span><span class=p>().</span><span class=na>get</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span></span></span></code></pre></td></tr></table></div></div><h3 id=调优参数>调优参数</h3><h4 id=linux-系统参数>Linux 系统参数</h4><p><code>ulimit -n [xxx]</code>：防止出现"Too many open file"报错。（重启或退出用户后失效）</p><h4 id=socketchannel>SocketChannel</h4><ul><li>SO_SNDBUF：TCP数据发送缓冲区大小</li><li>SO_RCVBUF：TCP数据接收缓冲区大小</li><li>SO_KEEPALIVE：TCP层keepalive，默认关闭</li><li>SO_REUSEADDR：地址重用，多IP绑定相同端口，让关闭连接释放的端口更早可使用，默认不开启</li><li>SO_LINGER：关闭Socket的延迟时间，默认不开启</li><li>IP_TOS：设置IP头部的 Type-of-Service 字段，设定延时或吞吐量的优先级</li><li>TCP_NODELAY：是否启用Nagle算法，默认不开启<ul><li><code>serverBootstrap.childOption(NioChannelOption.TCP_NODELAY,true);</code></li></ul></li></ul><h4 id=serversocketchannel>ServerSocketChannel</h4><ul><li>SO_RCVBUF</li><li>SO_REUSEADDR</li><li>SO_BACKLOG：最大等待连接数 <code>channel().bind(address,config.getBacklog());</code>，默认128<ul><li><code>serverBootstrap.childOption(NioChannelOption.SO_BACKLOG,1024);</code></li></ul></li></ul><h4 id=chenneloption>ChennelOption</h4><ul><li><p>WRITE_UFFER_WATER_MARK：高低水位线，间接防止OOM（默认32k～64k）</p></li><li><p>CONNECT_TIMEOUT_MILLIS：客户端连接服务器最大允许时间，默认30s</p><ul><li><code>bootstrap.option(NioChannelOption.CONNECT_TIMEOUT_MILLIS,10*1000);</code></li></ul></li><li><p>MAX_MESSAGES_PER_READ：最大允许连续读次数</p></li><li><p>WRITE_SPIN_COUNT：最大允许连续写次数</p></li><li><p>ALLOCATOR：ByteBuf 分配器，默认池化、堆外</p></li><li><p>RCVBUF_ALLOCATOR：数据接收 ByteBuf 分配大小计算器+读次数控制器</p></li><li><p>AUTO_READ：是否监听读事件，默认 true</p></li><li><p>AUTO_CLOSE：是否在写失败时关闭连接，默认 true</p></li><li><p>MESSAGE_SIZE_ESTIMATOR：数据大小计算器 <code>byteBuf.readableBytes()</code></p></li><li><p>SINGLE_EVENTEXECUTOR_PER_GROUP：当增加 handler 且指定 EventExecutorGroup 时，决定这个 handler 是否只用其中的一个固定的 EventExecutor，默认 true</p></li><li><p>ALLOW_HALF_CLOSURE：是否允许半关闭连接，默认 false</p><ul><li><p>实现关闭通道后还能收到未发送完的数据</p><p><a class=lightgallery href=https://publicpictures.oss-cn-hangzhou.aliyuncs.com/img/image-20230826161404956.png data-thumbnail=https://publicpictures.oss-cn-hangzhou.aliyuncs.com/img/image-20230826161404956.png data-sub-html="<h2>image-20230826161404956</h2>"><img loading=lazy src=https://publicpictures.oss-cn-hangzhou.aliyuncs.com/img/image-20230826161404956.png srcset="https://publicpictures.oss-cn-hangzhou.aliyuncs.com/img/image-20230826161404956.png, https://publicpictures.oss-cn-hangzhou.aliyuncs.com/img/image-20230826161404956.png 1.5x, https://publicpictures.oss-cn-hangzhou.aliyuncs.com/img/image-20230826161404956.png 2x" sizes=auto data-title=image-20230826161404956 data-alt=image-20230826161404956 style="background:url(/svg/loading.min.svg)no-repeat 50%" onload='this.title=this.dataset.title,this.alt=this.dataset.alt;for(const e of["style","data-title","data-alt","onerror","onload"])this.removeAttribute(e);this.dataset.lazyloaded=""' onerror='this.title=this.dataset.title,this.alt=this.dataset.alt;for(const e of["style","data-title","data-alt","onerror","onload"])this.removeAttribute(e)'></a></p></li></ul></li></ul><h3 id=易诊断性>易诊断性</h3><h4 id=完善对象名称>完善对象名称</h4><h5 id=线程名称>线程名称</h5><p><code>NioEventLoopGroup boss = new NioEventLoopGroup(0, new DefaultThreadFactory("boss"));</code></p><h5 id=handler-名称>handler 名称</h5><p><code>pipeline.addLast("frameDecoder",new OrderFrameDecoder());</code></p><h4 id=集成日志>集成日志</h4><p>netty 使用日志的优先级 slf4j > log4j > log4j2 > jdkLogger</p><h5 id=原理>原理</h5><div class=highlight id=id-3><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=c1>// InternalLoggerFactory.java</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>// slf4j &gt; log4j &gt; log4j2 &gt; jdkLogger</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=n>InternalLoggerFactory</span><span class=w> </span><span class=nf>newDefaultFactory</span><span class=p>(</span><span class=n>String</span><span class=w> </span><span class=n>name</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>InternalLoggerFactory</span><span class=w> </span><span class=n>f</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>f</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>Slf4JLoggerFactory</span><span class=p>(</span><span class=kc>true</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>f</span><span class=p>.</span><span class=na>newInstance</span><span class=p>(</span><span class=n>name</span><span class=p>).</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;Using SLF4J as the default logging framework&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w> </span><span class=k>catch</span><span class=w> </span><span class=p>(</span><span class=n>Throwable</span><span class=w> </span><span class=n>ignore1</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>f</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>Log4JLoggerFactory</span><span class=p>.</span><span class=na>INSTANCE</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>f</span><span class=p>.</span><span class=na>newInstance</span><span class=p>(</span><span class=n>name</span><span class=p>).</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;Using Log4J as the default logging framework&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w> </span><span class=k>catch</span><span class=w> </span><span class=p>(</span><span class=n>Throwable</span><span class=w> </span><span class=n>ignore2</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>f</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>Log4J2LoggerFactory</span><span class=p>.</span><span class=na>INSTANCE</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>f</span><span class=p>.</span><span class=na>newInstance</span><span class=p>(</span><span class=n>name</span><span class=p>).</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;Using Log4J2 as the default logging framework&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w> </span><span class=k>catch</span><span class=w> </span><span class=p>(</span><span class=n>Throwable</span><span class=w> </span><span class=n>ignore3</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>f</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>JdkLoggerFactory</span><span class=p>.</span><span class=na>INSTANCE</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>f</span><span class=p>.</span><span class=na>newInstance</span><span class=p>(</span><span class=n>name</span><span class=p>).</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;Using java.util.logging as the default logging framework&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>f</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span></span></span></code></pre></td></tr></table></div></div><h5 id=使用>使用</h5><p>pom.xml</p><div class=highlight id=id-4><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-xml data-lang=xml><span class=line><span class=cl><span class=nt>&lt;dependency&gt;</span>
</span></span><span class=line><span class=cl>  <span class=nt>&lt;groupId&gt;</span>org.slf4j<span class=nt>&lt;/groupId&gt;</span>
</span></span><span class=line><span class=cl>  <span class=nt>&lt;artifactId&gt;</span>slf4j-log4j12<span class=nt>&lt;/artifactId&gt;</span>
</span></span><span class=line><span class=cl>  <span class=nt>&lt;version&gt;</span>1.7.25<span class=nt>&lt;/version&gt;</span>
</span></span><span class=line><span class=cl><span class=nt>&lt;/dependency&gt;</span></span></span></code></pre></td></tr></table></div></div><p>server.java</p><div class=highlight id=id-5><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=n>serverBootstrap</span><span class=p>.</span><span class=na>childHandler</span><span class=p>(</span><span class=k>new</span><span class=w> </span><span class=n>ChannelInitializer</span><span class=o>&lt;</span><span class=n>NioSocketChannel</span><span class=o>&gt;</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nd>@Override</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=kd>protected</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>initChannel</span><span class=p>(</span><span class=n>NioSocketChannel</span><span class=w> </span><span class=n>nioSocketChannel</span><span class=p>)</span><span class=w> </span><span class=kd>throws</span><span class=w> </span><span class=n>Exception</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>ChannelPipeline</span><span class=w> </span><span class=n>pipeline</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>nioSocketChannel</span><span class=p>.</span><span class=na>pipeline</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>pipeline</span><span class=p>.</span><span class=na>addLast</span><span class=p>(</span><span class=s>&#34;logHandler&#34;</span><span class=p>,</span><span class=k>new</span><span class=w> </span><span class=n>LoggingHandler</span><span class=p>(</span><span class=n>LogLevel</span><span class=p>.</span><span class=na>DEBUG</span><span class=p>));</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w> </span><span class=p>});</span></span></span></code></pre></td></tr></table></div></div><p>resources/log4j.properties</p><div class=highlight id=id-6><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-properties data-lang=properties><span class=line><span class=cl><span class=c1>### 设置###</span>
</span></span><span class=line><span class=cl><span class=na>log4j.rootLogger</span> <span class=o>=</span> <span class=s>debug,stdout</span>
</span></span><span class=line><span class=cl><span class=c1>### 输出信息到控制台 ###</span>
</span></span><span class=line><span class=cl><span class=na>log4j.appender.stdout</span> <span class=o>=</span> <span class=s>org.apache.log4j.ConsoleAppender</span>
</span></span><span class=line><span class=cl><span class=na>log4j.appender.stdout.Target</span> <span class=o>=</span> <span class=s>System.out</span>
</span></span><span class=line><span class=cl><span class=na>log4j.appender.stdout.layout</span> <span class=o>=</span> <span class=s>org.apache.log4j.PatternLayout</span>
</span></span><span class=line><span class=cl><span class=na>log4j.appender.stdout.layout.ConversionPattern</span> <span class=o>=</span> <span class=s>[%-5p] %d{yyyy-MM-dd HH:mm:ss,SSS} method:%l%n%m%n</span></span></span></code></pre></td></tr></table></div></div><h4 id=统计并展示当前系统连接数>统计并展示当前系统连接数</h4><p>pom.xml</p><div class=highlight id=id-7><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-xml data-lang=xml><span class=line><span class=cl>        <span class=c>&lt;!-- metrics 度量当前系统连接数--&gt;</span>
</span></span><span class=line><span class=cl>        <span class=nt>&lt;dependency&gt;</span>
</span></span><span class=line><span class=cl>            <span class=nt>&lt;groupId&gt;</span>io.dropwizard.metrics<span class=nt>&lt;/groupId&gt;</span>
</span></span><span class=line><span class=cl>            <span class=nt>&lt;artifactId&gt;</span>metrics-core<span class=nt>&lt;/artifactId&gt;</span>
</span></span><span class=line><span class=cl>            <span class=nt>&lt;version&gt;</span>4.2.19<span class=nt>&lt;/version&gt;</span>
</span></span><span class=line><span class=cl>        <span class=nt>&lt;/dependency&gt;</span>
</span></span><span class=line><span class=cl>        <span class=nt>&lt;dependency&gt;</span>
</span></span><span class=line><span class=cl>            <span class=nt>&lt;groupId&gt;</span>io.dropwizard.metrics<span class=nt>&lt;/groupId&gt;</span>
</span></span><span class=line><span class=cl>            <span class=nt>&lt;artifactId&gt;</span>metrics-jmx<span class=nt>&lt;/artifactId&gt;</span>
</span></span><span class=line><span class=cl>            <span class=nt>&lt;version&gt;</span>4.2.19<span class=nt>&lt;/version&gt;</span>
</span></span><span class=line><span class=cl>        <span class=nt>&lt;/dependency&gt;</span></span></span></code></pre></td></tr></table></div></div><p>MetricHandler.java</p><div class=highlight id=id-8><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * 统计并展示当前系统连接数
</span></span></span><span class=line><span class=cl><span class=cm> */</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nd>@ChannelHandler.Sharable</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kd>class</span> <span class=nc>MetricHandler</span><span class=w> </span><span class=kd>extends</span><span class=w> </span><span class=n>ChannelDuplexHandler</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=n>AtomicLong</span><span class=w> </span><span class=n>totalConnectionNumber</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>AtomicLong</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// 将信息以 Gauge 的形式 注册给 MetricRegistry</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>MetricRegistry</span><span class=w> </span><span class=n>metricRegistry</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>MetricRegistry</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>metricRegistry</span><span class=p>.</span><span class=na>register</span><span class=p>(</span><span class=s>&#34;totalConnectionNumber&#34;</span><span class=p>,</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>Gauge</span><span class=o>&lt;</span><span class=n>Long</span><span class=o>&gt;</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nd>@Override</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=kd>public</span><span class=w> </span><span class=n>Long</span><span class=w> </span><span class=nf>getValue</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>return</span><span class=w> </span><span class=n>totalConnectionNumber</span><span class=p>.</span><span class=na>longValue</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>});</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// console 每 5s 打印</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>ConsoleReporter</span><span class=w> </span><span class=n>consoleReporter</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>ConsoleReporter</span><span class=p>.</span><span class=na>forRegistry</span><span class=p>(</span><span class=n>metricRegistry</span><span class=p>).</span><span class=na>build</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>consoleReporter</span><span class=p>.</span><span class=na>start</span><span class=p>(</span><span class=n>5</span><span class=p>,</span><span class=w> </span><span class=n>TimeUnit</span><span class=p>.</span><span class=na>SECONDS</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// jconsole 实时展示</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>JmxReporter</span><span class=w> </span><span class=n>jmxReporter</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>JmxReporter</span><span class=p>.</span><span class=na>forRegistry</span><span class=p>(</span><span class=n>metricRegistry</span><span class=p>).</span><span class=na>build</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>jmxReporter</span><span class=p>.</span><span class=na>start</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Override</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>channelActive</span><span class=p>(</span><span class=n>ChannelHandlerContext</span><span class=w> </span><span class=n>ctx</span><span class=p>)</span><span class=w> </span><span class=kd>throws</span><span class=w> </span><span class=n>Exception</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>totalConnectionNumber</span><span class=p>.</span><span class=na>incrementAndGet</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kd>super</span><span class=p>.</span><span class=na>channelActive</span><span class=p>(</span><span class=n>ctx</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Override</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>channelInactive</span><span class=p>(</span><span class=n>ChannelHandlerContext</span><span class=w> </span><span class=n>ctx</span><span class=p>)</span><span class=w> </span><span class=kd>throws</span><span class=w> </span><span class=n>Exception</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>totalConnectionNumber</span><span class=p>.</span><span class=na>decrementAndGet</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kd>super</span><span class=p>.</span><span class=na>channelInactive</span><span class=p>(</span><span class=n>ctx</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span></span></span></code></pre></td></tr></table></div></div><p>server.java</p><div class=highlight id=id-9><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span><span class=lnt>9
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=n>MetricHandler</span><span class=w> </span><span class=n>metricHandler</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>MetricHandler</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>serverBootstrap</span><span class=p>.</span><span class=na>childHandler</span><span class=p>(</span><span class=k>new</span><span class=w> </span><span class=n>ChannelInitializer</span><span class=o>&lt;</span><span class=n>NioSocketChannel</span><span class=o>&gt;</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nd>@Override</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=kd>protected</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>initChannel</span><span class=p>(</span><span class=n>NioSocketChannel</span><span class=w> </span><span class=n>nioSocketChannel</span><span class=p>)</span><span class=w> </span><span class=kd>throws</span><span class=w> </span><span class=n>Exception</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>ChannelPipeline</span><span class=w> </span><span class=n>pipeline</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>nioSocketChannel</span><span class=p>.</span><span class=na>pipeline</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// 统计连接数</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>pipeline</span><span class=p>.</span><span class=na>addLast</span><span class=p>(</span><span class=s>&#34;metricHandler&#34;</span><span class=p>,</span><span class=w> </span><span class=n>metricHandler</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>});</span></span></span></code></pre></td></tr></table></div></div><p><a class=lightgallery href=https://publicpictures.oss-cn-hangzhou.aliyuncs.com/img/image-20230826194730417.png data-thumbnail=https://publicpictures.oss-cn-hangzhou.aliyuncs.com/img/image-20230826194730417.png data-sub-html="<h2>image-20230826194730417</h2>"><img loading=lazy src=https://publicpictures.oss-cn-hangzhou.aliyuncs.com/img/image-20230826194730417.png srcset="https://publicpictures.oss-cn-hangzhou.aliyuncs.com/img/image-20230826194730417.png, https://publicpictures.oss-cn-hangzhou.aliyuncs.com/img/image-20230826194730417.png 1.5x, https://publicpictures.oss-cn-hangzhou.aliyuncs.com/img/image-20230826194730417.png 2x" sizes=auto data-title=image-20230826194730417 data-alt=image-20230826194730417 style="background:url(/svg/loading.min.svg)no-repeat 50%" onload='this.title=this.dataset.title,this.alt=this.dataset.alt;for(const e of["style","data-title","data-alt","onerror","onload"])this.removeAttribute(e);this.dataset.lazyloaded=""' onerror='this.title=this.dataset.title,this.alt=this.dataset.alt;for(const e of["style","data-title","data-alt","onerror","onload"])this.removeAttribute(e)'></a></p><h3 id=内存泄漏检测>内存泄漏检测</h3><h4 id=resourceleakdetector>ResourceLeakDetector</h4><h5 id=级别>级别</h5><div class=highlight id=id-10><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span><span class=w> </span><span class=kd>enum</span><span class=w> </span><span class=n>Level</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=n>DISABLED</span><span class=p>,</span><span class=w> </span><span class=c1>// 关闭</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=n>SIMPLE</span><span class=p>,</span><span class=w> </span><span class=c1>// 抽样，是否泄露 (默认)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=n>ADVANCED</span><span class=p>,</span><span class=w> </span><span class=c1>// 抽样，具体泄露地方</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=n>PARANOID</span><span class=p>;</span><span class=w> </span><span class=c1>// 全样本</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span></span></span></code></pre></td></tr></table></div></div><p>修改 VM options：<code>-Dio.netty.leakDetection.level=PARANOID</code></p><h5 id=弱引用>弱引用</h5><p>将 DefaultResourceLeak 放入 ReferenceQueue</p><p>判断时机：弱引用指向对象被 GC 回收时，遍历弱引用队列 ReferenceQueue</p><h5 id=记录访问信息>记录访问信息</h5><p><code>Record extends Thowable</code></p><h5 id=触发汇报时机>触发汇报时机</h5><p><code>AbstractByteBufAllocator#buffer()</code></p><p><a class=lightgallery href=https://publicpictures.oss-cn-hangzhou.aliyuncs.com/img/image-20230826194637484.png data-thumbnail=https://publicpictures.oss-cn-hangzhou.aliyuncs.com/img/image-20230826194637484.png data-sub-html="<h2>image-20230826194637484</h2>"><img loading=lazy src=https://publicpictures.oss-cn-hangzhou.aliyuncs.com/img/image-20230826194637484.png srcset="https://publicpictures.oss-cn-hangzhou.aliyuncs.com/img/image-20230826194637484.png, https://publicpictures.oss-cn-hangzhou.aliyuncs.com/img/image-20230826194637484.png 1.5x, https://publicpictures.oss-cn-hangzhou.aliyuncs.com/img/image-20230826194637484.png 2x" sizes=auto data-title=image-20230826194637484 data-alt=image-20230826194637484 style="background:url(/svg/loading.min.svg)no-repeat 50%" onload='this.title=this.dataset.title,this.alt=this.dataset.alt;for(const e of["style","data-title","data-alt","onerror","onload"])this.removeAttribute(e);this.dataset.lazyloaded=""' onerror='this.title=this.dataset.title,this.alt=this.dataset.alt;for(const e of["style","data-title","data-alt","onerror","onload"])this.removeAttribute(e)'></a></p><h3 id=netty-注解>Netty 注解</h3><ul><li>Sharable：标识 handler 提醒可共享，否则不能重复加入 pipeline。如果没有需要竞争的资源，就可以共享。</li><li>Skip：跳过 handler 的执行</li><li>UnstableApi：标识不稳定的 Api</li></ul><h3 id=pipeline-优化>pipeline 优化</h3><h4 id=线程模型优化>线程模型优化</h4><ul><li><p>CPU 密集型</p><ul><li>Runtime.getRuntime().availableProcessors() * 2</li><li>io.netty.availableProcessors * 2【考虑 docker】</li><li>io.netty.eventLoopThreads</li></ul></li><li><p>IO 密集型：独立出线程池来处理业务</p><ul><li><p>在 handler 内部使用 JDK Executors</p></li><li><p>添加 handler 时指定 <code>EventExecutorGroup</code>，和 handler 参数一起放入 pipeline 中</p><ul><li><div class=highlight id=id-11><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span><span class=lnt>9
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=n>UnorderedThreadPoolEventExecutor</span><span class=w> </span><span class=n>businessExecutor</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>UnorderedThreadPoolEventExecutor</span><span class=p>(</span><span class=n>10</span><span class=p>,</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>DefaultThreadFactory</span><span class=p>(</span><span class=s>&#34;business&#34;</span><span class=p>));</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>serverBootstrap</span><span class=p>.</span><span class=na>childHandler</span><span class=p>(</span><span class=k>new</span><span class=w> </span><span class=n>ChannelInitializer</span><span class=o>&lt;</span><span class=n>NioSocketChannel</span><span class=o>&gt;</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nd>@Override</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=kd>protected</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>initChannel</span><span class=p>(</span><span class=n>NioSocketChannel</span><span class=w> </span><span class=n>nioSocketChannel</span><span class=p>)</span><span class=w> </span><span class=kd>throws</span><span class=w> </span><span class=n>Exception</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>ChannelPipeline</span><span class=w> </span><span class=n>pipeline</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>nioSocketChannel</span><span class=p>.</span><span class=na>pipeline</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// 处理：IO 密集型，独立线程池</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>pipeline</span><span class=p>.</span><span class=na>addLast</span><span class=p>(</span><span class=n>businessExecutor</span><span class=p>,</span><span class=s>&#34;business&#34;</span><span class=p>,</span><span class=k>new</span><span class=w> </span><span class=n>OrderServerProcessHandler</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>});</span></span></span></code></pre></td></tr></table></div></div></li><li><p>为什么用 UnorderedThreadPoolEventExecutor 而不是 NioEventLoopGroup？</p></li><li><p>因为 NioEventLoopGroup 在 ChannelOption.SINGLE_EVENTEXECUTOR_PER_GROUP 参数的作用下， next() 方法返回 this，默认只启用一个线程。</p></li></ul></li></ul></li></ul><h4 id=增强写>增强写</h4><p><code>pipeline.addLast("flushEnhance",new FlushConsolidationHandler(5,true));</code></p><h4 id=流量整形>流量整形</h4><p><code>pipeline.addLast("TSHandler", globalTrafficShapingHandler);</code></p><h4 id=linux-下开启-native>Linux 下开启 native</h4><ol><li>准备好 native 库</li><li>加载顺序：java.library.path 优先于 META-INF/native/</li></ol><h4 id=防止-oom>防止 OOM</h4><div class=highlight id=id-12><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>channelHandlerContext</span><span class=p>.</span><span class=na>channel</span><span class=p>().</span><span class=na>isActive</span><span class=p>()</span><span class=w> </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=n>channelHandlerContext</span><span class=p>.</span><span class=na>channel</span><span class=p>().</span><span class=na>isWritable</span><span class=p>()){</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=n>channelHandlerContext</span><span class=p>.</span><span class=na>writeAndFlush</span><span class=p>(</span><span class=n>responseMessage</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=k>else</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=n>log</span><span class=p>.</span><span class=na>error</span><span class=p>(</span><span class=s>&#34;message dropped&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span></span></span></code></pre></td></tr></table></div></div><h4 id=空闲监测keepalive-和-idle>空闲监测：keepalive 和 idle</h4><p>位于 TCP 层，不同于 HTTP的 keep-alive（默认于 HTTP/1.1 支持），idle 配合监测：</p><ol><li>减少 keepalive 消息</li><li>直接关闭连接，防止拒绝服务攻击</li></ol><div class=highlight id=id-13><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=c1>// server 端开启 TCP keepalive</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>// 在很多的 if-else 语句之中</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>bootstrap</span><span class=p>.</span><span class=na>childOption</span><span class=p>(</span><span class=n>ChannelOption</span><span class=p>.</span><span class=na>SO_KEEPALIVE</span><span class=p>,</span><span class=kc>true</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>// 以 key-value 方式加入参数（推荐）</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>bootstrap</span><span class=p>.</span><span class=na>childOption</span><span class=p>(</span><span class=n>NioChannelOption</span><span class=p>.</span><span class=na>of</span><span class=p>(</span><span class=n>StandardSocketOptions</span><span class=p>.</span><span class=na>SO_KEEPALIVE</span><span class=p>),</span><span class=kc>true</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>// 开启 idel check，对应于 读、写、all 三个时间</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>pipeline</span><span class=p>().</span><span class=na>addLast</span><span class=p>(</span><span class=s>&#34;idleCheckHandler&#34;</span><span class=p>,</span><span class=k>new</span><span class=w> </span><span class=n>IdleStateHandler</span><span class=p>(</span><span class=n>0</span><span class=p>,</span><span class=n>20</span><span class=p>,</span><span class=n>0</span><span class=p>,</span><span class=n>TimeUnit</span><span class=p>.</span><span class=na>SECONDS</span><span class=p>));</span></span></span></code></pre></td></tr></table></div></div><h5 id=服务端>服务端</h5><p>ServerIdleCheckHandler.java</p><div class=highlight id=id-14><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@Slf4j</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kd>class</span> <span class=nc>ServerIdleCheckHandler</span><span class=w> </span><span class=kd>extends</span><span class=w> </span><span class=n>IdleStateHandler</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=nf>ServerIdleCheckHandler</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kd>super</span><span class=p>(</span><span class=n>10</span><span class=p>,</span><span class=w> </span><span class=n>0</span><span class=p>,</span><span class=w> </span><span class=n>0</span><span class=p>,</span><span class=w> </span><span class=n>TimeUnit</span><span class=p>.</span><span class=na>SECONDS</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Override</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>protected</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>channelIdle</span><span class=p>(</span><span class=n>ChannelHandlerContext</span><span class=w> </span><span class=n>ctx</span><span class=p>,</span><span class=w> </span><span class=n>IdleStateEvent</span><span class=w> </span><span class=n>evt</span><span class=p>)</span><span class=w> </span><span class=kd>throws</span><span class=w> </span><span class=n>Exception</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>evt</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=n>IdleStateEvent</span><span class=p>.</span><span class=na>FIRST_READER_IDLE_STATE_EVENT</span><span class=p>){</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>log</span><span class=p>.</span><span class=na>info</span><span class=p>(</span><span class=s>&#34;idle check happen, so close the connection&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>ctx</span><span class=p>.</span><span class=na>close</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>return</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kd>super</span><span class=p>.</span><span class=na>channelIdle</span><span class=p>(</span><span class=n>ctx</span><span class=p>,</span><span class=w> </span><span class=n>evt</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span></span></span></code></pre></td></tr></table></div></div><p>Server.java</p><div class=highlight id=id-15><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=c1>// Idle监测</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>pipeline</span><span class=p>.</span><span class=na>addLast</span><span class=p>(</span><span class=s>&#34;idleCheck&#34;</span><span class=p>,</span><span class=k>new</span><span class=w> </span><span class=n>ServerIdleCheckHandler</span><span class=p>());</span></span></span></code></pre></td></tr></table></div></div><h5 id=客户端>客户端</h5><p>ClientIdleCheckHandler.java</p><div class=highlight id=id-16><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span><span class=w> </span><span class=kd>class</span> <span class=nc>ClientIdleCheckHandler</span><span class=w> </span><span class=kd>extends</span><span class=w> </span><span class=n>IdleStateHandler</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=nf>ClientIdleCheckHandler</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kd>super</span><span class=p>(</span><span class=n>0</span><span class=p>,</span><span class=n>5</span><span class=p>,</span><span class=n>0</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span></span></span></code></pre></td></tr></table></div></div><p>KeepaliveHandler.java</p><div class=highlight id=id-17><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@Slf4j</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nd>@ChannelHandler.Sharable</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kd>class</span> <span class=nc>KeepaliveHandler</span><span class=w> </span><span class=kd>extends</span><span class=w> </span><span class=n>ChannelDuplexHandler</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Override</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>userEventTriggered</span><span class=p>(</span><span class=n>ChannelHandlerContext</span><span class=w> </span><span class=n>ctx</span><span class=p>,</span><span class=w> </span><span class=n>Object</span><span class=w> </span><span class=n>evt</span><span class=p>)</span><span class=w> </span><span class=kd>throws</span><span class=w> </span><span class=n>Exception</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>evt</span><span class=o>==</span><span class=w> </span><span class=n>IdleStateEvent</span><span class=p>.</span><span class=na>FIRST_WRITER_IDLE_STATE_EVENT</span><span class=p>){</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>log</span><span class=p>.</span><span class=na>info</span><span class=p>(</span><span class=s>&#34;write idle happen, so need to send keepalive to keep connection not closed&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>KeepaliveOperation</span><span class=w> </span><span class=n>keepaliveOperation</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>KeepaliveOperation</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>RequestMessage</span><span class=w> </span><span class=n>requestMessage</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>RequestMessage</span><span class=p>(</span><span class=n>IdUtil</span><span class=p>.</span><span class=na>nextId</span><span class=p>(),</span><span class=n>keepaliveOperation</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>ctx</span><span class=p>.</span><span class=na>writeAndFlush</span><span class=p>(</span><span class=n>requestMessage</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kd>super</span><span class=p>.</span><span class=na>userEventTriggered</span><span class=p>(</span><span class=n>ctx</span><span class=p>,</span><span class=w> </span><span class=n>evt</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span></span></span></code></pre></td></tr></table></div></div><p>Client.java</p><div class=highlight id=id-18><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=c1>// Sharable</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>KeepaliveHandler</span><span class=w> </span><span class=n>keepaliveHandler</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>KeepaliveHandler</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>bootstrap</span><span class=p>.</span><span class=na>handler</span><span class=p>(</span><span class=k>new</span><span class=w> </span><span class=n>ChannelInitializer</span><span class=o>&lt;</span><span class=n>NioSocketChannel</span><span class=o>&gt;</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nd>@Override</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=kd>protected</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>initChannel</span><span class=p>(</span><span class=n>NioSocketChannel</span><span class=w> </span><span class=n>nioSocketChannel</span><span class=p>)</span><span class=w> </span><span class=kd>throws</span><span class=w> </span><span class=n>Exception</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>ChannelPipeline</span><span class=w> </span><span class=n>pipeline</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>nioSocketChannel</span><span class=p>.</span><span class=na>pipeline</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>pipeline</span><span class=p>.</span><span class=na>addLast</span><span class=p>(</span><span class=s>&#34;keepalive&#34;</span><span class=p>,</span><span class=n>keepaliveHandler</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>});</span></span></span></code></pre></td></tr></table></div></div><h4 id=黑白名单>黑白名单</h4><p>Server.java</p><div class=highlight id=id-19><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=c1>// 黑白名单 Sharable</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>final</span><span class=w> </span><span class=n>RuleBasedIpFilter</span><span class=w> </span><span class=n>ruleBasedIpFilter</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>RuleBasedIpFilter</span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=c1>// 基于 CIDR 前缀，以下表示禁止以 127.1 开头的 ip 地址</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=k>new</span><span class=w> </span><span class=n>IpSubnetFilterRule</span><span class=p>(</span><span class=s>&#34;127.1.0.1&#34;</span><span class=p>,</span><span class=w> </span><span class=n>16</span><span class=p>,</span><span class=w> </span><span class=n>IpFilterRuleType</span><span class=p>.</span><span class=na>REJECT</span><span class=p>));</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>...</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=n>pipeline</span><span class=p>.</span><span class=na>addLast</span><span class=p>(</span><span class=s>&#34;ipFilter&#34;</span><span class=p>,</span><span class=n>ruleBasedIpFilter</span><span class=p>);</span></span></span></code></pre></td></tr></table></div></div><h4 id=认证>认证</h4><div class=highlight id=id-20><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * 自定义认证
</span></span></span><span class=line><span class=cl><span class=cm> * 若认证成功，移除认证 handler；若认证失败，关闭连接，也不需要该 handler 了
</span></span></span><span class=line><span class=cl><span class=cm> */</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nd>@Slf4j</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nd>@ChannelHandler.Sharable</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kd>class</span> <span class=nc>AuthHandler</span><span class=w> </span><span class=kd>extends</span><span class=w> </span><span class=n>SimpleChannelInboundHandler</span><span class=o>&lt;</span><span class=n>RequestMessage</span><span class=o>&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Override</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>protected</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>channelRead0</span><span class=p>(</span><span class=n>ChannelHandlerContext</span><span class=w> </span><span class=n>ctx</span><span class=p>,</span><span class=w> </span><span class=n>RequestMessage</span><span class=w> </span><span class=n>msg</span><span class=p>)</span><span class=w> </span><span class=kd>throws</span><span class=w> </span><span class=n>Exception</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>Operation</span><span class=w> </span><span class=n>operation</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>msg</span><span class=p>.</span><span class=na>getMessageBody</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>operation</span><span class=w> </span><span class=k>instanceof</span><span class=w> </span><span class=n>AuthOperation</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=c1>// 认证操作</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>AuthOperation</span><span class=w> </span><span class=n>authOperation</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>AuthOperation</span><span class=p>.</span><span class=na>class</span><span class=p>.</span><span class=na>cast</span><span class=p>(</span><span class=n>operation</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>AuthOperationResult</span><span class=w> </span><span class=n>authOperationResult</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>authOperation</span><span class=p>.</span><span class=na>execute</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>authOperationResult</span><span class=p>.</span><span class=na>isPassAuth</span><span class=p>())</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>log</span><span class=p>.</span><span class=na>info</span><span class=p>(</span><span class=s>&#34;pass auth&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w> </span><span class=k>else</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>log</span><span class=p>.</span><span class=na>error</span><span class=p>(</span><span class=s>&#34;fail to auth&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>ctx</span><span class=p>.</span><span class=na>close</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w> </span><span class=k>else</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>log</span><span class=p>.</span><span class=na>error</span><span class=p>(</span><span class=s>&#34;expect first msg is auth&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>ctx</span><span class=p>.</span><span class=na>close</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w> </span><span class=k>catch</span><span class=w> </span><span class=p>(</span><span class=n>Exception</span><span class=w> </span><span class=n>e</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>log</span><span class=p>.</span><span class=na>error</span><span class=p>(</span><span class=s>&#34;exception happen: &#34;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>e</span><span class=p>.</span><span class=na>getMessage</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>ctx</span><span class=p>.</span><span class=na>close</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w> </span><span class=k>finally</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>ctx</span><span class=p>.</span><span class=na>pipeline</span><span class=p>().</span><span class=na>remove</span><span class=p>(</span><span class=k>this</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span></span></span></code></pre></td></tr></table></div></div><p>加入 pipeline 同理，Sharable 的 handler 对象提前定义，但是在顺序上需要注意，<strong>必须放在 protocolDecoder 之后</strong>，因为它需要的参数不是 ByteBuf，而是 RequestMessage 对象，如下：</p><div class=highlight id=id-21><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=c1>// 请求</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>pipeline</span><span class=p>.</span><span class=na>addLast</span><span class=p>(</span><span class=s>&#34;frameDecoder&#34;</span><span class=p>,</span><span class=k>new</span><span class=w> </span><span class=n>OrderFrameDecoder</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>pipeline</span><span class=p>.</span><span class=na>addLast</span><span class=p>(</span><span class=s>&#34;protocolDecoder&#34;</span><span class=p>,</span><span class=k>new</span><span class=w> </span><span class=n>OrderProtocolDecoder</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>// 认证， 必须放在 protocolDecoder 之后</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>pipeline</span><span class=p>.</span><span class=na>addLast</span><span class=p>(</span><span class=s>&#34;ipFilter&#34;</span><span class=p>,</span><span class=n>authHandler</span><span class=p>);</span></span></span></code></pre></td></tr></table></div></div><h4 id=ssltls-协议>SSL/TLS 协议</h4><p>在传输层上封装了应用层协议，在不需要修改应用层协议的前提下提供安全保障。</p><p><a class=lightgallery href=https://publicpictures.oss-cn-hangzhou.aliyuncs.com/img/image-20230827100639817.png data-thumbnail=https://publicpictures.oss-cn-hangzhou.aliyuncs.com/img/image-20230827100639817.png data-sub-html="<h2>image-20230827100639817</h2>"><img loading=lazy src=https://publicpictures.oss-cn-hangzhou.aliyuncs.com/img/image-20230827100639817.png srcset="https://publicpictures.oss-cn-hangzhou.aliyuncs.com/img/image-20230827100639817.png, https://publicpictures.oss-cn-hangzhou.aliyuncs.com/img/image-20230827100639817.png 1.5x, https://publicpictures.oss-cn-hangzhou.aliyuncs.com/img/image-20230827100639817.png 2x" sizes=auto data-title=image-20230827100639817 data-alt=image-20230827100639817 style="background:url(/svg/loading.min.svg)no-repeat 50%" onload='this.title=this.dataset.title,this.alt=this.dataset.alt;for(const e of["style","data-title","data-alt","onerror","onload"])this.removeAttribute(e);this.dataset.lazyloaded=""' onerror='this.title=this.dataset.title,this.alt=this.dataset.alt;for(const e of["style","data-title","data-alt","onerror","onload"])this.removeAttribute(e)'></a></p><p>非对称加密：公钥放在证书，私钥通过三个随机数生成。</p><p>抓包工具：WireShark</p><p>Server.java</p><div class=highlight id=id-22><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=c1>// SSL 自签证书</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>SelfSignedCertificate</span><span class=w> </span><span class=n>selfSignedCertificate</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>SelfSignedCertificate</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>// 证书路径，用于客户端导入</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>log</span><span class=p>.</span><span class=na>info</span><span class=p>(</span><span class=n>selfSignedCertificate</span><span class=p>.</span><span class=na>certificate</span><span class=p>().</span><span class=na>toString</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>SslContext</span><span class=w> </span><span class=n>sslContext</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>SslContextBuilder</span><span class=p>.</span><span class=na>forServer</span><span class=p>(</span><span class=n>selfSignedCertificate</span><span class=p>.</span><span class=na>certificate</span><span class=p>(),</span><span class=w> </span><span class=n>selfSignedCertificate</span><span class=p>.</span><span class=na>privateKey</span><span class=p>()).</span><span class=na>build</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>SslHandler</span><span class=w> </span><span class=n>sslHandler</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>sslContext</span><span class=p>.</span><span class=na>newHandler</span><span class=p>(</span><span class=n>nioSocketChannel</span><span class=p>.</span><span class=na>alloc</span><span class=p>());</span></span></span></code></pre></td></tr></table></div></div><p>Client.java</p><div class=highlight id=id-23><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=n>SslContext</span><span class=w> </span><span class=n>sslContext</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>SslContextBuilder</span><span class=p>.</span><span class=na>forClient</span><span class=p>().</span><span class=na>build</span><span class=p>();</span></span></span></code></pre></td></tr></table></div></div><h3 id=netty-的应用>Netty 的应用</h3><h4 id=dubbo>Dubbo</h4><ul><li>利用 Idle 机制，在读写都空闲时，触发心跳。</li><li>使用 socks5 代替 http 协议，能代理 TCP、UDP。</li></ul><h4 id=hadoop>Hadoop</h4><ul><li>HTTP 服务构建</li><li>用 filter 来阻止 CSRF 跨站请求伪造</li><li>分块写（chucked write）</li></ul><h3 id=开源贡献注意事项>开源贡献注意事项</h3><ul><li>代码风格和项目保持一致</li><li><code>Deprecated</code> 要写注释，建议用哪个方法或类来替代</li><li>功能性提升，要做单元测试；性能优化，要做性能测试（benchmark）</li><li>400 行以内为一个 PR，作为一次 Code Review</li></ul><h3 id=参考资料>参考资料</h3><ul><li>极客时间《Netty 源码剖析与实战》</li></ul></div><div class=post-footer id=post-footer><div class=post-info><div class=post-info-line><div class=post-info-mod><span title="更新于 2023-08-27 21:01:43">更新于 2023-08-27&nbsp;</span></div><div class=post-info-license><span><a rel="license external nofollow noopener noreferrer" href=https://creativecommons.org/licenses/by-nc/4.0/ target=_blank>CC BY-NC 4.0</a></span></div></div><div class=post-info-line><div class=post-info-md></div><div class=post-info-share><span><a href=javascript:void(0); title="分享到 微博" data-sharer=weibo data-url=https://leni.fun/netty%E5%AE%9E%E8%B7%B5%E8%AE%B0%E5%BD%95/ data-title="Netty 实践记录" data-image=/images/pic11.jpg><i class="fa-brands fa-weibo fa-fw" aria-hidden=true></i></a></span></div></div></div><div class=post-info-more><section class=post-tags><i class="fa-solid fa-tags fa-fw me-1" aria-hidden=true></i><a href=/tags/network/ class=post-tag>NetWork</a><a href=/tags/netty/ class=post-tag>Netty</a></section><section><span><a href=javascript:void(0); onclick=window.history.back()>返回</a></span>&nbsp;|&nbsp;<span><a href=/>主页</a></span></section></div><div class=post-nav><a href=/netty/ class=post-nav-item rel=prev title=🚩Netty><i class="fa-solid fa-angle-left fa-fw" aria-hidden=true></i>🚩Netty</a>
<a href=/springsecurity/ class=post-nav-item rel=next title=SpringSecurity>SpringSecurity<i class="fa-solid fa-angle-right fa-fw" aria-hidden=true></i></a></div></div></article></main><footer class=footer><div class=footer-container><div class="footer-line copyright order-5" itemscope itemtype=http://schema.org/CreativeWork><i class="fa-regular fa-copyright fa-fw" aria-hidden=true></i>
<span itemprop=copyrightYear>2021 - 2024</span><span class=author itemprop=copyrightHolder>
<a href=/>都将会</a></span><span class="license footer-divider"><a rel="license external nofollow noopener noreferrer" href=https://beian.miit.gov.cn target=_blank>浙ICP备2023023782号</a></span></div><div class="footer-line statistics"><span class=site-time title=网站运行中……><i class="fa-solid fa-heartbeat fa-fw animate-icon" aria-hidden=true></i><span class="run-times ms-1">网站运行中……</span></span></div><div class="footer-line visitor order-4"><span id=busuanzi_container_site_uv title=总访客数><i class="fa-regular fa-user fa-fw" aria-hidden=true></i>&nbsp;<span id=busuanzi_value_site_uv><i class="fa-solid fa-spinner fa-spin fa-fw" aria-hidden=true></i></span></span><span id=busuanzi_container_site_pv class=footer-divider title=总访问量><i class="fa-regular fa-eye fa-fw" aria-hidden=true></i>&nbsp;<span id=busuanzi_value_site_pv><i class="fa-solid fa-spinner fa-spin fa-fw" aria-hidden=true></i></span></span></div></div></footer></div><div class=widgets><div class="fixed-buttons animate__faster d-none"><div class="fixed-button back-to-top" role=button aria-label=回到顶部><i class="fa-solid fa-arrow-up fa-fw" aria-hidden=true></i><span class=variant-numeric>0%</span></div></div><a href=https://github.com/hihihiman/hihihiman.github.io title=博客源码 target=_blank rel="external nofollow" class="github-corner left d-none-mobile"><svg viewBox="0 0 250 250" aria-hidden="true"><path d="M0 0 115 115h15l12 27L250 250V0z"/><path d="M128.3 109C113.8 99.7 119 89.6 119 89.6 122 82.7 120.5 78.6 120.5 78.6 119.2 72 123.4 76.3 123.4 76.3 127.3 80.9 125.5 87.3 125.5 87.3 122.9 97.6 130.6 101.9 134.4 103.2" fill="currentcolor" style="transform-origin:130px 106px" class="octo-arm"/><path d="M115 115C114.9 115.1 118.7 116.5 119.8 115.4l13.9-13.8C136.9 99.2 139.9 98.4 142.2 98.6 133.8 88 127.5 74.4 143.8 58 148.5 53.4 154 51.2 159.7 51 160.3 49.4 163.2 43.6 171.4 40.1 171.4 40.1 176.1 42.5 178.8 56.2 183.1 58.6 187.2 61.8 190.9 65.4 194.5 69 197.7 73.2 200.1 77.6 213.8 80.2 216.3 84.9 216.3 84.9 212.7 93.1 206.9 96 205.4 96.6 205.1 102.4 203 107.8 198.3 112.5 181.9 128.9 168.3 122.5 157.7 114.1 157.9 116.9 156.7 120.9 152.7 124.9L141 136.5C139.8 137.7 141.6 141.9 141.8 141.8z" fill="currentcolor" class="octo-body"/></svg></a><div id=mask></div><div class=reading-progress-bar style=left:0;bottom:0></div><noscript><div class=noscript-warning>FixIt 主题在启用 JavaScript 的情况下效果最佳。</div></noscript></div><link rel=stylesheet href=/lib/lightgallery/css/lightgallery-bundle.min.css><link rel=stylesheet href=/lib/katex/katex.min.css><link rel=stylesheet href=/lib/cookieconsent/cookieconsent.min.css><link rel=stylesheet href=/lib/pace/themes/pink/pace-theme-center-atom.css><script src=/lib/autocomplete/autocomplete.min.js defer></script><script src=/lib/fuse/fuse.min.js defer></script><script src=/lib/lightgallery/lightgallery.min.js defer></script><script src=/lib/lightgallery/plugins/thumbnail/lg-thumbnail.min.js defer></script><script src=/lib/lightgallery/plugins/zoom/lg-zoom.min.js defer></script><script src=/lib/sharer/sharer.min.js async defer></script><script src=/lib/typeit/index.umd.js defer></script><script src=/lib/katex/katex.min.js defer></script><script src=/lib/katex/auto-render.min.js defer></script><script src=/lib/katex/copy-tex.min.js defer></script><script src=/lib/katex/mhchem.min.js defer></script><script src=/lib/cookieconsent/cookieconsent.min.js defer></script><script src=/lib/pangu/pangu.min.js defer></script><script src=//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js async defer></script><script src=/lib/pace/pace.min.js async defer></script><script>window.config={autoBookmark:!0,code:{copyTitle:"复制到剪贴板",editLockTitle:"锁定可编辑代码块",editUnLockTitle:"解锁可编辑代码块",editable:!0,maxShownLines:1024},comment:{enable:!1},cookieconsent:{content:{dismiss:"同意",link:"了解更多",message:"本网站使用 Cookies 来改善您的浏览体验。"},enable:!0,palette:{button:{background:"#f0f0f0"},popup:{background:"#1aa3ff"}},theme:"edgeless"},data:{"typeit-header-subtitle-desktop":"的博客           ","typeit-header-subtitle-mobile":"的博客           "},enablePWA:!0,lightgallery:!0,math:{delimiters:[{display:!0,left:"$$",right:"$$"},{display:!0,left:"\\[",right:"\\]"},{display:!0,left:"\\begin{equation}",right:"\\end{equation}"},{display:!0,left:"\\begin{equation*}",right:"\\end{equation*}"},{display:!0,left:"\\begin{align}",right:"\\end{align}"},{display:!0,left:"\\begin{align*}",right:"\\end{align*}"},{display:!0,left:"\\begin{alignat}",right:"\\end{alignat}"},{display:!0,left:"\\begin{alignat*}",right:"\\end{alignat*}"},{display:!0,left:"\\begin{gather}",right:"\\end{gather}"},{display:!0,left:"\\begin{CD}",right:"\\end{CD}"},{display:!1,left:"$",right:"$"},{display:!1,left:"\\(",right:"\\)"}],strict:!1},pangu:{enable:!0,selector:"article"},search:{distance:100,findAllMatches:!1,highlightTag:"em",ignoreFieldNorm:!0,ignoreLocation:!0,isCaseSensitive:!1,location:0,maxResultLength:10,minMatchCharLength:2,noResultsFound:"没有找到结果",snippetLength:50,threshold:.3,useExtendedSearch:!0},siteTime:"2021-08-26T23:31:00+08:00",typeit:{cursorChar:"_",cursorSpeed:1e3,data:{"typeit-header-subtitle-desktop":["typeit-header-subtitle-desktop"],"typeit-header-subtitle-mobile":["typeit-header-subtitle-mobile"]},duration:-1,loop:!0,speed:150}}</script><script src=/js/theme.min.js defer></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/jquery@2.1.3/dist/jquery.min.js></script><script type=text/javascript src=/js/custom.js></script></body></html>
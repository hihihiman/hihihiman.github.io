<!doctype html><html itemscope itemtype=http://schema.org/WebPage lang=zh-CN><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1,maximum-scale=2"><meta name=robots content="noodp"><title>NIO -</title><meta name=author content="都将会"><meta name=author-link content><meta name=description content="
NIO 于 jdk1.4 引入，支持面向缓冲区的、基于通道的IO操作。
"><meta name=keywords content="都将会,Java"><meta itemprop=name content="NIO"><meta itemprop=description content="
NIO 于 jdk1.4 引入，支持面向缓冲区的、基于通道的IO操作。
"><meta itemprop=datePublished content="2023-08-15T13:04:23+08:00"><meta itemprop=dateModified content="2023-08-15T13:04:23+08:00"><meta itemprop=wordCount content="3656"><meta itemprop=image content="https://leni.fun/images/avatar.jpg"><meta itemprop=keywords content="NIO,Java,Network,"><meta property="og:title" content="NIO"><meta property="og:description" content="
NIO 于 jdk1.4 引入，支持面向缓冲区的、基于通道的IO操作。
"><meta property="og:type" content="article"><meta property="og:url" content="https://leni.fun/nio/"><meta property="og:image" content="https://leni.fun/images/avatar.jpg"><meta property="article:section" content="posts"><meta property="article:published_time" content="2023-08-15T13:04:23+08:00"><meta property="article:modified_time" content="2023-08-15T13:04:23+08:00"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://leni.fun/images/avatar.jpg"><meta name=twitter:title content="NIO"><meta name=twitter:description content="
NIO 于 jdk1.4 引入，支持面向缓冲区的、基于通道的IO操作。
"><meta name=application-name content="都将会的 APP"><meta name=apple-mobile-web-app-title content="都将会的 APP"><meta name=theme-color data-light=#f8f8f8 data-dark=#252627 content="#f8f8f8"><meta name=msapplication-TileColor content="#da532c"><link rel="shortcut icon" type=image/x-icon href=/favicon.ico><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=mask-icon href=/safari-pinned-tab.svg color=#5bbad5><link rel=manifest href=/site.webmanifest><link rel=canonical href=https://leni.fun/nio/><link rel=prev href=https://leni.fun/aop%E5%AE%9E%E7%8E%B0%E6%96%B9%E6%B3%95%E8%80%97%E6%97%B6%E7%BB%9F%E8%AE%A1/><link rel=next href=https://leni.fun/dp/><link rel=stylesheet href=/css/style.min.css><link rel=stylesheet href=/lib/fontawesome-free/all.min.css><link rel=stylesheet href=/lib/animate/animate.min.css><script type=application/ld+json>{"@context":"http://schema.org","@type":"BlogPosting","headline":"NIO","inLanguage":"zh-CN","mainEntityOfPage":{"@type":"WebPage","@id":"https:\/\/leni.fun\/nio\/"},"genre":"posts","keywords":"NIO, Java, Network","wordcount":3656,"url":"https:\/\/leni.fun\/nio\/","datePublished":"2023-08-15T13:04:23+08:00","dateModified":"2023-08-15T13:04:23+08:00","publisher":{"@type":"Organization","name":""},"author":{"@type":"Person","name":"都将会"},"description":""}</script></head><body data-header-desktop=sticky data-header-mobile=auto><script>(window.localStorage?.getItem("theme")?localStorage.getItem("theme")==="dark":"dark"==="auto"?window.matchMedia("(prefers-color-scheme: dark)").matches:"dark"==="dark")&&document.body.setAttribute("data-theme","dark")</script><div class=wrapper data-page-style=normal><header class="desktop animate__faster" id=header-desktop><div class=header-wrapper data-github-corner=left><div class=header-title><a href=/ title><img loading=lazy src=/images/icon.png srcset="/images/icon.png, /images/icon.png 1.5x, /images/icon.png 2x" sizes=auto data-title=/images/icon.png data-alt=/images/icon.png class=logo style="background:url(/svg/loading.min.svg)no-repeat 50%" onload='this.title=this.dataset.title,this.alt=this.dataset.alt;for(const e of["style","data-title","data-alt","onerror","onload"])this.removeAttribute(e);this.dataset.lazyloaded=""' onerror='this.title=this.dataset.title,this.alt=this.dataset.alt;for(const e of["style","data-title","data-alt","onerror","onload"])this.removeAttribute(e)'><span class=header-title-text>都将会</span></a><span id=typeit-header-subtitle-desktop class="typeit header-subtitle"></span></div><nav><ul class=menu><li class="menu-item has-children"><a class=menu-link href=/posts/><i class="fa-solid fa-archive fa-fw fa-sm" aria-hidden=true></i> 技术</a><i class="dropdown-icon fa-solid fa-chevron-down" aria-hidden=true></i><ul class=sub-menu><li class=menu-item><a class=menu-link href=/categories/><i class="fa-solid fa-th fa-fw fa-sm" aria-hidden=true></i> 分类</a></li><li class=menu-item><a class=menu-link href=/tags/><i class="fa-solid fa-tags fa-fw fa-sm" aria-hidden=true></i> 标签</a></li></ul></li><li class=menu-item><a class=menu-link href=/life/><i class="fa-solid fa-camera-alt fa-fw fa-sm" aria-hidden=true></i> 生活</a></li><li class=menu-item><a class=menu-link href=/friends/><i class="fa-solid fa-users fa-fw fa-sm" aria-hidden=true></i> 友链</a></li><li class=menu-item><a class=menu-link href=/about/><i class="fa-solid fa-info-circle fa-fw fa-sm" aria-hidden=true></i> 关于</a></li><li class="menu-item delimiter"></li><li class="menu-item search" id=search-desktop><input type=text placeholder=关键词搜索 id=search-input-desktop>
<a href=javascript:void(0); class="search-button search-toggle" id=search-toggle-desktop title=搜索><i class="fa-solid fa-search fa-fw" aria-hidden=true></i></a>
<a href=javascript:void(0); class="search-button search-clear" id=search-clear-desktop title=清空><i class="fa-solid fa-times-circle fa-fw" aria-hidden=true></i></a>
<span class="search-button search-loading" id=search-loading-desktop><i class="fa-solid fa-spinner fa-fw fa-spin" aria-hidden=true></i></span></li><li class="menu-item theme-switch" title=切换主题><i class="fa-solid fa-adjust fa-fw" aria-hidden=true></i></li></ul></nav></div></header><header class="mobile animate__faster" id=header-mobile><div class=header-container><div class=header-wrapper><div class=header-title><a href=/ title><img loading=lazy src=/images/icon.png srcset="/images/icon.png, /images/icon.png 1.5x, /images/icon.png 2x" sizes=auto data-title=/images/icon.png data-alt=/images/icon.png class=logo style="background:url(/svg/loading.min.svg)no-repeat 50%" onload='this.title=this.dataset.title,this.alt=this.dataset.alt;for(const e of["style","data-title","data-alt","onerror","onload"])this.removeAttribute(e);this.dataset.lazyloaded=""' onerror='this.title=this.dataset.title,this.alt=this.dataset.alt;for(const e of["style","data-title","data-alt","onerror","onload"])this.removeAttribute(e)'><span class=header-title-text>都将会</span></a><span id=typeit-header-subtitle-mobile class="typeit header-subtitle"></span></div><div class=menu-toggle id=menu-toggle-mobile><span></span><span></span><span></span></div></div><nav><ul class=menu id=menu-mobile><li class=search-wrapper><div class="search mobile" id=search-mobile><input type=text placeholder=关键词搜索 id=search-input-mobile>
<a href=javascript:void(0); class="search-button search-toggle" id=search-toggle-mobile title=搜索><i class="fa-solid fa-search fa-fw" aria-hidden=true></i></a>
<a href=javascript:void(0); class="search-button search-clear" id=search-clear-mobile title=清空><i class="fa-solid fa-times-circle fa-fw" aria-hidden=true></i></a>
<span class="search-button search-loading" id=search-loading-mobile><i class="fa-solid fa-spinner fa-fw fa-spin" aria-hidden=true></i></span></div><a href=javascript:void(0); class=search-cancel id=search-cancel-mobile>取消</a></li><li class=menu-item><span class=nested-item><a class=menu-link href=/posts/><i class="fa-solid fa-archive fa-fw fa-sm" aria-hidden=true></i> 技术</a>
<i class="dropdown-icon fa-solid fa-chevron-right" aria-hidden=true></i></span><ul class=sub-menu><li class=menu-item><a class=menu-link href=/categories/><i class="fa-solid fa-th fa-fw fa-sm" aria-hidden=true></i> 分类</a></li><li class=menu-item><a class=menu-link href=/tags/><i class="fa-solid fa-tags fa-fw fa-sm" aria-hidden=true></i> 标签</a></li></ul></li><li class=menu-item><a class=menu-link href=/life/><i class="fa-solid fa-camera-alt fa-fw fa-sm" aria-hidden=true></i> 生活</a></li><li class=menu-item><a class=menu-link href=/friends/><i class="fa-solid fa-users fa-fw fa-sm" aria-hidden=true></i> 友链</a></li><li class=menu-item><a class=menu-link href=/about/><i class="fa-solid fa-info-circle fa-fw fa-sm" aria-hidden=true></i> 关于</a></li><li class="menu-item menu-system"><span class="menu-system-item theme-switch" title=切换主题><i class="fa-solid fa-adjust fa-fw" aria-hidden=true></i></span></li></ul></nav></div></header><div class="search-dropdown desktop"><div id=search-dropdown-desktop></div></div><div class="search-dropdown mobile"><div id=search-dropdown-mobile></div></div><nav aria-label=breadcrumb class="breadcrumb-container sticky"><ol class=breadcrumb><li class=breadcrumb-item><a href=/ title>主页</a></li><li class=breadcrumb-item><a href=/posts/ title=Posts>Posts</a></li><li class="breadcrumb-item active" aria-current=page>NIO</li></ol></nav><main class=container><aside class=toc id=toc-auto><h2 class=toc-title>目录&nbsp;<i class="toc-icon fa-solid fa-angle-down fa-fw" aria-hidden=true></i></h2><div class=toc-content id=toc-content-auto></div></aside><aside class=aside-custom></aside><article class="page single"><div class=header><h1 class="single-title animate__animated animate__flipInX"><span>NIO</span></h1></div><div class=post-meta><div class=post-meta-line><span class=post-author><span class=author><img loading=lazy src=/images/avatar.jpg srcset="/images/avatar.jpg, /images/avatar.jpg 1.5x, /images/avatar.jpg 2x" sizes=auto data-title=都将会 data-alt=都将会 class=avatar style="background:url(/svg/loading.min.svg)no-repeat 50%" onload='this.title=this.dataset.title,this.alt=this.dataset.alt;for(const e of["style","data-title","data-alt","onerror","onload"])this.removeAttribute(e);this.dataset.lazyloaded=""' onerror='this.title=this.dataset.title,this.alt=this.dataset.alt;for(const e of["style","data-title","data-alt","onerror","onload"])this.removeAttribute(e)'>&nbsp;都将会</span></span>
<span class=post-category>收录于 <a href=/categories/202308/><i class="fa-regular fa-folder fa-fw" aria-hidden=true></i> 202308</a></span></div><div class=post-meta-line><span title="发布于 2023-08-15 13:04:23"><i class="fa-regular fa-calendar-alt fa-fw me-1" aria-hidden=true></i><time datetime=2023-08-15>2023-08-15</time></span>&nbsp;<span title="更新于 2023-08-15 13:04:23"><i class="fa-regular fa-edit fa-fw me-1" aria-hidden=true></i><time datetime=2023-08-15>2023-08-15</time></span>&nbsp;<span><i class="fa-solid fa-pencil-alt fa-fw me-1" aria-hidden=true></i>约 3656 字</span>&nbsp;<span><i class="fa-regular fa-clock fa-fw me-1" aria-hidden=true></i>预计阅读 8 分钟</span>&nbsp;<span id=busuanzi_container_page_pv class="busuanzi_visitors comment-visitors" data-flag-title=NIO>
<i class="fa-regular fa-eye fa-fw me-1" aria-hidden=true></i><span id=busuanzi_value_page_pv>-</span>&nbsp;次阅读
</span>&nbsp;</div></div><div class=featured-image><img loading=lazy src=/images/pic7.jpg srcset="/images/pic7.jpg, /images/pic7.jpg 1.5x, /images/pic7.jpg 2x" sizes=auto data-title=/images/pic7.jpg data-alt=/images/pic7.jpg width=781 height=552 style="background:url(/svg/loading.min.svg)no-repeat 50%" onload='this.title=this.dataset.title,this.alt=this.dataset.alt;for(const e of["style","data-title","data-alt","onerror","onload"])this.removeAttribute(e);this.dataset.lazyloaded=""' onerror='this.title=this.dataset.title,this.alt=this.dataset.alt;for(const e of["style","data-title","data-alt","onerror","onload"])this.removeAttribute(e)'></div><div class="details toc" id=toc-static data-kept=false><div class="details-summary toc-title"><span>目录</span>
<span><i class="details-icon fa-solid fa-angle-right" aria-hidden=true></i></span></div><div class="details-content toc-content" id=toc-content-static><nav id=TableOfContents><ul><li><ul><li><a href=#buffer-缓冲区>Buffer 缓冲区</a><ul><li><a href=#核心参数>核心参数</a></li><li><a href=#核心方法>核心方法</a></li><li><a href=#实践>实践</a></li></ul></li><li><a href=#channel-通道>Channel 通道</a><ul><li><a href=#获得通道的方式>获得通道的方式</a></li><li><a href=#stream-与-channel-的区别>Stream 与 Channel 的区别</a></li></ul></li><li><a href=#selector-选择器>Selector 选择器</a><ul><li><a href=#selectionkey-绑定的事件类型>SelectionKey 绑定的事件类型</a></li><li><a href=#selector-监听类型>Selector 监听类型</a></li><li><a href=#事件处理>事件处理</a></li></ul></li><li><a href=#消息边界处理>消息边界处理</a></li><li><a href=#多线程优化>多线程优化</a></li><li><a href=#io-演进>IO 演进</a><ul><li><a href=#五种-io-模型>五种 IO 模型</a></li><li><a href=#bio>BIO</a></li><li><a href=#nio>NIO</a></li><li><a href=#多路复用>多路复用</a></li><li><a href=#信号驱动io>信号驱动IO</a></li><li><a href=#异步-io>异步 IO</a></li><li><a href=#零拷贝>零拷贝</a></li><li><a href=#netty-中的零拷贝>Netty 中的零拷贝</a></li></ul></li><li><a href=#参考资料>参考资料</a></li></ul></li></ul></nav></div></div><div class=content id=content><blockquote><p>NIO 于 jdk1.4 引入，支持面向缓冲区的、基于通道的IO操作。</p></blockquote><p><a class=lightgallery href=https://publicpictures.oss-cn-hangzhou.aliyuncs.com/img/20201109085054.png data-thumbnail=https://publicpictures.oss-cn-hangzhou.aliyuncs.com/img/20201109085054.png data-sub-html="<h2>img</h2>"><img loading=lazy src=https://publicpictures.oss-cn-hangzhou.aliyuncs.com/img/20201109085054.png srcset="https://publicpictures.oss-cn-hangzhou.aliyuncs.com/img/20201109085054.png, https://publicpictures.oss-cn-hangzhou.aliyuncs.com/img/20201109085054.png 1.5x, https://publicpictures.oss-cn-hangzhou.aliyuncs.com/img/20201109085054.png 2x" sizes=auto data-title=img data-alt=img style="background:url(/svg/loading.min.svg)no-repeat 50%" onload='this.title=this.dataset.title,this.alt=this.dataset.alt;for(const e of["style","data-title","data-alt","onerror","onload"])this.removeAttribute(e);this.dataset.lazyloaded=""' onerror='this.title=this.dataset.title,this.alt=this.dataset.alt;for(const e of["style","data-title","data-alt","onerror","onload"])this.removeAttribute(e)'></a></p><p>通道负责传输，缓冲区负责存储。</p><h3 id=buffer-缓冲区>Buffer 缓冲区</h3><p>高效的数据容器，除了布尔类型，所有原始数据类型都有相应的 Buffer 实现。</p><p><a class=lightgallery href=https://publicpictures.oss-cn-hangzhou.aliyuncs.com/img/20201109091555.png data-thumbnail=https://publicpictures.oss-cn-hangzhou.aliyuncs.com/img/20201109091555.png data-sub-html="<h2>img</h2>"><img loading=lazy src=https://publicpictures.oss-cn-hangzhou.aliyuncs.com/img/20201109091555.png srcset="https://publicpictures.oss-cn-hangzhou.aliyuncs.com/img/20201109091555.png, https://publicpictures.oss-cn-hangzhou.aliyuncs.com/img/20201109091555.png 1.5x, https://publicpictures.oss-cn-hangzhou.aliyuncs.com/img/20201109091555.png 2x" sizes=auto data-title=img data-alt=img style="background:url(/svg/loading.min.svg)no-repeat 50%" onload='this.title=this.dataset.title,this.alt=this.dataset.alt;for(const e of["style","data-title","data-alt","onerror","onload"])this.removeAttribute(e);this.dataset.lazyloaded=""' onerror='this.title=this.dataset.title,this.alt=this.dataset.alt;for(const e of["style","data-title","data-alt","onerror","onload"])this.removeAttribute(e)'></a></p><div class=highlight id=id-1><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=c1>// 获取缓冲区，单位：B 字节
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=n>ByteBuffer</span> <span class=n>byteBuffer</span> <span class=o>=</span> <span class=n>ByteBuffer</span><span class=o>.</span><span class=na>allocate</span><span class=o>(</span><span class=mi>1024</span><span class=o>);</span></span></span></code></pre></td></tr></table></div></div><h4 id=核心参数>核心参数</h4><p>mark &lt;= position &lt;= limit &lt;= capacity</p><ul><li>mark：当前 position 保存点，通过 <code>reset()</code> 恢复到 mark 位置<ul><li>mark - position 区域：未保存</li></ul></li><li>position：下一个读写位置的索引<ul><li>position - limit 区域：可读写</li></ul></li><li>limit：缓冲区界限<ul><li>limit - capacity 区域：不可读写</li></ul></li><li>capacity：缓冲区容量</li></ul><h4 id=核心方法>核心方法</h4><ul><li><p><code>allocate(int capacity)</code>：分配非直接缓冲区，位于 <strong>JVM 堆内存</strong>之中。</p></li><li><p><code>allocateDirect(int capacity)</code>：分配直接缓冲区，位于<strong>物理内存</strong>之中。（多个虚拟空间指向同一个物理地址）</p><ul><li><a class=lightgallery href=https://publicpictures.oss-cn-hangzhou.aliyuncs.com/img/image-20230815211809727.png data-thumbnail=https://publicpictures.oss-cn-hangzhou.aliyuncs.com/img/image-20230815211809727.png data-sub-html="<h2>image-20230815211809727</h2>"><img loading=lazy src=https://publicpictures.oss-cn-hangzhou.aliyuncs.com/img/image-20230815211809727.png srcset="https://publicpictures.oss-cn-hangzhou.aliyuncs.com/img/image-20230815211809727.png, https://publicpictures.oss-cn-hangzhou.aliyuncs.com/img/image-20230815211809727.png 1.5x, https://publicpictures.oss-cn-hangzhou.aliyuncs.com/img/image-20230815211809727.png 2x" sizes=auto data-title=image-20230815211809727 data-alt=image-20230815211809727 style="background:url(/svg/loading.min.svg)no-repeat 50%" onload='this.title=this.dataset.title,this.alt=this.dataset.alt;for(const e of["style","data-title","data-alt","onerror","onload"])this.removeAttribute(e);this.dataset.lazyloaded=""' onerror='this.title=this.dataset.title,this.alt=this.dataset.alt;for(const e of["style","data-title","data-alt","onerror","onload"])this.removeAttribute(e)'></a></li></ul></li><li><p><code>put()</code>：写入数据，position++,capacity = limit</p></li><li><p><code>flip()</code>：读写切换</p><ul><li>读模式： limit = position+1, position = 0</li><li>写模式：position = limit +1, limit = position</li></ul></li><li><p><code>get()</code>：读取数据，position++</p></li><li><p><code>rewind()</code>：只能在读模式下使用，恢复参数到 <code>get()</code> 前</p></li><li><p><code>clean()</code>：指针归位，数据仍然存在，position = 0,capacity = limit</p></li><li><p><code>mark()</code>：mark = position</p></li><li><p><code>reset()</code>：position = mark</p></li></ul><h4 id=实践>实践</h4><div class=highlight id=id-2><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kn>import</span> <span class=nn>java.nio.ByteBuffer</span><span class=o>;</span>
</span></span><span class=line><span class=cl><span class=kd>public</span> <span class=kd>class</span> <span class=nc>Demo1</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=kd>public</span> <span class=kd>static</span> <span class=kt>void</span> <span class=nf>main</span><span class=o>(</span><span class=n>String</span><span class=o>[]</span> <span class=n>args</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>ByteBuffer</span> <span class=n>byteBuffer</span> <span class=o>=</span> <span class=n>ByteBuffer</span><span class=o>.</span><span class=na>allocate</span><span class=o>(</span><span class=mi>1024</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=n>printByteBuffer</span><span class=o>(</span><span class=n>byteBuffer</span><span class=o>,</span> <span class=s>&#34;初始参数&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=n>System</span><span class=o>.</span><span class=na>out</span><span class=o>.</span><span class=na>println</span><span class=o>(</span><span class=s>&#34;------put()------&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=n>System</span><span class=o>.</span><span class=na>out</span><span class=o>.</span><span class=na>println</span><span class=o>(</span><span class=s>&#34;放入10个数据&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=kt>byte</span> <span class=n>bt</span> <span class=o>=</span> <span class=mi>1</span><span class=o>;</span>
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=o>(</span><span class=kt>int</span> <span class=n>i</span> <span class=o>=</span> <span class=mi>0</span><span class=o>;</span> <span class=n>i</span> <span class=o>&lt;</span> <span class=mi>10</span><span class=o>;</span> <span class=n>i</span><span class=o>++)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=n>byteBuffer</span><span class=o>.</span><span class=na>put</span><span class=o>(</span><span class=n>bt</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>        <span class=n>printByteBuffer</span><span class=o>(</span><span class=n>byteBuffer</span><span class=o>,</span> <span class=s>&#34;放入后参数&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=n>System</span><span class=o>.</span><span class=na>out</span><span class=o>.</span><span class=na>println</span><span class=o>(</span><span class=s>&#34;------flip()-get()------&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=n>System</span><span class=o>.</span><span class=na>out</span><span class=o>.</span><span class=na>println</span><span class=o>(</span><span class=s>&#34;读取一个数据&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=c1>// 切换模式
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=n>byteBuffer</span><span class=o>.</span><span class=na>flip</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        <span class=n>byteBuffer</span><span class=o>.</span><span class=na>get</span><span class=o>();</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=n>printByteBuffer</span><span class=o>(</span><span class=n>byteBuffer</span><span class=o>,</span> <span class=s>&#34;读取后参数&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=n>System</span><span class=o>.</span><span class=na>out</span><span class=o>.</span><span class=na>println</span><span class=o>(</span><span class=s>&#34;------rewind()------&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=n>byteBuffer</span><span class=o>.</span><span class=na>rewind</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        <span class=n>printByteBuffer</span><span class=o>(</span><span class=n>byteBuffer</span><span class=o>,</span> <span class=s>&#34;恢复后参数&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=n>System</span><span class=o>.</span><span class=na>out</span><span class=o>.</span><span class=na>println</span><span class=o>(</span><span class=s>&#34;------clear()------&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=c1>// 清空缓冲区，这里只是恢复了各个属性的值，但是缓冲区里的数据依然存在
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=c1>// 但是下次写入的时候会覆盖缓冲区中之前的数据
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=n>byteBuffer</span><span class=o>.</span><span class=na>clear</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        <span class=n>printByteBuffer</span><span class=o>(</span><span class=n>byteBuffer</span><span class=o>,</span> <span class=s>&#34;清空后参数&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=n>System</span><span class=o>.</span><span class=na>out</span><span class=o>.</span><span class=na>println</span><span class=o>(</span><span class=s>&#34;清空后获得旧数据&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=n>System</span><span class=o>.</span><span class=na>out</span><span class=o>.</span><span class=na>println</span><span class=o>(</span><span class=n>byteBuffer</span><span class=o>.</span><span class=na>get</span><span class=o>());</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kd>private</span> <span class=kd>static</span> <span class=kt>void</span> <span class=nf>printByteBuffer</span><span class=o>(</span><span class=n>ByteBuffer</span> <span class=n>byteBuffer</span><span class=o>,</span> <span class=n>String</span> <span class=n>string</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>System</span><span class=o>.</span><span class=na>out</span><span class=o>.</span><span class=na>println</span><span class=o>(</span><span class=s>&#34;|=======&#34;</span> <span class=o>+</span> <span class=n>string</span> <span class=o>+</span> <span class=s>&#34;=============&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=n>System</span><span class=o>.</span><span class=na>out</span><span class=o>.</span><span class=na>println</span><span class=o>(</span><span class=s>&#34;|position &#34;</span> <span class=o>+</span> <span class=n>byteBuffer</span><span class=o>.</span><span class=na>position</span><span class=o>());</span>
</span></span><span class=line><span class=cl>        <span class=n>System</span><span class=o>.</span><span class=na>out</span><span class=o>.</span><span class=na>println</span><span class=o>(</span><span class=s>&#34;|limit    &#34;</span> <span class=o>+</span> <span class=n>byteBuffer</span><span class=o>.</span><span class=na>limit</span><span class=o>());</span>
</span></span><span class=line><span class=cl>        <span class=n>System</span><span class=o>.</span><span class=na>out</span><span class=o>.</span><span class=na>println</span><span class=o>(</span><span class=s>&#34;|capacity &#34;</span> <span class=o>+</span> <span class=n>byteBuffer</span><span class=o>.</span><span class=na>capacity</span><span class=o>());</span>
</span></span><span class=line><span class=cl>        <span class=n>System</span><span class=o>.</span><span class=na>out</span><span class=o>.</span><span class=na>println</span><span class=o>(</span><span class=s>&#34;|=============================&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span></span></span></code></pre></td></tr></table></div></div><p>输出：</p><div class=highlight id=id-3><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>|=======初始参数=============
</span></span><span class=line><span class=cl>|position 0
</span></span><span class=line><span class=cl>|limit    1024
</span></span><span class=line><span class=cl>|capacity 1024
</span></span><span class=line><span class=cl>|=============================
</span></span><span class=line><span class=cl>------put()------
</span></span><span class=line><span class=cl>放入10个数据
</span></span><span class=line><span class=cl>|=======放入后参数=============
</span></span><span class=line><span class=cl>|position 10
</span></span><span class=line><span class=cl>|limit    1024
</span></span><span class=line><span class=cl>|capacity 1024
</span></span><span class=line><span class=cl>|=============================
</span></span><span class=line><span class=cl>------flip()-get()------
</span></span><span class=line><span class=cl>读取一个数据
</span></span><span class=line><span class=cl>|=======读取后参数=============
</span></span><span class=line><span class=cl>|position 1
</span></span><span class=line><span class=cl>|limit    10
</span></span><span class=line><span class=cl>|capacity 1024
</span></span><span class=line><span class=cl>|=============================
</span></span><span class=line><span class=cl>------rewind()------
</span></span><span class=line><span class=cl>|=======恢复后参数=============
</span></span><span class=line><span class=cl>|position 0
</span></span><span class=line><span class=cl>|limit    10
</span></span><span class=line><span class=cl>|capacity 1024
</span></span><span class=line><span class=cl>|=============================
</span></span><span class=line><span class=cl>------clear()------
</span></span><span class=line><span class=cl>|=======清空后参数=============
</span></span><span class=line><span class=cl>|position 0
</span></span><span class=line><span class=cl>|limit    1024
</span></span><span class=line><span class=cl>|capacity 1024
</span></span><span class=line><span class=cl>|=============================
</span></span><span class=line><span class=cl>清空后获得旧数据
</span></span><span class=line><span class=cl>1</span></span></code></pre></td></tr></table></div></div><h3 id=channel-通道>Channel 通道</h3><p>Channel 表示 IO 源与目标打开的连接，它本身不能直接访问数据，Channel 只能<strong>与Buffer 进行交互</strong>。channel 类似在 Linux 之类操作系统上看到的文件描述符，是 NIO 中被用来支持批量式 IO 操作的一种抽象。<strong>File 或者 Socket，通常被认为是比较高层次的抽象</strong>，而 Channel 则是更加操作系统底层的一种抽象，这也使得 NIO 得以充分利用现代操作系统底层机制，获得特定场景的性能优化，例如，DMA（Direct Memory Access）等。</p><p><a class=lightgallery href=https://publicpictures.oss-cn-hangzhou.aliyuncs.com/img/20201109154803.png data-thumbnail=https://publicpictures.oss-cn-hangzhou.aliyuncs.com/img/20201109154803.png data-sub-html="<h2>img</h2>"><img loading=lazy src=https://publicpictures.oss-cn-hangzhou.aliyuncs.com/img/20201109154803.png srcset="https://publicpictures.oss-cn-hangzhou.aliyuncs.com/img/20201109154803.png, https://publicpictures.oss-cn-hangzhou.aliyuncs.com/img/20201109154803.png 1.5x, https://publicpictures.oss-cn-hangzhou.aliyuncs.com/img/20201109154803.png 2x" sizes=auto data-title=img data-alt=img style="background:url(/svg/loading.min.svg)no-repeat 50%" onload='this.title=this.dataset.title,this.alt=this.dataset.alt;for(const e of["style","data-title","data-alt","onerror","onload"])this.removeAttribute(e);this.dataset.lazyloaded=""' onerror='this.title=this.dataset.title,this.alt=this.dataset.alt;for(const e of["style","data-title","data-alt","onerror","onload"])this.removeAttribute(e)'></a></p><ul><li>FileChanner：本地文件 IO，阻塞式<ul><li>通过 FileInputStream 获取的 channel <strong>只能读</strong></li><li>通过 FileOutputStream 获取的 channel <strong>只能写</strong></li><li>通过 RandomAccessFile 是否能读写<strong>根据构造 RandomAccessFile 时的读写模式决定</strong></li></ul></li><li>SocketChannel：客户端 TCP 传输</li><li>ServerSocketChannel：服务端 TCP 传输</li><li>DatagramChannel：UDP 传输</li></ul><h4 id=获得通道的方式>获得通道的方式</h4><ol><li><code>stream.getChannel()</code> 或<code>socket.getChannel()</code>获得通道 + <code>allocate()</code> 获取非直接缓冲区（最慢）</li><li><code>FileChannel.open()</code> 获得通道 + <code>fileChannel.map()</code> 获取直接缓冲区<ol><li>直接写入内存映射文件：<code>inMapBuf.get(bytes); outMapBuf.put(bytes)</code>（对应 Linux 中的 <code>mmap()</code> 操作，内核缓冲区与 socket 缓冲区共享，节省了一次 CPU拷贝。读写速度虽快，但内存占用高）</li><li>通道间直接传输：<code>inChannel.transferTo((0,inChannel.size(),outChannel))</code>（最快）</li></ol></li></ol><h4 id=stream-与-channel-的区别>Stream 与 Channel 的区别</h4><ol><li>stream 不会自动缓冲数据，channel 会利用系统提供的缓冲区。</li><li>stream 仅支持阻塞 API，channel 同时支持阻塞、非阻塞 API，<strong>网络 channel 可配合 selector 实现多路复用</strong>。</li></ol><h3 id=selector-选择器>Selector 选择器</h3><p>多路复用是非阻塞 IO 的核心，通过 Selector 可以实现单个线程管理多个 Channel，适合连接数多，但流量较少的场景。</p><ul><li>多路复用仅针对<strong>网络 IO</strong>：Selector<strong>可以检测到注册在 Selector 上的多个 Channel 中，是否有 Channel 处于就绪状态</strong>，进而实现了<strong>单线程对多 Channel 的高效管理</strong>。</li><li>普通文件 IO 无法利用多路复用。</li></ul><div class=highlight id=id-4><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=c1>// 创建选择器
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=n>Selector</span> <span class=n>selector</span> <span class=o>=</span> <span class=n>Selector</span><span class=o>.</span><span class=na>open</span><span class=o>();</span>
</span></span><span class=line><span class=cl><span class=c1>// Q：设置 channel 为非阻塞模式 ？
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=n>socketChannel</span><span class=o>.</span><span class=na>configureBlocking</span><span class=o>(</span><span class=kc>false</span><span class=o>);</span>
</span></span><span class=line><span class=cl><span class=c1>// 监听状态，多个状态通过“|”分隔
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=n>channel</span><span class=o>.</span><span class=na>register</span><span class=o>(</span><span class=n>selector</span><span class=o>,</span> <span class=n>SelectionKey</span><span class=o>.</span><span class=na>OP_READ</span> <span class=o>|</span> <span class=n>SelectionKey</span><span class=o>.</span><span class=na>OP_ACCEPT</span><span class=o>);</span></span></span></code></pre></td></tr></table></div></div><p>A：阻塞模式下，注册操作是不允许的，会抛出 IllegalBlockingModeException 异常。</p><h4 id=selectionkey-绑定的事件类型>SelectionKey 绑定的事件类型</h4><ul><li>connect：客户端连接成功时触发</li><li>accept：服务端连接成功时触发</li><li>read：数据可读入时</li><li>write：数据可写出时</li></ul><h4 id=selector-监听类型>Selector 监听类型</h4><ul><li><code>select()</code>：阻塞直到绑定事件发生</li><li><code>select(long)</code>：阻塞直到绑定事件发生，或超时</li><li><code>selectNow</code>：不会阻塞，检查是否有事件，立刻返回</li></ul><h4 id=事件处理>事件处理</h4><p>事件发生后，要么正常处理 <code>accept()</code>，要么 catch 异常时取消 <code>cancel()</code>，如果什么都不做，下次该事件仍会触发。</p><div class=highlight id=id-5><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=c1>// 获取所有事件
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=n>Set</span><span class=o>&lt;</span><span class=n>SelectionKey</span><span class=o>&gt;</span> <span class=n>selectionKeys</span> <span class=o>=</span> <span class=n>selector</span><span class=o>.</span><span class=na>selectedKeys</span><span class=o>();</span>           
</span></span><span class=line><span class=cl><span class=c1>// 使用迭代器遍历事件
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=n>Iterator</span><span class=o>&lt;</span><span class=n>SelectionKey</span><span class=o>&gt;</span> <span class=n>iterator</span> <span class=o>=</span> <span class=n>selectionKeys</span><span class=o>.</span><span class=na>iterator</span><span class=o>();</span>
</span></span><span class=line><span class=cl><span class=k>while</span> <span class=o>(</span><span class=n>iterator</span><span class=o>.</span><span class=na>hasNext</span><span class=o>())</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>	<span class=n>SelectionKey</span> <span class=n>key</span> <span class=o>=</span> <span class=n>iterator</span><span class=o>.</span><span class=na>next</span><span class=o>();</span>                
</span></span><span class=line><span class=cl>	<span class=c1>// 判断key的类型，此处为Accept类型
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=k>if</span><span class=o>(</span><span class=n>key</span><span class=o>.</span><span class=na>isAcceptable</span><span class=o>())</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=c1>// 获得key对应的channel
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=n>ServerSocketChannel</span> <span class=n>channel</span> <span class=o>=</span> <span class=o>(</span><span class=n>ServerSocketChannel</span><span class=o>)</span> <span class=n>key</span><span class=o>.</span><span class=na>channel</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        <span class=c1>// 获取连接并处理，而且是必须处理，否则需要取消
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=n>SocketChannel</span> <span class=n>socketChannel</span> <span class=o>=</span> <span class=n>channel</span><span class=o>.</span><span class=na>accept</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        <span class=c1>// 处理完毕后移除，否则会导致已被处理过的事件再次被处理。
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=n>iterator</span><span class=o>.</span><span class=na>remove</span><span class=o>();</span>
</span></span><span class=line><span class=cl>	<span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span></span></span></code></pre></td></tr></table></div></div><h3 id=消息边界处理>消息边界处理</h3><ul><li>固定消息长度：浪费带宽。</li><li>按分隔符拆分：效率低。</li><li>TLV 格式（Type 类型、Length 长度、Value 数据）：需要提前分配，如果内容过大，影响 server 吞吐量。</li></ul><h3 id=多线程优化>多线程优化</h3><p>将选择器 Selector 分成两组：</p><ul><li><p>单线程配一个选择器 Boss，专门处理 <code>accept（）</code> 事件。</p><ul><li>接受并处理Accepet事件，当Accept事件发生后，调用Worker的register(SocketChannel socket)方法，让Worker去处理Read事件，其中需要<strong>根据标识robin去判断将任务分配给哪个Worker</strong>。</li></ul><div class=highlight id=id-6><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=c1>// 创建固定数量的Worker
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=n>Worker</span><span class=o>[]</span> <span class=n>workers</span> <span class=o>=</span> <span class=k>new</span> <span class=n>Worker</span><span class=o>[</span><span class=mi>4</span><span class=o>];</span>
</span></span><span class=line><span class=cl><span class=c1>// 用于负载均衡的原子整数
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=n>AtomicInteger</span> <span class=n>robin</span> <span class=o>=</span> <span class=k>new</span> <span class=n>AtomicInteger</span><span class=o>(</span><span class=mi>0</span><span class=o>);</span>
</span></span><span class=line><span class=cl><span class=c1>// 负载均衡，轮询分配Worker
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=n>workers</span><span class=o>[</span><span class=n>robin</span><span class=o>.</span><span class=na>getAndIncrement</span><span class=o>()%</span> <span class=n>workers</span><span class=o>.</span><span class=na>length</span><span class=o>].</span><span class=na>register</span><span class=o>(</span><span class=n>socket</span><span class=o>);</span></span></span></code></pre></td></tr></table></div></div><ul><li>添加任务后需要调用<code>selector.wakeup()</code>来唤醒被阻塞的Selector，select类似LockSupport中的park，wakeup的原理类似LockSupport中的unpark。</li></ul></li><li><p>创建 CPU 核心数的线程 Worker，每个线程配一个选择器，轮流处理 <code>read()</code> 事件。</p><ul><li>从同步队列中获取注册任务，并处理Read事件。</li></ul></li></ul><h3 id=io-演进>IO 演进</h3><h4 id=五种-io-模型>五种 IO 模型</h4><p><a class=lightgallery href=https://publicpictures.oss-cn-hangzhou.aliyuncs.com/img/1678173074860-40037a85-e5ec-414c-a92d-9dc368b52fc5-20230816090049750.png data-thumbnail=https://publicpictures.oss-cn-hangzhou.aliyuncs.com/img/1678173074860-40037a85-e5ec-414c-a92d-9dc368b52fc5-20230816090049750.png data-sub-html="<h2>img</h2>"><img loading=lazy src=https://publicpictures.oss-cn-hangzhou.aliyuncs.com/img/1678173074860-40037a85-e5ec-414c-a92d-9dc368b52fc5-20230816090049750.png srcset="https://publicpictures.oss-cn-hangzhou.aliyuncs.com/img/1678173074860-40037a85-e5ec-414c-a92d-9dc368b52fc5-20230816090049750.png, https://publicpictures.oss-cn-hangzhou.aliyuncs.com/img/1678173074860-40037a85-e5ec-414c-a92d-9dc368b52fc5-20230816090049750.png 1.5x, https://publicpictures.oss-cn-hangzhou.aliyuncs.com/img/1678173074860-40037a85-e5ec-414c-a92d-9dc368b52fc5-20230816090049750.png 2x" sizes=auto data-title=img data-alt=img style="background:url(/svg/loading.min.svg)no-repeat 50%" onload='this.title=this.dataset.title,this.alt=this.dataset.alt;for(const e of["style","data-title","data-alt","onerror","onload"])this.removeAttribute(e);this.dataset.lazyloaded=""' onerror='this.title=this.dataset.title,this.alt=this.dataset.alt;for(const e of["style","data-title","data-alt","onerror","onload"])this.removeAttribute(e)'></a></p><h4 id=bio>BIO</h4><p>在while(true)中调用<code>accept()</code>方法等待客户端。一个线程只能同时处理一个连接请求。</p><p>4 次上下文切换 + 2 次 DMA 拷贝 + 2 次 CPU 拷贝</p><blockquote><p>DMA：Direct Memory Access，即直接内存访问，DMA 本质上是一块主板上的芯片，它直接参与外设设备和内存存储器之间的 IO 数据传输，过程中不需要 CPU 参与。</p></blockquote><p><a class=lightgallery href=https://publicpictures.oss-cn-hangzhou.aliyuncs.com/img/image-20230815211630610.png data-thumbnail=https://publicpictures.oss-cn-hangzhou.aliyuncs.com/img/image-20230815211630610.png data-sub-html="<h2>image-20230815211630610</h2>"><img loading=lazy src=https://publicpictures.oss-cn-hangzhou.aliyuncs.com/img/image-20230815211630610.png srcset="https://publicpictures.oss-cn-hangzhou.aliyuncs.com/img/image-20230815211630610.png, https://publicpictures.oss-cn-hangzhou.aliyuncs.com/img/image-20230815211630610.png 1.5x, https://publicpictures.oss-cn-hangzhou.aliyuncs.com/img/image-20230815211630610.png 2x" sizes=auto data-title=image-20230815211630610 data-alt=image-20230815211630610 style="background:url(/svg/loading.min.svg)no-repeat 50%" onload='this.title=this.dataset.title,this.alt=this.dataset.alt;for(const e of["style","data-title","data-alt","onerror","onload"])this.removeAttribute(e);this.dataset.lazyloaded=""' onerror='this.title=this.dataset.title,this.alt=this.dataset.alt;for(const e of["style","data-title","data-alt","onerror","onload"])this.removeAttribute(e)'></a></p><h4 id=nio>NIO</h4><p>内核会立即返回，已获得足够的CPU事件继续做其他事情，用户进程只是在<strong>等待阶段</strong>非阻塞，需要不断主动询问kernel数据是否准备好，第二阶段仍然阻塞。</p><img src=https://publicpictures.oss-cn-hangzhou.aliyuncs.com/img/20210418152137.png alt=img style=zoom:150%><h4 id=多路复用>多路复用</h4><p>通过 <strong>Selector</strong> 实现，没有事件时调用select方法会被阻塞住，发生事件后就会处理。进程首先阻塞在select/poll上，再阻塞在读操作的第二阶段上。</p><img src=https://publicpictures.oss-cn-hangzhou.aliyuncs.com/img/20210418154208.png alt=img style=zoom:150%><h4 id=信号驱动io>信号驱动IO</h4><p>在IO执行的数据准备阶段，不会阻塞用户进程，当用户进程收到信号后，才去查收数据。</p><h4 id=异步-io>异步 IO</h4><p>线程 1 调用方法后立即返回，由线程 2 返回最终结果，需要底层操作系统（Kernel）提供支持。</p><ul><li>Windows 系统通过 IOCP 实现了真正的异步 IO</li><li>Linux 系统异步 IO 在 2.6 版本引入，但其底层实现还是用<strong>多路复用模拟了异步 IO</strong>，性能没有优势</li></ul><img src=https://publicpictures.oss-cn-hangzhou.aliyuncs.com/img/20210418160106.png alt=img style=zoom:150%><h4 id=零拷贝>零拷贝</h4><p>数据不经过 JVM 内存，直接拷贝到目的区域，适合小文件传输。</p><ol><li><p><code>ByteBuffer.allocateDirect(10)</code>：将堆外操作系统内存映射到 JVM 内存中来直接访问使用，减少一次数据拷贝，内存回收通过将虚引用加入引用队列，再调用 <code>Unsafe.freeMemory()</code> 方法释放底层资源。</p></li><li><p><code>sendFile()</code>：于 Linux2.1 引入，应用于<code>channel.transferTo()/transferFrom()</code>方法。</p><img src=https://publicpictures.oss-cn-hangzhou.aliyuncs.com/img/20210418162750.png alt=img style=zoom:150%><ul><li>1 次状态切换：调用方法后，用户态 -> 内核态</li><li>3 次数据拷贝：上图中，1、3 为 DMA拷贝，2 为 CPU 拷贝</li></ul></li><li><p><code>sendFile</code>：于 Linux2.4 优化，DMA直接将数据写入网卡，只会将一些 offset 和 length 信息拷入 <strong>socket 缓冲区</strong>，几乎无消耗。</p><img src=https://publicpictures.oss-cn-hangzhou.aliyuncs.com/img/20210418163033.png alt=img style=zoom:150%><ol><li>1 次状态切换：用户态 -> 内核态</li><li>2 次都是 DMA 拷贝，其中 2 是通过 <strong>Linux2.4 中的 scatter/gather</strong> 实现的 SG-DMA。</li></ol></li></ol><h4 id=netty-中的零拷贝>Netty 中的零拷贝</h4><ol><li>CompositeByteBuf 类：将多个 ByteBuf 合并为逻辑上的 ByteBufe，避免 ByteBuf 之间的拷贝。</li><li>byte 数组包装称 ByteBuf 对象，包装过程中不会产生内存拷贝。</li><li>ByteBuf 支持 <code>slice()</code> 操作，因此可以将它分解为多个共享同一存储区域的 ByteBuf，避免内存拷贝。</li><li>通过 FileRegion 包装的 FileChannel.transferTo 实现文件传输，直接将文件缓冲区的数据发送到目标 channel，避免传统通过循环 write 方式导致的内存拷贝问题。</li></ol><h3 id=参考资料>参考资料</h3><ul><li><a href=https://nyimac.gitee.io/2021/04/18/Netty%E5%AD%A6%E4%B9%A0%E4%B9%8BNIO%E5%9F%BA%E7%A1%80/ target=_blank rel="external nofollow noopener noreferrer">https://nyimac.gitee.io/2021/04/18/Netty%E5%AD%A6%E4%B9%A0%E4%B9%8BNIO%E5%9F%BA%E7%A1%80/</a></li><li><a href=https://javaguide.cn/ target=_blank rel="external nofollow noopener noreferrer">https://javaguide.cn/</a></li></ul></div><div class=post-footer id=post-footer><div class=post-info><div class=post-info-line><div class=post-info-mod><span title="更新于 2023-08-15 13:04:23">更新于 2023-08-15&nbsp;</span></div><div class=post-info-license><span><a rel="license external nofollow noopener noreferrer" href=https://creativecommons.org/licenses/by-nc/4.0/ target=_blank>CC BY-NC 4.0</a></span></div></div><div class=post-info-line><div class=post-info-md></div><div class=post-info-share><span><a href=javascript:void(0); title="分享到 微博" data-sharer=weibo data-url=https://leni.fun/nio/ data-title=NIO data-image=/images/pic7.jpg><i class="fa-brands fa-weibo fa-fw" aria-hidden=true></i></a></span></div></div></div><div class=post-info-more><section class=post-tags><i class="fa-solid fa-tags fa-fw me-1" aria-hidden=true></i><a href=/tags/nio/ class=post-tag>NIO</a><a href=/tags/java/ class=post-tag>Java</a><a href=/tags/network/ class=post-tag>Network</a></section><section><span><a href=javascript:void(0); onclick=window.history.back()>返回</a></span>&nbsp;|&nbsp;<span><a href=/>主页</a></span></section></div><div class=post-nav><a href=/aop%E5%AE%9E%E7%8E%B0%E6%96%B9%E6%B3%95%E8%80%97%E6%97%B6%E7%BB%9F%E8%AE%A1/ class=post-nav-item rel=prev title="AOP 实现方法耗时统计"><i class="fa-solid fa-angle-left fa-fw" aria-hidden=true></i>AOP 实现方法耗时统计</a>
<a href=/dp/ class=post-nav-item rel=next title="🚩DP - 动态规划">🚩DP - 动态规划<i class="fa-solid fa-angle-right fa-fw" aria-hidden=true></i></a></div></div></article></main><footer class=footer><div class=footer-container><div class="footer-line copyright order-5" itemscope itemtype=http://schema.org/CreativeWork><i class="fa-regular fa-copyright fa-fw" aria-hidden=true></i>
<span itemprop=copyrightYear>2021 - 2023</span><span class=author itemprop=copyrightHolder>
<a href=/>都将会</a></span><span class="license footer-divider"><a rel="license external nofollow noopener noreferrer" href=https://beian.miit.gov.cn target=_blank>浙ICP备2023023782号</a></span></div><div class="footer-line statistics"><span class=site-time title=网站运行中……><i class="fa-solid fa-heartbeat fa-fw animate-icon" aria-hidden=true></i><span class="run-times ms-1">网站运行中……</span></span></div><div class="footer-line visitor order-4"><span id=busuanzi_container_site_uv title=总访客数><i class="fa-regular fa-user fa-fw" aria-hidden=true></i>&nbsp;<span id=busuanzi_value_site_uv><i class="fa-solid fa-spinner fa-spin fa-fw" aria-hidden=true></i></span></span><span id=busuanzi_container_site_pv class=footer-divider title=总访问量><i class="fa-regular fa-eye fa-fw" aria-hidden=true></i>&nbsp;<span id=busuanzi_value_site_pv><i class="fa-solid fa-spinner fa-spin fa-fw" aria-hidden=true></i></span></span></div></div></footer></div><div class=widgets><div class="fixed-buttons animate__faster d-none"><div class="fixed-button back-to-top" role=button aria-label=回到顶部><i class="fa-solid fa-arrow-up fa-fw" aria-hidden=true></i><span class=variant-numeric>0%</span></div></div><a href=https://github.com/hihihiman/hihihiman.github.io title=博客源码 target=_blank rel="external nofollow" class="github-corner left d-none-mobile"><svg viewBox="0 0 250 250" aria-hidden="true"><path d="M0 0 115 115h15l12 27L250 250V0z"/><path d="M128.3 109C113.8 99.7 119 89.6 119 89.6 122 82.7 120.5 78.6 120.5 78.6 119.2 72 123.4 76.3 123.4 76.3 127.3 80.9 125.5 87.3 125.5 87.3 122.9 97.6 130.6 101.9 134.4 103.2" fill="currentcolor" style="transform-origin:130px 106px" class="octo-arm"/><path d="M115 115C114.9 115.1 118.7 116.5 119.8 115.4l13.9-13.8C136.9 99.2 139.9 98.4 142.2 98.6 133.8 88 127.5 74.4 143.8 58 148.5 53.4 154 51.2 159.7 51 160.3 49.4 163.2 43.6 171.4 40.1 171.4 40.1 176.1 42.5 178.8 56.2 183.1 58.6 187.2 61.8 190.9 65.4 194.5 69 197.7 73.2 200.1 77.6 213.8 80.2 216.3 84.9 216.3 84.9 212.7 93.1 206.9 96 205.4 96.6 205.1 102.4 203 107.8 198.3 112.5 181.9 128.9 168.3 122.5 157.7 114.1 157.9 116.9 156.7 120.9 152.7 124.9L141 136.5C139.8 137.7 141.6 141.9 141.8 141.8z" fill="currentcolor" class="octo-body"/></svg></a><div id=mask></div><div class=reading-progress-bar style=left:0;bottom:0></div><noscript><div class=noscript-warning>FixIt 主题在启用 JavaScript 的情况下效果最佳。</div></noscript></div><link rel=stylesheet href=/lib/lightgallery/css/lightgallery-bundle.min.css><link rel=stylesheet href=/lib/katex/katex.min.css><link rel=stylesheet href=/lib/cookieconsent/cookieconsent.min.css><link rel=stylesheet href=/lib/pace/themes/pink/pace-theme-center-atom.css><script src=/lib/autocomplete/autocomplete.min.js defer></script><script src=/lib/fuse/fuse.min.js defer></script><script src=/lib/lightgallery/lightgallery.min.js defer></script><script src=/lib/lightgallery/plugins/thumbnail/lg-thumbnail.min.js defer></script><script src=/lib/lightgallery/plugins/zoom/lg-zoom.min.js defer></script><script src=/lib/sharer/sharer.min.js async defer></script><script src=/lib/typeit/index.umd.js defer></script><script src=/lib/katex/katex.min.js defer></script><script src=/lib/katex/auto-render.min.js defer></script><script src=/lib/katex/copy-tex.min.js defer></script><script src=/lib/katex/mhchem.min.js defer></script><script src=/lib/cookieconsent/cookieconsent.min.js defer></script><script src=/lib/pangu/pangu.min.js defer></script><script src=//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js async defer></script><script src=/lib/pace/pace.min.js async defer></script><script>window.config={autoBookmark:!0,code:{copyTitle:"复制到剪贴板",editLockTitle:"锁定可编辑代码块",editUnLockTitle:"解锁可编辑代码块",editable:!0,maxShownLines:1024},comment:{enable:!1},cookieconsent:{content:{dismiss:"同意",link:"了解更多",message:"本网站使用 Cookies 来改善您的浏览体验。"},enable:!0,palette:{button:{background:"#f0f0f0"},popup:{background:"#1aa3ff"}},theme:"edgeless"},data:{"typeit-header-subtitle-desktop":"的博客           ","typeit-header-subtitle-mobile":"的博客           "},enablePWA:!0,lightgallery:!0,math:{delimiters:[{display:!0,left:"$$",right:"$$"},{display:!0,left:"\\[",right:"\\]"},{display:!0,left:"\\begin{equation}",right:"\\end{equation}"},{display:!0,left:"\\begin{equation*}",right:"\\end{equation*}"},{display:!0,left:"\\begin{align}",right:"\\end{align}"},{display:!0,left:"\\begin{align*}",right:"\\end{align*}"},{display:!0,left:"\\begin{alignat}",right:"\\end{alignat}"},{display:!0,left:"\\begin{alignat*}",right:"\\end{alignat*}"},{display:!0,left:"\\begin{gather}",right:"\\end{gather}"},{display:!0,left:"\\begin{CD}",right:"\\end{CD}"},{display:!1,left:"$",right:"$"},{display:!1,left:"\\(",right:"\\)"}],strict:!1},pangu:{enable:!0,selector:"article"},search:{distance:100,findAllMatches:!1,highlightTag:"em",ignoreFieldNorm:!0,ignoreLocation:!0,isCaseSensitive:!1,location:0,maxResultLength:10,minMatchCharLength:2,noResultsFound:"没有找到结果",snippetLength:50,threshold:.3,useExtendedSearch:!0},siteTime:"2021-08-26T23:31:00+08:00",typeit:{cursorChar:"_",cursorSpeed:1e3,data:{"typeit-header-subtitle-desktop":["typeit-header-subtitle-desktop"],"typeit-header-subtitle-mobile":["typeit-header-subtitle-mobile"]},duration:-1,loop:!0,speed:150}}</script><script src=/js/theme.min.js defer></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/jquery@2.1.3/dist/jquery.min.js></script><script type=text/javascript src=/js/custom.js></script></body></html>
<!doctype html><html itemscope itemtype=http://schema.org/WebPage lang=zh-CN><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1,maximum-scale=2"><meta name=robots content="noodp"><title>Docker 杂记 -</title><meta name=author content="都将会"><meta name=author-link content><meta name=description content="容器的本质是进程。"><meta name=keywords content="Docker,证书,interview,面试"><meta itemprop=name content="Docker 杂记"><meta itemprop=description content="容器的本质是进程。"><meta itemprop=datePublished content="2023-08-08T16:20:34+08:00"><meta itemprop=dateModified content="2023-08-08T16:20:34+08:00"><meta itemprop=wordCount content="1174"><meta itemprop=image content="https://leni.fun/images/avatar.jpg"><meta itemprop=keywords content="Docker,"><meta property="og:title" content="Docker 杂记"><meta property="og:description" content="容器的本质是进程。"><meta property="og:type" content="article"><meta property="og:url" content="https://leni.fun/posts/docker_draft/"><meta property="og:image" content="https://leni.fun/images/avatar.jpg"><meta property="article:section" content="posts"><meta property="article:published_time" content="2023-08-08T16:20:34+08:00"><meta property="article:modified_time" content="2023-08-08T16:20:34+08:00"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://leni.fun/images/avatar.jpg"><meta name=twitter:title content="Docker 杂记"><meta name=twitter:description content="容器的本质是进程。"><meta name=application-name content="都将会的 APP"><meta name=apple-mobile-web-app-title content="都将会的 APP"><meta name=theme-color data-light=#f8f8f8 data-dark=#252627 content="#f8f8f8"><meta name=msapplication-TileColor content="#da532c"><link rel="shortcut icon" type=image/x-icon href=/favicon.ico><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=mask-icon href=/safari-pinned-tab.svg color=#5bbad5><link rel=manifest href=/site.webmanifest><link rel=canonical href=https://leni.fun/posts/docker_draft/><link rel=prev href=https://leni.fun/posts/%E5%BE%80%E6%9C%9F%E5%91%A8%E8%B5%9B%E9%A2%98%E8%A7%A3/><link rel=next href=https://leni.fun/posts/os/><link rel=stylesheet href=/css/style.min.css><link rel=stylesheet href=/lib/fontawesome-free/all.min.css><link rel=stylesheet href=/lib/animate/animate.min.css><script type=application/ld+json>{"@context":"http://schema.org","@type":"BlogPosting","headline":"Docker 杂记","inLanguage":"zh-CN","mainEntityOfPage":{"@type":"WebPage","@id":"https:\/\/leni.fun\/posts\/docker_draft\/"},"genre":"posts","keywords":"Docker","wordcount":1174,"url":"https:\/\/leni.fun\/posts\/docker_draft\/","datePublished":"2023-08-08T16:20:34+08:00","dateModified":"2023-08-08T16:20:34+08:00","publisher":{"@type":"Organization","name":""},"author":{"@type":"Person","name":"都将会"},"description":"容器的本质是进程。"}</script></head><body data-header-desktop=sticky data-header-mobile=auto><script>(window.localStorage?.getItem("theme")?localStorage.getItem("theme")==="dark":"dark"==="auto"?window.matchMedia("(prefers-color-scheme: dark)").matches:"dark"==="dark")&&document.body.setAttribute("data-theme","dark")</script><div class=wrapper data-page-style=normal><header class="desktop animate__faster" id=header-desktop><div class=header-wrapper data-github-corner=left><div class=header-title><a href=/ title><img loading=lazy src=/images/avatar.jpg srcset="/images/avatar.jpg, /images/avatar.jpg 1.5x, /images/avatar.jpg 2x" sizes=auto data-title=/images/avatar.jpg data-alt=/images/avatar.jpg class=logo style="background:url(/svg/loading.min.svg)no-repeat 50%" onload='this.title=this.dataset.title,this.alt=this.dataset.alt;for(const e of["style","data-title","data-alt","onerror","onload"])this.removeAttribute(e);this.dataset.lazyloaded=""' onerror='this.title=this.dataset.title,this.alt=this.dataset.alt;for(const e of["style","data-title","data-alt","onerror","onload"])this.removeAttribute(e)'><span class=header-title-text>都将会</span></a><span id=typeit-header-subtitle-desktop class="typeit header-subtitle"></span></div><nav><ul class=menu><li class=menu-item><a class=menu-link href=/posts/><i class="fa-solid fa-archive fa-fw fa-sm" aria-hidden=true></i> Posts</a></li><li class=menu-item><a class=menu-link href=/categories/><i class="fa-solid fa-th fa-fw fa-sm" aria-hidden=true></i> Categories</a></li><li class=menu-item><a class=menu-link href=/tags/><i class="fa-solid fa-tags fa-fw fa-sm" aria-hidden=true></i> Tags</a></li><li class="menu-item delimiter"></li><li class="menu-item search" id=search-desktop><input type=text placeholder=输入关键词搜索 id=search-input-desktop>
<a href=javascript:void(0); class="search-button search-toggle" id=search-toggle-desktop title=Search><i class="fa-solid fa-search fa-fw" aria-hidden=true></i></a>
<a href=javascript:void(0); class="search-button search-clear" id=search-clear-desktop title=Clear><i class="fa-solid fa-times-circle fa-fw" aria-hidden=true></i></a>
<span class="search-button search-loading" id=search-loading-desktop><i class="fa-solid fa-spinner fa-fw fa-spin" aria-hidden=true></i></span></li><li class="menu-item theme-switch" title="Switch Theme"><i class="fa-solid fa-adjust fa-fw" aria-hidden=true></i></li></ul></nav></div></header><header class="mobile animate__faster" id=header-mobile><div class=header-container><div class=header-wrapper><div class=header-title><a href=/ title><img loading=lazy src=/images/avatar.jpg srcset="/images/avatar.jpg, /images/avatar.jpg 1.5x, /images/avatar.jpg 2x" sizes=auto data-title=/images/avatar.jpg data-alt=/images/avatar.jpg class=logo style="background:url(/svg/loading.min.svg)no-repeat 50%" onload='this.title=this.dataset.title,this.alt=this.dataset.alt;for(const e of["style","data-title","data-alt","onerror","onload"])this.removeAttribute(e);this.dataset.lazyloaded=""' onerror='this.title=this.dataset.title,this.alt=this.dataset.alt;for(const e of["style","data-title","data-alt","onerror","onload"])this.removeAttribute(e)'><span class=header-title-text>都将会</span></a><span id=typeit-header-subtitle-mobile class="typeit header-subtitle"></span></div><div class=menu-toggle id=menu-toggle-mobile><span></span><span></span><span></span></div></div><nav><ul class=menu id=menu-mobile><li class=search-wrapper><div class="search mobile" id=search-mobile><input type=text placeholder=输入关键词搜索 id=search-input-mobile>
<a href=javascript:void(0); class="search-button search-toggle" id=search-toggle-mobile title=Search><i class="fa-solid fa-search fa-fw" aria-hidden=true></i></a>
<a href=javascript:void(0); class="search-button search-clear" id=search-clear-mobile title=Clear><i class="fa-solid fa-times-circle fa-fw" aria-hidden=true></i></a>
<span class="search-button search-loading" id=search-loading-mobile><i class="fa-solid fa-spinner fa-fw fa-spin" aria-hidden=true></i></span></div><a href=javascript:void(0); class=search-cancel id=search-cancel-mobile>Cancel</a></li><li class=menu-item><a class=menu-link href=/posts/><i class="fa-solid fa-archive fa-fw fa-sm" aria-hidden=true></i> Posts</a></li><li class=menu-item><a class=menu-link href=/categories/><i class="fa-solid fa-th fa-fw fa-sm" aria-hidden=true></i> Categories</a></li><li class=menu-item><a class=menu-link href=/tags/><i class="fa-solid fa-tags fa-fw fa-sm" aria-hidden=true></i> Tags</a></li><li class="menu-item menu-system"><span class="menu-system-item theme-switch" title="Switch Theme"><i class="fa-solid fa-adjust fa-fw" aria-hidden=true></i></span></li></ul></nav></div></header><div class="search-dropdown desktop"><div id=search-dropdown-desktop></div></div><div class="search-dropdown mobile"><div id=search-dropdown-mobile></div></div><nav aria-label=breadcrumb class="breadcrumb-container sticky"><ol class=breadcrumb><li class=breadcrumb-item><a href=/ title>Home</a></li><li class=breadcrumb-item><a href=/posts/ title=Posts>Posts</a></li><li class="breadcrumb-item active" aria-current=page>Docker 杂记</li></ol></nav><main class=container><aside class=toc id=toc-auto><h2 class=toc-title>Contents&nbsp;<i class="toc-icon fa-solid fa-angle-down fa-fw" aria-hidden=true></i></h2><div class=toc-content id=toc-content-auto></div></aside><aside class=aside-custom></aside><article class="page single"><div class=header><h1 class="single-title animate__animated animate__flipInX"><span>Docker 杂记</span></h1></div><div class=post-meta><div class=post-meta-line><span class=post-author><span class=author><img loading=lazy src=/images/avatar.jpg srcset="/images/avatar.jpg, /images/avatar.jpg 1.5x, /images/avatar.jpg 2x" sizes=auto data-title=都将会 data-alt=都将会 class=avatar style="background:url(/svg/loading.min.svg)no-repeat 50%" onload='this.title=this.dataset.title,this.alt=this.dataset.alt;for(const e of["style","data-title","data-alt","onerror","onload"])this.removeAttribute(e);this.dataset.lazyloaded=""' onerror='this.title=this.dataset.title,this.alt=this.dataset.alt;for(const e of["style","data-title","data-alt","onerror","onload"])this.removeAttribute(e)'>&nbsp;都将会</span></span>
<span class=post-category>included in <a href=/categories/draft/><i class="fa-regular fa-folder fa-fw" aria-hidden=true></i> draft</a></span></div><div class=post-meta-line><span title="published on 2023-08-08 16:20:34"><i class="fa-regular fa-calendar-alt fa-fw me-1" aria-hidden=true></i><time datetime=2023-08-08>2023-08-08</time></span>&nbsp;<span title="Updated on 2023-08-08 16:20:34"><i class="fa-regular fa-edit fa-fw me-1" aria-hidden=true></i><time datetime=2023-08-08>2023-08-08</time></span>&nbsp;<span><i class="fa-solid fa-pencil-alt fa-fw me-1" aria-hidden=true></i>1174 words</span>&nbsp;<span><i class="fa-regular fa-clock fa-fw me-1" aria-hidden=true></i>6 minutes</span>&nbsp;</div></div><div class="details toc" id=toc-static data-kept=false><div class="details-summary toc-title"><span>Contents</span>
<span><i class="details-icon fa-solid fa-angle-right" aria-hidden=true></i></span></div><div class="details-content toc-content" id=toc-content-static><nav id=TableOfContents><ul><li><a href=#基础知识>基础知识</a><ul><li><a href=#docker的优点>docker的优点</a></li><li><a href=#docker-的缺点>docker 的缺点</a></li><li><a href=#docker-compose-和-dockerfile-的区别>Docker Compose 和 Dockerfile 的区别？</a></li></ul></li><li><a href=#使用教程>使用教程</a><ul><li><a href=#1-portainer可视化工具>1. portainer（可视化工具）</a></li><li><a href=#2-生成ca证书>2. 生成ca证书</a></li><li><a href=#3-idea部署https>3. idea部署https</a></li><li><a href=#4-redis-安装>4. Redis 安装</a></li><li><a href=#5-minio-配置>5. minio 配置</a></li></ul></li><li><a href=#监控系统>监控系统</a><ul><li><a href=#如何配置监控系统>如何配置监控系统？</a></li><li><a href=#springboot-集成-grafana--prometheus-获得-99-线和-999-线>Springboot 集成 grafana + Prometheus 获得 99 线和 999 线？</a></li><li><a href=#动态配置限流阈值>动态配置限流阈值</a></li></ul></li></ul></nav></div></div><div class=content id=content><h2 id=基础知识>基础知识</h2><h3 id=docker的优点>docker的优点</h3><ol><li>轻量级和可移植性：Docker 容器非常轻量级，相比于虚拟机，它们只需要少量的系统资源和运行时间，因此可以更快地启动和停止。Docker 容器还具有高度的可移植性，可以在任何运行 Docker 的环境中运行，无需担心依赖项或环境配置的问题。</li><li>简化应用程序部署：Docker 使得应用程序的部署和管理变得更加简单和可靠。通过将应用程序和其依赖项打包成容器，可以将其轻松地部署到任何环境中，从而简化了整个部署过程。</li><li>高度可定制性：Docker 允许用户构建自己的 Docker 镜像，并根据自己的需求进行自定义配置。这使得用户可以根据自己的应用程序需求创建定制化的容器镜像，提高了应用程序的可定制性和可扩展性。</li><li>容器化应用程序隔离：Docker 容器提供了隔离的环境，可以避免应用程序之间的冲突和干扰。每个容器都具有自己的文件系统、网络、内存和 CPU 资源，可以有效地隔离应用程序之间的资源。</li><li>更好的资源利用率：Docker 容器可以共享主机操作系统的内核和其他资源，从而提高了资源利用率。与虚拟机相比，Docker 容器可以更高效地使用系统资源，从而提高了系统的性能和稳定性。</li></ol><h3 id=docker-的缺点>docker 的缺点</h3><p>容器只是一种特殊的进程，通过Linux Namespace机制进行隔离，但是隔离得不彻底，多个容器使用的还是同一个宿主机的操作系统内核：</p><ol><li>在容器里执行 top 指令,显示的信息居然是宿主机的 CPU 和内存数据，而不是当前容器的数据</li><li>很多资源和对象无法被 Namespace 化，如“时间”</li></ol><h3 id=docker-compose-和-dockerfile-的区别>Docker Compose 和 Dockerfile 的区别？</h3><ul><li>Dockerfile：是一种文本文件格式，用于定义 <strong>Docker 镜像的构建过程</strong>。Dockerfile 中包含了一系列的指令，用于指定基础镜像、安装软件、拷贝文件、配置环境变量等操作，最终生成一个新的 Docker 镜像。Dockerfile 可以通过 docker build 命令执行，将 Dockerfile 转换为 Docker 镜像。</li><li></li><li>FROM，该命令指定基于哪个基础镜像，因为你要指定一个基础镜像才能基于这个镜像之上进行其他操作，DockerFile第一条必须为From指令。如果同一个DockerFile创建多个镜像时，可使用多个From指令（每个镜像一次）</li><li>MAINTAINER，指定作者信息</li><li>CMD</li><li>EXPOSE ，这个是用来暴露端口的</li><li>ENV ，是用于定义环境变量</li><li>VOLUME，这个是用来指定挂载点（也可以在idea配置）</li><li>Docker Compose：用于<strong>定义和运行多个容器之间的依赖关系</strong>。Docker Compose 中使用 YAML 文件格式，定义了应用程序中的服务、网络、卷等资源，以及它们之间的关系和依赖关系。Docker Compose 可以通过 docker-compose 命令集成管理多个容器。</li></ul><p>需要注意的是，Docker Compose 和 Dockerfile 并不是互斥的概念，它们可以一起使用，Dockerfile 定义容器镜像的构建过程，Docker Compose 定义容器之间的关系和依赖关系，可以一起协同工作，实现更加灵活和高效的容器化应用部署和管理。</p><h2 id=使用教程>使用教程</h2><p>首先给服务器上的防火墙打开端口：</p><p><img loading=lazy src="https://publicpictures.oss-cn-hangzhou.aliyuncs.com/img/image-20230309152430376.png#id=yHuHW&amp;originHeight=616&amp;originWidth=2748&amp;originalType=binary&amp;ratio=1&amp;rotation=0&amp;showTitle=false&amp;status=done&amp;style=none&amp;title=" srcset="https://publicpictures.oss-cn-hangzhou.aliyuncs.com/img/image-20230309152430376.png#id=yHuHW&amp;originHeight=616&amp;originWidth=2748&amp;originalType=binary&amp;ratio=1&amp;rotation=0&amp;showTitle=false&amp;status=done&amp;style=none&amp;title=, https://publicpictures.oss-cn-hangzhou.aliyuncs.com/img/image-20230309152430376.png#id=yHuHW&amp;originHeight=616&amp;originWidth=2748&amp;originalType=binary&amp;ratio=1&amp;rotation=0&amp;showTitle=false&amp;status=done&amp;style=none&amp;title= 1.5x, https://publicpictures.oss-cn-hangzhou.aliyuncs.com/img/image-20230309152430376.png#id=yHuHW&amp;originHeight=616&amp;originWidth=2748&amp;originalType=binary&amp;ratio=1&amp;rotation=0&amp;showTitle=false&amp;status=done&amp;style=none&amp;title= 2x" sizes=auto data-title="https://publicpictures.oss-cn-hangzhou.aliyuncs.com/img/image-20230309152430376.png#id=yHuHW&amp;originHeight=616&amp;originWidth=2748&amp;originalType=binary&amp;ratio=1&amp;rotation=0&amp;showTitle=false&amp;status=done&amp;style=none&amp;title=" data-alt="https://publicpictures.oss-cn-hangzhou.aliyuncs.com/img/image-20230309152430376.png#id=yHuHW&amp;originHeight=616&amp;originWidth=2748&amp;originalType=binary&amp;ratio=1&amp;rotation=0&amp;showTitle=false&amp;status=done&amp;style=none&amp;title=" style="background:url(/svg/loading.min.svg)no-repeat 50%" onload='this.title=this.dataset.title,this.alt=this.dataset.alt;for(const e of["style","data-title","data-alt","onerror","onload"])this.removeAttribute(e);this.dataset.lazyloaded=""' onerror='this.title=this.dataset.title,this.alt=this.dataset.alt;for(const e of["style","data-title","data-alt","onerror","onload"])this.removeAttribute(e)'></p><h3 id=1-portainer可视化工具>1. portainer（可视化工具）</h3><div class=highlight id=id-1><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#75715e># docker搜索</span>
</span></span><span style=display:flex><span>docker search portainer
</span></span><span style=display:flex><span><span style=color:#75715e># docker拉取镜像</span>
</span></span><span style=display:flex><span>docker pull portainer/portainer:latest
</span></span><span style=display:flex><span><span style=color:#75715e># 创建数据卷</span>
</span></span><span style=display:flex><span>docker volume create portainer_data
</span></span><span style=display:flex><span><span style=color:#75715e># 运行容器</span>
</span></span><span style=display:flex><span>docker run --name portainer -d -p 9000:9000 -v /var/run/docker.sock:/var/run/docker.sock -v portainer_data:/data portainer/portainer 
</span></span><span style=display:flex><span><span style=color:#75715e>#-d #容器在后台运行</span>
</span></span><span style=display:flex><span><span style=color:#75715e>#-p 9000:9000 # 宿主机9000端口映射容器中的9000端口</span>
</span></span><span style=display:flex><span><span style=color:#75715e>#-v /var/run/docker.sock:/var/run/docker.sock # 把宿主机的Docker守护进程(docker daemon)默认监听的Unix域套接字挂载到容器中</span>
</span></span><span style=display:flex><span><span style=color:#75715e>#-v # 把宿主机目录 挂载到 容器目录；</span>
</span></span><span style=display:flex><span><span style=color:#75715e>#–-name portainer # 指定运行容器的名称</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>cd /usr/libexec/docker/
</span></span><span style=display:flex><span>sudo ln -s docker-runc-current docker-runc</span></span></code></pre></div><blockquote><p>参考：<a href=https://cloud.tencent.com/developer/article/1867994 target=_blank rel="external nofollow noopener noreferrer">https://cloud.tencent.com/developer/article/1867994</a></p></blockquote><h3 id=2-生成ca证书>2. 生成ca证书</h3><div class=highlight id=id-2><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#75715e># 创建ca证书</span>
</span></span><span style=display:flex><span>mkdir -p /usr/local/ca
</span></span><span style=display:flex><span>cd /usr/local/ca/
</span></span><span style=display:flex><span><span style=color:#75715e># 创建密码（输入两次）</span>
</span></span><span style=display:flex><span>openssl genrsa -aes256 -out ca-key.pem <span style=color:#ae81ff>4096</span>
</span></span><span style=display:flex><span><span style=color:#75715e># 依次输入密码、国家、省、市、组织名称等,输入‘.’略过</span>
</span></span><span style=display:flex><span><span style=color:#75715e># common name 填服务器ip</span>
</span></span><span style=display:flex><span>openssl req -new -x509 -days <span style=color:#ae81ff>365</span> -key ca-key.pem -sha256 -out ca.pem</span></span></code></pre></div><p><img loading=lazy src="https://publicpictures.oss-cn-hangzhou.aliyuncs.com/img/image-20230309111129471.png#id=doogK&amp;originHeight=357&amp;originWidth=810&amp;originalType=binary&amp;ratio=1&amp;rotation=0&amp;showTitle=false&amp;status=done&amp;style=none&amp;title=" srcset="https://publicpictures.oss-cn-hangzhou.aliyuncs.com/img/image-20230309111129471.png#id=doogK&amp;originHeight=357&amp;originWidth=810&amp;originalType=binary&amp;ratio=1&amp;rotation=0&amp;showTitle=false&amp;status=done&amp;style=none&amp;title=, https://publicpictures.oss-cn-hangzhou.aliyuncs.com/img/image-20230309111129471.png#id=doogK&amp;originHeight=357&amp;originWidth=810&amp;originalType=binary&amp;ratio=1&amp;rotation=0&amp;showTitle=false&amp;status=done&amp;style=none&amp;title= 1.5x, https://publicpictures.oss-cn-hangzhou.aliyuncs.com/img/image-20230309111129471.png#id=doogK&amp;originHeight=357&amp;originWidth=810&amp;originalType=binary&amp;ratio=1&amp;rotation=0&amp;showTitle=false&amp;status=done&amp;style=none&amp;title= 2x" sizes=auto data-title="https://publicpictures.oss-cn-hangzhou.aliyuncs.com/img/image-20230309111129471.png#id=doogK&amp;originHeight=357&amp;originWidth=810&amp;originalType=binary&amp;ratio=1&amp;rotation=0&amp;showTitle=false&amp;status=done&amp;style=none&amp;title=" data-alt="https://publicpictures.oss-cn-hangzhou.aliyuncs.com/img/image-20230309111129471.png#id=doogK&amp;originHeight=357&amp;originWidth=810&amp;originalType=binary&amp;ratio=1&amp;rotation=0&amp;showTitle=false&amp;status=done&amp;style=none&amp;title=" style="background:url(/svg/loading.min.svg)no-repeat 50%" onload='this.title=this.dataset.title,this.alt=this.dataset.alt;for(const e of["style","data-title","data-alt","onerror","onload"])this.removeAttribute(e);this.dataset.lazyloaded=""' onerror='this.title=this.dataset.title,this.alt=this.dataset.alt;for(const e of["style","data-title","data-alt","onerror","onload"])this.removeAttribute(e)'></p><div class=highlight id=id-3><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#75715e># 生成服务端的 server-key.pem</span>
</span></span><span style=display:flex><span>openssl genrsa -out server-key.pem <span style=color:#ae81ff>4096</span>
</span></span><span style=display:flex><span><span style=color:#75715e># ip地址改成自己的ip或域名</span>
</span></span><span style=display:flex><span>openssl req -subj <span style=color:#e6db74>&#34;/CN=124.221.157.240&#34;</span> -sha256 -new -key server-key.pem -out server.csr
</span></span><span style=display:flex><span><span style=color:#75715e># 配置任何ip+证书可以访问</span>
</span></span><span style=display:flex><span>echo subjectAltName <span style=color:#f92672>=</span> IP:124.221.157.240,IP:0.0.0.0 &gt;&gt; extfile.cnf
</span></span><span style=display:flex><span><span style=color:#75715e># 密钥仅用于服务器身份验证</span>
</span></span><span style=display:flex><span>echo extendedKeyUsage <span style=color:#f92672>=</span> serverAuth &gt;&gt; extfile.cnf
</span></span><span style=display:flex><span><span style=color:#75715e># 生成签名证书</span>
</span></span><span style=display:flex><span>openssl x509 -req -days <span style=color:#ae81ff>365</span> -sha256 -in server.csr -CA ca.pem -CAkey ca-key.pem -CAcreateserial -out server-cert.pem -extfile extfile.cnf
</span></span><span style=display:flex><span><span style=color:#75715e># 生成客户端的 key.pem</span>
</span></span><span style=display:flex><span>openssl genrsa -out key.pem <span style=color:#ae81ff>4096</span>
</span></span><span style=display:flex><span>openssl req -subj <span style=color:#e6db74>&#39;/CN=client&#39;</span> -new -key key.pem -out client.csr
</span></span><span style=display:flex><span><span style=color:#75715e># 密钥适用于客户端身份验证</span>
</span></span><span style=display:flex><span>echo extendedKeyUsage <span style=color:#f92672>=</span> clientAuth &gt; extfile-client.cnf
</span></span><span style=display:flex><span><span style=color:#75715e># 生成签名证书 以下表示365天，可以改成更长</span>
</span></span><span style=display:flex><span>openssl x509 -req -days <span style=color:#ae81ff>365</span> -sha256 -in client.csr -CA ca.pem -CAkey ca-key.pem -CAcreateserial -out cert.pem -extfile extfile-client.cnf
</span></span><span style=display:flex><span><span style=color:#75715e># 删除过程中产生的配置文件</span>
</span></span><span style=display:flex><span>rm -v client.csr server.csr extfile.cnf extfile-client.cnf
</span></span><span style=display:flex><span><span style=color:#75715e># 密钥读写权限改为读取权限</span>
</span></span><span style=display:flex><span><span style=color:#75715e># from 0600 (rw-------) to 0400 (r--------)</span>
</span></span><span style=display:flex><span>chmod -v <span style=color:#ae81ff>0400</span> ca-key.pem key.pem server-key.pem
</span></span><span style=display:flex><span><span style=color:#75715e># 证书对外可读，也关闭写权限</span>
</span></span><span style=display:flex><span><span style=color:#75715e># from 0644 (rw-r--r--) to 0444 (r--r--r--)</span>
</span></span><span style=display:flex><span>chmod -v <span style=color:#ae81ff>0444</span> ca.pem server-cert.pem cert.pem
</span></span><span style=display:flex><span><span style=color:#75715e># 复制证书</span>
</span></span><span style=display:flex><span>cp server-*.pem  /etc/docker/
</span></span><span style=display:flex><span>cp ca.pem /etc/docker/
</span></span><span style=display:flex><span><span style=color:#75715e># docker 关联 ca</span>
</span></span><span style=display:flex><span>vim /usr/lib/systemd/system/docker.service
</span></span><span style=display:flex><span><span style=color:#75715e># 修改ExecStart这一行（添加没有的部分，不删除原有的）</span>
</span></span><span style=display:flex><span>ExecStart<span style=color:#f92672>=</span>/usr/bin/dockerd --tlsverify --tlscacert<span style=color:#f92672>=</span>/etc/docker/ca.pem --tlscert<span style=color:#f92672>=</span>/etc/docker/server-cert.pem --tlskey<span style=color:#f92672>=</span>/etc/docker/server-key.pem -H tcp://0.0.0.0:2376 -H unix:///var/run/docker.sock
</span></span><span style=display:flex><span><span style=color:#75715e># 重新加载 daemon </span>
</span></span><span style=display:flex><span>systemctl daemon-reload 
</span></span><span style=display:flex><span><span style=color:#75715e># 重启 docker</span>
</span></span><span style=display:flex><span>systemctl restart docker
</span></span><span style=display:flex><span><span style=color:#75715e># 开放2376端口</span>
</span></span><span style=display:flex><span>/sbin/iptables -I INPUT -p tcp --dport <span style=color:#ae81ff>2376</span> -j ACCEPT
</span></span><span style=display:flex><span><span style=color:#75715e># 回到主机，把ca文件拷贝出来，-r 表示拷贝文件夹</span>
</span></span><span style=display:flex><span>scp -r ubuntu@124.221.157.240:/usr/local/ca ~/Desktop
</span></span><span style=display:flex><span><span style=color:#75715e># 这里遇到了 key.pem 无法拷贝的问题，临时修改了权限</span>
</span></span><span style=display:flex><span>chmod -v <span style=color:#ae81ff>0444</span> key.pem
</span></span><span style=display:flex><span><span style=color:#75715e># 单独拷贝</span>
</span></span><span style=display:flex><span>scp ubuntu@124.221.157.240:/usr/local/ca/key.pem ~/Desktop/ca
</span></span><span style=display:flex><span><span style=color:#75715e># 再改回来</span>
</span></span><span style=display:flex><span>chmod -v <span style=color:#ae81ff>0400</span> key.pem
</span></span><span style=display:flex><span><span style=color:#75715e># 测试证书接口</span>
</span></span><span style=display:flex><span>curl https://124.221.157.240:2376/info --cert ./cert.pem --key ./key.pem --cacert ./ca.pem</span></span></code></pre></div><p><img loading=lazy src="https://publicpictures.oss-cn-hangzhou.aliyuncs.com/img/image-20230309151931406.png#id=vX8Fk&amp;originHeight=321&amp;originWidth=1724&amp;originalType=binary&amp;ratio=1&amp;rotation=0&amp;showTitle=false&amp;status=done&amp;style=none&amp;title=" srcset="https://publicpictures.oss-cn-hangzhou.aliyuncs.com/img/image-20230309151931406.png#id=vX8Fk&amp;originHeight=321&amp;originWidth=1724&amp;originalType=binary&amp;ratio=1&amp;rotation=0&amp;showTitle=false&amp;status=done&amp;style=none&amp;title=, https://publicpictures.oss-cn-hangzhou.aliyuncs.com/img/image-20230309151931406.png#id=vX8Fk&amp;originHeight=321&amp;originWidth=1724&amp;originalType=binary&amp;ratio=1&amp;rotation=0&amp;showTitle=false&amp;status=done&amp;style=none&amp;title= 1.5x, https://publicpictures.oss-cn-hangzhou.aliyuncs.com/img/image-20230309151931406.png#id=vX8Fk&amp;originHeight=321&amp;originWidth=1724&amp;originalType=binary&amp;ratio=1&amp;rotation=0&amp;showTitle=false&amp;status=done&amp;style=none&amp;title= 2x" sizes=auto data-title="https://publicpictures.oss-cn-hangzhou.aliyuncs.com/img/image-20230309151931406.png#id=vX8Fk&amp;originHeight=321&amp;originWidth=1724&amp;originalType=binary&amp;ratio=1&amp;rotation=0&amp;showTitle=false&amp;status=done&amp;style=none&amp;title=" data-alt="https://publicpictures.oss-cn-hangzhou.aliyuncs.com/img/image-20230309151931406.png#id=vX8Fk&amp;originHeight=321&amp;originWidth=1724&amp;originalType=binary&amp;ratio=1&amp;rotation=0&amp;showTitle=false&amp;status=done&amp;style=none&amp;title=" style="background:url(/svg/loading.min.svg)no-repeat 50%" onload='this.title=this.dataset.title,this.alt=this.dataset.alt;for(const e of["style","data-title","data-alt","onerror","onload"])this.removeAttribute(e);this.dataset.lazyloaded=""' onerror='this.title=this.dataset.title,this.alt=this.dataset.alt;for(const e of["style","data-title","data-alt","onerror","onload"])this.removeAttribute(e)'></p><p>证书生效了。</p><blockquote><p>参考：<a href=https://blog.csdn.net/qq_46126559/article/details/118373855 target=_blank rel="external nofollow noopener noreferrer">https://blog.csdn.net/qq_46126559/article/details/118373855</a></p></blockquote><h3 id=3-idea部署https>3. idea部署https</h3><p>resources/docker/dockerFile</p><div class=highlight id=id-4><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-dockerfile data-lang=dockerfile><span style=display:flex><span><span style=color:#75715e>#FROM openjdk:8-jdk-alpine</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>FROM</span><span style=color:#e6db74> java:8</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>RUN</span> mkdir -p /apps<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#75715e># app改成项目名称</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>ADD</span> *.jar /apps/app.jar<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#75715e>#对外暴露的端口</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>EXPOSE</span><span style=color:#e6db74> 8801</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#75715e># 环境、jar包路径 </span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#75715e># app改成项目名称</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>ENTRYPOINT</span>  [<span style=color:#e6db74>&#34;java&#34;</span>,<span style=color:#e6db74>&#34;-Xmx512m&#34;</span>,<span style=color:#e6db74>&#34;-Xms512m&#34;</span>,<span style=color:#e6db74>&#34;-Dspring.profiles.active=test&#34;</span>,<span style=color:#e6db74>&#34;-jar&#34;</span>,<span style=color:#e6db74>&#34;/apps/app.jar&#34;</span>]<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>RUN</span> echo <span style=color:#e6db74>&#34;Asia/shanghai&#34;</span> &gt; /etc/timezone;<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>ENV</span> LANG C.UTF-8</span></span></code></pre></div><p><img loading=lazy src="https://publicpictures.oss-cn-hangzhou.aliyuncs.com/img/image-20230309160553008.png#id=FrsAk&amp;originHeight=670&amp;originWidth=797&amp;originalType=binary&amp;ratio=1&amp;rotation=0&amp;showTitle=false&amp;status=done&amp;style=none&amp;title=" srcset="https://publicpictures.oss-cn-hangzhou.aliyuncs.com/img/image-20230309160553008.png#id=FrsAk&amp;originHeight=670&amp;originWidth=797&amp;originalType=binary&amp;ratio=1&amp;rotation=0&amp;showTitle=false&amp;status=done&amp;style=none&amp;title=, https://publicpictures.oss-cn-hangzhou.aliyuncs.com/img/image-20230309160553008.png#id=FrsAk&amp;originHeight=670&amp;originWidth=797&amp;originalType=binary&amp;ratio=1&amp;rotation=0&amp;showTitle=false&amp;status=done&amp;style=none&amp;title= 1.5x, https://publicpictures.oss-cn-hangzhou.aliyuncs.com/img/image-20230309160553008.png#id=FrsAk&amp;originHeight=670&amp;originWidth=797&amp;originalType=binary&amp;ratio=1&amp;rotation=0&amp;showTitle=false&amp;status=done&amp;style=none&amp;title= 2x" sizes=auto data-title="https://publicpictures.oss-cn-hangzhou.aliyuncs.com/img/image-20230309160553008.png#id=FrsAk&amp;originHeight=670&amp;originWidth=797&amp;originalType=binary&amp;ratio=1&amp;rotation=0&amp;showTitle=false&amp;status=done&amp;style=none&amp;title=" data-alt="https://publicpictures.oss-cn-hangzhou.aliyuncs.com/img/image-20230309160553008.png#id=FrsAk&amp;originHeight=670&amp;originWidth=797&amp;originalType=binary&amp;ratio=1&amp;rotation=0&amp;showTitle=false&amp;status=done&amp;style=none&amp;title=" style="background:url(/svg/loading.min.svg)no-repeat 50%" onload='this.title=this.dataset.title,this.alt=this.dataset.alt;for(const e of["style","data-title","data-alt","onerror","onload"])this.removeAttribute(e);this.dataset.lazyloaded=""' onerror='this.title=this.dataset.title,this.alt=this.dataset.alt;for(const e of["style","data-title","data-alt","onerror","onload"])this.removeAttribute(e)'></p><p><a href=https://124.221.157.240:2376 target=_blank rel="external nofollow noopener noreferrer">https://124.221.157.240:2376</a></p><p>选择包含<code>cert.pem、key.pem、ca.pem</code> 的文件夹</p><p><img loading=lazy src="https://publicpictures.oss-cn-hangzhou.aliyuncs.com/img/image-20230309165618960.png#id=yy5oL&amp;originHeight=714&amp;originWidth=1040&amp;originalType=binary&amp;ratio=1&amp;rotation=0&amp;showTitle=false&amp;status=done&amp;style=none&amp;title=" srcset="https://publicpictures.oss-cn-hangzhou.aliyuncs.com/img/image-20230309165618960.png#id=yy5oL&amp;originHeight=714&amp;originWidth=1040&amp;originalType=binary&amp;ratio=1&amp;rotation=0&amp;showTitle=false&amp;status=done&amp;style=none&amp;title=, https://publicpictures.oss-cn-hangzhou.aliyuncs.com/img/image-20230309165618960.png#id=yy5oL&amp;originHeight=714&amp;originWidth=1040&amp;originalType=binary&amp;ratio=1&amp;rotation=0&amp;showTitle=false&amp;status=done&amp;style=none&amp;title= 1.5x, https://publicpictures.oss-cn-hangzhou.aliyuncs.com/img/image-20230309165618960.png#id=yy5oL&amp;originHeight=714&amp;originWidth=1040&amp;originalType=binary&amp;ratio=1&amp;rotation=0&amp;showTitle=false&amp;status=done&amp;style=none&amp;title= 2x" sizes=auto data-title="https://publicpictures.oss-cn-hangzhou.aliyuncs.com/img/image-20230309165618960.png#id=yy5oL&amp;originHeight=714&amp;originWidth=1040&amp;originalType=binary&amp;ratio=1&amp;rotation=0&amp;showTitle=false&amp;status=done&amp;style=none&amp;title=" data-alt="https://publicpictures.oss-cn-hangzhou.aliyuncs.com/img/image-20230309165618960.png#id=yy5oL&amp;originHeight=714&amp;originWidth=1040&amp;originalType=binary&amp;ratio=1&amp;rotation=0&amp;showTitle=false&amp;status=done&amp;style=none&amp;title=" style="background:url(/svg/loading.min.svg)no-repeat 50%" onload='this.title=this.dataset.title,this.alt=this.dataset.alt;for(const e of["style","data-title","data-alt","onerror","onload"])this.removeAttribute(e);this.dataset.lazyloaded=""' onerror='this.title=this.dataset.title,this.alt=this.dataset.alt;for(const e of["style","data-title","data-alt","onerror","onload"])this.removeAttribute(e)'></p><p><img loading=lazy src="https://publicpictures.oss-cn-hangzhou.aliyuncs.com/img/image-20230309165701931.png#id=KkbSh&amp;originHeight=215&amp;originWidth=645&amp;originalType=binary&amp;ratio=1&amp;rotation=0&amp;showTitle=false&amp;status=done&amp;style=none&amp;title=" srcset="https://publicpictures.oss-cn-hangzhou.aliyuncs.com/img/image-20230309165701931.png#id=KkbSh&amp;originHeight=215&amp;originWidth=645&amp;originalType=binary&amp;ratio=1&amp;rotation=0&amp;showTitle=false&amp;status=done&amp;style=none&amp;title=, https://publicpictures.oss-cn-hangzhou.aliyuncs.com/img/image-20230309165701931.png#id=KkbSh&amp;originHeight=215&amp;originWidth=645&amp;originalType=binary&amp;ratio=1&amp;rotation=0&amp;showTitle=false&amp;status=done&amp;style=none&amp;title= 1.5x, https://publicpictures.oss-cn-hangzhou.aliyuncs.com/img/image-20230309165701931.png#id=KkbSh&amp;originHeight=215&amp;originWidth=645&amp;originalType=binary&amp;ratio=1&amp;rotation=0&amp;showTitle=false&amp;status=done&amp;style=none&amp;title= 2x" sizes=auto data-title="https://publicpictures.oss-cn-hangzhou.aliyuncs.com/img/image-20230309165701931.png#id=KkbSh&amp;originHeight=215&amp;originWidth=645&amp;originalType=binary&amp;ratio=1&amp;rotation=0&amp;showTitle=false&amp;status=done&amp;style=none&amp;title=" data-alt="https://publicpictures.oss-cn-hangzhou.aliyuncs.com/img/image-20230309165701931.png#id=KkbSh&amp;originHeight=215&amp;originWidth=645&amp;originalType=binary&amp;ratio=1&amp;rotation=0&amp;showTitle=false&amp;status=done&amp;style=none&amp;title=" style="background:url(/svg/loading.min.svg)no-repeat 50%" onload='this.title=this.dataset.title,this.alt=this.dataset.alt;for(const e of["style","data-title","data-alt","onerror","onload"])this.removeAttribute(e);this.dataset.lazyloaded=""' onerror='this.title=this.dataset.title,this.alt=this.dataset.alt;for(const e of["style","data-title","data-alt","onerror","onload"])this.removeAttribute(e)'></p><p>/etc/localtime</p><p>/usr/share/zoneinfo/Asia/Shanghai</p><p>/apps</p><h3 id=4-redis-安装>4. Redis 安装</h3><div class=highlight id=id-5><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#75715e># 拉镜像</span>
</span></span><span style=display:flex><span>docker pull redis:latest
</span></span><span style=display:flex><span><span style=color:#75715e># 挂载目录</span>
</span></span><span style=display:flex><span>mkdir /docker-data/redis
</span></span><span style=display:flex><span>cd /docker-data/redis
</span></span><span style=display:flex><span><span style=color:#75715e># 下载redis.conf</span>
</span></span><span style=display:flex><span>wget http://download.redis.io/redis-stable/redis.conf
</span></span><span style=display:flex><span><span style=color:#75715e># 权限</span>
</span></span><span style=display:flex><span>chmod <span style=color:#ae81ff>777</span> redis.conf
</span></span><span style=display:flex><span><span style=color:#75715e># 修改配置信息</span>
</span></span><span style=display:flex><span>vim /docker-data/redis/redis.conf</span></span></code></pre></div><div class=highlight id=id-6><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>bind 127.0.0.1 <span style=color:#75715e># 这行要注释掉，解除本地连接限制</span>
</span></span><span style=display:flex><span>protected-mode no <span style=color:#75715e># 默认yes，如果设置为yes，则只允许在本机的回环连接，其他机器无法连接。</span>
</span></span><span style=display:flex><span>daemonize no <span style=color:#75715e># 默认no 为不守护进程模式，docker部署不需要改为yes，docker run -d本身就是后台启动，不然会冲突</span>
</span></span><span style=display:flex><span>requirepass <span style=color:#ae81ff>123456</span> <span style=color:#75715e># 设置密码</span>
</span></span><span style=display:flex><span>appendonly yes <span style=color:#75715e># 持久化</span></span></span></code></pre></div><div class=highlight id=id-7><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#75715e>#启动</span>
</span></span><span style=display:flex><span>docker run --name redis <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>-p 6379:6379 <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>-v /docker-data/redis/redis.conf:/etc/redis/redis.conf <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>-v /docker-data/redis:/data <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>-d redis redis-server /etc/redis/redis.conf --appendonly yes</span></span></code></pre></div><blockquote><p>参考：<a href=https://cloud.tencent.com/developer/article/1997596 target=_blank rel="external nofollow noopener noreferrer">https://cloud.tencent.com/developer/article/1997596</a></p></blockquote><h3 id=5-minio-配置>5. minio 配置</h3><div class=highlight id=id-8><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>docker run -p 9090:9090 -p 9091:9091 <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>     --name minio <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>     -d --restart<span style=color:#f92672>=</span>always <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>     -e <span style=color:#e6db74>&#34;MINIO_ACCESS_KEY=minioadmin&#34;</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>     -e <span style=color:#e6db74>&#34;MINIO_SECRET_KEY=Josh@123&#34;</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>     -v /home/minio/data:/data <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>     -v /home/minio/config:/root/.minio <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>     minio/minio server <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>     /data --console-address <span style=color:#e6db74>&#34;:9091&#34;</span> -address <span style=color:#e6db74>&#34;:9090&#34;</span></span></span></code></pre></div><p>9090是服务端口，9091是可视化界面</p><h2 id=监控系统>监控系统</h2><h3 id=如何配置监控系统>如何配置监控系统？</h3><ol><li>安装：编写一个 docker-compose.yml 文件，指定 Prometheus 和 Grafana 的镜像、端口等配置，然后使用 docker-compose up 命令启动 Prometheus 和 Grafana 。</li></ol><div class=highlight id=id-9><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#f92672>version</span>: <span style=color:#e6db74>&#39;3&#39;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>services</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>prometheus</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>image</span>: <span style=color:#ae81ff>prom/prometheus</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>ports</span>:
</span></span><span style=display:flex><span>      - <span style=color:#e6db74>&#34;9090:9090&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>volumes</span>:
</span></span><span style=display:flex><span>      - <span style=color:#ae81ff>./prometheus:/etc/prometheus/</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>command</span>:
</span></span><span style=display:flex><span>      - --<span style=color:#ae81ff>config.file=/etc/prometheus/prometheus.yml</span>
</span></span><span style=display:flex><span>      - --<span style=color:#ae81ff>storage.tsdb.path=/prometheus</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>restart</span>: <span style=color:#ae81ff>always</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>grafana</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>image</span>: <span style=color:#ae81ff>grafana/grafana</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>ports</span>:
</span></span><span style=display:flex><span>      - <span style=color:#e6db74>&#34;3000:3000&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>volumes</span>:
</span></span><span style=display:flex><span>      - <span style=color:#ae81ff>./grafana:/var/lib/grafana</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>restart</span>: <span style=color:#ae81ff>always</span></span></span></code></pre></div><ol start=2><li>配置 Prometheus：在 Prometheus 的配置文件中，指定需要监控的目标（例如 Java 应用程序），以及需要采集的指标（例如 JVM 内存使用情况、线程池情况等）。可以使用 Prometheus 的查询语言（PromQL）查询指标，在Grafana面板中，点击“Apply”或“Refresh”按钮，即可执行查询语句并显示结果</li></ol><div class=highlight id=id-10><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#75715e># 获取实例的 CPU 使用率：</span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>100</span> - <span style=color:#f92672>(</span>avg by <span style=color:#f92672>(</span>instance<span style=color:#f92672>)</span> <span style=color:#f92672>(</span>irate<span style=color:#f92672>(</span>node_cpu_seconds_total<span style=color:#f92672>{</span>mode<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;idle&#34;</span><span style=color:#f92672>}[</span>5m<span style=color:#f92672>]))</span> * 100<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 获取实例的内存使用率：</span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>100</span> - <span style=color:#f92672>((</span>node_memory_MemFree_bytes + node_memory_Buffers_bytes + node_memory_Cached_bytes<span style=color:#f92672>)</span> / node_memory_MemTotal_bytes<span style=color:#f92672>)</span> * <span style=color:#ae81ff>100</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 获取实例的磁盘使用率：</span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>100</span> - <span style=color:#f92672>(</span>avg by <span style=color:#f92672>(</span>instance<span style=color:#f92672>)</span> <span style=color:#f92672>(</span>node_filesystem_free_bytes<span style=color:#f92672>{</span>fstype<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;ext4&#34;</span><span style=color:#f92672>}</span> / node_filesystem_size_bytes<span style=color:#f92672>{</span>fstype<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;ext4&#34;</span><span style=color:#f92672>})</span> * 100<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 获取 HTTP 请求数量：</span>
</span></span><span style=display:flex><span>sum by <span style=color:#f92672>(</span>job<span style=color:#f92672>)</span> <span style=color:#f92672>(</span>http_requests_total<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 获取 HTTP 请求错误数量：</span>
</span></span><span style=display:flex><span>sum by <span style=color:#f92672>(</span>job, status<span style=color:#f92672>)</span> <span style=color:#f92672>(</span>http_requests_total<span style=color:#f92672>{</span>status<span style=color:#f92672>=</span>~<span style=color:#e6db74>&#34;5..&#34;</span><span style=color:#f92672>})</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 获取 HTTP 请求响应时间的平均值：</span>
</span></span><span style=display:flex><span>avg by <span style=color:#f92672>(</span>job<span style=color:#f92672>)</span> <span style=color:#f92672>(</span>http_request_duration_seconds<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 获取 HTTP 请求响应时间的 90% 百分位数：</span>
</span></span><span style=display:flex><span>histogram_quantile<span style=color:#f92672>(</span>0.9, sum by <span style=color:#f92672>(</span>le<span style=color:#f92672>)</span> <span style=color:#f92672>(</span>rate<span style=color:#f92672>(</span>http_request_duration_seconds_bucket<span style=color:#f92672>[</span>5m<span style=color:#f92672>])))</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 获取容器 CPU 使用率：</span>
</span></span><span style=display:flex><span>sum by <span style=color:#f92672>(</span>container<span style=color:#f92672>)</span> <span style=color:#f92672>(</span>rate<span style=color:#f92672>(</span>container_cpu_usage_seconds_total<span style=color:#f92672>{</span>container!<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;POD&#34;</span><span style=color:#f92672>}[</span>5m<span style=color:#f92672>]))</span> * <span style=color:#ae81ff>100</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 获取容器内存使用率：</span>
</span></span><span style=display:flex><span>sum by <span style=color:#f92672>(</span>container<span style=color:#f92672>)</span> <span style=color:#f92672>(</span>container_memory_usage_bytes<span style=color:#f92672>{</span>container!<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;POD&#34;</span><span style=color:#f92672>})</span> / sum by <span style=color:#f92672>(</span>container<span style=color:#f92672>)</span> <span style=color:#f92672>(</span>container_spec_memory_limit_bytes<span style=color:#f92672>{</span>container!<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;POD&#34;</span><span style=color:#f92672>})</span> * <span style=color:#ae81ff>100</span></span></span></code></pre></div><ol start=3><li>配置 Grafana：在 Grafana 中，选择“Prometheus”作为数据源类型，创建仪表盘和面板，使用 Grafana 的查询语言（GQL）查询指标，并将查询结果可视化展示。</li></ol><div class=highlight id=id-11><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#75715e># 获取指定时间范围内的监控数据</span>
</span></span><span style=display:flex><span>SELECT mean<span style=color:#f92672>(</span><span style=color:#e6db74>&#34;metric_name&#34;</span><span style=color:#f92672>)</span> FROM <span style=color:#e6db74>&#34;measurement_name&#34;</span> WHERE time &gt;<span style=color:#f92672>=</span> now<span style=color:#f92672>()</span> - 1h GROUP BY time<span style=color:#f92672>(</span>1m<span style=color:#f92672>)</span> fill<span style=color:#f92672>(</span>null<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 数据聚合和重采样</span>
</span></span><span style=display:flex><span>SELECT sum<span style=color:#f92672>(</span><span style=color:#e6db74>&#34;metric_name&#34;</span><span style=color:#f92672>)</span> FROM <span style=color:#e6db74>&#34;measurement_name&#34;</span> WHERE time &gt;<span style=color:#f92672>=</span> now<span style=color:#f92672>()</span> - 1d GROUP BY time<span style=color:#f92672>(</span>1h<span style=color:#f92672>)</span> fill<span style=color:#f92672>(</span>0<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 根据标签过滤数据</span>
</span></span><span style=display:flex><span>SELECT mean<span style=color:#f92672>(</span><span style=color:#e6db74>&#34;metric_name&#34;</span><span style=color:#f92672>)</span> FROM <span style=color:#e6db74>&#34;measurement_name&#34;</span> WHERE <span style=color:#e6db74>&#34;tag_name&#34;</span> <span style=color:#f92672>=</span>~ /tag_value/ AND time &gt;<span style=color:#f92672>=</span> now<span style=color:#f92672>()</span> - 1h GROUP BY time<span style=color:#f92672>(</span>1m<span style=color:#f92672>)</span> fill<span style=color:#f92672>(</span>null<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 获取最新的监控数据</span>
</span></span><span style=display:flex><span>SELECT last<span style=color:#f92672>(</span><span style=color:#e6db74>&#34;metric_name&#34;</span><span style=color:#f92672>)</span> FROM <span style=color:#e6db74>&#34;measurement_name&#34;</span> WHERE time &gt;<span style=color:#f92672>=</span> now<span style=color:#f92672>()</span> - 1h GROUP BY <span style=color:#e6db74>&#34;tag_name&#34;</span> fill<span style=color:#f92672>(</span>null<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 数据去重</span>
</span></span><span style=display:flex><span>SELECT distinct<span style=color:#f92672>(</span><span style=color:#e6db74>&#34;tag_name&#34;</span><span style=color:#f92672>)</span> FROM <span style=color:#e6db74>&#34;measurement_name&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 计算两个指标之间的关系</span>
</span></span><span style=display:flex><span>SELECT derivative<span style=color:#f92672>(</span><span style=color:#e6db74>&#34;metric1_name&#34;</span><span style=color:#f92672>)</span> / derivative<span style=color:#f92672>(</span><span style=color:#e6db74>&#34;metric2_name&#34;</span><span style=color:#f92672>)</span> * <span style=color:#ae81ff>100</span> FROM <span style=color:#e6db74>&#34;measurement_name&#34;</span> WHERE time &gt;<span style=color:#f92672>=</span> now<span style=color:#f92672>()</span> - 1h GROUP BY time<span style=color:#f92672>(</span>1m<span style=color:#f92672>)</span> fill<span style=color:#f92672>(</span>null<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 计算指标的百分位数</span>
</span></span><span style=display:flex><span>SELECT percentile<span style=color:#f92672>(</span><span style=color:#e6db74>&#34;metric_name&#34;</span>, 95<span style=color:#f92672>)</span> FROM <span style=color:#e6db74>&#34;measurement_name&#34;</span> WHERE time &gt;<span style=color:#f92672>=</span> now<span style=color:#f92672>()</span> - 1h GROUP BY time<span style=color:#f92672>(</span>1m<span style=color:#f92672>)</span> fill<span style=color:#f92672>(</span>null<span style=color:#f92672>)</span></span></span></code></pre></div><h3 id=springboot-集成-grafana--prometheus-获得-99-线和-999-线>Springboot 集成 grafana + Prometheus 获得 99 线和 999 线？</h3><ol><li>添加依赖</li></ol><p>在 Spring Boot 项目的 pom.xml 文件中添加以下依赖：</p><pre tabindex=0><code>&lt;dependency&gt;
    &lt;groupId&gt;io.micrometer&lt;/groupId&gt;
    &lt;artifactId&gt;micrometer-core&lt;/artifactId&gt;
    &lt;version&gt;1.5.9&lt;/version&gt;
&lt;/dependency&gt;
&lt;dependency&gt;
    &lt;groupId&gt;io.micrometer&lt;/groupId&gt;
    &lt;artifactId&gt;micrometer-registry-prometheus&lt;/artifactId&gt;
    &lt;version&gt;1.5.9&lt;/version&gt;
&lt;/dependency&gt;</code></pre><p>其中，micrometer-core 是 Micrometer 库的核心依赖，micrometer-registry-prometheus 是 Micrometer 的 Prometheus 注册表依赖。</p><ol start=2><li>配置 Prometheus 注册表</li></ol><p>在 Spring Boot 项目的配置文件 application.yml 中添加 Prometheus 注册表配置：</p><pre tabindex=0><code>management:
  endpoints:
    web:
      exposure:
        include: &#34;*&#34;
  metrics:
    tags:
      application: ${spring.application.name}
    distribution:
      percentiles-histogram:
        http.server.requests: true
    export:
      prometheus:
        enabled: true
        step: 10s</code></pre><p>其中，management.endpoints.web.exposure.include 配置开启所有的监控端点；management.metrics.tags.application 配置应用程序名称；management.metrics.export.prometheus.enabled 配置开启 Prometheus 注册表；management.metrics.export.prometheus.step 配置采集数据的时间间隔。</p><ol start=3><li>配置 Grafana 数据源</li></ol><p>在 Grafana 中添加 Prometheus 数据源，并配置数据源 URL。例如，Prometheus 数据源 URL 可以配置为 http://localhost:9090。</p><ol start=4><li>创建 Dashboard</li></ol><p>在 Grafana 中创建 Dashboard，并配置 Panel。例如，可以添加一个新的 Graph Panel，然后在 Metrics 选项卡中选择 http.server.requests 指标并设置 percentiles 为 0.99 和 0.999。</p><ol start=5><li>查看 99 线和 999 线</li></ol><p>在创建好的 Dashboard 中，可以查看 http.server.requests 指标的 99 线和 999 线。这些线条将显示在 Graph Panel 中，并显示当前时间范围内的 99% 和 99.9% 的请求响应时间。
以上是 Spring Boot 集成 Grafana 和 Prometheus 并获取 99 线和 999 线的步骤。需要注意的是，具体的配置和实现可能因应用程序的具体情况而异，需要根据具体情况进行调整和修改。</p><h3 id=动态配置限流阈值>动态配置限流阈值</h3><p>要根据 Grafana 监控数据动态更改限流阈值，可以使用 Grafana 的 Alerting 功能和 Spring Boot 的 Actuator 端点，具体步骤如下：</p><ol><li>创建 Grafana Alerting 规则</li></ol><p>在 Grafana 中创建 Alerting 规则，以监控请求响应时间超过 999 线的情况。具体步骤如下：
a. 在 Grafana 中创建一个 Dashboard，并添加一个 Graph Panel。
b. 在 Metrics 选项卡中选择 http.server.requests 指标，并设置 percentiles 为 0.999。
c. 在 Alert 选项卡中创建一个 Alerting 规则，当请求响应时间超过 999 线时触发。
d. 在 Notifications 选项卡中配置 Alert 的通知方式，例如邮件通知。</p><ol start=2><li>创建 Actuator 端点</li></ol><p>在 Spring Boot 应用程序中创建 Actuator 端点，用于接收来自 Grafana 的 Alerting 通知，并动态更改限流阈值。具体步骤如下：
a. 创建一个实现 Actuator Endpoint 接口的类，用于接收来自 Grafana 的 Alerting 通知。</p><div class=highlight id=id-14><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#a6e22e>@Component</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Endpoint</span><span style=color:#f92672>(</span>id <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;my-endpoint&#34;</span><span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>MyEndpoint</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>@WriteOperation</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>setRateLimit</span><span style=color:#f92672>(</span><span style=color:#a6e22e>@Selector</span> String route<span style=color:#f92672>,</span> <span style=color:#66d9ef>int</span> rateLimit<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            <span style=color:#75715e>// 设置限流阈值，例如使用 Redis 缓存保存阈值。
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span></span></span></code></pre></div><p>其中，setRateLimit 方法用于设置限流阈值，例如使用 Redis 缓存保存阈值。
b. 在 Spring Boot 应用程序的配置文件 application.yml 中开启 Actuator 端点。</p><div class=highlight id=id-15><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#f92672>management</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>endpoints</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>web</span>:
</span></span><span style=display:flex><span>      <span style=color:#f92672>exposure</span>:
</span></span><span style=display:flex><span>        <span style=color:#f92672>include</span>: <span style=color:#e6db74>&#34;*&#34;</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>endpoint</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>my-endpoint</span>:
</span></span><span style=display:flex><span>      <span style=color:#f92672>enabled</span>: <span style=color:#66d9ef>true</span></span></span></code></pre></div><ol start=3><li>实现限流器</li></ol><p>在 Spring Boot 应用程序中实现限流器，用于根据 Actuator 端点中保存的阈值进行限流。例如，可以使用 Spring Cloud Gateway 的 RequestRateLimiter 过滤器进行限流。</p><div class=highlight id=id-16><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#a6e22e>@Component</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>RateLimiterGatewayFilterFactory</span> <span style=color:#66d9ef>extends</span> AbstractGatewayFilterFactory<span style=color:#f92672>&lt;</span>RateLimiterGatewayFilterFactory<span style=color:#f92672>.</span><span style=color:#a6e22e>Config</span><span style=color:#f92672>&gt;</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// 从 Redis 缓存中获取限流阈值
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>int</span> <span style=color:#a6e22e>getRateLimit</span><span style=color:#f92672>(</span>String route<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            <span style=color:#75715e>// 例如使用 Redis 缓存保存阈值。
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>public</span> <span style=color:#a6e22e>RateLimiterGatewayFilterFactory</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>super</span><span style=color:#f92672>(</span>Config<span style=color:#f92672>.</span><span style=color:#a6e22e>class</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>@Override</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>public</span> GatewayFilter <span style=color:#a6e22e>apply</span><span style=color:#f92672>(</span>Config config<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span> <span style=color:#f92672>(</span>exchange<span style=color:#f92672>,</span> chain<span style=color:#f92672>)</span> <span style=color:#f92672>-&gt;</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                String route <span style=color:#f92672>=</span> exchange<span style=color:#f92672>.</span><span style=color:#a6e22e>getAttribute</span><span style=color:#f92672>(</span>ServerWebExchangeUtils<span style=color:#f92672>.</span><span style=color:#a6e22e>GATEWAY_ROUTE_ATTR</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>int</span> rateLimit <span style=color:#f92672>=</span> getRateLimit<span style=color:#f92672>(</span>route<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>                <span style=color:#75715e>// 使用 RequestRateLimiter 过滤器进行限流
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>                <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>new</span> RequestRateLimiterGatewayFilterFactory<span style=color:#f92672>().</span><span style=color:#a6e22e>apply</span><span style=color:#f92672>(</span><span style=color:#66d9ef>new</span> RequestRateLimiterGatewayFilterFactory<span style=color:#f92672>.</span><span style=color:#a6e22e>Config</span><span style=color:#f92672>().</span><span style=color:#a6e22e>setRateLimiter</span><span style=color:#f92672>(</span><span style=color:#66d9ef>new</span> RedisRateLimiter<span style=color:#f92672>(</span>rateLimit<span style=color:#f92672>,</span> rateLimit<span style=color:#f92672>,</span> Duration<span style=color:#f92672>.</span><span style=color:#a6e22e>ofSeconds</span><span style=color:#f92672>(</span>1<span style=color:#f92672>))));</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>};</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>Config</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            <span style=color:#75715e>// 配置
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span></span></span></code></pre></div><p>其中，RateLimiterGatewayFilterFactory 是自定义的限流器，使用 Redis 缓存保存限流阈值；getRateLimit 方法用于从 Redis 缓存中获取限流阈值；使用 RequestRateLimiter 过滤器进行限流。</p><ol start=4><li>测试</li></ol><p>启动 Spring Boot 应用程序，然后在 Grafana 中创建一个 Alerting 规则，当请求响应时间超过 999 线时触发。当 Alert 触发时，Grafana 会向 Actuator 端点发送通知，Actuator 端点会动态更改限流阈值。限流器会根据新的限流阈值进行限流，从而有效控制请求的并发量。
以上是根据 Grafana 监控数据动态更改限流阈值的步骤。需要注意的是，具体的实现和配置可能因应用程序的具体情况而异，需要根据具体情况进行调整和修改。</p></div><div class=post-footer id=post-footer><div class=post-info><div class=post-info-line><div class=post-info-mod><span title="Updated on 2023-08-08 16:20:34">Updated on 2023-08-08&nbsp;</span></div></div><div class=post-info-line><div class=post-info-md></div><div class=post-info-share><span><a href=javascript:void(0); title="Share on 微博" data-sharer=weibo data-url=https://leni.fun/posts/docker_draft/ data-title="Docker 杂记"><i class="fa-brands fa-weibo fa-fw" aria-hidden=true></i></a></span></div></div></div><div class=post-info-more><section class=post-tags><i class="fa-solid fa-tags fa-fw me-1" aria-hidden=true></i><a href=/tags/docker/ class=post-tag>Docker</a></section><section><span><a href=javascript:void(0); onclick=window.history.back()>Back</a></span>&nbsp;|&nbsp;<span><a href=/>Home</a></span></section></div><div class=post-nav><a href=/posts/%E5%BE%80%E6%9C%9F%E5%91%A8%E8%B5%9B%E9%A2%98%E8%A7%A3/ class=post-nav-item rel=prev title=往期周赛与笔试题解><i class="fa-solid fa-angle-left fa-fw" aria-hidden=true></i>往期周赛与笔试题解</a>
<a href=/posts/os/ class=post-nav-item rel=next title="🚩OS - 操作系统">🚩OS - 操作系统<i class="fa-solid fa-angle-right fa-fw" aria-hidden=true></i></a></div></div></article></main><footer class=footer><div class=footer-container><div class="footer-line copyright" itemscope itemtype=http://schema.org/CreativeWork><i class="fa-regular fa-copyright fa-fw" aria-hidden=true></i>
<span itemprop=copyrightYear>2023</span><span class=author itemprop=copyrightHolder>
<a href=/>都将会</a></span><span class="license footer-divider">Back-End Engineer</span></div><div class="footer-line statistics"><span class=site-time title='Website running ...'><i class="fa-solid fa-heartbeat fa-fw animate-icon" aria-hidden=true></i><span class="run-times ms-1">Website running ...</span></span></div><div class="footer-line visitor"><span id=busuanzi_container_site_uv title='Total visitors'><i class="fa-regular fa-user fa-fw" aria-hidden=true></i>&nbsp;<span id=busuanzi_value_site_uv><i class="fa-solid fa-spinner fa-spin fa-fw" aria-hidden=true></i></span></span><span id=busuanzi_container_site_pv class=footer-divider title='Total visits'><i class="fa-regular fa-eye fa-fw" aria-hidden=true></i>&nbsp;<span id=busuanzi_value_site_pv><i class="fa-solid fa-spinner fa-spin fa-fw" aria-hidden=true></i></span></span></div></div></footer></div><div class=widgets><div class="fixed-buttons animate__faster d-none"><div class="fixed-button back-to-top" role=button aria-label="Back to Top"><i class="fa-solid fa-arrow-up fa-fw" aria-hidden=true></i><span class=variant-numeric>0%</span></div></div><a href=https://github.com/hihihiman/hihihiman.github.io title=博客源码 target=_blank rel="external nofollow" class="github-corner left d-none-mobile"><svg viewBox="0 0 250 250" aria-hidden="true"><path d="M0 0 115 115h15l12 27L250 250V0z"/><path d="M128.3 109C113.8 99.7 119 89.6 119 89.6 122 82.7 120.5 78.6 120.5 78.6 119.2 72 123.4 76.3 123.4 76.3 127.3 80.9 125.5 87.3 125.5 87.3 122.9 97.6 130.6 101.9 134.4 103.2" fill="currentcolor" style="transform-origin:130px 106px" class="octo-arm"/><path d="M115 115C114.9 115.1 118.7 116.5 119.8 115.4l13.9-13.8C136.9 99.2 139.9 98.4 142.2 98.6 133.8 88 127.5 74.4 143.8 58 148.5 53.4 154 51.2 159.7 51 160.3 49.4 163.2 43.6 171.4 40.1 171.4 40.1 176.1 42.5 178.8 56.2 183.1 58.6 187.2 61.8 190.9 65.4 194.5 69 197.7 73.2 200.1 77.6 213.8 80.2 216.3 84.9 216.3 84.9 212.7 93.1 206.9 96 205.4 96.6 205.1 102.4 203 107.8 198.3 112.5 181.9 128.9 168.3 122.5 157.7 114.1 157.9 116.9 156.7 120.9 152.7 124.9L141 136.5C139.8 137.7 141.6 141.9 141.8 141.8z" fill="currentcolor" class="octo-body"/></svg></a><div id=mask></div><div class=reading-progress-bar style=left:0;bottom:0;--bg-progress:#000;--bg-progress-dark:#fff></div><noscript><div class=noscript-warning>Theme FixIt works best with JavaScript enabled.</div></noscript></div><link rel=stylesheet href=/lib/cookieconsent/cookieconsent.min.css><link rel=stylesheet href=/lib/pace/themes/pink/pace-theme-center-atom.css><script src=/lib/autocomplete/autocomplete.min.js defer></script><script src=/lib/fuse/fuse.min.js defer></script><script src=/lib/instant-page/instantpage.min.js async defer type=module></script><script src=/lib/sharer/sharer.min.js async defer></script><script src=/lib/typeit/index.umd.js defer></script><script src=/lib/cookieconsent/cookieconsent.min.js defer></script><script src=/lib/pangu/pangu.min.js defer></script><script src=//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js async defer></script><script src=/lib/pace/pace.min.js async defer></script><script>window.config={autoBookmark:!0,code:{copyTitle:"Copy to clipboard",editLockTitle:"Lock editable code block",editUnLockTitle:"Unlock editable code block",editable:!0,maxShownLines:64},comment:{enable:!1},cookieconsent:{content:{dismiss:"Got it!",link:"Learn more",message:"This website uses Cookies to improve your experience."},enable:!0,palette:{button:{background:"#f0f0f0"},popup:{background:"#1aa3ff"}},theme:"edgeless"},data:{"typeit-header-subtitle-desktop":"的博客","typeit-header-subtitle-mobile":"的博客"},enablePWA:!0,pangu:{enable:!0,selector:"article"},search:{distance:100,findAllMatches:!1,highlightTag:"em",ignoreFieldNorm:!0,ignoreLocation:!0,isCaseSensitive:!1,location:0,maxResultLength:10,minMatchCharLength:2,noResultsFound:"No results found",snippetLength:50,threshold:.3,useExtendedSearch:!0},siteTime:"2023-08-06T23:31:00+08:00",typeit:{cursorChar:"_",cursorSpeed:1e3,data:{"typeit-header-subtitle-desktop":["typeit-header-subtitle-desktop"],"typeit-header-subtitle-mobile":["typeit-header-subtitle-mobile"]},duration:-1,loop:!0,speed:100}}</script><script src=/js/theme.min.js defer></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/jquery@2.1.3/dist/jquery.min.js></script><script type=text/javascript src=/js/custom.js></script></body></html>
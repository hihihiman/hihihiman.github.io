# ðŸš©MySQL


<!--more-->

![image.png](https://publicpictures.oss-cn-hangzhou.aliyuncs.com/img/1681975245174-4b0669a4-d72e-4d09-aca5-d4df06397181.png)

### MySQL ä¸­çš„é”

InnoDB å¼•æ“ŽåŠ é”çš„æœ¬è´¨æ˜¯é”ä½ç´¢å¼•è®°å½•ï¼ˆå¯ä»¥ç†è§£ä¸º B+æ ‘çš„å¶å­èŠ‚ç‚¹ï¼‰ã€‚åœ¨å¯é‡å¤è¯» RR çš„éš”ç¦»çº§åˆ«ä¸‹ï¼Œ

- ä¸€èˆ¬éƒ½åŠ ä¸´é”®é”ï¼Œå·¦å¼€å³é—­ ï¼ˆé˜²æ­¢å¹»è¯»ï¼‰
- ä¸Šç•Œæ— ç©·é—´éš™é”
- å”¯ä¸€ç´¢å¼•ç­‰å€¼æŸ¥è¯¢è®°å½•é”

### Innodb å’Œ MyISAM çš„åŒºåˆ«ï¼Ÿ

1. innodb æ”¯æŒäº‹åŠ¡å’Œå¤–é”®
2. innodb é»˜è®¤è¡¨é”ï¼Œä½¿ç”¨ç´¢å¼•æ£€ç´¢æ¡ä»¶æ—¶æ˜¯è¡Œé”ï¼Œè€Œ myisam æ˜¯è¡¨é”ï¼ˆæ¯æ¬¡æ›´æ–°å¢žåŠ åˆ é™¤éƒ½ä¼šé”ä½è¡¨ï¼‰
3. innodb å’Œ myisam çš„ç´¢å¼•éƒ½æ˜¯åŸºäºŽ b+æ ‘ï¼Œä½† innodb çš„ b+æ ‘çš„å¶å­èŠ‚ç‚¹æ˜¯å­˜æ”¾æ•°æ®çš„ï¼Œ**myisam çš„ b+æ ‘çš„å¶å­èŠ‚ç‚¹æ˜¯å­˜æ”¾æŒ‡é’ˆçš„**
4. **innodb æ˜¯èšç°‡ç´¢å¼•ï¼Œå¿…é¡»è¦æœ‰ä¸»é”®ï¼Œä¸€å®šä¼šåŸºäºŽä¸»é”®æŸ¥è¯¢ï¼Œä½†æ˜¯è¾…åŠ©ç´¢å¼•å°±ä¼šæŸ¥è¯¢ä¸¤æ¬¡ï¼Œmyisam æ˜¯éžèšç°‡ç´¢å¼•ï¼Œç´¢å¼•å’Œæ•°æ®æ˜¯åˆ†ç¦»çš„ï¼Œç´¢å¼•é‡Œä¿å­˜çš„æ˜¯æ•°æ®åœ°å€çš„æŒ‡é’ˆï¼Œä¸»é”®ç´¢å¼•å’Œè¾…åŠ©ç´¢å¼•æ˜¯åˆ†å¼€çš„ã€‚**
5. innodb ä¸å­˜å‚¨è¡¨çš„è¡Œæ•°ï¼Œæ‰€ä»¥ select count( _ )çš„æ—¶å€™ä¼šå…¨è¡¨æŸ¥è¯¢ï¼Œè€Œ myisam ä¼šå­˜æ”¾è¡¨çš„è¡Œæ•°ï¼Œselect count(_ï¼‰çš„æ—¶å€™ä¼šæŸ¥çš„å¾ˆå¿«ã€‚
6. **MyISAM å­˜å‚¨é™åˆ¶ 256TBï¼Œæ›´é€‚åˆä½Žå¹¶å‘ã€å¼±ä¸€è‡´æ€§åœºæ™¯ï¼›Innodb å­˜å‚¨é™åˆ¶ 64TBï¼Œæ›´é€‚åˆé«˜å¹¶å‘ã€æ›´æ–°é¢‘ç¹çš„åœºæ™¯ã€‚**

### ç»“æž„åŒ–æŸ¥è¯¢è¯­è¨€çš„ 6 ä¸ªéƒ¨åˆ†

- DDLï¼šData Define Languageï¼Œæ•°æ®å®šä¹‰è¯­è¨€ï¼Œå¦‚ CREATEã€ALTERã€DROP
- DMLï¼šData Manipulation Languageï¼Œæ•°æ®æ“ä½œè¯­è¨€ï¼Œå¦‚ INSERTã€UPDATEã€DELETE
- DQLï¼šData Query Languageï¼Œæ•°æ®æŸ¥è¯¢è¯­è¨€ï¼Œå¦‚ SELECTã€WHEREã€ORDER BYã€GROUP BYã€HAVING
- TCLï¼šTransactional Control Languageï¼Œäº‹åŠ¡æŽ§åˆ¶è¯­è¨€ï¼Œç¡®ä¿ DML å½±å“çš„æ‰€æœ‰è¡ŒåŠæ—¶å¾—ä»¥æ›´æ–°ï¼Œå¦‚ COMMITã€SAVEPOINTã€ROLLBACK
- DCLï¼šData Control Languageï¼Œæ•°æ®æŽ§åˆ¶è¯­è¨€ï¼Œå®žçŽ°æƒé™æŽ§åˆ¶ï¼Œå¦‚ GRANTã€REVOKE
- CCLï¼šCursor Control Languageï¼ŒæŒ‡é’ˆæŽ§åˆ¶è¯­è¨€ï¼Œå¦‚ DECLARE CURSORã€FETCH INTOã€UPDATE WHERE CURRENT

### binlog ã€redolog å’Œ undolog çš„åŒºåˆ«ï¼Ÿ

- binlogï¼š æ‰€æœ‰å¼•æ“Ž**å¢žé‡è®°å½•é€»è¾‘æ—¥å¿—ï¼ˆäºŒè¿›åˆ¶ï¼‰**
  - æ•°æ®åº“è¿˜åŽŸ
  - ä¸»ä»ŽåŒæ­¥ï¼ˆCanal ç±»ä¸­é—´ä»¶æœ¬è´¨æ˜¯æŠŠè‡ªå·±ä¼ªè£…æˆä»ŽèŠ‚ç‚¹ï¼‰ï¼š
    - ä¸»åº“æäº¤ï¼Œå°† DDL ä¸Ž DML æ•°æ®å†™å…¥ binlogï¼›
    - ä»Žåº“å°†ä¸»åº“çš„ binlog å†™å…¥è‡ªå·±çš„ä¸­ç»§æ—¥å¿— **relay log**
    - ä»Žåº“æ‰§è¡Œ relay log ä¸­çš„äº‹ä»¶
  - `sync_binlog = 0`ï¼šå†™å…¥ page cache å°±ç®—æˆåŠŸï¼ˆé»˜è®¤ï¼‰
  - `sync_binlog = N`ï¼šæ¯æäº¤ N æ¬¡å°±åˆ·æ–°åˆ°ç£ç›˜ï¼ŒN è¶Šå°æ€§èƒ½è¶Šå·®ã€‚
- redologï¼šInnoDB **å¾ªçŽ¯è®°å½•ç‰©ç†æ—¥å¿—**ï¼ˆæŸä¸ªé¡µçš„ä¿®æ”¹ï¼‰ï¼Œå¤§å°å›ºå®šï¼Œå†™åˆ°ç»“å°¾æ—¶ï¼Œä¼šå›žåˆ°å¼€å¤´å¾ªçŽ¯å†™æ—¥å¿—ï¼Œä¿è¯äº†æŒä¹…æ€§ã€‚
  - å…ˆæ›´æ–° buffer poolï¼Œå†å†™ redo logï¼Œç­‰äº‹åŠ¡ç»“æŸåŽåˆ·ç›˜åˆ°ç£ç›˜
  - é¡ºåºå†™ï¼Œæ€§èƒ½ä¼˜äºŽéšæœºå†™
- undologï¼š è®°å½•é€»è¾‘ç›¸åæ“ä½œé€»è¾‘æ—¥å¿—ï¼Œç”¨äºŽå›žæ»š
  - deleteï¼šè®°å½•ä¸»é”®é€»è¾‘åˆ é™¤
  - insertï¼šè®°å½•ä¸»é”®
  - update
    - æ²¡æœ‰æ›´æ–°ä¸»é”®ï¼šä¸»é”®+åŽŸå€¼
    - æ›´æ–°ä¸»é”®ï¼šdelete+insert

#### äº‹åŠ¡æ‰§è¡Œè¿‡ç¨‹

![image.png](https://publicpictures.oss-cn-hangzhou.aliyuncs.com/img/1691041539662-bce37b97-6a2f-4a4f-9de9-89cb088faa79-20230808082056219.png)

å®•æœºæƒ…å½¢ï¼š

- åœ¨ redo log åˆ·æ–°åˆ°ç£ç›˜ï¼ˆäº‹åŠ¡æäº¤ï¼‰ä¹‹å‰ï¼Œéƒ½æ˜¯å›žæ»š undo logã€‚
- å¦‚æžœåœ¨ redo log å·²ç»åˆ·æ–°åˆ°ç£ç›˜ï¼Œåœ¨ MySQL é‡å¯ä¹‹åŽå°±ä¼šå›žæ”¾è¿™ä¸ª redo logï¼Œä»¥çº æ­£æ•°æ®åº“é‡Œçš„æ•°æ®ã€‚

### åˆ†åº“åˆ†è¡¨ - sharding-sphere ä¸­é—´ä»¶

- æ°´å¹³åˆ†åº“ï¼šåº”å¯¹å¤§æ•°æ®ï¼Œå¯¹æ€§èƒ½è¦æ±‚ä¸åŒçš„æ•°æ®è¿›è¡Œåˆ†åº“ `sync_binlog = 0/1`
- åž‚ç›´åˆ†åº“ï¼šæ ¹æ®ä¸šåŠ¡è¿›è¡Œæ‹†åˆ†å¾®æœåŠ¡
- **åž‚ç›´åˆ†è¡¨ï¼šå†·çƒ­æ•°æ®åˆ†ç¦»ï¼ˆé›¶é›¶æ’­é¡¹ç›®ä¸­çš„ userã€streamerã€ownerï¼‰**

### ç´¢å¼•åˆ†ç±»

- èšç°‡/éžèšç°‡ï¼šå¶å­èŠ‚ç‚¹æ˜¯å¦å­˜å‚¨è¡Œæ•°æ®
- è¦†ç›–ç´¢å¼•ï¼šç´¢å¼•åŒ…å«æŸæ¬¡æŸ¥è¯¢çš„æ‰€æœ‰åˆ—
- å”¯ä¸€ç´¢å¼• uniqueï¼šå¯ä»¥ä¸ºç©ºï¼Œä½†æœ€å¤šä¸€ä¸ªç©º
- ä¸»é”®ç´¢å¼• primary keyï¼šä¸èƒ½ä¸ºç©º
- å‰ç¼€ç´¢å¼•ï¼šå¯ä»¥é€‰æ‹©åœ¨ varchar(128)çš„åˆ—ä¸Šé€‰æ‹©å‰ 32 ä¸ªå­—ç¬¦ä½œä¸ºç´¢å¼•
- è”åˆç´¢å¼•ï¼šæœ€å·¦åŒ¹é…åŽŸåˆ™
- å…¨æ–‡ç´¢å¼• full text ï¼šæ”¯æŒæ–‡æœ¬æ¨¡ç³ŠæŸ¥è¯¢ç”¨äºŽ charã€varcharã€text
- å“ˆå¸Œç´¢å¼•ï¼šInnodb å’Œ MyISAM éƒ½ä¸é€‚ç”¨

### å¦‚ä½•ä½¿ç”¨æ…¢ SQL ä¼˜åŒ–ï¼Ÿ

```sql
# å¼€å¯æ…¢æŸ¥è¯¢æ—¥å¿—
SET GLOBAL slow_query_log = 'ON';
# è›®æŸ¥è¯¢æ—¥å¿—å­˜æ”¾ä½ç½®
SET GLOBAL slow_query_log_file = 'var/lib/mysql/slow_query.log'
# æœªè¢«ç´¢å¼•çš„è®°å½•
SET GLOBAL log_queries_not_using_indexes = 'ON';
# æ…¢æŸ¥è¯¢é˜ˆå€¼ï¼ˆç§’ï¼‰
SET SESSION long_query_time = 1;
# æ…¢æŸ¥è¯¢è®°å½•æ‰«æè¡Œæ•°é˜ˆå€¼
SET SESSION min_examined_row_limit = 100;
```

æ‰¾åˆ°æ…¢ SQL ä¹‹åŽï¼Œç”¨ `EXPLAIN` å‘½ä»¤åˆ†æžï¼š

1. possible_keyï¼šå¯èƒ½ç”¨åˆ°çš„ç´¢å¼•
2. keyï¼šå®žé™…å‘½ä¸­çš„ç´¢å¼•
3. key_lenï¼šç´¢å¼•å ç”¨çš„å¤§å°
4. rowsï¼šæ‰«æçš„è¡Œæ•°
5. filteredï¼šæ‰€éœ€æ•°æ®å  rows çš„æ¯”ä¾‹
6. extraï¼šé¢å¤–çš„ä¼˜åŒ–å»ºè®®
   1. Using whereï¼›Using Index ç”¨åˆ°ç´¢å¼•ï¼Œä¸ç”¨å›žè¡¨
   2. Using index** condition** ç”¨åˆ°ç´¢å¼•ï¼Œéœ€è¦**å›žè¡¨**
7. typeï¼šæ€§èƒ½ä»Žå¥½åˆ°å·®
   1. systemï¼šmysql è‡ªå¸¦çš„è¡¨
   2. constï¼šæ ¹æ®ä¸»é”®æŸ¥è¯¢
   3. eq_refï¼šä¸»é”®ç´¢å¼•/å”¯ä¸€ç´¢å¼•
   4. refï¼šç´¢å¼•æŸ¥è¯¢
   5. rangeï¼šèŒƒå›´æŸ¥è¯¢
   6. indexï¼šç´¢å¼•æ ‘æ‰«æ
   7. allï¼šå…¨ç›˜æ‰«æ

#### é€‰æ‹©ç´¢å¼•åˆ—

1. æ•°æ®é‡å¤§ã€æŸ¥è¯¢é¢‘ç¹çš„è¡¨ï¼Œæ¶‰åŠ whereã€orderbyã€groupby é¢‘ç¹çš„å­—æ®µ
2. åŒºåˆ†åº¦é«˜çš„å­—æ®µå»ºç«‹å”¯ä¸€ç´¢å¼•æˆ–æ”¾åœ¨å·¦è¾¹
3. å­—ç¬¦ä¸²ç±»åž‹ä¼˜å…ˆä½¿ç”¨å‰ç¼€ç´¢å¼•ï¼Œå ç”¨ç©ºé—´æ›´å°
4. `not null` çº¦æŸ

#### ä¸é€‰æ‹©ç´¢å¼•æƒ…å†µ

1. è¢«é¢‘ç¹æ›´æ–°çš„å­—æ®µ
2. é•¿æœŸæœªä½¿ç”¨çš„ç´¢å¼•ï¼šsys åº“çš„`schema_unused_indexes`è§†å›¾

### ç´¢å¼•å¤±æ•ˆæƒ…å†µï¼Ÿ

1. æ²¡æœ‰è¦†ç›–ç´¢å¼•ï¼Œå¦‚ select \*
2. è”åˆç´¢å¼•æœªéµå¾ªæœ€å·¦å‰ç¼€åŽŸåˆ™
   1. Mysql ä»Žå·¦åˆ°å³çš„ä½¿ç”¨ç´¢å¼•ä¸­çš„å­—æ®µï¼Œä¸€ä¸ªæŸ¥è¯¢å¯ä»¥åªä½¿ç”¨ç´¢å¼•ä¸­çš„ä¸€éƒ¨ä»½ï¼Œä½†åªèƒ½æ˜¯æœ€å·¦ä¾§éƒ¨åˆ†
   2. ä¾‹å¦‚ç´¢å¼•æ˜¯ key index ï¼ˆa,b,cï¼‰ã€‚ å¯ä»¥æ”¯æŒ a ã€a,b ã€a,b,c 3 ç§ç»„åˆè¿›è¡ŒæŸ¥æ‰¾ï¼Œä½†ä¸æ”¯æŒ b,c è¿›è¡ŒæŸ¥æ‰¾ã€‚
3. èŒƒå›´æŸ¥è¯¢å³è¾¹çš„åˆ—ä¼šå¤±æ•ˆï¼ŒèŒƒå›´è¿‡å¤§ä¹Ÿä¼šå¯¼è‡´å…¨è¡¨æ‰«æ
4. åœ¨ç´¢å¼•åˆ—ä¸Šè¿ç®—æ“ä½œ
   1. å¦‚æžœæŸ¥è¯¢ä¸­å¿…é¡»ä½¿ç”¨å‡½æ•°æˆ–è¡¨è¾¾å¼ï¼Œè€Œä¸”è¿™äº›å‡½æ•°æˆ–è¡¨è¾¾å¼æ— æ³•ä½¿ç”¨ç´¢å¼•åŠ é€ŸæŸ¥è¯¢ï¼Œé‚£ä¹ˆå¯ä»¥è€ƒè™‘ä½¿ç”¨è®¡ç®—åˆ—ï¼ˆComputed Columnï¼‰æ¥åŠ é€ŸæŸ¥è¯¢ã€‚è®¡ç®—åˆ—æ˜¯ä¸€ç§ç‰¹æ®Šçš„åˆ—ï¼Œå®ƒçš„å€¼æ˜¯é€šè¿‡è®¡ç®—å¾—åˆ°çš„ï¼Œè€Œä¸æ˜¯ç›´æŽ¥å­˜å‚¨åœ¨è¡¨ä¸­ã€‚åœ¨ MySQL ä¸­ï¼Œå¯ä»¥ä½¿ç”¨è™šæ‹Ÿåˆ—ï¼ˆVirtual Columnï¼‰æˆ–å­˜å‚¨åˆ—ï¼ˆStored Columnï¼‰æ¥å®žçŽ°è®¡ç®—åˆ—ã€‚è™šæ‹Ÿåˆ—æ˜¯ä¸€ç§åªå­˜åœ¨äºŽæŸ¥è¯¢ç»“æžœä¸­çš„è®¡ç®—åˆ—ï¼Œå®ƒä¸ä¼šåœ¨è¡¨ä¸­å­˜å‚¨ä»»ä½•æ•°æ®ã€‚è™šæ‹Ÿåˆ—å¯ä»¥ä½¿ç”¨è¡¨è¾¾å¼æ¥è®¡ç®—ï¼Œä¾‹å¦‚ï¼š`ALTER TABLE table ADD COLUMN virtual_col INT AS (YEAR(date_col)) VIRTUAL;`
5. like '%abc'
6. or çš„å‰åŽæ¡ä»¶ä¸­æœ‰ä¸€ä¸ªåˆ—æ²¡æœ‰ç´¢å¼•ï¼Œæ¶‰åŠçš„ç´¢å¼•ä¹Ÿå¤±æ•ˆ
7. in()æŸ¥è¯¢æ—¶ï¼Œåº”è¯¥å°½å¯èƒ½å‡å°‘å€¼åˆ—è¡¨çš„é•¿åº¦ï¼Œé¿å…æŸ¥è¯¢è½¬åŒ–æˆè¿‡é•¿çš„ OR å­å¥ï¼Œä»¥åŠé¿å…åœ¨æŸ¥è¯¢ä¸­ä½¿ç”¨ NULL å€¼ã€‚

### ðŸŒŸ ä»€ä¹ˆæ˜¯èšç°‡ç´¢å¼•ï¼Ÿ

> æ¯ä¸ªè¡¨åœ¨ MySQL ä¸­å¯¹åº”ç€ä¸€ä¸ªèšç°‡ç´¢å¼•å’Œå¤šä¸ªè¾…åŠ©ç´¢å¼•ï¼Œæ¯ä¸ªç´¢å¼•éƒ½å¯¹åº”ä¸€ä¸ªç‹¬ç«‹çš„ B+ æ ‘ã€‚æ¯ä¸ª B+ æ ‘ç´¢å¼•éƒ½åŒ…å«äº†ç›¸åº”ç´¢å¼•ç±»åž‹çš„æ‰€æœ‰ç´¢å¼•é”®å€¼ï¼Œä½†å¹¶ä¸æ˜¯ä¸€ä¸ªå•ç‹¬çš„ B+ æ ‘ç´¢å¼•åŒ…å«äº†æ‰€æœ‰çš„ç´¢å¼•é”®å€¼ã€‚æ‰€ä»¥ï¼Œå¯ä»¥è¯´åœ¨ MySQL ä¸­ï¼Œæ¯ä¸ªè¡¨å¯¹åº”å¤šæ£µ B+ æ ‘ç´¢å¼•ã€‚

![](https://publicpictures.oss-cn-hangzhou.aliyuncs.com/img/1678155173320-852872be-de47-4708-bcdb-0b3afdf3ccf8-20230808082056230.jpeg)

- èšç°‡ç´¢å¼•ï¼šå¶å­èŠ‚ç‚¹ä¿å­˜äº†è¡Œæ•°æ®ï¼Œæœ‰ä¸”åªæœ‰ä¸€ä¸ªèšç°‡ç´¢å¼•ã€‚
  - ä¸»é”® pk > å”¯ä¸€ç´¢å¼• unique > è‡ªåŠ¨ç”Ÿæˆ row_id
- éžèšç°‡ç´¢å¼•ï¼šå¶å­èŠ‚ç‚¹å…³è”ä¸»é”®ï¼ŒæŒ‡å‘äº†æ•°æ®çš„å¯¹åº”è¡Œï¼Œè‹¥æ²¡æœ‰è¦†ç›–ç´¢å¼•åˆ™éœ€è¦å›žè¡¨èµ°èšç°‡ç´¢å¼•ã€‚

èšç°‡ç´¢å¼•çš„ä¼˜ç‚¹ï¼š

1. ç”±äºŽè¡Œæ•°æ®å’Œå¶å­èŠ‚ç‚¹å­˜å‚¨åœ¨ä¸€èµ·ï¼ŒåŒä¸€é¡µä¸­ä¼šæœ‰å¤šæ¡è¡Œæ•°æ®ï¼Œè®¿é—®åŒä¸€æ•°æ®é¡µä¸åŒè¡Œè®°å½•æ—¶ï¼Œå·²ç»æŠŠé¡µåŠ è½½åˆ°äº† Buffer ä¸­ï¼Œå†æ¬¡è®¿é—®çš„æ—¶å€™ï¼Œä¼šåœ¨å†…å­˜ä¸­å®Œæˆè®¿é—®ï¼Œä¸å¿…è®¿é—®ç£ç›˜ã€‚è¿™æ ·ä¸»é”®å’Œè¡Œæ•°æ®æ˜¯ä¸€èµ·è¢«è½½å…¥å†…å­˜çš„ï¼Œæ‰¾åˆ°å¶å­èŠ‚ç‚¹å°±å¯ä»¥ç«‹åˆ»å°†è¡Œæ•°æ®è¿”å›žäº†ï¼Œå¦‚æžœæŒ‰ç…§ä¸»é”® Id æ¥ç»„ç»‡æ•°æ®ï¼ŒèŽ·å¾—æ•°æ®æ›´å¿«ã€‚
2. è¾…åŠ©ç´¢å¼•ä½¿ç”¨ä¸»é”®ä½œä¸º"æŒ‡é’ˆ"è€Œä¸æ˜¯ä½¿ç”¨åœ°å€å€¼ä½œä¸ºæŒ‡é’ˆçš„å¥½å¤„æ˜¯ï¼Œå‡å°‘äº†å½“å‡ºçŽ°è¡Œç§»åŠ¨æˆ–è€…æ•°æ®é¡µåˆ†è£‚æ—¶è¾…åŠ©ç´¢å¼•çš„ç»´æŠ¤å·¥ä½œï¼Œä½¿ç”¨ä¸»é”®å€¼å½“ä½œæŒ‡é’ˆä¼šè®©è¾…åŠ©ç´¢å¼•å ç”¨æ›´å¤šçš„ç©ºé—´ï¼Œæ¢æ¥çš„å¥½å¤„æ˜¯ InnoDB åœ¨ç§»åŠ¨è¡Œæ—¶æ— é¡»æ›´æ–°è¾…åŠ©ç´¢å¼•ä¸­çš„è¿™ä¸ª"æŒ‡é’ˆ"ã€‚ä¹Ÿå°±æ˜¯è¯´è¡Œçš„ä½ç½®ï¼ˆå®žçŽ°ä¸­é€šè¿‡ 16K çš„ Page æ¥å®šä½ï¼‰ä¼šéšç€æ•°æ®åº“é‡Œæ•°æ®çš„ä¿®æ”¹è€Œå‘ç”Ÿå˜åŒ–ï¼ˆå‰é¢çš„ B+æ ‘èŠ‚ç‚¹åˆ†è£‚ä»¥åŠ Page çš„åˆ†è£‚ï¼‰ï¼Œä½¿ç”¨èšç°‡ç´¢å¼•å°±å¯ä»¥ä¿è¯ä¸ç®¡è¿™ä¸ªä¸»é”® B+æ ‘çš„èŠ‚ç‚¹å¦‚ä½•å˜åŒ–ï¼Œè¾…åŠ©ç´¢å¼•æ ‘éƒ½ä¸å—å½±å“ã€‚
3. èšç°‡ç´¢å¼•é€‚åˆç”¨åœ¨æŽ’åºçš„åœºåˆï¼Œéžèšç°‡ç´¢å¼•ä¸é€‚åˆ
4. å–å‡ºä¸€å®šèŒƒå›´æ•°æ®çš„æ—¶å€™ï¼Œä½¿ç”¨ç”¨èšç°‡ç´¢å¼•
5. äºŒçº§ç´¢å¼•éœ€è¦ä¸¤æ¬¡ç´¢å¼•æŸ¥æ‰¾ï¼Œè€Œä¸æ˜¯ä¸€æ¬¡æ‰èƒ½å–åˆ°æ•°æ®ï¼Œå› ä¸ºå­˜å‚¨å¼•æ“Žç¬¬ä¸€æ¬¡éœ€è¦é€šè¿‡äºŒçº§ç´¢å¼•æ‰¾åˆ°ç´¢å¼•çš„å¶å­èŠ‚ç‚¹ï¼Œä»Žè€Œæ‰¾åˆ°æ•°æ®çš„ä¸»é”®ï¼Œç„¶åŽåœ¨èšç°‡ç´¢å¼•ä¸­ç”¨ä¸»é”®å†æ¬¡æŸ¥æ‰¾ç´¢å¼•ï¼Œå†æ‰¾åˆ°æ•°æ®
6. å¯ä»¥æŠŠç›¸å…³æ•°æ®ä¿å­˜åœ¨ä¸€èµ·ã€‚ä¾‹å¦‚å®žçŽ°ç”µå­é‚®ç®±æ—¶ï¼Œå¯ä»¥æ ¹æ®ç”¨æˆ· ID æ¥èšé›†æ•°æ®ï¼Œè¿™æ ·åªéœ€è¦ä»Žç£ç›˜è¯»å–å°‘æ•°çš„æ•°æ®é¡µå°±èƒ½èŽ·å–æŸä¸ªç”¨æˆ·çš„å…¨éƒ¨é‚®ä»¶ã€‚å¦‚æžœæ²¡æœ‰ä½¿ç”¨èšç°‡ç´¢å¼•ï¼Œåˆ™æ¯å°é‚®ä»¶éƒ½å¯èƒ½å¯¼è‡´ä¸€æ¬¡ç£ç›˜ I/Oã€‚

### ðŸŒŸSQL ä¼˜åŒ–ç»éªŒï¼Ÿ

1. é¿å… select \*ï¼Œä¸»æŸ¥è¯¢èšç°‡ç´¢å¼•ï¼Œå­æŸ¥è¯¢è¦†ç›–ç´¢å¼•
2. **ç”¨ union all **ä»£æ›¿ unionï¼ˆåŽ»é‡ã€æŽ’åºæ¶ˆè€—æ€§èƒ½ï¼‰
3. where è¯­å¥ä¸­ä¸ä½¿ç”¨è¡¨è¾¾å¼ï¼Œé˜²æ­¢ç´¢å¼•å¤±æ•ˆ
4. èƒ½**ç”¨ inner join**ï¼ˆä¼˜å…ˆä»¥å°è¡¨é©±åŠ¨å¤§è¡¨ï¼‰ å°±ä¸ç”¨ left/right joinã€‚
5. å°† HAVING ä¸­éƒ¨åˆ†æ¡ä»¶æå‰åˆ° WHERE é‡Œ
6. ç”¨ EXPLAIN è¿”å›žçš„é¢„ä¼°è¡Œæ•°

```
SELECT rows FROM (EXPLAIN SELECT * FROM xxx WHERE uid = 123) a;
```

7. å°† RR é™ä½Žä¸º RCï¼Œé¿å…ä¸´é”®é”å¼•å‘æ­»é”ï¼Œæé«˜æ€§èƒ½ã€‚
   1. å¯ä»¥é€šè¿‡ç¼“å­˜ç¬¬ä¸€æ¬¡æ•°æ®ï¼Œæ¥é¿å…ç¬¬äºŒæ¬¡æŸ¥è¯¢ï¼Œæ¥ä¿è¯å‡ ä¹Žå…¨éƒ¨äº‹åŠ¡å†…éƒ¨å¯¹æŸä¸€æ•°æ®éƒ½åªè¯»å–ä¸€æ¬¡
   2. å¯ä»¥å•ç‹¬æŒ‡å®š Session æˆ–è€…äº‹åŠ¡çš„éš”ç¦»çº§åˆ«ã€‚

### ðŸŒŸ å¹¶å‘äº‹åŠ¡é—®é¢˜

#### éš”ç¦»çº§åˆ«

- è„è¯»ï¼šè¯»åˆ°å…¶ä»–äº‹åŠ¡æœªæäº¤çš„æ•°æ®
- ä¸å¯é‡å¤è¯»ï¼šåŒä¸€äº‹åŠ¡å†…ï¼Œå…ˆåŽè¯»å–çš„æ•°æ®ä¸åŒï¼Œå› ä¸ºå…¶ä»–äº‹åŠ¡ update æˆ– delete ä¼šå½±å“ç»“æžœé›†ã€‚
- å¹»è¯»ï¼šåŒä¸€äº‹åŠ¡å†…ï¼Œå…ˆåŽè¯»å–çš„ count ä¸åŒã€‚ä¾‹å¦‚ï¼ŒæŸ¥è¯¢æ—¶æ²¡æœ‰æŸ idï¼Œæ’å…¥æ—¶ id å·²å­˜åœ¨ã€‚
  - åŽŸå› ï¼šåŠ é”åŽï¼Œä¸é”å®šé—´éš™ï¼Œå…¶ä»–äº‹åŠ¡å¯ä»¥ INSERTï¼Œå¯¼è‡´ç›¸åŒçš„æŸ¥è¯¢åœ¨ä¸åŒçš„æ—¶é—´å¾—åˆ°ä¸åŒçš„ç»“æžœã€‚
  - è§£å†³æ–¹æ¡ˆï¼šä½¿ç”¨**ä¸´é”®é”**ï¼Œå¯¹äºŽä½¿ç”¨äº†å”¯ä¸€ç´¢å¼•ç­‰å”¯ä¸€æŸ¥è¯¢æ¡ä»¶ï¼ŒInnoDB åªé”å®šç´¢å¼•è®°å½•ï¼Œä¸é”å®šé—´éš™ï¼›å¯¹äºŽå…¶ä»–æŸ¥è¯¢æ¡ä»¶ï¼ŒInnoDB ä¼š**é”å®šæ‰«æåˆ°çš„ç´¢å¼•èŒƒå›´**ï¼Œé€šè¿‡ä¸´é”®é”æ¥é˜»æ­¢å…¶ä»–ä¼šè¯åœ¨è¿™ä¸ªèŒƒå›´ä¸­æ’å…¥æ–°å€¼ã€‚
- RU è¯»æœªæäº¤ï¼šè„è¯»ã€ä¸å¯é‡å¤è¯»ã€å¹»è¯»éƒ½ä¼šå‡ºçŽ°
- RC è¯»å·²æäº¤ï¼šè§£å†³è„è¯»ï¼Œæ¯ä¸€æ¬¡å¿«ç…§è¯»æ—¶ç”Ÿæˆ** ReadView è¯»å–è‡ªå·±çš„æ–°å¿«ç…§**
  - å¤šæ•°æ•°æ®åº“é»˜è®¤
  - ä»…æ”¯æŒåŸºäºŽè¡Œçš„ bin log
  - å½“ä¸€ä¸ªäº‹åŠ¡å¯åŠ¨æ—¶ï¼Œæ•°æ®åº“ä¼šä¸ºè¯¥äº‹åŠ¡åˆ›å»ºä¸€ä¸ªç‰ˆæœ¬é“¾ï¼Œè¯¥ç‰ˆæœ¬é“¾åŒ…å«äº†æ•°æ®åº“ä¸­æ‰€æœ‰æ•°æ®å¯¹è±¡çš„æ‰€æœ‰ç‰ˆæœ¬ã€‚å½“äº‹åŠ¡è¯»å–æ•°æ®æ—¶ï¼Œæ•°æ®åº“ä¼šæ ¹æ®äº‹åŠ¡çš„å¯åŠ¨æ—¶é—´æˆ³é€‰æ‹©ç›¸åº”çš„ç‰ˆæœ¬ï¼Œå¹¶ä¸”åœ¨ç‰ˆæœ¬é“¾ä¸­æ·»åŠ ä¸€ä¸ªæ–°çš„ç‰ˆæœ¬ï¼Œä»¥ä¿è¯è¯¥äº‹åŠ¡æ‰€è¯»å–çš„æ•°æ®ä¸ä¼šè¢«å…¶ä»–äº‹åŠ¡ä¿®æ”¹ã€‚
- RR å¯é‡å¤è¯»ï¼šè§£å†³ä¸å¯é‡å¤è¯»ï¼Œ**ä»…ç¬¬ä¸€æ¬¡ç”Ÿæˆ ReadView çš„æ´»è·ƒäº‹åŠ¡ m_idsï¼ŒåŽç»­å¤ç”¨ï¼ˆä¸€è‡´æ€§å¿«ç…§ï¼‰**
  - **èšç°‡ç´¢å¼•æ›´æ–° = æ›¿æ¢ï¼Œéžèšç°‡ç´¢å¼•æ›´æ–° = åˆ é™¤+æ–°å»º**
  - MVCC = multiple version concurrent control å¤šç‰ˆæœ¬å¹¶å‘æŽ§åˆ¶
    - ç›®çš„ï¼šé«˜å¹¶å‘åœºæ™¯ä¸‹ï¼Œé”çš„æ€§èƒ½å·®ï¼ŒMVCC å¯ä»¥é¿å…è¯»å†™é˜»å¡ž
    - **DB_ROW_IDï¼šéšè—åˆ—**
    - **DB_ROLL_PIRï¼šå›žæ»šæŒ‡é’ˆ**ï¼ŒæŒ‡å‘è¿™æ¡è®°å½•çš„ä¸Šä¸€ç‰ˆæœ¬
      - ç‰ˆæœ¬é“¾å­˜å‚¨åœ¨ undo log ä¸­
    - **DB_TRX_IDï¼šæœ€è¿‘ä¿®æ”¹çš„äº‹åŠ¡ id**
  - **ç†è®ºä¸Š RR å­˜åœ¨å¹»è¯»ï¼Œä½† MySQL ä¸´é”®é” next key lock è§£å†³äº†å¹»è¯»é—®é¢˜**
  - **é—®ï¼šå¦‚ä½•ä¿è¯ REPEATABLE READ çº§åˆ«ç»å¯¹ä¸äº§â½£å¹»è¯»ï¼Ÿ**
    - **ç­”**ï¼šåœ¨ SQL ä¸­åŠ â¼Š** for update (æŽ’ä»–é”) æˆ– lock in share mode (å…±äº«é”)**è¯­å¥å®žçŽ°ã€‚å°±æ˜¯é”ä½äº†å¯èƒ½é€ æˆå¹»è¯»çš„æ•°æ®ï¼Œé˜»â½Œæ•°æ®çš„å†™â¼Šæ“ä½œã€‚
- Serializable ä¸²è¡ŒåŒ–
  - åŠ é”è¯»ï¼šåœ¨æ¯ä¸€è¡Œæ•°æ®ä¸Šéƒ½åŠ é”ï¼Œå¯¼è‡´å¤§é‡çš„è¶…æ—¶å’Œé”äº‰ç”¨çš„é—®é¢˜ï¼Œåªæœ‰åœ¨éžå¸¸éœ€è¦ç¡®ä¿æ•°æ®ä¸€è‡´æ€§å¹¶ä¸”å¯ä»¥æŽ¥å—æ²¡æœ‰å¹¶å‘çš„æƒ…å†µä¸‹ï¼Œæ‰è€ƒè™‘é‡‡ç”¨è¯¥çº§åˆ«

#### äº‹åŠ¡ç‰¹æ€§

- Atomic åŽŸå­æ€§
  - ä¸€ä¸ªäº‹åŠ¡è¦ä¹ˆå…¨éƒ¨æäº¤ï¼Œè¦ä¹ˆå…¨éƒ¨å›žæ»š
  - é€šè¿‡ **undo log è®°å½•é€»è¾‘æ—¥å¿—**ï¼Œå›žæ»šæ—¶é€šè¿‡é€†æ“ä½œæ¥æ¢å¤
    - ä¿å­˜ä½ç½®ï¼šsystem tablespace(mysql5.7) æˆ– undo tablespaces(mysql8.0)
- Consistent ä¸€è‡´æ€§
  - äº‹åŠ¡æ€»æ˜¯ç”±ä¸€ç§çŠ¶æ€è½¬æ¢ä¸ºå¦ä¸€ç§çŠ¶æ€ï¼Œè€Œä¸ä¼šåœç•™åœ¨æ‰§è¡Œä¸­çš„æŸä¸ªçŠ¶æ€
  - Aã€Iã€D åŒæ—¶ä½œç”¨ï¼Œä¿è¯äº† Cï¼ˆä¸€è‡´æ€§ï¼‰
- Isolate éš”ç¦»æ€§
  - **è¯»å†™éš”ç¦»ï¼šMVCCï¼Œundo log ç‰ˆæœ¬é“¾ï¼ˆä»Žæœ€æ–°è®°å½•ä¾æ¬¡æŒ‡å‘æœ€æ—§è®°å½•çš„é“¾è¡¨ï¼‰ï¼ŒReadView åœ¨ RC å’Œ RR çš„ä¸åŒ**
  - å†™å†™éš”ç¦»ï¼šé”
- Ddurable æŒä¹…æ€§
  - äº‹åŠ¡åªè¦æäº¤äº†ï¼Œé‚£ä¹ˆæ•°æ®åº“ä¸­çš„æ•°æ®ä¹Ÿæ°¸ä¹…çš„å‘ç”Ÿäº†å˜åŒ–
  - é€šè¿‡ **redo log å¢žé‡**è®°å½•æ•°æ®é¡µçš„**ç‰©ç†**å˜åŒ–ï¼Œ**æœåŠ¡å®•æœºæ—¶ç”¨æ¥åŒæ­¥æ•°æ®ï¼Œå…ˆå†™æ—¥å¿—ï¼Œå†å†™ç£ç›˜**
  - æ—¥å¿—æ–‡ä»¶ï¼šã€ib_logfile0ã€‘ã€ib_logfile1ã€‘
  - æ—¥å¿—ç¼“å†²ï¼šinnodb_logh_buffer_size
  - å¼ºåˆ·ï¼šfsync()

### delete/truncate/drop çš„åŒºåˆ«ï¼Ÿ

- DELETE åˆ é™¤è¡¨ä¸­çš„è¡Œï¼Œä¸åˆ é™¤è¡¨æœ¬èº«
  - é¡¹ç›®ä¸­ä¸€èˆ¬ä½¿ç”¨é€»è¾‘åˆ é™¤ï¼Œå¢žåŠ  deleted å­—æ®µ
- TRUNCATE åˆ é™¤è¡¨ï¼Œå†åˆ›å»ºä¸€ä¸ªç©ºè¡¨
  - åˆå§‹åŒ–æ•°æ®
- DROP åˆ é™¤è¡¨

### æ•°æ®è¿ç§»

```java
mysqldump -u root -p db_name > 'Desktop/test.sql'
```

1. åŠ å¿«å¯¼å…¥é€Ÿåº¦

- å…³é—­å”¯ä¸€æ€§æ£€æŸ¥
- å¼€å¯ extended-insert å°†å¤šè¡Œåˆå¹¶ä¸ºä¸€ä¸ª INSERT è¯­å¥
- å…³é—­ binlogï¼Œè¿ç§»åŽå†å¼€å¯
- è°ƒæ•´ redolog æ—¶æœº

2. æ•°æ®æ ¡éªŒ
   1. å…ˆè¯» binlogï¼Œä¸ä¸€è‡´å†è¯»æºè¡¨ï¼Œä»¥æºè¡¨ä¸ºå‡†ã€‚
   2. å…ˆè¯»ä»Žåº“ï¼Œä¸ä¸€è‡´å†è¯»ä¸»åº“ï¼Œä»¥ä¸»åº“ä¸ºå‡†ã€‚
3. å¢žé‡åŒæ­¥æ•°æ®

- æ—¶é—´æˆ³
- binlog

### éš¾ç‚¹

Situationï¼šå‡ºçŽ°ç¦»èŒäººå‘˜è¢«ä¼ä¸šå¾®ä¿¡æœºå™¨äºº at çš„é—®é¢˜
Action-Wrongï¼šåœ¨è§¦å‘æœºå™¨äººæ¶ˆæ¯çš„æ—¶å€™æŸ¥è¯¢äººå‘˜æœ€æ–°çŠ¶æ€æ˜¯å¦ç¦»èŒï¼Œç¦»èŒåˆ™ä¸ atã€æ²»æ ‡ä¸æ²»æœ¬ã€‘
Taskï¼šç”¨æˆ·ç™»å½•ä»¥åŽéœ€è¦æ›´æ–°å‡ ä¸ªå­—æ®µçš„æ•°æ®ï¼Œå¦‚æžœå­˜åœ¨åˆ™æ›´æ–°ï¼Œä¸å­˜åœ¨åˆ™æ’å…¥ï¼Œæœ€æ–°æ•°æ®æ¥è‡ªäºŽå…¶ä»–éƒ¨é—¨å‘˜å·¥è´¦æˆ·ä¸­å¿ƒçš„å¾®æœåŠ¡ï¼Œï¼ˆç»è¿‡é€‚é…å™¨è®¾è®¡æ¨¡å¼ï¼Œæœ‰äº›å­—æ®µéœ€è¦è½¬åŒ–ï¼Œæœ‰äº›å­—æ®µç›´æŽ¥å¤åˆ¶ï¼Œæ¯”å¦‚ç¦»èŒæ—¶é—´ä¸º null ä»£è¡¨æœªç¦»èŒï¼Œæ›´æ–°ä¸º 0ï¼‰ï¼Œä¿¡æ¯éœ€è¦é€šè¿‡ç”¨æˆ· id æŸ¥è¯¢ï¼Œä¸€ä¸ªæŽ¥å£åªèƒ½æŸ¥è¯¢ 100 æ¡ã€‚
Action-Wrongï¼šä¼šæœ‰æ­»é”çš„å¯èƒ½æ€§ï¼šå¹¶å‘+ä¸šåŠ¡è€—æ—¶ = **ä¸¤ä¸ªä¸´é”®é”å‘ç”Ÿæ­»é”**

```sql
BEGIN;
// for update ä¸ºæ‚²è§‚é”
SELECT * FROM biz WHERE id = ? FOR UPDATE
// ä¸­é—´æœ‰å¾ˆå¤šä¸šåŠ¡æ“ä½œ
INSERT INTO biz(id, data) VALUE(?, ?);
COMMIT;
```

Actionï¼š

1. âœ“ ä¸ç®¡æœ‰æ²¡æœ‰æ•°æ®ï¼Œç›´æŽ¥æ’å…¥ï¼Œè§„é¿æ­»é”ã€‚
2. è°ƒæ•´éš”ç¦»çº§åˆ«ä¸º RCï¼ˆå½±å“å¤ªå¤§ï¼‰
3. **ä¹è§‚é”**ï¼ˆæ•°æ®åº“çš„ CAS æ“ä½œï¼Œå¼•å…¥ version åˆ—ï¼Œæˆ–è€…ä½¿ç”¨ update_time æ¥ç¡®ä¿æ•°æ®æ²¡æœ‰å‘ç”Ÿå˜æ›´ï¼‰

Result
è§£å†³äº†é—®é¢˜ï¼ŒåŒæ—¶æœç»äº†æ­»é”çš„å‘ç”Ÿï¼Œå¦‚æžœä½¿ç”¨ä¹è§‚é”è¿˜èƒ½æå‡æ€§èƒ½ã€‚


---

> ä½œè€…: éƒ½å°†ä¼š  
> URL: https://leni.fun/mysql/  


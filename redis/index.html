<!doctype html><html itemscope itemtype=http://schema.org/WebPage lang=zh-CN><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1,maximum-scale=2"><meta name=robots content="noodp"><title>🚩Redis -</title><meta name=author content="都将会"><meta name=author-link content><meta name=description content="“”"><meta name=keywords content="Redis,interview,面试"><meta itemprop=name content="🚩Redis"><meta itemprop=description content="“”"><meta itemprop=datePublished content="2023-01-01T08:08:08+08:00"><meta itemprop=dateModified content="2023-01-01T08:08:08+08:00"><meta itemprop=wordCount content="4495"><meta itemprop=image content="https://leni.fun/images/avatar.jpg"><meta itemprop=keywords content="Redis,"><meta property="og:title" content="🚩Redis"><meta property="og:description" content="“”"><meta property="og:type" content="article"><meta property="og:url" content="https://leni.fun/redis/"><meta property="og:image" content="https://leni.fun/images/avatar.jpg"><meta property="article:section" content="posts"><meta property="article:published_time" content="2023-01-01T08:08:08+08:00"><meta property="article:modified_time" content="2023-01-01T08:08:08+08:00"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://leni.fun/images/avatar.jpg"><meta name=twitter:title content="🚩Redis"><meta name=twitter:description content="“”"><meta name=application-name content="都将会的 APP"><meta name=apple-mobile-web-app-title content="都将会的 APP"><meta name=theme-color data-light=#f8f8f8 data-dark=#252627 content="#f8f8f8"><meta name=msapplication-TileColor content="#da532c"><link rel="shortcut icon" type=image/x-icon href=/favicon.ico><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=mask-icon href=/safari-pinned-tab.svg color=#5bbad5><link rel=manifest href=/site.webmanifest><link rel=canonical href=https://leni.fun/redis/><link rel=prev href=https://leni.fun/%E5%A4%9A%E7%BA%BF%E7%A8%8B%E9%9D%A2%E8%AF%95%E9%A2%98/><link rel=next href=https://leni.fun/os/><link rel=stylesheet href=/css/style.min.css><link rel=stylesheet href=/lib/fontawesome-free/all.min.css><link rel=stylesheet href=/lib/animate/animate.min.css><script type=application/ld+json>{"@context":"http://schema.org","@type":"BlogPosting","headline":"🚩Redis","inLanguage":"zh-CN","mainEntityOfPage":{"@type":"WebPage","@id":"https:\/\/leni.fun\/redis\/"},"genre":"posts","keywords":"Redis","wordcount":4495,"url":"https:\/\/leni.fun\/redis\/","datePublished":"2023-01-01T08:08:08+08:00","dateModified":"2023-01-01T08:08:08+08:00","publisher":{"@type":"Organization","name":""},"author":{"@type":"Person","name":"都将会"},"description":"“”"}</script></head><body data-header-desktop=sticky data-header-mobile=auto><script>(window.localStorage?.getItem("theme")?localStorage.getItem("theme")==="dark":"dark"==="auto"?window.matchMedia("(prefers-color-scheme: dark)").matches:"dark"==="dark")&&document.body.setAttribute("data-theme","dark")</script><div class=wrapper data-page-style=normal><header class="desktop animate__faster" id=header-desktop><div class=header-wrapper data-github-corner=left><div class=header-title><a href=/ title><img loading=lazy src=/images/icon.png srcset="/images/icon.png, /images/icon.png 1.5x, /images/icon.png 2x" sizes=auto data-title=/images/icon.png data-alt=/images/icon.png class=logo style="background:url(/svg/loading.min.svg)no-repeat 50%" onload='this.title=this.dataset.title,this.alt=this.dataset.alt;for(const e of["style","data-title","data-alt","onerror","onload"])this.removeAttribute(e);this.dataset.lazyloaded=""' onerror='this.title=this.dataset.title,this.alt=this.dataset.alt;for(const e of["style","data-title","data-alt","onerror","onload"])this.removeAttribute(e)'><span class=header-title-text>都将会</span></a><span id=typeit-header-subtitle-desktop class="typeit header-subtitle"></span></div><nav><ul class=menu><li class="menu-item has-children"><a class=menu-link href=/posts/><i class="fa-solid fa-archive fa-fw fa-sm" aria-hidden=true></i> 技术</a><i class="dropdown-icon fa-solid fa-chevron-down" aria-hidden=true></i><ul class=sub-menu><li class=menu-item><a class=menu-link href=/categories/><i class="fa-solid fa-th fa-fw fa-sm" aria-hidden=true></i> 分类</a></li><li class=menu-item><a class=menu-link href=/tags/><i class="fa-solid fa-tags fa-fw fa-sm" aria-hidden=true></i> 标签</a></li></ul></li><li class=menu-item><a class=menu-link href=/life/><i class="fa-solid fa-camera-alt fa-fw fa-sm" aria-hidden=true></i> 生活</a></li><li class=menu-item><a class=menu-link href=/friends/><i class="fa-solid fa-users fa-fw fa-sm" aria-hidden=true></i> 友链</a></li><li class=menu-item><a class=menu-link href=/about/><i class="fa-solid fa-info-circle fa-fw fa-sm" aria-hidden=true></i> 关于</a></li><li class="menu-item delimiter"></li><li class="menu-item search" id=search-desktop><input type=text placeholder=关键词搜索 id=search-input-desktop>
<a href=javascript:void(0); class="search-button search-toggle" id=search-toggle-desktop title=搜索><i class="fa-solid fa-search fa-fw" aria-hidden=true></i></a>
<a href=javascript:void(0); class="search-button search-clear" id=search-clear-desktop title=清空><i class="fa-solid fa-times-circle fa-fw" aria-hidden=true></i></a>
<span class="search-button search-loading" id=search-loading-desktop><i class="fa-solid fa-spinner fa-fw fa-spin" aria-hidden=true></i></span></li><li class="menu-item theme-switch" title=切换主题><i class="fa-solid fa-adjust fa-fw" aria-hidden=true></i></li></ul></nav></div></header><header class="mobile animate__faster" id=header-mobile><div class=header-container><div class=header-wrapper><div class=header-title><a href=/ title><img loading=lazy src=/images/icon.png srcset="/images/icon.png, /images/icon.png 1.5x, /images/icon.png 2x" sizes=auto data-title=/images/icon.png data-alt=/images/icon.png class=logo style="background:url(/svg/loading.min.svg)no-repeat 50%" onload='this.title=this.dataset.title,this.alt=this.dataset.alt;for(const e of["style","data-title","data-alt","onerror","onload"])this.removeAttribute(e);this.dataset.lazyloaded=""' onerror='this.title=this.dataset.title,this.alt=this.dataset.alt;for(const e of["style","data-title","data-alt","onerror","onload"])this.removeAttribute(e)'><span class=header-title-text>都将会</span></a><span id=typeit-header-subtitle-mobile class="typeit header-subtitle"></span></div><div class=menu-toggle id=menu-toggle-mobile><span></span><span></span><span></span></div></div><nav><ul class=menu id=menu-mobile><li class=search-wrapper><div class="search mobile" id=search-mobile><input type=text placeholder=关键词搜索 id=search-input-mobile>
<a href=javascript:void(0); class="search-button search-toggle" id=search-toggle-mobile title=搜索><i class="fa-solid fa-search fa-fw" aria-hidden=true></i></a>
<a href=javascript:void(0); class="search-button search-clear" id=search-clear-mobile title=清空><i class="fa-solid fa-times-circle fa-fw" aria-hidden=true></i></a>
<span class="search-button search-loading" id=search-loading-mobile><i class="fa-solid fa-spinner fa-fw fa-spin" aria-hidden=true></i></span></div><a href=javascript:void(0); class=search-cancel id=search-cancel-mobile>取消</a></li><li class=menu-item><span class=nested-item><a class=menu-link href=/posts/><i class="fa-solid fa-archive fa-fw fa-sm" aria-hidden=true></i> 技术</a>
<i class="dropdown-icon fa-solid fa-chevron-right" aria-hidden=true></i></span><ul class=sub-menu><li class=menu-item><a class=menu-link href=/categories/><i class="fa-solid fa-th fa-fw fa-sm" aria-hidden=true></i> 分类</a></li><li class=menu-item><a class=menu-link href=/tags/><i class="fa-solid fa-tags fa-fw fa-sm" aria-hidden=true></i> 标签</a></li></ul></li><li class=menu-item><a class=menu-link href=/life/><i class="fa-solid fa-camera-alt fa-fw fa-sm" aria-hidden=true></i> 生活</a></li><li class=menu-item><a class=menu-link href=/friends/><i class="fa-solid fa-users fa-fw fa-sm" aria-hidden=true></i> 友链</a></li><li class=menu-item><a class=menu-link href=/about/><i class="fa-solid fa-info-circle fa-fw fa-sm" aria-hidden=true></i> 关于</a></li><li class="menu-item menu-system"><span class="menu-system-item theme-switch" title=切换主题><i class="fa-solid fa-adjust fa-fw" aria-hidden=true></i></span></li></ul></nav></div></header><div class="search-dropdown desktop"><div id=search-dropdown-desktop></div></div><div class="search-dropdown mobile"><div id=search-dropdown-mobile></div></div><nav aria-label=breadcrumb class="breadcrumb-container sticky"><ol class=breadcrumb><li class=breadcrumb-item><a href=/ title>主页</a></li><li class=breadcrumb-item><a href=/posts/ title=Posts>Posts</a></li><li class="breadcrumb-item active" aria-current=page>🚩Redis</li></ol></nav><main class=container><aside class=toc id=toc-auto><h2 class=toc-title>目录&nbsp;<i class="toc-icon fa-solid fa-angle-down fa-fw" aria-hidden=true></i></h2><div class=toc-content id=toc-content-auto></div></aside><aside class=aside-custom></aside><article class="page single"><div class=header><h1 class="single-title animate__animated animate__flipInX"><span>🚩Redis</span></h1></div><div class=post-meta><div class=post-meta-line><span class=post-author><span class=author><img loading=lazy src=/images/avatar.jpg srcset="/images/avatar.jpg, /images/avatar.jpg 1.5x, /images/avatar.jpg 2x" sizes=auto data-title=都将会 data-alt=都将会 class=avatar style="background:url(/svg/loading.min.svg)no-repeat 50%" onload='this.title=this.dataset.title,this.alt=this.dataset.alt;for(const e of["style","data-title","data-alt","onerror","onload"])this.removeAttribute(e);this.dataset.lazyloaded=""' onerror='this.title=this.dataset.title,this.alt=this.dataset.alt;for(const e of["style","data-title","data-alt","onerror","onload"])this.removeAttribute(e)'>&nbsp;都将会</span></span>
<span class=post-category>收录于 <a href=/categories/interview/><i class="fa-regular fa-folder fa-fw" aria-hidden=true></i> interview</a></span></div><div class=post-meta-line><span title="发布于 2023-01-01 08:08:08"><i class="fa-regular fa-calendar-alt fa-fw me-1" aria-hidden=true></i><time datetime=2023-01-01>2023-01-01</time></span>&nbsp;<span title="更新于 2023-01-01 08:08:08"><i class="fa-regular fa-edit fa-fw me-1" aria-hidden=true></i><time datetime=2023-01-01>2023-01-01</time></span>&nbsp;<span><i class="fa-solid fa-pencil-alt fa-fw me-1" aria-hidden=true></i>约 4495 字</span>&nbsp;<span><i class="fa-regular fa-clock fa-fw me-1" aria-hidden=true></i>预计阅读 9 分钟</span>&nbsp;<span id=busuanzi_container_page_pv class="busuanzi_visitors comment-visitors" data-flag-title=🚩Redis>
<i class="fa-regular fa-eye fa-fw me-1" aria-hidden=true></i><span id=busuanzi_value_page_pv>-</span>&nbsp;次阅读
</span>&nbsp;</div></div><div class="details toc" id=toc-static data-kept=false><div class="details-summary toc-title"><span>目录</span>
<span><i class="details-icon fa-solid fa-angle-right" aria-hidden=true></i></span></div><div class="details-content toc-content" id=toc-content-static><nav id=TableOfContents><ul><li><ul><li><a href=#五种基础数据结构>五种基础数据结构？</a></li><li><a href=#如何保证mysql和redis的数据一致性>🌟如何保证MySQL和Redis的数据一致性？</a><ul><li><a href=#更新导致不一致>更新导致不一致</a></li><li><a href=#失效导致不一致>失效导致不一致</a></li></ul></li><li><a href=#两种持久化方式>两种持久化方式？</a></li><li><a href=#过期key的删除策略>过期key的删除策略？</a></li><li><a href=#哨兵sentinel---高可用>哨兵Sentinel - 高可用</a><ul><li><a href=#自动选主>自动选主</a></li></ul></li><li><a href=#sentinel-哨兵>Sentinel 哨兵</a><ul><li><a href=#脑裂>脑裂</a></li></ul></li><li><a href=#回收淘汰策略如何保证redis里存储的都是热点数据>回收（淘汰）策略？如何保证Redis里存储的都是热点数据？</a></li><li><a href=#什么是穿透击穿与雪崩>🌟什么是穿透、击穿与雪崩？</a><ul><li><a href=#穿透>穿透</a></li><li><a href=#击穿>击穿</a></li><li><a href=#雪崩>雪崩</a></li><li><a href=#击穿和穿透的本质区别是什么>击穿和穿透的本质区别是什么？</a></li></ul></li><li><a href=#redis-集群---主从复制>Redis 集群 - 主从复制？</a><ul><li><a href=#概念>概念</a></li><li><a href=#使用>使用</a></li></ul></li><li><a href=#redis-集群与高可用>Redis 集群与高可用</a></li><li><a href=#redis-单线程吗为什么快>🌟Redis 单线程吗，为什么快？</a></li><li><a href=#spring-cache-和-redis-的区别>Spring Cache 和 Redis 的区别？</a></li><li><a href=#redis-的使用>Redis 的使用？</a><ul><li><a href=#分布式锁>分布式锁</a></li><li><a href=#redis如何设置密码和验证密码>Redis如何设置密码和验证密码？</a></li><li><a href=#redis-事务>Redis 事务</a></li><li><a href=#q假如-redis-里面有-1-亿个-key其中有-10w-个-key-是以某个固定的已知的前缀开头的如果将它们全部找出来><strong>Q：假如 Redis 里面有 1 亿个 key，其中有 10w</strong> 个 key 是以某个固定的已知的前缀开头的，如果将它们全部找出来？</a></li></ul></li><li><a href=#pipeline有什么好处>Pipeline有什么好处？</a></li><li><a href=#q新创建的用户没有权限信息redis-查询权限为空如何优化>Q：新创建的用户没有权限信息，Redis 查询权限为空，如何优化？</a></li><li><a href=#用-lua-脚本结合-redission-springsecurity实现限流>用 lua 脚本结合 Redission 、SpringSecurity实现限流？</a></li></ul></li></ul></nav></div></div><div class=content id=content><h3 id=五种基础数据结构>五种基础数据结构？</h3><ol><li>string：最大存储512M</li><li>hash：hget、hmget、hset、hmset</li><li>list<ol><li>可以作为队列，<strong>rpush 生产消息，lpop消费消息</strong>，当lpop没有消息时，要适当sleep一会再重试，或者使用<strong>blpop，它在没有消息的时候会阻塞住直到消息到来</strong>。</li><li>如果想生产一次消费多次，就使用 pub/sub 主题订阅者模式，可以实现1：N的消息队列。但是消费者下线的情况下，生产的消息会丢失，就需要采用更专业的MQ，如RabbitMQ。</li></ol></li><li>set</li><li>sorted set 每个成员会有一个分数与之关联<ol><li>可以实现延时队列。拿<strong>时间戳作为 score</strong>，<strong>消息内容作为key调用 zadd来生产消息</strong>，消费者用 <strong>zrangebyscore获取N秒之前的数据轮询进行处理。</strong></li></ol></li></ol><h3 id=如何保证mysql和redis的数据一致性>🌟如何保证MySQL和Redis的数据一致性？</h3><h4 id=更新导致不一致>更新导致不一致</h4><ol><li>先删缓存，再更新数据库，延迟双删。</li><li>先更新数据库，再删缓存。（推荐，因为读操作的速度远快于写操作）</li></ol><h4 id=失效导致不一致>失效导致不一致</h4><ol><li>强一致性方案-分布式锁<ol><li>先拿 <strong>setnx来争抢锁</strong>，抢到之后，用<strong>expire给锁加一个过期时间</strong>防止忘记释放引发死锁。set指令有复杂的参数，是把setnx和expire合成一条指令来用。</li><li><strong>任意时刻只能有一个客户端持有锁</strong>，**加锁和解锁必须是同一个客户端，客户端自己加的锁只能自己去解。**只要大多数 Redis 节点正常，客户端就能正常使用锁。</li><li>底层 <strong>setnx 通过 lua 脚本实现，保证原子性</strong>。</li><li>redisson 实现的分布式锁对同一线程可重入</li><li>RedLock 红锁：在多个实例上创建锁，性能差，违背了 Redis 的 AP 思想，不如使用 zookeeper 实现强一致性的 CP 系统</li><li>WatchDog 看门狗：给持有锁的线程续期（默认 10s）</li></ol></li><li>高可用方案-异步通知：<strong>将binlog日志采集发送到MQ队列里面，然后通过ACK机制确认处理这条更新消息，删除缓存</strong>，保证数据缓存一致性。【canal 伪装从节点，订阅binlog】</li></ol><h3 id=两种持久化方式>两种持久化方式？</h3><ol><li>RDB（Redis DataBase）：用数据集<strong>快照</strong>的方式半持久化（高效，持久化之间记录会丢失）</li><li>AOF（Append-Only File）：所有的命令行记录以 redis 命令请求协议的格式完全持久化存储保存为 aof 文件（文件大、安全）</li></ol><p>备份：</p><ul><li>save可以在 redis 数据目录生成数据文件 <strong>dump.rdb</strong></li><li>bgsave 用子线程异步执行，&ldquo;save 300 10&rdquo; 表示 300s 内有 10 个 key 被修改就执行 bgsave</li><li><strong>appendonly 默认关闭</strong>，若配置为 yes，则以AOF方式备份数据，在特定的时候执行追加命令</li><li>appendfsync everysec 每秒刷盘</li><li>bgrewriteaof 重写优化 aof 文件</li></ul><p>恢复：重启服务，自动加载redis数据目录的 dump.rdb</p><h3 id=过期key的删除策略>过期key的删除策略？</h3><p>两者配合使用：</p><ol><li>定期：读取配置server.hz的值，默认为10</li><li>惰性：get key时，如果过期就删除，如果没过期就返回</li></ol><h3 id=哨兵sentinel---高可用>哨兵Sentinel - 高可用</h3><p>通过心跳机制，每秒发送 ping 命令，检查 master 和 slave 是否按期工作，在 master 故障时，Sentinel 将一个 slave 提升为 master。</p><h4 id=自动选主>自动选主</h4><p>采用 <strong>Raft 共识</strong>算法，order by：</p><ol><li>断线时间越低</li><li>优先级越高 slave-priority</li><li>offset 越大</li><li>运行 id 越小</li></ol><p>Sentinel（哨兵）不提供读写服务，默认运行在 26379 端口，建议多个 sentinel 节点（参数：quorum）协作运行，通过投票的方式来避免误判：</p><ul><li>单个未响应，主观下线</li><li>多个未响应，客观下线</li></ul><h3 id=sentinel-哨兵>Sentinel 哨兵</h3><p>不提供读写服务，默认运行在 26379 端口上，当 master 节点出现故障时，Sentinel 会帮我们实现故障转移，<strong>自动</strong>选出一个 slave 升级为 master，确保 Redis 集群的可用性。</p><div class=highlight id=id-1><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>redis-server /path/to/sentinel.conf --sentinel</span></span></code></pre></td></tr></table></div></div><p>sentinel.conf</p><div class=highlight id=id-2><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl><span class=c1># 2 表示当两个哨兵认为 master 失效时才算失效</span>
</span></span><span class=line><span class=cl>sentinel monitor mymaster 127.0.0.1 <span class=m>6379</span> <span class=m>2</span>
</span></span><span class=line><span class=cl>sentinel down-after-milliseconds mymaster <span class=m>60000</span>
</span></span><span class=line><span class=cl>sentinel failover-timeout mymaster <span class=m>180000</span>
</span></span><span class=line><span class=cl><span class=c1># 主备切换时最多可以有 1 个 slave 同时对新的 master 进行同步</span>
</span></span><span class=line><span class=cl>sentinel parallel-sync mymaster <span class=m>1</span></span></span></code></pre></td></tr></table></div></div><h4 id=脑裂>脑裂</h4><p>Sentinel 与 master 失联，选出了新的 master&rsquo;，于是覆盖了旧 master 用户写入的数据。
解决方案：</p><ol><li>min-replicas-to-write = 1：至少 1 个 slave 成功写入</li><li>min-replicas-max-lay = 5：<strong>同步延迟</strong>不超过 5s</li></ol><h3 id=回收淘汰策略如何保证redis里存储的都是热点数据>回收（淘汰）策略？如何保证Redis里存储的都是热点数据？</h3><ul><li>no-enviction：不淘汰，满了就报错（默认）</li><li>volatile-：从已过期的数据集（<strong>server.db[i].expires</strong>）中挑选<ul><li>ttl：剩余 ttl 越短的优先淘汰</li><li>random：随机</li><li><strong>lru：最近最少使用【业务数据有冷热区分，且有置顶需求】</strong></li><li>lfu：最少频率使用</li></ul></li><li>allkeys-：针对全体<ul><li>random【无明显冷热数据区分时】</li><li>lru【业务数据有冷热区分】</li><li>lfu【短时高频】</li></ul></li></ul><h3 id=什么是穿透击穿与雪崩>🌟什么是穿透、击穿与雪崩？</h3><h4 id=穿透>穿透</h4><p>Q：大量并发查询<strong>不存在的 key</strong>，导致压力传到数据库。
A：让缓存能够区分 key 不存在和查询到一个空值</p><ol><li>缓存空值的（无效的） key，这样第一次不存在也会被加载并记录，下次拿到有这个key；</li><li>Bloom过滤【判断一个元素是否在一个集合中】或RoaringBitmap 判断 key 是否存在；（RoaringBitMap和bloom filter本质上都是使用bitmap进行存储【bitmap的底层数据结构就是0/1bit 的二进制数值，最大长度512Mb = 512 1024 * 1024 * 8 = 2^32】。但bloom filter 使用的是多个hash函数对存储数据进行映射存储，如果两个游戏appId经过hash映射后得出的数据一致，则判定两者重复，这中间有一定的误判率，所以为满足在该业务场景其空间开销会非常的大。而RoaringBitMap是直接将元数据进行存储压缩，其准确率是100%的）</li><li>完全以缓存为准，使用延迟异步加载。</li></ol><h4 id=击穿>击穿</h4><p>Q：某个<strong>key失效</strong>的时候，正好有大量并发请求访问这个key
A：key的更新操作添加全局<strong>互斥锁（强一致性，只有第一个请求拿到数据）</strong> 或 使用<strong>延迟异步加载（高可用）</strong>，或watchdog逻辑过期。</p><h4 id=雪崩>雪崩</h4><p>Q：<strong>某一时刻发生大规模的缓存失效</strong>的情况，会有大量的请求直接打到数据库，导致压力过大甚至宕机。
A：</p><ol><li>分散请求<ol><li>热数据分散到不同机器上；</li><li>限流</li></ol></li><li>控制过期时间：范围内随机；</li><li>多台机器做主从复制或多副本，实现高可用；</li></ol><h4 id=击穿和穿透的本质区别是什么>击穿和穿透的本质区别是什么？</h4><ul><li>穿透：【策略维度】查询的 key 不在缓存中，缓存没有起到缓冲的效果</li><li>击穿：【时间维度】查询的 key曾经有效，在失效的瞬时打击了数据库</li></ul><h3 id=redis-集群---主从复制>Redis 集群 - 主从复制？</h3><h4 id=概念>概念</h4><p>主节点写，从节点读。
RDB同步有两个参数：</p><ol><li><strong>replication id：标记数据集</strong></li><li><strong>offset：slave &lt; master 时需要更新</strong></li></ol><ul><li>全量同步：主节点执行 **bgsave 生成 dump.rdb **文件给 slave</li><li>增量同步：slave 重启时，获取相同 replication id 的 offset 之后的数据</li></ul><p>主从复制不要使用网状结构，<strong>使用单向链表结构，如 Master &lt;- slave1 &lt;- slave2 &lt;- slave3</strong>，更方便解决<strong>单点故障</strong>问题。
Redis 集群没有使用一致性 hash，而是引入了<strong>哈希槽</strong>概念，有 <strong>16384（2的14次）个哈希槽</strong>，每个key通过**CRC16（上限 2 的 16 次）**校验后对16384取模来决定放置哪个槽，集群的每个节点负责一部分hash槽。</p><h4 id=使用>使用</h4><p>使用 Docker Compose 工具来创建 Redis 集群容器</p><div class=highlight id=id-3><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>version</span><span class=p>:</span><span class=w> </span><span class=s1>&#39;3&#39;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>services</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>redis-7000</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>image</span><span class=p>:</span><span class=w> </span><span class=l>redis</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>command</span><span class=p>:</span><span class=w> </span><span class=l>redis-server /usr/local/etc/redis/redis.conf</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>ports</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=s2>&#34;7000:6379&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>volumes</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>./conf/redis-7000.conf:/usr/local/etc/redis/redis.conf</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>networks</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>redis-net</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>redis-7001</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>image</span><span class=p>:</span><span class=w> </span><span class=l>redis</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>command</span><span class=p>:</span><span class=w> </span><span class=l>redis-server /usr/local/etc/redis/redis.conf</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>ports</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=s2>&#34;7001:6379&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>volumes</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>./conf/redis-7001.conf:/usr/local/etc/redis/redis.conf</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>networks</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>redis-net</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>redis-7002</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>image</span><span class=p>:</span><span class=w> </span><span class=l>redis</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>command</span><span class=p>:</span><span class=w> </span><span class=l>redis-server /usr/local/etc/redis/redis.conf</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>ports</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=s2>&#34;7002:6379&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>volumes</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>./conf/redis-7002.conf:/usr/local/etc/redis/redis.conf</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>networks</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>redis-net</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>networks</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=l>redis-net:</span></span></span></code></pre></td></tr></table></div></div><p>该配置文件定义了三个 Redis 节点，每个节点监听不同的端口，使用不同的配置文件。可以使用 Docker Compose 工具来启动 Redis 集群容器： <code>docker-compose up -d</code></p><h3 id=redis-集群与高可用>Redis 集群与高可用</h3><ol><li>Redis Sentinal 着眼于高可用，在 master 宕机时会自动将 slave 提升位 master，继续提供服务；</li><li>Redis Cluster 着眼于扩展性，在单个 redis 内存不足时，使用 Cluster 进行分片存储。</li></ol><div class=highlight id=id-4><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl># 从节点只读、异步复制
</span></span><span class=line><span class=cl>SLAVEOF 127.0.0.1 6379
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl># 主从切换基于 raft 协议,两种启动方式
</span></span><span class=line><span class=cl>redis-sentinel sentinel.conf
</span></span><span class=line><span class=cl>redis-server redis.conf --sentinel</span></span></code></pre></td></tr></table></div></div><p>sentinel.conf 配置：</p><div class=highlight id=id-5><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>sentinel monitor mymaster 127.0.0.1 6379 2
</span></span><span class=line><span class=cl>sentinel down-after-milliseconds mymaster 60000
</span></span><span class=line><span class=cl>sentinel failover-timeout mymaster 180000
</span></span><span class=line><span class=cl>sentinel parallel-syncs mymaster 1
</span></span><span class=line><span class=cl># 数据分片
</span></span><span class=line><span class=cl>cluster-enabled yes</span></span></code></pre></td></tr></table></div></div><p>注意：</p><ol><li>节点间使用 gossip 通信，规模&lt;1000</li><li>默认所有槽位可用，才提供服务</li><li>一般会配合主从模式使用</li></ol><h3 id=redis-单线程吗为什么快>🌟Redis 单线程吗，为什么快？</h3><p><strong>Redis 网络模型 = IO 多路复用+事件派发</strong>（接收网络请求，Redis6 之后命令的<strong>转换采用多线程</strong>，执行采用单线程）
<strong>内存处理线程是单线程，纯内存操作，避免上下文切换，保证了高性能</strong>，也不会产生现成安全问题。
使用了 I/O 多路复用模型，是非阻塞 IO，利用<strong>单线程同时监听多个 socket</strong>，在某个 socket 可读、可写时得到通知，<strong>对就绪的 socket 调用 recvfrom，避免无效等待，充分利用 CPU</strong>。
<strong>select 和 poll 只通知有某个 socket 就绪（不知道是哪个），需要遍历确定具体的 socket，而 epoll 通知并把已就绪的 socket 写入用户空间</strong>。</p><h3 id=spring-cache-和-redis-的区别>Spring Cache 和 Redis 的区别？</h3><ol><li><strong>Spring cache是代码级的缓存</strong>，一般是使用一个 ConcurrentMap，也就是说实际上还是是使用JVM的内存来缓存对象的，这势必会造成大量的内存消耗。但好处是显然的：使用方便。</li><li><strong>Redis 是内存级的缓存</strong>。它是使用单纯的内存来进行缓存。</li><li>集群环境下，每台服务器的spring cache是不同步的，这样会出问题的，<strong>spring cache只适合单机环境</strong>。</li><li>Redis是设置单独的缓存服务器，所有集群服务器统一访问redis，不会出现缓存不同步的情况。</li></ol><h3 id=redis-的使用>Redis 的使用？</h3><ul><li>❌Jedis：基于BIO，线程不安全，需要配置连接池管理连接</li><li>Lettuce：主流推荐的驱动，基于 Netty NIO，API 线程安全</li><li><strong>Redission</strong>：<strong>基于 Netty NIO</strong>，API 线程安全，大量丰富的分布式供能特性<ul><li><strong>JUC 的线程安全集合和工具的分布式版本</strong></li><li>分布式的基本数据类型和锁</li></ul></li></ul><h4 id=分布式锁>分布式锁</h4><div class=highlight id=id-6><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@Autowired</span>
</span></span><span class=line><span class=cl><span class=kd>private</span> <span class=n>RedissionClient</span> <span class=n>redissionClient</span><span class=o>;</span>
</span></span><span class=line><span class=cl><span class=kd>private</span> <span class=kd>final</span> <span class=n>String</span> <span class=n>KEY</span> <span class=o>=</span> <span class=s>&#34;KEY&#34;</span><span class=o>;</span>
</span></span><span class=line><span class=cl><span class=c1>// 行锁
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=n>RLock</span> <span class=n>rLock</span> <span class=o>=</span> <span class=n>redissionClient</span><span class=o>.</span><span class=na>getLock</span><span class=o>(</span><span class=n>KEY</span><span class=o>+</span><span class=s>&#34;:&#34;</span><span class=o>+</span><span class=n>id</span><span class=o>);</span>
</span></span><span class=line><span class=cl><span class=k>try</span><span class=o>{</span>
</span></span><span class=line><span class=cl>  <span class=c1>// 可以传超时时间，也有默认的
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=n>rLock</span><span class=o>.</span><span class=na>lock</span><span class=o>();</span>
</span></span><span class=line><span class=cl><span class=o>}</span><span class=k>finally</span><span class=o>{</span>
</span></span><span class=line><span class=cl>  <span class=n>rLock</span><span class=o>.</span><span class=na>unlock</span><span class=o>();</span>
</span></span><span class=line><span class=cl><span class=o>}</span></span></span></code></pre></td></tr></table></div></div><h4 id=redis如何设置密码和验证密码>Redis如何设置密码和验证密码？</h4><ul><li>设置密码：<code>config set requirepass 123456</code></li><li>认证密码：<code>auth 123456</code></li></ul><h4 id=redis-事务>Redis 事务</h4><ul><li>开启事务：multi</li><li>执行事务：exec</li><li>撤销事务：discard</li><li>实现乐观锁：watch</li></ul><h4 id=q假如-redis-里面有-1-亿个-key其中有-10w-个-key-是以某个固定的已知的前缀开头的如果将它们全部找出来><strong>Q：假如 Redis 里面有 1 亿个 key，其中有 10w</strong> 个 key 是以某个固定的已知的前缀开头的，如果将它们全部找出来？</h4><p>A：使用 keys 指令可以扫出指定模式的 key 列表。
Q2：如果这个 redis 正在给线上的业务提供服务，那使用 keys 指令会有什么问题？
A2：redis <strong>内存处理</strong>是单线程的。keys 指令会导致线程阻塞一段时间，线上服务会停顿，直到指令执行完毕，服务才能恢复。这个时候可以使用 scan 指令**，scan 指令可以无阻塞的提取出指定模式的key 列表，但是会有一定的重复概率，**在客户端做一次去重就可以了，但是整体所花费的时间会比直接用 keys 指令长。</p><h3 id=pipeline有什么好处>Pipeline有什么好处？</h3><p>将多次 IO 往返时间缩减为一次，前提是 pipeline 执行的指令之间没有因果相关性。</p><p>使用 redis-benchmark 进行压测的时候可以发现影响 redis 的 QPS 峰值的一个重要因素是 pipeline 批次指令的数目。</p><h3 id=q新创建的用户没有权限信息redis-查询权限为空如何优化>Q：新创建的用户没有权限信息，Redis 查询权限为空，如何优化？</h3><p>A：维护一张空用户表，在用户创建的时候插入，更新权限的时候移除，在查询权限缓存之前进行判断。</p><h3 id=用-lua-脚本结合-redission-springsecurity实现限流>用 lua 脚本结合 Redission 、SpringSecurity实现限流？</h3><div class=highlight id=id-7><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span><span class=lnt>57
</span><span class=lnt>58
</span><span class=lnt>59
</span><span class=lnt>60
</span><span class=lnt>61
</span><span class=lnt>62
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@Component</span>
</span></span><span class=line><span class=cl><span class=nd>@Order</span><span class=o>(</span><span class=n>1</span><span class=o>)</span> <span class=c1>// 定义过滤器的执行顺序
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>public</span> <span class=kd>class</span> <span class=nc>RedisRateLimitFilter</span> <span class=kd>extends</span> <span class=n>OncePerRequestFilter</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nd>@Autowired</span>
</span></span><span class=line><span class=cl>    <span class=kd>private</span> <span class=n>RedissonClient</span> <span class=n>redissonClient</span><span class=o>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nd>@Override</span>
</span></span><span class=line><span class=cl>    <span class=kd>protected</span> <span class=kt>void</span> <span class=nf>doFilterInternal</span><span class=o>(</span><span class=n>HttpServletRequest</span> <span class=n>request</span><span class=o>,</span> <span class=n>HttpServletResponse</span> <span class=n>response</span><span class=o>,</span> <span class=n>FilterChain</span> <span class=n>filterChain</span><span class=o>)</span>
</span></span><span class=line><span class=cl>            <span class=kd>throws</span> <span class=n>ServletException</span><span class=o>,</span> <span class=n>IOException</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1>// 获取请求的相关信息，例如客户端IP地址、接口路径等
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=n>String</span> <span class=n>clientIp</span> <span class=o>=</span> <span class=n>request</span><span class=o>.</span><span class=na>getRemoteAddr</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        <span class=n>String</span> <span class=n>path</span> <span class=o>=</span> <span class=n>request</span><span class=o>.</span><span class=na>getRequestURI</span><span class=o>();</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1>// 生成唯一的键，用于在Redis中标识此请求的限流记录
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=n>String</span> <span class=n>key</span> <span class=o>=</span> <span class=n>clientIp</span> <span class=o>+</span> <span class=s>&#34;:&#34;</span> <span class=o>+</span> <span class=n>path</span><span class=o>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1>// 执行Redis限流脚本
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=n>Object</span> <span class=n>result</span> <span class=o>=</span> <span class=n>redissonClient</span><span class=o>.</span><span class=na>getScript</span><span class=o>().</span><span class=na>eval</span><span class=o>(</span><span class=n>RScript</span><span class=o>.</span><span class=na>Mode</span><span class=o>.</span><span class=na>READ_ONLY</span><span class=o>,</span>
</span></span><span class=line><span class=cl>                <span class=s>&#34;local current = tonumber(redis.call(&#39;GET&#39;, KEYS[1]) or &#39;0&#39;)\n&#34;</span> <span class=o>+</span>
</span></span><span class=line><span class=cl>                <span class=s>&#34;local maxRequests = tonumber(ARGV[1])\n&#34;</span> <span class=o>+</span>
</span></span><span class=line><span class=cl>                <span class=s>&#34;local windowSize = tonumber(ARGV[2])\n&#34;</span> <span class=o>+</span>
</span></span><span class=line><span class=cl>                <span class=s>&#34;if current &lt; maxRequests then\n&#34;</span> <span class=o>+</span>
</span></span><span class=line><span class=cl>                <span class=s>&#34;    redis.call(&#39;INCR&#39;, KEYS[1])\n&#34;</span> <span class=o>+</span>
</span></span><span class=line><span class=cl>                <span class=s>&#34;    redis.call(&#39;EXPIRE&#39;, KEYS[1], windowSize)\n&#34;</span> <span class=o>+</span>
</span></span><span class=line><span class=cl>                <span class=s>&#34;    return true\n&#34;</span> <span class=o>+</span>
</span></span><span class=line><span class=cl>                <span class=s>&#34;else\n&#34;</span> <span class=o>+</span>
</span></span><span class=line><span class=cl>                <span class=s>&#34;    return false\n&#34;</span> <span class=o>+</span>
</span></span><span class=line><span class=cl>                <span class=s>&#34;end&#34;</span><span class=o>,</span> <span class=n>RScript</span><span class=o>.</span><span class=na>ReturnType</span><span class=o>.</span><span class=na>BOOLEAN</span><span class=o>,</span> <span class=k>new</span> <span class=n>String</span><span class=o>[]{</span><span class=n>key</span><span class=o>},</span> <span class=s>&#34;100&#34;</span><span class=o>,</span> <span class=s>&#34;60&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1>// 根据限流结果进行处理
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=k>if</span> <span class=o>(</span><span class=n>result</span> <span class=k>instanceof</span> <span class=n>Boolean</span> <span class=o>&amp;&amp;</span> <span class=o>(</span><span class=n>Boolean</span><span class=o>)</span> <span class=n>result</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=c1>// 请求通过限流检查，继续处理请求
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=n>filterChain</span><span class=o>.</span><span class=na>doFilter</span><span class=o>(</span><span class=n>request</span><span class=o>,</span> <span class=n>response</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span> <span class=k>else</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=c1>// 请求超出限流限制，返回限流错误状态
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=n>response</span><span class=o>.</span><span class=na>setStatus</span><span class=o>(</span><span class=n>HttpStatus</span><span class=o>.</span><span class=na>TOO_MANY_REQUESTS</span><span class=o>.</span><span class=na>value</span><span class=o>());</span>
</span></span><span class=line><span class=cl>            <span class=n>response</span><span class=o>.</span><span class=na>getWriter</span><span class=o>().</span><span class=na>write</span><span class=o>(</span><span class=s>&#34;Too many requests&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nd>@Configuration</span>
</span></span><span class=line><span class=cl><span class=nd>@EnableWebSecurity</span>
</span></span><span class=line><span class=cl><span class=kd>public</span> <span class=kd>class</span> <span class=nc>SecurityConfig</span> <span class=kd>extends</span> <span class=n>WebSecurityConfigurerAdapter</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=nd>@Autowired</span>
</span></span><span class=line><span class=cl>    <span class=kd>private</span> <span class=n>RedisRateLimitFilter</span> <span class=n>redisRateLimitFilter</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=nd>@Override</span>
</span></span><span class=line><span class=cl>    <span class=kd>protected</span> <span class=kt>void</span> <span class=nf>configure</span><span class=o>(</span><span class=n>HttpSecurity</span> <span class=n>http</span><span class=o>)</span> <span class=kd>throws</span> <span class=n>Exception</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>http</span>
</span></span><span class=line><span class=cl>            <span class=o>.</span><span class=na>addFilterBefore</span><span class=o>(</span><span class=n>redisRateLimitFilter</span><span class=o>,</span> <span class=n>UsernamePasswordAuthenticationFilter</span><span class=o>.</span><span class=na>class</span><span class=o>)</span>
</span></span><span class=line><span class=cl>            <span class=c1>// 配置其他的Spring Security规则
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=o>.</span><span class=na>authorizeRequests</span><span class=o>()</span>
</span></span><span class=line><span class=cl>            <span class=o>.</span><span class=na>antMatchers</span><span class=o>(</span><span class=s>&#34;/public/**&#34;</span><span class=o>).</span><span class=na>permitAll</span><span class=o>()</span>
</span></span><span class=line><span class=cl>            <span class=o>.</span><span class=na>anyRequest</span><span class=o>().</span><span class=na>authenticated</span><span class=o>()</span>
</span></span><span class=line><span class=cl>            <span class=o>.</span><span class=na>and</span><span class=o>()</span>
</span></span><span class=line><span class=cl>            <span class=o>.</span><span class=na>formLogin</span><span class=o>()</span>
</span></span><span class=line><span class=cl>            <span class=o>.</span><span class=na>and</span><span class=o>()</span>
</span></span><span class=line><span class=cl>            <span class=o>.</span><span class=na>httpBasic</span><span class=o>();</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span></span></span></code></pre></td></tr></table></div></div></div><div class=post-footer id=post-footer><div class=post-info><div class=post-info-line><div class=post-info-mod><span title="更新于 2023-01-01 08:08:08">更新于 2023-01-01&nbsp;</span></div><div class=post-info-license><span><a rel="license external nofollow noopener noreferrer" href=https://creativecommons.org/licenses/by-nc/4.0/ target=_blank>CC BY-NC 4.0</a></span></div></div><div class=post-info-line><div class=post-info-md></div><div class=post-info-share><span><a href=javascript:void(0); title="分享到 微博" data-sharer=weibo data-url=https://leni.fun/redis/ data-title=🚩Redis><i class="fa-brands fa-weibo fa-fw" aria-hidden=true></i></a></span></div></div></div><div class=post-info-more><section class=post-tags><i class="fa-solid fa-tags fa-fw me-1" aria-hidden=true></i><a href=/tags/redis/ class=post-tag>Redis</a></section><section><span><a href=javascript:void(0); onclick=window.history.back()>返回</a></span>&nbsp;|&nbsp;<span><a href=/>主页</a></span></section></div><div class=post-nav><a href=/%E5%A4%9A%E7%BA%BF%E7%A8%8B%E9%9D%A2%E8%AF%95%E9%A2%98/ class=post-nav-item rel=prev title=多线程面试题><i class="fa-solid fa-angle-left fa-fw" aria-hidden=true></i>多线程面试题</a>
<a href=/os/ class=post-nav-item rel=next title="🚩OS - 操作系统">🚩OS - 操作系统<i class="fa-solid fa-angle-right fa-fw" aria-hidden=true></i></a></div></div></article></main><footer class=footer><div class=footer-container><div class="footer-line copyright order-5" itemscope itemtype=http://schema.org/CreativeWork><i class="fa-regular fa-copyright fa-fw" aria-hidden=true></i>
<span itemprop=copyrightYear>2021 - 2023</span><span class=author itemprop=copyrightHolder>
<a href=/>都将会</a></span><span class="license footer-divider"><a rel="license external nofollow noopener noreferrer" href=https://beian.miit.gov.cn target=_blank>浙ICP备2023023782号</a></span></div><div class="footer-line statistics"><span class=site-time title=网站运行中……><i class="fa-solid fa-heartbeat fa-fw animate-icon" aria-hidden=true></i><span class="run-times ms-1">网站运行中……</span></span></div><div class="footer-line visitor order-4"><span id=busuanzi_container_site_uv title=总访客数><i class="fa-regular fa-user fa-fw" aria-hidden=true></i>&nbsp;<span id=busuanzi_value_site_uv><i class="fa-solid fa-spinner fa-spin fa-fw" aria-hidden=true></i></span></span><span id=busuanzi_container_site_pv class=footer-divider title=总访问量><i class="fa-regular fa-eye fa-fw" aria-hidden=true></i>&nbsp;<span id=busuanzi_value_site_pv><i class="fa-solid fa-spinner fa-spin fa-fw" aria-hidden=true></i></span></span></div></div></footer></div><div class=widgets><div class="fixed-buttons animate__faster d-none"><div class="fixed-button back-to-top" role=button aria-label=回到顶部><i class="fa-solid fa-arrow-up fa-fw" aria-hidden=true></i><span class=variant-numeric>0%</span></div></div><a href=https://github.com/hihihiman/hihihiman.github.io title=博客源码 target=_blank rel="external nofollow" class="github-corner left d-none-mobile"><svg viewBox="0 0 250 250" aria-hidden="true"><path d="M0 0 115 115h15l12 27L250 250V0z"/><path d="M128.3 109C113.8 99.7 119 89.6 119 89.6 122 82.7 120.5 78.6 120.5 78.6 119.2 72 123.4 76.3 123.4 76.3 127.3 80.9 125.5 87.3 125.5 87.3 122.9 97.6 130.6 101.9 134.4 103.2" fill="currentcolor" style="transform-origin:130px 106px" class="octo-arm"/><path d="M115 115C114.9 115.1 118.7 116.5 119.8 115.4l13.9-13.8C136.9 99.2 139.9 98.4 142.2 98.6 133.8 88 127.5 74.4 143.8 58 148.5 53.4 154 51.2 159.7 51 160.3 49.4 163.2 43.6 171.4 40.1 171.4 40.1 176.1 42.5 178.8 56.2 183.1 58.6 187.2 61.8 190.9 65.4 194.5 69 197.7 73.2 200.1 77.6 213.8 80.2 216.3 84.9 216.3 84.9 212.7 93.1 206.9 96 205.4 96.6 205.1 102.4 203 107.8 198.3 112.5 181.9 128.9 168.3 122.5 157.7 114.1 157.9 116.9 156.7 120.9 152.7 124.9L141 136.5C139.8 137.7 141.6 141.9 141.8 141.8z" fill="currentcolor" class="octo-body"/></svg></a><div id=mask></div><div class=reading-progress-bar style=left:0;bottom:0></div><noscript><div class=noscript-warning>FixIt 主题在启用 JavaScript 的情况下效果最佳。</div></noscript></div><link rel=stylesheet href=/lib/lightgallery/css/lightgallery-bundle.min.css><link rel=stylesheet href=/lib/katex/katex.min.css><link rel=stylesheet href=/lib/cookieconsent/cookieconsent.min.css><link rel=stylesheet href=/lib/pace/themes/pink/pace-theme-center-atom.css><script src=/lib/autocomplete/autocomplete.min.js defer></script><script src=/lib/fuse/fuse.min.js defer></script><script src=/lib/lightgallery/lightgallery.min.js defer></script><script src=/lib/lightgallery/plugins/thumbnail/lg-thumbnail.min.js defer></script><script src=/lib/lightgallery/plugins/zoom/lg-zoom.min.js defer></script><script src=/lib/sharer/sharer.min.js async defer></script><script src=/lib/typeit/index.umd.js defer></script><script src=/lib/katex/katex.min.js defer></script><script src=/lib/katex/auto-render.min.js defer></script><script src=/lib/katex/copy-tex.min.js defer></script><script src=/lib/katex/mhchem.min.js defer></script><script src=/lib/cookieconsent/cookieconsent.min.js defer></script><script src=/lib/pangu/pangu.min.js defer></script><script src=//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js async defer></script><script src=/lib/pace/pace.min.js async defer></script><script>window.config={autoBookmark:!0,code:{copyTitle:"复制到剪贴板",editLockTitle:"锁定可编辑代码块",editUnLockTitle:"解锁可编辑代码块",editable:!0,maxShownLines:1024},comment:{enable:!1},cookieconsent:{content:{dismiss:"同意",link:"了解更多",message:"本网站使用 Cookies 来改善您的浏览体验。"},enable:!0,palette:{button:{background:"#f0f0f0"},popup:{background:"#1aa3ff"}},theme:"edgeless"},data:{"typeit-header-subtitle-desktop":"的博客           ","typeit-header-subtitle-mobile":"的博客           "},enablePWA:!0,lightgallery:!0,math:{delimiters:[{display:!0,left:"$$",right:"$$"},{display:!0,left:"\\[",right:"\\]"},{display:!0,left:"\\begin{equation}",right:"\\end{equation}"},{display:!0,left:"\\begin{equation*}",right:"\\end{equation*}"},{display:!0,left:"\\begin{align}",right:"\\end{align}"},{display:!0,left:"\\begin{align*}",right:"\\end{align*}"},{display:!0,left:"\\begin{alignat}",right:"\\end{alignat}"},{display:!0,left:"\\begin{alignat*}",right:"\\end{alignat*}"},{display:!0,left:"\\begin{gather}",right:"\\end{gather}"},{display:!0,left:"\\begin{CD}",right:"\\end{CD}"},{display:!1,left:"$",right:"$"},{display:!1,left:"\\(",right:"\\)"}],strict:!1},pangu:{enable:!0,selector:"article"},search:{distance:100,findAllMatches:!1,highlightTag:"em",ignoreFieldNorm:!0,ignoreLocation:!0,isCaseSensitive:!1,location:0,maxResultLength:10,minMatchCharLength:2,noResultsFound:"没有找到结果",snippetLength:50,threshold:.3,useExtendedSearch:!0},siteTime:"2021-08-26T23:31:00+08:00",typeit:{cursorChar:"_",cursorSpeed:1e3,data:{"typeit-header-subtitle-desktop":["typeit-header-subtitle-desktop"],"typeit-header-subtitle-mobile":["typeit-header-subtitle-mobile"]},duration:-1,loop:!0,speed:150}}</script><script src=/js/theme.min.js defer></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/jquery@2.1.3/dist/jquery.min.js></script><script type=text/javascript src=/js/custom.js></script></body></html>
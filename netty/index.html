<!doctype html><html itemscope itemtype=http://schema.org/WebPage lang=zh-CN><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1,maximum-scale=2"><meta name=robots content="noodp"><title>🚩Netty -</title><meta name=author content="都将会"><meta name=author-link content><meta name=description content="基于Java语言的Netty"><meta name=keywords content="Netty,笔记"><meta itemprop=name content="🚩Netty"><meta itemprop=description content="基于Java语言的Netty"><meta itemprop=datePublished content="2023-08-23T08:08:08+08:00"><meta itemprop=dateModified content="2023-08-23T08:08:08+08:00"><meta itemprop=wordCount content="2167"><meta itemprop=image content="https://leni.fun/images/avatar.jpg"><meta itemprop=keywords content="Network,Netty,"><meta property="og:title" content="🚩Netty"><meta property="og:description" content="基于Java语言的Netty"><meta property="og:type" content="article"><meta property="og:url" content="https://leni.fun/netty/"><meta property="og:image" content="https://leni.fun/images/avatar.jpg"><meta property="article:section" content="posts"><meta property="article:published_time" content="2023-08-23T08:08:08+08:00"><meta property="article:modified_time" content="2023-08-23T08:08:08+08:00"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://leni.fun/images/avatar.jpg"><meta name=twitter:title content="🚩Netty"><meta name=twitter:description content="基于Java语言的Netty"><meta name=application-name content="都将会的 APP"><meta name=apple-mobile-web-app-title content="都将会的 APP"><meta name=theme-color data-light=#f8f8f8 data-dark=#252627 content="#f8f8f8"><meta name=msapplication-TileColor content="#da532c"><link rel="shortcut icon" type=image/x-icon href=/favicon.ico><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=mask-icon href=/safari-pinned-tab.svg color=#5bbad5><link rel=manifest href=/site.webmanifest><link rel=canonical href=https://leni.fun/netty/><link rel=prev href=https://leni.fun/netty%E5%AE%9E%E8%B7%B5%E8%AE%B0%E5%BD%95/><link rel=stylesheet href=/css/style.min.css><link rel=stylesheet href=/lib/fontawesome-free/all.min.css><link rel=stylesheet href=/lib/animate/animate.min.css><script type=application/ld+json>{"@context":"http://schema.org","@type":"BlogPosting","headline":"🚩Netty","inLanguage":"zh-CN","mainEntityOfPage":{"@type":"WebPage","@id":"https:\/\/leni.fun\/netty\/"},"genre":"posts","keywords":"Network, Netty","wordcount":2167,"url":"https:\/\/leni.fun\/netty\/","datePublished":"2023-08-23T08:08:08+08:00","dateModified":"2023-08-23T08:08:08+08:00","publisher":{"@type":"Organization","name":""},"author":{"@type":"Person","name":"都将会"},"description":"基于Java语言的Netty"}</script></head><body data-header-desktop=sticky data-header-mobile=auto><script>(window.localStorage?.getItem("theme")?localStorage.getItem("theme")==="dark":"dark"==="auto"?window.matchMedia("(prefers-color-scheme: dark)").matches:"dark"==="dark")&&document.body.setAttribute("data-theme","dark")</script><div class=wrapper data-page-style=normal><header class="desktop animate__faster" id=header-desktop><div class=header-wrapper data-github-corner=left><div class=header-title><a href=/ title><img loading=lazy src=/images/icon.png srcset="/images/icon.png, /images/icon.png 1.5x, /images/icon.png 2x" sizes=auto data-title=/images/icon.png data-alt=/images/icon.png class=logo style="background:url(/svg/loading.min.svg)no-repeat 50%" onload='this.title=this.dataset.title,this.alt=this.dataset.alt;for(const e of["style","data-title","data-alt","onerror","onload"])this.removeAttribute(e);this.dataset.lazyloaded=""' onerror='this.title=this.dataset.title,this.alt=this.dataset.alt;for(const e of["style","data-title","data-alt","onerror","onload"])this.removeAttribute(e)'><span class=header-title-text>都将会</span></a><span id=typeit-header-subtitle-desktop class="typeit header-subtitle"></span></div><nav><ul class=menu><li class="menu-item has-children"><a class=menu-link href=/posts/><i class="fa-solid fa-archive fa-fw fa-sm" aria-hidden=true></i> 技术</a><i class="dropdown-icon fa-solid fa-chevron-down" aria-hidden=true></i><ul class=sub-menu><li class=menu-item><a class=menu-link href=/categories/><i class="fa-solid fa-th fa-fw fa-sm" aria-hidden=true></i> 分类</a></li><li class=menu-item><a class=menu-link href=/tags/><i class="fa-solid fa-tags fa-fw fa-sm" aria-hidden=true></i> 标签</a></li></ul></li><li class=menu-item><a class=menu-link href=/life/><i class="fa-solid fa-camera-alt fa-fw fa-sm" aria-hidden=true></i> 生活</a></li><li class=menu-item><a class=menu-link href=/friends/><i class="fa-solid fa-users fa-fw fa-sm" aria-hidden=true></i> 友链</a></li><li class=menu-item><a class=menu-link href=/about/><i class="fa-solid fa-info-circle fa-fw fa-sm" aria-hidden=true></i> 关于</a></li><li class="menu-item delimiter"></li><li class="menu-item search" id=search-desktop><input type=text placeholder=关键词搜索 id=search-input-desktop>
<a href=javascript:void(0); class="search-button search-toggle" id=search-toggle-desktop title=搜索><i class="fa-solid fa-search fa-fw" aria-hidden=true></i></a>
<a href=javascript:void(0); class="search-button search-clear" id=search-clear-desktop title=清空><i class="fa-solid fa-times-circle fa-fw" aria-hidden=true></i></a>
<span class="search-button search-loading" id=search-loading-desktop><i class="fa-solid fa-spinner fa-fw fa-spin" aria-hidden=true></i></span></li><li class="menu-item theme-switch" title=切换主题><i class="fa-solid fa-adjust fa-fw" aria-hidden=true></i></li></ul></nav></div></header><header class="mobile animate__faster" id=header-mobile><div class=header-container><div class=header-wrapper><div class=header-title><a href=/ title><img loading=lazy src=/images/icon.png srcset="/images/icon.png, /images/icon.png 1.5x, /images/icon.png 2x" sizes=auto data-title=/images/icon.png data-alt=/images/icon.png class=logo style="background:url(/svg/loading.min.svg)no-repeat 50%" onload='this.title=this.dataset.title,this.alt=this.dataset.alt;for(const e of["style","data-title","data-alt","onerror","onload"])this.removeAttribute(e);this.dataset.lazyloaded=""' onerror='this.title=this.dataset.title,this.alt=this.dataset.alt;for(const e of["style","data-title","data-alt","onerror","onload"])this.removeAttribute(e)'><span class=header-title-text>都将会</span></a><span id=typeit-header-subtitle-mobile class="typeit header-subtitle"></span></div><div class=menu-toggle id=menu-toggle-mobile><span></span><span></span><span></span></div></div><nav><ul class=menu id=menu-mobile><li class=search-wrapper><div class="search mobile" id=search-mobile><input type=text placeholder=关键词搜索 id=search-input-mobile>
<a href=javascript:void(0); class="search-button search-toggle" id=search-toggle-mobile title=搜索><i class="fa-solid fa-search fa-fw" aria-hidden=true></i></a>
<a href=javascript:void(0); class="search-button search-clear" id=search-clear-mobile title=清空><i class="fa-solid fa-times-circle fa-fw" aria-hidden=true></i></a>
<span class="search-button search-loading" id=search-loading-mobile><i class="fa-solid fa-spinner fa-fw fa-spin" aria-hidden=true></i></span></div><a href=javascript:void(0); class=search-cancel id=search-cancel-mobile>取消</a></li><li class=menu-item><span class=nested-item><a class=menu-link href=/posts/><i class="fa-solid fa-archive fa-fw fa-sm" aria-hidden=true></i> 技术</a>
<i class="dropdown-icon fa-solid fa-chevron-right" aria-hidden=true></i></span><ul class=sub-menu><li class=menu-item><a class=menu-link href=/categories/><i class="fa-solid fa-th fa-fw fa-sm" aria-hidden=true></i> 分类</a></li><li class=menu-item><a class=menu-link href=/tags/><i class="fa-solid fa-tags fa-fw fa-sm" aria-hidden=true></i> 标签</a></li></ul></li><li class=menu-item><a class=menu-link href=/life/><i class="fa-solid fa-camera-alt fa-fw fa-sm" aria-hidden=true></i> 生活</a></li><li class=menu-item><a class=menu-link href=/friends/><i class="fa-solid fa-users fa-fw fa-sm" aria-hidden=true></i> 友链</a></li><li class=menu-item><a class=menu-link href=/about/><i class="fa-solid fa-info-circle fa-fw fa-sm" aria-hidden=true></i> 关于</a></li><li class="menu-item menu-system"><span class="menu-system-item theme-switch" title=切换主题><i class="fa-solid fa-adjust fa-fw" aria-hidden=true></i></span></li></ul></nav></div></header><div class="search-dropdown desktop"><div id=search-dropdown-desktop></div></div><div class="search-dropdown mobile"><div id=search-dropdown-mobile></div></div><nav aria-label=breadcrumb class="breadcrumb-container sticky"><ol class=breadcrumb><li class=breadcrumb-item><a href=/ title>主页</a></li><li class=breadcrumb-item><a href=/posts/ title=Posts>Posts</a></li><li class="breadcrumb-item active" aria-current=page>🚩Netty</li></ol></nav><main class=container><aside class=toc id=toc-auto><h2 class=toc-title>目录&nbsp;<i class="toc-icon fa-solid fa-angle-down fa-fw" aria-hidden=true></i></h2><div class=toc-content id=toc-content-auto></div></aside><aside class=aside-custom></aside><article class="page single"><div class=header><h1 class="single-title animate__animated animate__flipInX"><span>🚩Netty</span></h1></div><div class=post-meta><div class=post-meta-line><span class=post-author><span class=author><img loading=lazy src=/images/avatar.jpg srcset="/images/avatar.jpg, /images/avatar.jpg 1.5x, /images/avatar.jpg 2x" sizes=auto data-title=都将会 data-alt=都将会 class=avatar style="background:url(/svg/loading.min.svg)no-repeat 50%" onload='this.title=this.dataset.title,this.alt=this.dataset.alt;for(const e of["style","data-title","data-alt","onerror","onload"])this.removeAttribute(e);this.dataset.lazyloaded=""' onerror='this.title=this.dataset.title,this.alt=this.dataset.alt;for(const e of["style","data-title","data-alt","onerror","onload"])this.removeAttribute(e)'>&nbsp;都将会</span></span>
<span class=post-category>收录于 <a href=/categories/202308/><i class="fa-regular fa-folder fa-fw" aria-hidden=true></i> 202308</a>&ensp;<a href=/categories/interview/><i class="fa-regular fa-folder fa-fw" aria-hidden=true></i> interview</a></span></div><div class=post-meta-line><span title="发布于 2023-08-23 08:08:08"><i class="fa-regular fa-calendar-alt fa-fw me-1" aria-hidden=true></i><time datetime=2023-08-23>2023-08-23</time></span>&nbsp;<span title="更新于 2023-08-23 08:08:08"><i class="fa-regular fa-edit fa-fw me-1" aria-hidden=true></i><time datetime=2023-08-23>2023-08-23</time></span>&nbsp;<span><i class="fa-solid fa-pencil-alt fa-fw me-1" aria-hidden=true></i>约 2167 字</span>&nbsp;<span><i class="fa-regular fa-clock fa-fw me-1" aria-hidden=true></i>预计阅读 5 分钟</span>&nbsp;<span id=busuanzi_container_page_pv class="busuanzi_visitors comment-visitors" data-flag-title=🚩Netty>
<i class="fa-regular fa-eye fa-fw me-1" aria-hidden=true></i><span id=busuanzi_value_page_pv>-</span>&nbsp;次阅读
</span>&nbsp;</div></div><div class=featured-image><img loading=lazy src=/images/pic10.jpg srcset="/images/pic10.jpg, /images/pic10.jpg 1.5x, /images/pic10.jpg 2x" sizes=auto data-title=基于Java语言的Netty data-alt=/images/pic10.jpg width=1280 height=719 style="background:url(/svg/loading.min.svg)no-repeat 50%" onload='this.title=this.dataset.title,this.alt=this.dataset.alt;for(const e of["style","data-title","data-alt","onerror","onload"])this.removeAttribute(e);this.dataset.lazyloaded=""' onerror='this.title=this.dataset.title,this.alt=this.dataset.alt;for(const e of["style","data-title","data-alt","onerror","onload"])this.removeAttribute(e)'></div><div class="details toc" id=toc-static data-kept=false><div class="details-summary toc-title"><span>目录</span>
<span><i class="details-icon fa-solid fa-angle-right" aria-hidden=true></i></span></div><div class="details-content toc-content" id=toc-content-static><nav id=TableOfContents><ul><li><ul><li><a href=#netty-定义>Netty 定义</a><ul><li><a href=#核心概念>核心概念</a></li><li><a href=#为什么-netty-仅支持-nio>为什么 Netty 仅支持 NIO？</a></li><li><a href=#netty-如何解决-java-nio-早期版本中的-epoll空转问题>Netty 如何解决 Java NIO 早期版本中的 Epoll空转问题？</a></li></ul></li><li><a href=#channel-和-channelpipeline>Channel 和 ChannelPipeline</a></li><li><a href=#eventloop>EventLoop</a><ul><li><a href=#四种事件类型>四种事件类型</a></li></ul></li><li><a href=#三种-reactor-模型>三种 Reactor 模型</a></li><li><a href=#bytebuf>ByteBuf</a><ul><li><a href=#bytebuffer-的种类>ByteBuffer 的种类</a></li></ul></li><li><a href=#如何处理粘包与拆包>如何处理粘包与拆包？</a><ul><li><a href=#一次解码器---抽象类-bytetomessagedecoder>一次解码器 - 抽象类 ByteToMessageDecoder</a></li><li><a href=#二次解码器---抽象类messagetomessagedecoder>二次解码器 - 抽象类MessageToMessageDecoder</a></li></ul></li><li><a href=#netty-内存使用>Netty 内存使用</a></li></ul></li></ul></nav></div></div><div class=content id=content><h3 id=netty-定义>Netty 定义</h3><ul><li>本质：网络应用程序框架</li><li>实现：异步、事件驱动</li><li>特性：高性能、可维护、快速开发，可以取代 JDK 的NIO<ul><li>支持常用应用层协议</li><li>解决 TCP 粘包</li><li>不会出现 epoll 空轮询导致 CPU 100%</li><li>FastThreadLocal 替代 ThreadLocal，ByteBuf 替代 ByteBuffer</li></ul></li><li>用途：开发服务器和客户端</li><li>主版本：4.1（支持 Android）</li><li>场景：Spark、Hadoop、RocketMQ、ElasticSearch、ZooKeeper、Dubbo、Spring5（响应式编程）</li></ul><h4 id=核心概念>核心概念</h4><ul><li>ServerBootstrap，<strong>服务器端程序的入口</strong>，这是 Netty 为简化网络程序配置和关闭等生命周期管理，所引入的 Bootstrapping 机制。我们通常要做的创建 Channel、绑定端口、注册 Handler 等，都可以通过这个统一的入口，以 Fluent API 等形式完成，相对简化了 API 使用。与之相对应， <strong>Bootstrap则是 Client 端的通常入口。</strong></li><li>Channel：可以理解为读操作或写操作，因此可以被打开或被关闭 。作为一个基于 NIO 的扩展框架，Channel 和 Selector 等概念仍然是 Netty 的基础组件，但是针对应用开发具体需求，提供了相对易用的抽象。</li><li>EventLoop：只由一个线程驱动，处理一个 Channel中 的所有 I/O 事件。这是 Netty <strong>处理事件的核心机制</strong>。例子中使用了 EventLoopGroup。我们在 NIO 中通常要做的几件事情，如<strong>注册感兴趣的事件、调度相应的 Handler</strong> 等，都是 EventLoop 负责。</li><li>ChannelFuture，这是 Netty 实现<strong>异步 IO</strong> 的基础之一，保证了同一个 Channel 操作的调用顺序。Netty 扩展了 Java 标准的 Future，提供了针对自己场景的特有Future定义。</li><li>ChannelHandler，这是应用开发者放置<strong>业务逻辑</strong>的主要地方，也是我上面提到的“Separation Of Concerns”原则的体现。每个事件都可以被分发给 ChannelHandler 类中的某个用户实现的方法，实现业务逻辑与网络处理代码分离。</li><li>ChannelPipeline：它是 ChannelHandler 链条的容器，每个 Channel 在创建后，自动被分配一个 ChannelPipeline。</li></ul><h4 id=为什么-netty-仅支持-nio>为什么 Netty 仅支持 NIO？</h4><ol><li>BIO 在连接数高的时候阻塞等待消耗资源，效率低，连接数低的时候使用 JDK 的就够了，因为实现简单。</li><li>Windows AIO 实现成熟，但很少用来做服务器；Linux 常用做服务器，但是 AIO 不成熟，相比较 NIO的性能提升并不明显。</li></ol><h4 id=netty-如何解决-java-nio-早期版本中的-epoll空转问题>Netty 如何解决 Java NIO 早期版本中的 Epoll空转问题？</h4><p>epoll 空轮询导致 CPU 100%，Netty 检测空轮询次数大于一定阈值，就会 rebuild 多路复用服务器。</p><h3 id=channel-和-channelpipeline>Channel 和 ChannelPipeline</h3><p>在 Netty 中，Channel 是网络通信的基础，表示一个<strong>可靠的网络连接</strong>。<strong>ChannelPipeline 是一系列 ChannelHandler 的链表，用于处理 Channel 上的事件和数据，类似于 Servlet 中的 Filter</strong>。</p><p><a class=lightgallery href=https://publicpictures.oss-cn-hangzhou.aliyuncs.com/img/image-20230823074134400.png data-thumbnail=https://publicpictures.oss-cn-hangzhou.aliyuncs.com/img/image-20230823074134400.png data-sub-html="<h2>image-20230823074134400</h2>"><img loading=lazy src=https://publicpictures.oss-cn-hangzhou.aliyuncs.com/img/image-20230823074134400.png srcset="https://publicpictures.oss-cn-hangzhou.aliyuncs.com/img/image-20230823074134400.png, https://publicpictures.oss-cn-hangzhou.aliyuncs.com/img/image-20230823074134400.png 1.5x, https://publicpictures.oss-cn-hangzhou.aliyuncs.com/img/image-20230823074134400.png 2x" sizes=auto data-title=image-20230823074134400 data-alt=image-20230823074134400 style="background:url(/svg/loading.min.svg)no-repeat 50%" onload='this.title=this.dataset.title,this.alt=this.dataset.alt;for(const e of["style","data-title","data-alt","onerror","onload"])this.removeAttribute(e);this.dataset.lazyloaded=""' onerror='this.title=this.dataset.title,this.alt=this.dataset.alt;for(const e of["style","data-title","data-alt","onerror","onload"])this.removeAttribute(e)'></a></p><h3 id=eventloop>EventLoop</h3><p>EventLoop 是 Netty 中的一个重要组件，用于处理 Channel 上的事件和任务，负责监听网络事件并调用事件处理器进行相关I/O操作。每个 Channel 都会绑定一个 EventLoop**，一个 EventLoop 可以处理多个 Channel 上的事件和任务**。Netty 采用了多种线程模型，如单线程模型、多线程模型、主从线程模型等，根据实际需求选择不同的线程模型可以更好地提高程序的性能和并发性。</p><p>Channel 是 Netty 网络操作抽象类，EventLoop负责处理注册到其上的Channel 的 I/O操作。</p><p>EventloopGroup包含多个EventLoop（EventLoop：Thread = 1 : 1），它管理着所有的EventLoop的生命周期。</p><p><a class=lightgallery href=https://publicpictures.oss-cn-hangzhou.aliyuncs.com/img/image-20230823083543457.png data-thumbnail=https://publicpictures.oss-cn-hangzhou.aliyuncs.com/img/image-20230823083543457.png data-sub-html="<h2>image-20230823083543457</h2>"><img loading=lazy src=https://publicpictures.oss-cn-hangzhou.aliyuncs.com/img/image-20230823083543457.png srcset="https://publicpictures.oss-cn-hangzhou.aliyuncs.com/img/image-20230823083543457.png, https://publicpictures.oss-cn-hangzhou.aliyuncs.com/img/image-20230823083543457.png 1.5x, https://publicpictures.oss-cn-hangzhou.aliyuncs.com/img/image-20230823083543457.png 2x" sizes=auto data-title=image-20230823083543457 data-alt=image-20230823083543457 style="background:url(/svg/loading.min.svg)no-repeat 50%" onload='this.title=this.dataset.title,this.alt=this.dataset.alt;for(const e of["style","data-title","data-alt","onerror","onload"])this.removeAttribute(e);this.dataset.lazyloaded=""' onerror='this.title=this.dataset.title,this.alt=this.dataset.alt;for(const e of["style","data-title","data-alt","onerror","onload"])this.removeAttribute(e)'></a></p><p>NioEventLoopGroup 默认的构造函数实际会起的线程数为 <strong>CPU核心数*2</strong></p><h4 id=四种事件类型>四种事件类型</h4><ul><li>accept：在有连接请求时触发</li><li>connect：客户端，连接建立后触发</li><li>read：可读事件</li><li>write：可写事件</li></ul><p>在 select 后，事件要么处理 accept，要么取消 cancel（catch 异常之后），</p><h3 id=三种-reactor-模型>三种 Reactor 模型</h3><div class=highlight id=id-1><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=c1>// 1. 单线程 BIO
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=n>EventLoopGroup</span> <span class=n>eventGroup</span> <span class=o>=</span> <span class=k>new</span> <span class=n>NioEventLoopGroup</span><span class=o>(</span><span class=n>1</span><span class=o>);</span>
</span></span><span class=line><span class=cl><span class=n>ServerBootstrap</span> <span class=n>serverBootstrap</span> <span class=o>=</span> <span class=k>new</span> <span class=n>ServerBootstrap</span><span class=o>();</span>
</span></span><span class=line><span class=cl><span class=n>serverBootStrap</span><span class=o>.</span><span class=na>group</span><span class=o>(</span><span class=n>eventGroup</span><span class=o>);</span>
</span></span><span class=line><span class=cl><span class=c1>// 2. 多线程 NIO
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=n>EventLoopGroup</span> <span class=n>eventGroup</span> <span class=o>=</span> <span class=k>new</span> <span class=n>NioEventLoopGroup</span><span class=o>();</span>
</span></span><span class=line><span class=cl><span class=n>ServerBootstrap</span> <span class=n>serverBootstrap</span> <span class=o>=</span> <span class=k>new</span> <span class=n>ServerBootstrap</span><span class=o>();</span>
</span></span><span class=line><span class=cl><span class=n>serverBootStrap</span><span class=o>.</span><span class=na>group</span><span class=o>(</span><span class=n>eventGroup</span><span class=o>);</span>
</span></span><span class=line><span class=cl><span class=c1>// 3. 主从多线程 AIO
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=n>EventLoopGroup</span> <span class=n>bossGroup</span> <span class=o>=</span> <span class=k>new</span> <span class=n>NioEventLoopGroup</span><span class=o>();</span>
</span></span><span class=line><span class=cl><span class=n>EventLoopGroup</span> <span class=n>workerGroup</span> <span class=o>=</span> <span class=k>new</span> <span class=n>NioEventLoopGroup</span><span class=o>();</span>
</span></span><span class=line><span class=cl><span class=n>ServerBootstrap</span> <span class=n>serverBootstrap</span> <span class=o>=</span> <span class=k>new</span> <span class=n>ServerBootstrap</span><span class=o>();</span>
</span></span><span class=line><span class=cl><span class=n>serverBootStrap</span><span class=o>.</span><span class=na>group</span><span class=o>(</span><span class=n>bossGroup</span><span class=o>,</span> <span class=n>workerGroup</span><span class=o>);</span>
</span></span><span class=line><span class=cl><span class=c1>// 关闭服务 chennel.close() key.cancel()
</span></span></span><span class=line><span class=cl><span class=c1>// 先不接活，尽量做完手头的事情
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=n>bossGroup</span><span class=o>.</span><span class=na>shutdownGracefully</span><span class=o>();</span>
</span></span><span class=line><span class=cl><span class=n>workerGroup</span><span class=o>.</span><span class=na>shutdownGracefully</span><span class=o>();</span></span></span></code></pre></td></tr></table></div></div><h3 id=bytebuf>ByteBuf</h3><p>ByteBuf 是 Netty 中的一个重要组件，用于处理数据的缓冲区。与 JDK 中的 ByteBuffer 相比，ByteBuf 具有更好的可扩展性、更高的性能和更丰富的功能。<strong>ByteBuf 支持读写索引分离，内存池化和引用计数等功能</strong>，可以更好地管理内存和提高程序的性能。</p><h4 id=bytebuffer-的种类>ByteBuffer 的种类</h4><ul><li>java.nio.HeapByteBuffer：java 堆内存，读写效率较低，受到 GC 的影响</li><li>java.nio.DirectByteBuffer：直接内存，读写效率高（少一次拷贝），不受 GC 影响，分配效率低</li></ul><h3 id=如何处理粘包与拆包>如何处理粘包与拆包？</h3><h4 id=一次解码器---抽象类-bytetomessagedecoder>一次解码器 - 抽象类 ByteToMessageDecoder</h4><p>ByteBuf -> ByteBuf</p><p>提供了一些常见的实现类：</p><ol><li><p>FixedLengthFrameDecoder：定长协议解码器，指定固定的字节数</p></li><li><p>DelimiterBasedFrameDecoder：分隔符解码器</p></li><li><p>LineBasedFrameDecoder：行分隔符解码器，识别 \n或\r\n</p></li><li><p>LengthFieldBasedFrameDecoder：长度编码解码器，将报文划分为header和body</p><p>在处理 protobuf 类型数据时，运用了ProtobufVarint32FrameDecoder，允许 int 长度可变，进一步节约内存。</p></li><li><p>JsonObjectDecoder：监测到匹配的{}或[]就认为是完整的json对象或json数组</p></li></ol><h4 id=二次解码器---抽象类messagetomessagedecoder>二次解码器 - 抽象类MessageToMessageDecoder</h4><p>ByteBuf -> Java Object</p><p>Netty 序列化相比 JDK 序列化减少了：</p><ol><li>固定的魔数</li><li>类的元信息，只保留了类名用于反射</li></ol><h3 id=netty-内存使用>Netty 内存使用</h3><p>内存池方法：<code>get()</code> <code>recycle()</code></p></div><div class=post-footer id=post-footer><div class=post-info><div class=post-info-line><div class=post-info-mod><span title="更新于 2023-08-23 08:08:08">更新于 2023-08-23&nbsp;</span></div><div class=post-info-license><span><a rel="license external nofollow noopener noreferrer" href=https://creativecommons.org/licenses/by-nc/4.0/ target=_blank>CC BY-NC 4.0</a></span></div></div><div class=post-info-line><div class=post-info-md></div><div class=post-info-share><span><a href=javascript:void(0); title="分享到 微博" data-sharer=weibo data-url=https://leni.fun/netty/ data-title=🚩Netty data-image=/images/pic10.jpg><i class="fa-brands fa-weibo fa-fw" aria-hidden=true></i></a></span></div></div></div><div class=post-info-more><section class=post-tags><i class="fa-solid fa-tags fa-fw me-1" aria-hidden=true></i><a href=/tags/network/ class=post-tag>Network</a><a href=/tags/netty/ class=post-tag>Netty</a></section><section><span><a href=javascript:void(0); onclick=window.history.back()>返回</a></span>&nbsp;|&nbsp;<span><a href=/>主页</a></span></section></div><div class=post-nav><a href=/netty%E5%AE%9E%E8%B7%B5%E8%AE%B0%E5%BD%95/ class=post-nav-item rel=prev title="Netty 实践记录"><i class="fa-solid fa-angle-left fa-fw" aria-hidden=true></i>Netty 实践记录</a></div></div></article></main><footer class=footer><div class=footer-container><div class="footer-line copyright order-5" itemscope itemtype=http://schema.org/CreativeWork><i class="fa-regular fa-copyright fa-fw" aria-hidden=true></i>
<span itemprop=copyrightYear>2021 - 2023</span><span class=author itemprop=copyrightHolder>
<a href=/>都将会</a></span><span class="license footer-divider"><a rel="license external nofollow noopener noreferrer" href=https://beian.miit.gov.cn target=_blank>浙ICP备2023023782号</a></span></div><div class="footer-line statistics"><span class=site-time title=网站运行中……><i class="fa-solid fa-heartbeat fa-fw animate-icon" aria-hidden=true></i><span class="run-times ms-1">网站运行中……</span></span></div><div class="footer-line visitor order-4"><span id=busuanzi_container_site_uv title=总访客数><i class="fa-regular fa-user fa-fw" aria-hidden=true></i>&nbsp;<span id=busuanzi_value_site_uv><i class="fa-solid fa-spinner fa-spin fa-fw" aria-hidden=true></i></span></span><span id=busuanzi_container_site_pv class=footer-divider title=总访问量><i class="fa-regular fa-eye fa-fw" aria-hidden=true></i>&nbsp;<span id=busuanzi_value_site_pv><i class="fa-solid fa-spinner fa-spin fa-fw" aria-hidden=true></i></span></span></div></div></footer></div><div class=widgets><div class="fixed-buttons animate__faster d-none"><div class="fixed-button back-to-top" role=button aria-label=回到顶部><i class="fa-solid fa-arrow-up fa-fw" aria-hidden=true></i><span class=variant-numeric>0%</span></div></div><a href=https://github.com/hihihiman/hihihiman.github.io title=博客源码 target=_blank rel="external nofollow" class="github-corner left d-none-mobile"><svg viewBox="0 0 250 250" aria-hidden="true"><path d="M0 0 115 115h15l12 27L250 250V0z"/><path d="M128.3 109C113.8 99.7 119 89.6 119 89.6 122 82.7 120.5 78.6 120.5 78.6 119.2 72 123.4 76.3 123.4 76.3 127.3 80.9 125.5 87.3 125.5 87.3 122.9 97.6 130.6 101.9 134.4 103.2" fill="currentcolor" style="transform-origin:130px 106px" class="octo-arm"/><path d="M115 115C114.9 115.1 118.7 116.5 119.8 115.4l13.9-13.8C136.9 99.2 139.9 98.4 142.2 98.6 133.8 88 127.5 74.4 143.8 58 148.5 53.4 154 51.2 159.7 51 160.3 49.4 163.2 43.6 171.4 40.1 171.4 40.1 176.1 42.5 178.8 56.2 183.1 58.6 187.2 61.8 190.9 65.4 194.5 69 197.7 73.2 200.1 77.6 213.8 80.2 216.3 84.9 216.3 84.9 212.7 93.1 206.9 96 205.4 96.6 205.1 102.4 203 107.8 198.3 112.5 181.9 128.9 168.3 122.5 157.7 114.1 157.9 116.9 156.7 120.9 152.7 124.9L141 136.5C139.8 137.7 141.6 141.9 141.8 141.8z" fill="currentcolor" class="octo-body"/></svg></a><div id=mask></div><div class=reading-progress-bar style=left:0;bottom:0></div><noscript><div class=noscript-warning>FixIt 主题在启用 JavaScript 的情况下效果最佳。</div></noscript></div><link rel=stylesheet href=/lib/lightgallery/css/lightgallery-bundle.min.css><link rel=stylesheet href=/lib/katex/katex.min.css><link rel=stylesheet href=/lib/cookieconsent/cookieconsent.min.css><link rel=stylesheet href=/lib/pace/themes/pink/pace-theme-center-atom.css><script src=/lib/autocomplete/autocomplete.min.js defer></script><script src=/lib/fuse/fuse.min.js defer></script><script src=/lib/lightgallery/lightgallery.min.js defer></script><script src=/lib/lightgallery/plugins/thumbnail/lg-thumbnail.min.js defer></script><script src=/lib/lightgallery/plugins/zoom/lg-zoom.min.js defer></script><script src=/lib/sharer/sharer.min.js async defer></script><script src=/lib/typeit/index.umd.js defer></script><script src=/lib/katex/katex.min.js defer></script><script src=/lib/katex/auto-render.min.js defer></script><script src=/lib/katex/copy-tex.min.js defer></script><script src=/lib/katex/mhchem.min.js defer></script><script src=/lib/cookieconsent/cookieconsent.min.js defer></script><script src=/lib/pangu/pangu.min.js defer></script><script src=//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js async defer></script><script src=/lib/pace/pace.min.js async defer></script><script>window.config={autoBookmark:!0,code:{copyTitle:"复制到剪贴板",editLockTitle:"锁定可编辑代码块",editUnLockTitle:"解锁可编辑代码块",editable:!0,maxShownLines:1024},comment:{enable:!1},cookieconsent:{content:{dismiss:"同意",link:"了解更多",message:"本网站使用 Cookies 来改善您的浏览体验。"},enable:!0,palette:{button:{background:"#f0f0f0"},popup:{background:"#1aa3ff"}},theme:"edgeless"},data:{"typeit-header-subtitle-desktop":"的博客           ","typeit-header-subtitle-mobile":"的博客           "},enablePWA:!0,lightgallery:!0,math:{delimiters:[{display:!0,left:"$$",right:"$$"},{display:!0,left:"\\[",right:"\\]"},{display:!0,left:"\\begin{equation}",right:"\\end{equation}"},{display:!0,left:"\\begin{equation*}",right:"\\end{equation*}"},{display:!0,left:"\\begin{align}",right:"\\end{align}"},{display:!0,left:"\\begin{align*}",right:"\\end{align*}"},{display:!0,left:"\\begin{alignat}",right:"\\end{alignat}"},{display:!0,left:"\\begin{alignat*}",right:"\\end{alignat*}"},{display:!0,left:"\\begin{gather}",right:"\\end{gather}"},{display:!0,left:"\\begin{CD}",right:"\\end{CD}"},{display:!1,left:"$",right:"$"},{display:!1,left:"\\(",right:"\\)"}],strict:!1},pangu:{enable:!0,selector:"article"},search:{distance:100,findAllMatches:!1,highlightTag:"em",ignoreFieldNorm:!0,ignoreLocation:!0,isCaseSensitive:!1,location:0,maxResultLength:10,minMatchCharLength:2,noResultsFound:"没有找到结果",snippetLength:50,threshold:.3,useExtendedSearch:!0},siteTime:"2021-08-26T23:31:00+08:00",typeit:{cursorChar:"_",cursorSpeed:1e3,data:{"typeit-header-subtitle-desktop":["typeit-header-subtitle-desktop"],"typeit-header-subtitle-mobile":["typeit-header-subtitle-mobile"]},duration:-1,loop:!0,speed:150}}</script><script src=/js/theme.min.js defer></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/jquery@2.1.3/dist/jquery.min.js></script><script type=text/javascript src=/js/custom.js></script></body></html>
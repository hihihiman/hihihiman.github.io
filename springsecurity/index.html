<!doctype html><html itemscope itemtype=http://schema.org/WebPage lang=zh-CN><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1,maximum-scale=2"><meta name=robots content="noodp"><title>SpringSecurity -</title><meta name=author content="都将会"><meta name=author-link content><meta name=description content="最近面试了 JD 厂的网络安全部门，有以下几个问题答得不是很好，本文对 SpringSecurity 相关知识点进行梳理。"><meta name=keywords content="都将会,Java,SpringSecurity"><meta itemprop=name content="SpringSecurity"><meta itemprop=description content="最近面试了 JD 厂的网络安全部门，有以下几个问题答得不是很好，本文对 SpringSecurity 相关知识点进行梳理。"><meta itemprop=datePublished content="2023-08-29T16:14:31+08:00"><meta itemprop=dateModified content="2023-08-29T16:14:31+08:00"><meta itemprop=wordCount content="2093"><meta itemprop=image content="https://leni.fun/images/avatar.jpg"><meta itemprop=keywords content="Spring,Security,"><meta property="og:title" content="SpringSecurity"><meta property="og:description" content="最近面试了 JD 厂的网络安全部门，有以下几个问题答得不是很好，本文对 SpringSecurity 相关知识点进行梳理。"><meta property="og:type" content="article"><meta property="og:url" content="https://leni.fun/springsecurity/"><meta property="og:image" content="https://leni.fun/images/avatar.jpg"><meta property="article:section" content="posts"><meta property="article:published_time" content="2023-08-29T16:14:31+08:00"><meta property="article:modified_time" content="2023-08-29T16:14:31+08:00"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://leni.fun/images/avatar.jpg"><meta name=twitter:title content="SpringSecurity"><meta name=twitter:description content="最近面试了 JD 厂的网络安全部门，有以下几个问题答得不是很好，本文对 SpringSecurity 相关知识点进行梳理。"><meta name=application-name content="都将会的 APP"><meta name=apple-mobile-web-app-title content="都将会的 APP"><meta name=theme-color data-light=#f8f8f8 data-dark=#252627 content="#f8f8f8"><meta name=msapplication-TileColor content="#da532c"><link rel="shortcut icon" type=image/x-icon href=/favicon.ico><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=mask-icon href=/safari-pinned-tab.svg color=#5bbad5><link rel=manifest href=/site.webmanifest><link rel=canonical href=https://leni.fun/springsecurity/><link rel=prev href=https://leni.fun/netty%E5%AE%9E%E8%B7%B5%E8%AE%B0%E5%BD%95/><link rel=next href=https://leni.fun/spring/><link rel=stylesheet href=/css/style.min.css><link rel=stylesheet href=/lib/fontawesome-free/all.min.css><link rel=stylesheet href=/lib/animate/animate.min.css><script type=application/ld+json>{"@context":"http://schema.org","@type":"BlogPosting","headline":"SpringSecurity","inLanguage":"zh-CN","mainEntityOfPage":{"@type":"WebPage","@id":"https:\/\/leni.fun\/springsecurity\/"},"genre":"posts","keywords":"Spring, Security","wordcount":2093,"url":"https:\/\/leni.fun\/springsecurity\/","datePublished":"2023-08-29T16:14:31+08:00","dateModified":"2023-08-29T16:14:31+08:00","publisher":{"@type":"Organization","name":""},"author":{"@type":"Person","name":"都将会"},"description":""}</script></head><body data-header-desktop=sticky data-header-mobile=auto><script>(window.localStorage?.getItem("theme")?localStorage.getItem("theme")==="dark":"dark"==="auto"?window.matchMedia("(prefers-color-scheme: dark)").matches:"dark"==="dark")&&document.body.setAttribute("data-theme","dark")</script><div class=wrapper data-page-style=normal><header class="desktop animate__faster" id=header-desktop><div class=header-wrapper data-github-corner=left><div class=header-title><a href=/ title><img loading=lazy src=/images/icon.png srcset="/images/icon.png, /images/icon.png 1.5x, /images/icon.png 2x" sizes=auto data-title=/images/icon.png data-alt=/images/icon.png class=logo style="background:url(/svg/loading.min.svg)no-repeat 50%" onload='this.title=this.dataset.title,this.alt=this.dataset.alt;for(const e of["style","data-title","data-alt","onerror","onload"])this.removeAttribute(e);this.dataset.lazyloaded=""' onerror='this.title=this.dataset.title,this.alt=this.dataset.alt;for(const e of["style","data-title","data-alt","onerror","onload"])this.removeAttribute(e)'><span class=header-title-text>都将会</span></a><span id=typeit-header-subtitle-desktop class="typeit header-subtitle"></span></div><nav><ul class=menu><li class="menu-item has-children"><a class=menu-link href=/posts/><i class="fa-solid fa-archive fa-fw fa-sm" aria-hidden=true></i> 技术</a><i class="dropdown-icon fa-solid fa-chevron-down" aria-hidden=true></i><ul class=sub-menu><li class=menu-item><a class=menu-link href=/categories/><i class="fa-solid fa-th fa-fw fa-sm" aria-hidden=true></i> 分类</a></li><li class=menu-item><a class=menu-link href=/tags/><i class="fa-solid fa-tags fa-fw fa-sm" aria-hidden=true></i> 标签</a></li></ul></li><li class=menu-item><a class=menu-link href=/life/><i class="fa-solid fa-camera-alt fa-fw fa-sm" aria-hidden=true></i> 生活</a></li><li class=menu-item><a class=menu-link href=/friends/><i class="fa-solid fa-users fa-fw fa-sm" aria-hidden=true></i> 友链</a></li><li class=menu-item><a class=menu-link href=/about/><i class="fa-solid fa-info-circle fa-fw fa-sm" aria-hidden=true></i> 关于</a></li><li class="menu-item delimiter"></li><li class="menu-item search" id=search-desktop><input type=text placeholder=关键词搜索 id=search-input-desktop>
<a href=javascript:void(0); class="search-button search-toggle" id=search-toggle-desktop title=搜索><i class="fa-solid fa-search fa-fw" aria-hidden=true></i></a>
<a href=javascript:void(0); class="search-button search-clear" id=search-clear-desktop title=清空><i class="fa-solid fa-times-circle fa-fw" aria-hidden=true></i></a>
<span class="search-button search-loading" id=search-loading-desktop><i class="fa-solid fa-spinner fa-fw fa-spin" aria-hidden=true></i></span></li><li class="menu-item theme-switch" title=切换主题><i class="fa-solid fa-adjust fa-fw" aria-hidden=true></i></li></ul></nav></div></header><header class="mobile animate__faster" id=header-mobile><div class=header-container><div class=header-wrapper><div class=header-title><a href=/ title><img loading=lazy src=/images/icon.png srcset="/images/icon.png, /images/icon.png 1.5x, /images/icon.png 2x" sizes=auto data-title=/images/icon.png data-alt=/images/icon.png class=logo style="background:url(/svg/loading.min.svg)no-repeat 50%" onload='this.title=this.dataset.title,this.alt=this.dataset.alt;for(const e of["style","data-title","data-alt","onerror","onload"])this.removeAttribute(e);this.dataset.lazyloaded=""' onerror='this.title=this.dataset.title,this.alt=this.dataset.alt;for(const e of["style","data-title","data-alt","onerror","onload"])this.removeAttribute(e)'><span class=header-title-text>都将会</span></a><span id=typeit-header-subtitle-mobile class="typeit header-subtitle"></span></div><div class=menu-toggle id=menu-toggle-mobile><span></span><span></span><span></span></div></div><nav><ul class=menu id=menu-mobile><li class=search-wrapper><div class="search mobile" id=search-mobile><input type=text placeholder=关键词搜索 id=search-input-mobile>
<a href=javascript:void(0); class="search-button search-toggle" id=search-toggle-mobile title=搜索><i class="fa-solid fa-search fa-fw" aria-hidden=true></i></a>
<a href=javascript:void(0); class="search-button search-clear" id=search-clear-mobile title=清空><i class="fa-solid fa-times-circle fa-fw" aria-hidden=true></i></a>
<span class="search-button search-loading" id=search-loading-mobile><i class="fa-solid fa-spinner fa-fw fa-spin" aria-hidden=true></i></span></div><a href=javascript:void(0); class=search-cancel id=search-cancel-mobile>取消</a></li><li class=menu-item><span class=nested-item><a class=menu-link href=/posts/><i class="fa-solid fa-archive fa-fw fa-sm" aria-hidden=true></i> 技术</a>
<i class="dropdown-icon fa-solid fa-chevron-right" aria-hidden=true></i></span><ul class=sub-menu><li class=menu-item><a class=menu-link href=/categories/><i class="fa-solid fa-th fa-fw fa-sm" aria-hidden=true></i> 分类</a></li><li class=menu-item><a class=menu-link href=/tags/><i class="fa-solid fa-tags fa-fw fa-sm" aria-hidden=true></i> 标签</a></li></ul></li><li class=menu-item><a class=menu-link href=/life/><i class="fa-solid fa-camera-alt fa-fw fa-sm" aria-hidden=true></i> 生活</a></li><li class=menu-item><a class=menu-link href=/friends/><i class="fa-solid fa-users fa-fw fa-sm" aria-hidden=true></i> 友链</a></li><li class=menu-item><a class=menu-link href=/about/><i class="fa-solid fa-info-circle fa-fw fa-sm" aria-hidden=true></i> 关于</a></li><li class="menu-item menu-system"><span class="menu-system-item theme-switch" title=切换主题><i class="fa-solid fa-adjust fa-fw" aria-hidden=true></i></span></li></ul></nav></div></header><div class="search-dropdown desktop"><div id=search-dropdown-desktop></div></div><div class="search-dropdown mobile"><div id=search-dropdown-mobile></div></div><nav aria-label=breadcrumb class="breadcrumb-container sticky"><ol class=breadcrumb><li class=breadcrumb-item><a href=/ title>主页</a></li><li class=breadcrumb-item><a href=/posts/ title=Posts>Posts</a></li><li class="breadcrumb-item active" aria-current=page>SpringSecurity</li></ol></nav><main class=container><aside class=toc id=toc-auto><h2 class=toc-title>目录&nbsp;<i class="toc-icon fa-solid fa-angle-down fa-fw" aria-hidden=true></i></h2><div class=toc-content id=toc-content-auto></div></aside><aside class=aside-custom></aside><article class="page single"><div class=header><h1 class="single-title animate__animated animate__flipInX"><span>SpringSecurity</span></h1></div><div class=post-meta><div class=post-meta-line><span class=post-author><span class=author><img loading=lazy src=/images/avatar.jpg srcset="/images/avatar.jpg, /images/avatar.jpg 1.5x, /images/avatar.jpg 2x" sizes=auto data-title=都将会 data-alt=都将会 class=avatar style="background:url(/svg/loading.min.svg)no-repeat 50%" onload='this.title=this.dataset.title,this.alt=this.dataset.alt;for(const e of["style","data-title","data-alt","onerror","onload"])this.removeAttribute(e);this.dataset.lazyloaded=""' onerror='this.title=this.dataset.title,this.alt=this.dataset.alt;for(const e of["style","data-title","data-alt","onerror","onload"])this.removeAttribute(e)'>&nbsp;都将会</span></span>
<span class=post-category>收录于 <a href=/categories/202308/><i class="fa-regular fa-folder fa-fw" aria-hidden=true></i> 202308</a></span></div><div class=post-meta-line><span title="发布于 2023-08-29 16:14:31"><i class="fa-regular fa-calendar-alt fa-fw me-1" aria-hidden=true></i><time datetime=2023-08-29>2023-08-29</time></span>&nbsp;<span title="更新于 2023-08-29 16:14:31"><i class="fa-regular fa-edit fa-fw me-1" aria-hidden=true></i><time datetime=2023-08-29>2023-08-29</time></span>&nbsp;<span><i class="fa-solid fa-pencil-alt fa-fw me-1" aria-hidden=true></i>约 2093 字</span>&nbsp;<span><i class="fa-regular fa-clock fa-fw me-1" aria-hidden=true></i>预计阅读 5 分钟</span>&nbsp;<span id=busuanzi_container_page_pv class="busuanzi_visitors comment-visitors" data-flag-title=SpringSecurity>
<i class="fa-regular fa-eye fa-fw me-1" aria-hidden=true></i><span id=busuanzi_value_page_pv>-</span>&nbsp;次阅读
</span>&nbsp;</div></div><div class=featured-image><img loading=lazy src=/images/pic12.jpg srcset="/images/pic12.jpg, /images/pic12.jpg 1.5x, /images/pic12.jpg 2x" sizes=auto data-title=/images/pic12.jpg data-alt=/images/pic12.jpg width=1858 height=1394 style="background:url(/svg/loading.min.svg)no-repeat 50%" onload='this.title=this.dataset.title,this.alt=this.dataset.alt;for(const e of["style","data-title","data-alt","onerror","onload"])this.removeAttribute(e);this.dataset.lazyloaded=""' onerror='this.title=this.dataset.title,this.alt=this.dataset.alt;for(const e of["style","data-title","data-alt","onerror","onload"])this.removeAttribute(e)'></div><div class="details toc" id=toc-static data-kept=false><div class="details-summary toc-title"><span>目录</span>
<span><i class="details-icon fa-solid fa-angle-right" aria-hidden=true></i></span></div><div class="details-content toc-content" id=toc-content-static><nav id=TableOfContents><ul><li><ul><li><a href=#执行流程>执行流程</a></li><li><a href=#springsecurity-如何实现认证和授权>SpringSecurity 如何实现认证和授权？</a><ul><li><a href=#认证>认证</a></li><li><a href=#授权>授权</a></li></ul></li><li><a href=#什么是-csrf攻击springsecurity-如何防范>什么是 CSRF攻击，SpringSecurity 如何防范？</a></li><li><a href=#对信息安全和数据安全的理解>对信息安全和数据安全的理解？</a><ul><li><a href=#如何保证缓存数据的安全>如何保证缓存数据的安全？</a></li></ul></li><li><a href=#如何允许跨域>如何允许跨域？</a></li><li><a href=#单点登录-sso--single-sign-on>单点登录 SSO = Single Sign On</a></li><li><a href=#需求五次登录失败锁定三十分钟>需求：五次登录失败锁定三十分钟</a></li></ul></li></ul></nav></div></div><div class=content id=content><p>最近面试了 JD 厂的网络安全部门，有以下几个问题答得不是很好，本文对 SpringSecurity 相关知识点进行梳理。</p><h3 id=执行流程>执行流程</h3><p>加载配置文件，DelegatingFilterProxy 完成初始化操作，从容器中获取到 FilterChainProxy 对象，顺序调用过滤器。</p><ul><li>UsernamePasswordAuthenticationFilter 认证</li><li>ExceptionTranslationFilter 异常</li><li>FilterSecurityInterceptor 授权</li></ul><h3 id=springsecurity-如何实现认证和授权>SpringSecurity 如何实现认证和授权？</h3><h4 id=认证>认证</h4><p>LoginServiceImpl.java （核心：将用户名、密码、权限，封装 Authentication）</p><div class=highlight id=id-1><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=n>UserDetails</span> <span class=n>userDetails</span> <span class=o>=</span> <span class=n>loadUserByUsername</span><span class=o>(</span><span class=n>username</span><span class=o>);</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=o>(!</span><span class=n>passwordEncoder</span><span class=o>.</span><span class=na>matches</span><span class=o>(</span><span class=n>password</span><span class=o>,</span> <span class=n>userDetails</span><span class=o>.</span><span class=na>getPassword</span><span class=o>()))</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                <span class=n>Asserts</span><span class=o>.</span><span class=na>fail</span><span class=o>(</span><span class=s>&#34;密码不正确&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>            <span class=o>}</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=o>(!</span><span class=n>userDetails</span><span class=o>.</span><span class=na>isEnabled</span><span class=o>())</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                <span class=n>Asserts</span><span class=o>.</span><span class=na>fail</span><span class=o>(</span><span class=s>&#34;帐号已被禁用&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>            <span class=o>}</span>
</span></span><span class=line><span class=cl>            <span class=n>UsernamePasswordAuthenticationToken</span> <span class=n>authentication</span> <span class=o>=</span> <span class=k>new</span> <span class=n>UsernamePasswordAuthenticationToken</span><span class=o>(</span><span class=n>userDetails</span><span class=o>,</span> <span class=kc>null</span><span class=o>,</span> <span class=n>userDetails</span><span class=o>.</span><span class=na>getAuthorities</span><span class=o>());</span>
</span></span><span class=line><span class=cl>            <span class=n>SecurityContextHolder</span><span class=o>.</span><span class=na>getContext</span><span class=o>().</span><span class=na>setAuthentication</span><span class=o>(</span><span class=n>authentication</span><span class=o>);</span>
</span></span><span class=line><span class=cl>            <span class=n>token</span> <span class=o>=</span> <span class=n>jwtTokenUtil</span><span class=o>.</span><span class=na>generateToken</span><span class=o>(</span><span class=n>userDetails</span><span class=o>);</span>
</span></span><span class=line><span class=cl>            <span class=n>updateLoginTimeByUsername</span><span class=o>(</span><span class=n>username</span><span class=o>);</span>
</span></span><span class=line><span class=cl>            <span class=n>insertLoginLog</span><span class=o>(</span><span class=n>username</span><span class=o>);</span></span></span></code></pre></td></tr></table></div></div><p>SecurityConfig.java 认证过滤器配置（跨域、白名单、JWT 过滤器、动态权限校验过滤器？）</p><div class=highlight id=id-2><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@Bean</span>
</span></span><span class=line><span class=cl><span class=n>SecurityFilterChain</span> <span class=nf>filterChain</span><span class=o>(</span><span class=n>HttpSecurity</span> <span class=n>httpSecurity</span><span class=o>)</span> <span class=kd>throws</span> <span class=n>Exception</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>  <span class=n>ExpressionUrlAuthorizationConfigurer</span><span class=o>&lt;</span><span class=n>HttpSecurity</span><span class=o>&gt;.</span><span class=na>ExpressionInterceptUrlRegistry</span> <span class=n>registry</span> <span class=o>=</span> <span class=n>httpSecurity</span><span class=o>.</span><span class=na>authorizeRequests</span><span class=o>();</span>
</span></span><span class=line><span class=cl>  <span class=c1>//不需要保护的资源路径允许访问
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=k>for</span> <span class=o>(</span><span class=n>String</span> <span class=n>url</span> <span class=o>:</span> <span class=n>ignoreUrlsConfig</span><span class=o>.</span><span class=na>getUrls</span><span class=o>())</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=n>registry</span><span class=o>.</span><span class=na>antMatchers</span><span class=o>(</span><span class=n>url</span><span class=o>).</span><span class=na>permitAll</span><span class=o>();</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl>  <span class=c1>//允许跨域请求的OPTIONS请求
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=n>registry</span><span class=o>.</span><span class=na>antMatchers</span><span class=o>(</span><span class=n>HttpMethod</span><span class=o>.</span><span class=na>OPTIONS</span><span class=o>)</span>
</span></span><span class=line><span class=cl>    <span class=o>.</span><span class=na>permitAll</span><span class=o>();</span>
</span></span><span class=line><span class=cl>  <span class=c1>// 任何请求需要身份认证
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=n>registry</span><span class=o>.</span><span class=na>and</span><span class=o>()</span>
</span></span><span class=line><span class=cl>    <span class=o>.</span><span class=na>authorizeRequests</span><span class=o>()</span>
</span></span><span class=line><span class=cl>    <span class=o>.</span><span class=na>anyRequest</span><span class=o>()</span>
</span></span><span class=line><span class=cl>    <span class=o>.</span><span class=na>authenticated</span><span class=o>()</span>
</span></span><span class=line><span class=cl>    <span class=c1>// 禁用了 CSRF 保护，并配置了使用无状态的会话管理策略
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=o>.</span><span class=na>and</span><span class=o>()</span>
</span></span><span class=line><span class=cl>    <span class=o>.</span><span class=na>csrf</span><span class=o>()</span>
</span></span><span class=line><span class=cl>    <span class=o>.</span><span class=na>disable</span><span class=o>()</span>
</span></span><span class=line><span class=cl>    <span class=o>.</span><span class=na>sessionManagement</span><span class=o>()</span>
</span></span><span class=line><span class=cl>    <span class=o>.</span><span class=na>sessionCreationPolicy</span><span class=o>(</span><span class=n>SessionCreationPolicy</span><span class=o>.</span><span class=na>STATELESS</span><span class=o>)</span>
</span></span><span class=line><span class=cl>    <span class=c1>// 自定义权限拒绝处理类
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=o>.</span><span class=na>and</span><span class=o>()</span>
</span></span><span class=line><span class=cl>    <span class=o>.</span><span class=na>exceptionHandling</span><span class=o>()</span>
</span></span><span class=line><span class=cl>    <span class=o>.</span><span class=na>accessDeniedHandler</span><span class=o>(</span><span class=n>restfulAccessDeniedHandler</span><span class=o>)</span>
</span></span><span class=line><span class=cl>    <span class=o>.</span><span class=na>authenticationEntryPoint</span><span class=o>(</span><span class=n>restAuthenticationEntryPoint</span><span class=o>)</span>
</span></span><span class=line><span class=cl>    <span class=c1>// 自定义权限拦截器JWT过滤器
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=o>.</span><span class=na>and</span><span class=o>()</span>
</span></span><span class=line><span class=cl>    <span class=o>.</span><span class=na>addFilterBefore</span><span class=o>(</span><span class=n>jwtAuthenticationTokenFilter</span><span class=o>,</span> <span class=n>UsernamePasswordAuthenticationFilter</span><span class=o>.</span><span class=na>class</span><span class=o>);</span>
</span></span><span class=line><span class=cl>  <span class=c1>//有动态权限配置时添加动态权限校验过滤器
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=k>if</span> <span class=o>(</span><span class=n>dynamicSecurityService</span> <span class=o>!=</span> <span class=kc>null</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=n>registry</span><span class=o>.</span><span class=na>and</span><span class=o>().</span><span class=na>addFilterBefore</span><span class=o>(</span><span class=n>dynamicSecurityFilter</span><span class=o>,</span> <span class=n>FilterSecurityInterceptor</span><span class=o>.</span><span class=na>class</span><span class=o>);</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=n>httpSecurity</span><span class=o>.</span><span class=na>build</span><span class=o>();</span>
</span></span><span class=line><span class=cl><span class=o>}</span></span></span></code></pre></td></tr></table></div></div><p>登录</p><ul><li>调用 ProviderManager 的方法进行认证，通过 Jwts.builder() 生成 JWT（无状态<code>SessionCreationPolicy.STATELESS</code>）<ul><li>Claims 对象：存储用户 id 和自定义键值对</li><li>Expiration：过期时间</li><li>SignWith：加密方式和盐值</li></ul></li><li>实现 UserDetails 接口</li><li>密码加密采用：BCryptPasswordEncoder</li><li>将用户信息存入 Redis 中</li></ul><p>每次请求</p><ul><li>继承 OncePerRequestFilter，定义 jwt 认证过滤器，从 header.Authorization 字段中获取 token，解析获得用户 id</li><li>查询 Redis ，将用户信息放到 SecurityContextHolder 中</li></ul><h4 id=授权>授权</h4><p>FilterSecurityInterceptor 从 SecurityContextHolder 中获取 Authentication 里的权限信息。</p><p>基于注解：</p><ul><li>启动类配置：<code>EnableGlobalMethodSecurity(prePostEnabled = true)</code></li><li>在接口方法前<ul><li><code>@PreAuthorize(hasAuthority('test'))</code></li><li><code>@PreAuthorize(hasAnyAuthority('streamer','owner'))</code></li><li><code>@PreAuthorize(hasRole('test'))</code>：会拼接 &ldquo;ROLE_"，不常用</li><li>自定义<ul><li>@Component(&ldquo;beanName&rdquo;)</li><li>@PreAuthorize("@beanName.method(&rsquo;test&rsquo;)&rdquo;)</li></ul></li></ul></li></ul><p>AdminUserDetails.java</p><div class=highlight id=id-3><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span><span class=lnt>9
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span> <span class=kd>class</span> <span class=nc>AdminUserDetails</span> <span class=kd>implements</span> <span class=n>UserDetails</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=nd>@Override</span>
</span></span><span class=line><span class=cl>    <span class=kd>public</span> <span class=n>Collection</span><span class=o>&lt;?</span> <span class=kd>extends</span> <span class=n>GrantedAuthority</span><span class=o>&gt;</span> <span class=nf>getAuthorities</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=c1>//返回当前用户的角色
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=k>return</span> <span class=n>resourceList</span><span class=o>.</span><span class=na>stream</span><span class=o>()</span>
</span></span><span class=line><span class=cl>                <span class=o>.</span><span class=na>map</span><span class=o>(</span><span class=n>role</span> <span class=o>-&gt;</span> <span class=k>new</span> <span class=n>SimpleGrantedAuthority</span><span class=o>(</span><span class=n>role</span><span class=o>.</span><span class=na>getId</span><span class=o>()</span> <span class=o>+</span> <span class=s>&#34;:&#34;</span> <span class=o>+</span> <span class=n>role</span><span class=o>.</span><span class=na>getName</span><span class=o>()))</span>
</span></span><span class=line><span class=cl>                <span class=o>.</span><span class=na>collect</span><span class=o>(</span><span class=n>Collectors</span><span class=o>.</span><span class=na>toList</span><span class=o>());</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span></span></span></code></pre></td></tr></table></div></div><h3 id=什么是-csrf攻击springsecurity-如何防范>什么是 CSRF攻击，SpringSecurity 如何防范？</h3><blockquote><p>CSRF：跨站请求伪造，利用受信任用户的身份执行未经授权的操作</p></blockquote><p><a class=lightgallery href=https://publicpictures.oss-cn-hangzhou.aliyuncs.com/img/image-20230904140131997.png data-thumbnail=https://publicpictures.oss-cn-hangzhou.aliyuncs.com/img/image-20230904140131997.png data-sub-html="<h2>image-20230904140131997</h2>"><img loading=lazy src=https://publicpictures.oss-cn-hangzhou.aliyuncs.com/img/image-20230904140131997.png srcset="https://publicpictures.oss-cn-hangzhou.aliyuncs.com/img/image-20230904140131997.png, https://publicpictures.oss-cn-hangzhou.aliyuncs.com/img/image-20230904140131997.png 1.5x, https://publicpictures.oss-cn-hangzhou.aliyuncs.com/img/image-20230904140131997.png 2x" sizes=auto data-title=image-20230904140131997 data-alt=image-20230904140131997 style="background:url(/svg/loading.min.svg)no-repeat 50%" onload='this.title=this.dataset.title,this.alt=this.dataset.alt;for(const e of["style","data-title","data-alt","onerror","onload"])this.removeAttribute(e);this.dataset.lazyloaded=""' onerror='this.title=this.dataset.title,this.alt=this.dataset.alt;for(const e of["style","data-title","data-alt","onerror","onload"])this.removeAttribute(e)'></a></p><ol><li>生成一个随机的 CSRF Token，并将其嵌入到每个需要防范 CSRF 攻击的表单中。</li><li>将 CSRF Token 设置为 HttpOnly Cookie：将 CSRF Token 存储在 HttpOnly Cookie 中，以防止它被 JavaScript 访问。</li><li>Spring Security 默认启用 CSRF 保护，它会拦截所有非 GET 请求。如果 Token 不匹配，则拒绝请求。</li><li>将 Cookie 的 SameSite 属性设置为 &ldquo;Strict&rdquo; 或 &ldquo;Lax&rdquo;，以限制跨站点请求。<ol><li>&ldquo;Strict&rdquo; 模式：将完全禁止第三方站点发送带有 Cookie 的跨站请求</li><li>&ldquo;Lax&rdquo; 模式：仅允许安全的 GET 请求带有 Cookie。</li></ol></li></ol><p>如果有了 JWT token，就不需要 CSRF token 了，关闭即可：</p><div class=highlight id=id-4><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=n>registry</span><span class=o>.</span><span class=na>csrf</span><span class=o>()</span>
</span></span><span class=line><span class=cl>    <span class=o>.</span><span class=na>disable</span><span class=o>()</span>
</span></span><span class=line><span class=cl>    <span class=o>.</span><span class=na>sessionManagement</span><span class=o>()</span>
</span></span><span class=line><span class=cl>    <span class=o>.</span><span class=na>sessionCreationPolicy</span><span class=o>(</span><span class=n>SessionCreationPolicy</span><span class=o>.</span><span class=na>STATELESS</span><span class=o>)</span></span></span></code></pre></td></tr></table></div></div><h3 id=对信息安全和数据安全的理解>对信息安全和数据安全的理解？</h3><p>措施：认证授权、加密传输、防火墙、安全审计、HTTPS、安全漏洞（跨站脚本攻击、SQL 注入攻击）、数字签名……</p><h4 id=如何保证缓存数据的安全>如何保证缓存数据的安全？</h4><ul><li>脱敏，只缓存非敏感数据</li><li>加密</li><li>过期策略<ul><li>no-enviction：不淘汰，满了就报错（默认）</li><li>volatile-：从已过期的数据集（<strong>server.db[i].expires</strong>）中挑选<ul><li>ttl：剩余 ttl 越短的优先淘汰</li><li>random：随机</li><li><strong>lru：最近最少使用【业务数据有冷热区分，且有置顶需求】</strong></li><li>lfu：最少频率使用</li></ul></li><li>allkeys-：针对全体<ul><li>random【无明显冷热数据区分时】</li><li>lru【业务数据有冷热区分】</li><li>lfu【短时高频】</li></ul></li></ul></li><li>缓存隔离：不同应用使用独立的缓存实例（docker容器）</li></ul><h3 id=如何允许跨域>如何允许跨域？</h3><p>跨域：<strong>浏览器</strong>禁止请求的发起者与服务端发生跨域<strong>ajax请求</strong>，请求被浏览器拦截的问题。</p><ul><li>域名不同</li><li>域名相同，端口不同</li></ul><p>通过 SpringMVC 的 CorsFilter：</p><div class=highlight id=id-5><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@Configuration</span>
</span></span><span class=line><span class=cl><span class=kd>public</span> <span class=kd>class</span> <span class=nc>GlobalCorsConfig</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>     * 允许跨域调用的过滤器
</span></span></span><span class=line><span class=cl><span class=cm>     */</span>
</span></span><span class=line><span class=cl>    <span class=nd>@Bean</span>
</span></span><span class=line><span class=cl>    <span class=kd>public</span> <span class=n>CorsFilter</span> <span class=nf>corsFilter</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>CorsConfiguration</span> <span class=n>config</span> <span class=o>=</span> <span class=k>new</span> <span class=n>CorsConfiguration</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        <span class=c1>//允许所有域名进行跨域调用
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=n>config</span><span class=o>.</span><span class=na>addAllowedOriginPattern</span><span class=o>(</span><span class=s>&#34;*&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=c1>//该用法在SpringBoot 2.7.0中已不再支持
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=c1>//config.addAllowedOrigin(&#34;*&#34;);
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=c1>//允许跨越发送cookie
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=n>config</span><span class=o>.</span><span class=na>setAllowCredentials</span><span class=o>(</span><span class=kc>true</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=c1>//放行全部原始头信息
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=n>config</span><span class=o>.</span><span class=na>addAllowedHeader</span><span class=o>(</span><span class=s>&#34;*&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=c1>//允许所有请求方法跨域调用，比如 GET/POST/PUT/DELETE
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=n>config</span><span class=o>.</span><span class=na>addAllowedMethod</span><span class=o>(</span><span class=s>&#34;*&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=n>UrlBasedCorsConfigurationSource</span> <span class=n>source</span> <span class=o>=</span> <span class=k>new</span> <span class=n>UrlBasedCorsConfigurationSource</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        <span class=n>source</span><span class=o>.</span><span class=na>registerCorsConfiguration</span><span class=o>(</span><span class=s>&#34;/**&#34;</span><span class=o>,</span> <span class=n>config</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=k>new</span> <span class=n>CorsFilter</span><span class=o>(</span><span class=n>source</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span></span></span></code></pre></td></tr></table></div></div><h3 id=单点登录-sso--single-sign-on>单点登录 SSO = Single Sign On</h3><p>一次登录，访问所有信任的应用系统。</p><ol><li>集成认证中心到应用系统中，如 spring-security-oauth2</li><li>在认证中心中配置应用系统的信息，包括<strong>应用名称、域名、回调地址</strong>，同时为用户分配唯一 id</li><li>集成认证中心提供的 SDK 或库</li><li>用户未登录时，重定向（redirect）到认证中心进行登录，验证完身份重定向回应用系统，在 URL 参数中携带用户的身份标识符</li><li>记录用户登录状态于 Session 中</li></ol><h3 id=需求五次登录失败锁定三十分钟>需求：五次登录失败锁定三十分钟</h3><ol><li>创建一个实现<code>AuthenticationFailureHandler</code>接口的类 failureHandler，用于处理认证失败的情况。</li><li>在 SecurityConfig extends WebSecurityConfigurerAdapter 中配置<code>http.formLogin().failureHandler(failureHandler)</code></li><li>在失败处理器中，可以获取登录失败的用户名，然后将其作为键存储到Redis中，并将失败次数作为值进行计数。同时，设置键的过期时间为30分钟。</li><li>在登录前，判断用户是否是登录失败 5 次以上。</li></ol></div><div class=post-footer id=post-footer><div class=post-info><div class=post-info-line><div class=post-info-mod><span title="更新于 2023-08-29 16:14:31">更新于 2023-08-29&nbsp;</span></div><div class=post-info-license><span><a rel="license external nofollow noopener noreferrer" href=https://creativecommons.org/licenses/by-nc/4.0/ target=_blank>CC BY-NC 4.0</a></span></div></div><div class=post-info-line><div class=post-info-md></div><div class=post-info-share><span><a href=javascript:void(0); title="分享到 微博" data-sharer=weibo data-url=https://leni.fun/springsecurity/ data-title=SpringSecurity data-image=/images/pic12.jpg><i class="fa-brands fa-weibo fa-fw" aria-hidden=true></i></a></span></div></div></div><div class=post-info-more><section class=post-tags><i class="fa-solid fa-tags fa-fw me-1" aria-hidden=true></i><a href=/tags/spring/ class=post-tag>Spring</a><a href=/tags/security/ class=post-tag>Security</a></section><section><span><a href=javascript:void(0); onclick=window.history.back()>返回</a></span>&nbsp;|&nbsp;<span><a href=/>主页</a></span></section></div><div class=post-nav><a href=/netty%E5%AE%9E%E8%B7%B5%E8%AE%B0%E5%BD%95/ class=post-nav-item rel=prev title="Netty 实践记录"><i class="fa-solid fa-angle-left fa-fw" aria-hidden=true></i>Netty 实践记录</a>
<a href=/spring/ class=post-nav-item rel=next title=🚩Spring>🚩Spring<i class="fa-solid fa-angle-right fa-fw" aria-hidden=true></i></a></div></div></article></main><footer class=footer><div class=footer-container><div class="footer-line copyright order-5" itemscope itemtype=http://schema.org/CreativeWork><i class="fa-regular fa-copyright fa-fw" aria-hidden=true></i>
<span itemprop=copyrightYear>2021 - 2023</span><span class=author itemprop=copyrightHolder>
<a href=/>都将会</a></span><span class="license footer-divider"><a rel="license external nofollow noopener noreferrer" href=https://beian.miit.gov.cn target=_blank>浙ICP备2023023782号</a></span></div><div class="footer-line statistics"><span class=site-time title=网站运行中……><i class="fa-solid fa-heartbeat fa-fw animate-icon" aria-hidden=true></i><span class="run-times ms-1">网站运行中……</span></span></div><div class="footer-line visitor order-4"><span id=busuanzi_container_site_uv title=总访客数><i class="fa-regular fa-user fa-fw" aria-hidden=true></i>&nbsp;<span id=busuanzi_value_site_uv><i class="fa-solid fa-spinner fa-spin fa-fw" aria-hidden=true></i></span></span><span id=busuanzi_container_site_pv class=footer-divider title=总访问量><i class="fa-regular fa-eye fa-fw" aria-hidden=true></i>&nbsp;<span id=busuanzi_value_site_pv><i class="fa-solid fa-spinner fa-spin fa-fw" aria-hidden=true></i></span></span></div></div></footer></div><div class=widgets><div class="fixed-buttons animate__faster d-none"><div class="fixed-button back-to-top" role=button aria-label=回到顶部><i class="fa-solid fa-arrow-up fa-fw" aria-hidden=true></i><span class=variant-numeric>0%</span></div></div><a href=https://github.com/hihihiman/hihihiman.github.io title=博客源码 target=_blank rel="external nofollow" class="github-corner left d-none-mobile"><svg viewBox="0 0 250 250" aria-hidden="true"><path d="M0 0 115 115h15l12 27L250 250V0z"/><path d="M128.3 109C113.8 99.7 119 89.6 119 89.6 122 82.7 120.5 78.6 120.5 78.6 119.2 72 123.4 76.3 123.4 76.3 127.3 80.9 125.5 87.3 125.5 87.3 122.9 97.6 130.6 101.9 134.4 103.2" fill="currentcolor" style="transform-origin:130px 106px" class="octo-arm"/><path d="M115 115C114.9 115.1 118.7 116.5 119.8 115.4l13.9-13.8C136.9 99.2 139.9 98.4 142.2 98.6 133.8 88 127.5 74.4 143.8 58 148.5 53.4 154 51.2 159.7 51 160.3 49.4 163.2 43.6 171.4 40.1 171.4 40.1 176.1 42.5 178.8 56.2 183.1 58.6 187.2 61.8 190.9 65.4 194.5 69 197.7 73.2 200.1 77.6 213.8 80.2 216.3 84.9 216.3 84.9 212.7 93.1 206.9 96 205.4 96.6 205.1 102.4 203 107.8 198.3 112.5 181.9 128.9 168.3 122.5 157.7 114.1 157.9 116.9 156.7 120.9 152.7 124.9L141 136.5C139.8 137.7 141.6 141.9 141.8 141.8z" fill="currentcolor" class="octo-body"/></svg></a><div id=mask></div><div class=reading-progress-bar style=left:0;bottom:0></div><noscript><div class=noscript-warning>FixIt 主题在启用 JavaScript 的情况下效果最佳。</div></noscript></div><link rel=stylesheet href=/lib/lightgallery/css/lightgallery-bundle.min.css><link rel=stylesheet href=/lib/katex/katex.min.css><link rel=stylesheet href=/lib/cookieconsent/cookieconsent.min.css><link rel=stylesheet href=/lib/pace/themes/pink/pace-theme-center-atom.css><script src=/lib/autocomplete/autocomplete.min.js defer></script><script src=/lib/fuse/fuse.min.js defer></script><script src=/lib/lightgallery/lightgallery.min.js defer></script><script src=/lib/lightgallery/plugins/thumbnail/lg-thumbnail.min.js defer></script><script src=/lib/lightgallery/plugins/zoom/lg-zoom.min.js defer></script><script src=/lib/sharer/sharer.min.js async defer></script><script src=/lib/typeit/index.umd.js defer></script><script src=/lib/katex/katex.min.js defer></script><script src=/lib/katex/auto-render.min.js defer></script><script src=/lib/katex/copy-tex.min.js defer></script><script src=/lib/katex/mhchem.min.js defer></script><script src=/lib/cookieconsent/cookieconsent.min.js defer></script><script src=/lib/pangu/pangu.min.js defer></script><script src=//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js async defer></script><script src=/lib/pace/pace.min.js async defer></script><script>window.config={autoBookmark:!0,code:{copyTitle:"复制到剪贴板",editLockTitle:"锁定可编辑代码块",editUnLockTitle:"解锁可编辑代码块",editable:!0,maxShownLines:1024},comment:{enable:!1},cookieconsent:{content:{dismiss:"同意",link:"了解更多",message:"本网站使用 Cookies 来改善您的浏览体验。"},enable:!0,palette:{button:{background:"#f0f0f0"},popup:{background:"#1aa3ff"}},theme:"edgeless"},data:{"typeit-header-subtitle-desktop":"的博客           ","typeit-header-subtitle-mobile":"的博客           "},enablePWA:!0,lightgallery:!0,math:{delimiters:[{display:!0,left:"$$",right:"$$"},{display:!0,left:"\\[",right:"\\]"},{display:!0,left:"\\begin{equation}",right:"\\end{equation}"},{display:!0,left:"\\begin{equation*}",right:"\\end{equation*}"},{display:!0,left:"\\begin{align}",right:"\\end{align}"},{display:!0,left:"\\begin{align*}",right:"\\end{align*}"},{display:!0,left:"\\begin{alignat}",right:"\\end{alignat}"},{display:!0,left:"\\begin{alignat*}",right:"\\end{alignat*}"},{display:!0,left:"\\begin{gather}",right:"\\end{gather}"},{display:!0,left:"\\begin{CD}",right:"\\end{CD}"},{display:!1,left:"$",right:"$"},{display:!1,left:"\\(",right:"\\)"}],strict:!1},pangu:{enable:!0,selector:"article"},search:{distance:100,findAllMatches:!1,highlightTag:"em",ignoreFieldNorm:!0,ignoreLocation:!0,isCaseSensitive:!1,location:0,maxResultLength:10,minMatchCharLength:2,noResultsFound:"没有找到结果",snippetLength:50,threshold:.3,useExtendedSearch:!0},siteTime:"2021-08-26T23:31:00+08:00",typeit:{cursorChar:"_",cursorSpeed:1e3,data:{"typeit-header-subtitle-desktop":["typeit-header-subtitle-desktop"],"typeit-header-subtitle-mobile":["typeit-header-subtitle-mobile"]},duration:-1,loop:!0,speed:150}}</script><script src=/js/theme.min.js defer></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/jquery@2.1.3/dist/jquery.min.js></script><script type=text/javascript src=/js/custom.js></script></body></html>